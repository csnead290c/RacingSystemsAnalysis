var ws=Object.defineProperty;var xs=(we,xe,mt)=>xe in we?ws(we,xe,{enumerable:!0,configurable:!0,writable:!0,value:mt}):we[xe]=mt;var Ut=(we,xe,mt)=>xs(we,typeof xe!="symbol"?xe+"":xe,mt);(function(){"use strict";const we={EIGHTH:[60,330,660],THOUSAND:[60,330,660,1e3],QUARTER:[60,330,660,1e3,1320],ONE_MILE:[660,1320,2640,3960,5280],EL_MIRAGE:[660,1320,2640,3960,5280,6864],MUROC:[660,1320,2640,3960,5280,6600,7920],TWO_MILE:[660,1320,2640,5280,7920,10560],BONNEVILLE_SHORT:[660,1320,2640,5280,10560,15840],BONNEVILLE_LONG:[660,1320,2640,5280,10560,15840,21120,26400],TEN_MILE:[660,1320,2640,5280,10560,26400,52800]},xe={EIGHTH:{label:"1/8 Mile",shortLabel:"1/8",category:"drag",lengthFt:660,lengthMiles:.125},THOUSAND:{label:"1000 Foot",shortLabel:"1000'",category:"drag",lengthFt:1e3,lengthMiles:.189},QUARTER:{label:"1/4 Mile",shortLabel:"1/4",category:"drag",lengthFt:1320,lengthMiles:.25},ONE_MILE:{label:"One Mile Asphalt",shortLabel:"1 Mi",category:"landspeed",lengthFt:5280,lengthMiles:1},EL_MIRAGE:{label:"El Mirage Dry Lake",shortLabel:"El Mirage",category:"landspeed",lengthFt:6864,lengthMiles:1.3},MUROC:{label:"Muroc Dry Lake (EAFB)",shortLabel:"Muroc",category:"landspeed",lengthFt:7920,lengthMiles:1.5},TWO_MILE:{label:"Two Mile Asphalt",shortLabel:"2 Mi",category:"landspeed",lengthFt:10560,lengthMiles:2},BONNEVILLE_SHORT:{label:"Bonneville - 3 Miles",shortLabel:"BV 3Mi",category:"landspeed",lengthFt:15840,lengthMiles:3},BONNEVILLE_LONG:{label:"Bonneville - 5 Miles",shortLabel:"BV 5Mi",category:"landspeed",lengthFt:26400,lengthMiles:5},TEN_MILE:{label:"Ten Mile Test Track",shortLabel:"10 Mi",category:"landspeed",lengthFt:52800,lengthMiles:10}};function mt(e){const r=e.elevation+(29.92-e.barometerInHg)*1e3,o=59-r/1e3*3.5,s=(e.temperatureF-o)*120,n=e.humidityPct/10*50*(e.temperatureF/80);return r+s+n}function po(e){const r=.0061*Math.exp(17.27*(e.temperatureF-32)/1.8/(237.3+(e.temperatureF-32)/1.8))*(e.humidityPct/100),o=7e3*.622*(r/(e.barometerInHg-r));return Math.max(0,Math.min(o,500))}function Mo(e){const o=518.6700000000001,s=e.temperatureF+459.67,n=e.barometerInHg/29.92,l=o/s;let a=n*l;const c=1-po(e)/5e3;return a*=c,Math.max(.7,Math.min(a,1.15))}function Po(e){const{vehicle:t,env:r,raceLength:o}=e;if(t.weightLb<=0||t.powerHP<=0)throw new Error("Invalid vehicle params");const s=we[o];if(!s)throw new Error(`Invalid race length: ${o}`);const n=Mo(r),l=t.powerHP*n,a=Math.max(1,l),f=Math.max(1,t.weightLb),c=5.825*Math.cbrt(f/a),_=234*Math.cbrt(a/f),h=c*.64,d=_*.8;let g,u;if(o==="EIGHTH"?(g=h,u=d):(g=c,u=_),!Number.isFinite(g)||!Number.isFinite(u))throw new Error("Invalid ET or MPH calculation");const P=5.825*Math.cbrt(f/Math.max(1,t.powerHP)),m=g-P,p={60:.16,330:.44,660:.79,1e3:.93,1320:1},R=s.map(v=>{const y=p[v]??1,x=g*y,T=v/s[s.length-1],K=u*T;return{d_ft:v,t_s:Math.max(0,x),v_mph:Math.max(0,K)}}),E=[{name:"Weather (HP)",delta_s:m}];return{baseET_s:Math.max(0,g),baseMPH:Math.max(0,u),timeslip:R,factors:E}}function To(e){return e/32.174}function So(e,t,r){return e+(t-e)*r}function Ro(e){var r;const t=(Array.isArray(e)?e:e==null?void 0:e.powerHP)??((r=e==null?void 0:e.engineParams)==null?void 0:r.powerHP);if(!Array.isArray(t)||t.length<2){const o=e&&typeof e=="object"?Object.keys(e):[];throw new Error(`EngineParams must provide either torqueCurve or powerHP (got keys=${JSON.stringify(o)}, len=${(t==null?void 0:t.length)??0})`)}return t}function hr(e,t){const r=Ro(t);if(e<=r[0].rpm)return r[0].hp;if(e>=r[r.length-1].rpm)return r[r.length-1].hp;let o=0,s=r.length-1;for(;s-o>1;){const f=o+s>>1;r[f].rpm<=e?o=f:s=f}const n=r[o],l=r[s],a=(e-n.rpm)/(l.rpm-n.rpm);return n.hp+a*(l.hp-n.hp)}function Jt(e,t,r){if("corr"in t&&typeof t.corr=="number"){const n=t;let l;if(n.torqueCurve&&n.torqueCurve.length>0)l=Fo(e,n.torqueCurve);else if(n.powerHP!==void 0){const f=Math.max(e,1e3);l=n.powerHP*5252/f}else throw new Error("EngineParams must provide either torqueCurve or powerHP");return l*n.corr}const o=hr(e,t);return(e>0?5252*o/e:0)*(Number.isFinite(r)?r:1)}function Fo(e,t){const o=[...t.map(s=>{if(s.tq_lbft!==void 0)return{rpm:s.rpm,tq_lbft:s.tq_lbft};if(s.hp!==void 0&&s.rpm>0)return{rpm:s.rpm,tq_lbft:s.hp*5252/s.rpm};throw new Error(`Invalid torque curve point: ${JSON.stringify(s)}`)})].sort((s,n)=>s.rpm-n.rpm);if(e<=o[0].rpm)return o[0].tq_lbft;if(e>=o[o.length-1].rpm)return o[o.length-1].tq_lbft;for(let s=0;s<o.length-1;s++){const n=o[s],l=o[s+1];if(e>=n.rpm&&e<=l.rpm){const a=(e-n.rpm)/(l.rpm-n.rpm);return So(n.tq_lbft,l.tq_lbft,a)}}return o[o.length-1].tq_lbft}const S=e=>Math.fround(e),H={add:(e,t)=>Math.fround(Math.fround(e)+Math.fround(t)),sub:(e,t)=>Math.fround(Math.fround(e)-Math.fround(t)),mul:(e,t)=>Math.fround(Math.fround(e)*Math.fround(t)),div:(e,t)=>Math.fround(Math.fround(e)/Math.fround(t)),sqrt:e=>Math.fround(Math.sqrt(Math.fround(e))),pow:(e,t)=>Math.fround(Math.pow(Math.fround(e),Math.fround(t))),exp:e=>Math.fround(Math.exp(Math.fround(e))),log:e=>Math.fround(Math.log(Math.fround(e))),clamp:(e,t,r)=>Math.fround(Math.min(Math.max(Math.fround(e),Math.fround(t)),Math.fround(r))),abs:e=>Math.fround(Math.abs(Math.fround(e))),neg:e=>Math.fround(-Math.fround(e))};function vr(e,t=0){const r=Math.pow(10,t),o=Math.fround(e*r),s=Math.floor(o),n=o-s;return n>.5?(s+1)/r:n<.5?s/r:(s%2===0?s:s+1)/r}function bo(e,t,r,o,s){const n=S(e),l=S(t),a=S(r),f=S(o),c=S(s);if(a===l)return f;const _=H.div(H.sub(n,l),H.sub(a,l));return H.add(f,H.mul(_,H.sub(c,f)))}function Eo(e,t){if(t.length===0)return S(0);if(t.length===1)return S(t[0][1]);const r=S(e);if(r<=S(t[0][0]))return S(t[0][1]);if(r>=S(t[t.length-1][0]))return S(t[t.length-1][1]);for(let o=0;o<t.length-1;o++){const s=S(t[o][0]),n=S(t[o+1][0]);if(r>=s&&r<=n)return bo(r,s,n,t[o][1],t[o+1][1])}return S(t[t.length-1][1])}function Ao(e){return Array.isArray(e==null?void 0:e.ratios)&&e.ratios.length>0?e.ratios:Array.isArray(e==null?void 0:e.gearRatios)&&e.gearRatios.length>0?e.gearRatios:[]}function wo(e,t,r,o=0){const s=(r.tireDiaIn??28)/12,n=Math.PI*s,a=e/n*60,f=Ao(r),c=f.length>0?f[Math.min(t,f.length-1)]??1:1;return a*c*(r.finalDrive??3.73)*(1+o)}function xo(){return{t_s:0,v_fps:0,s_ft:0,rpm:0,gearIdx:0,warnings:[]}}const Xe=3.141593,A=32.174,_r=60/(2*Xe)*550,dr=519.67,Cr=14.696,Io=29.92,gr=28.9669,yr=18.016,Hr=1545.32,Qt=3600/5280,mr=.025,vo=.01,Lr=.03,Co=0,yo=9.7,Ho=1.01,Lo=0,No=0,Se=.004,pt=-4,Mt=2,Nr=.92,Dr=1.08,Gr=.15,kr=.25,Do=1.03,Go=10.8,fe=3600/5280,ko=459.67,Wo=A;function Oo(e){const{engineTorque_lbft_atSlip:t,gearRatio:r,transEff:o,drivelineEff:s,finalDrive:n,tireDia_in:l,tireSlip:a,dragForce_lbf:f,vehicleWeight_lbf:c,isAutoTrans:_,torqueMult:h=1}=e,d=t*h*r*o,g=l/24,P=d*n*s/(a*g)-f;return{Ags0_ftps2:(_?.96:.88)*(P/c)*A,netThrust_lbf:P,wheelTorque_lbft:d}}function Wr(e){const t=e.elevation_ft??0,r=e.fuelSystem??1,o=[.0205558,.00118163,154988e-10,40245e-11,434856e-15,2096e-14],s=o[0]+o[1]*e.temperature_F+o[2]*e.temperature_F**2+o[3]*e.temperature_F**3+o[4]*e.temperature_F**4+o[5]*e.temperature_F**5,n=e.relHumidity_pct/100*s,l=Math.pow((dr-.00356616*t)/dr,5.25588),a=Cr*e.barometer_inHg/Io*l,f=a-n,c=f/Cr,_=n*yr/(f*gr),h=Hr*(1/gr+_/yr)/(1+_),d=h/(Hr/gr),g=e.temperature_F+ko,u=g/dr,m=144*a/(h*g)/32.174;let p,R;switch(r){case 1:p=1,R=1;break;case 2:p=1,R=2;break;case 3:p=2,R=1;break;case 4:p=2,R=2;break;case 5:p=3,R=2;break;case 6:p=1,R=3;break;case 7:case 9:p=2,R=3;break;case 8:p=3,R=3;break;default:p=1,R=1;break}const E=1+2.48*Math.pow(_,1.5);let v,y,x;switch(p){case 1:v=1,y=.6,x=.15;break;case 2:v=1,y=.3,x=.13;break;case 3:v=.85,y=.5,x=.055;break;default:v=1,y=.6,x=.15;break}if(R===2&&(x=x-.005),R===3){const K=.3050108932461874;v=.95-K*y,y=y+K,x=.6*x}let T=Math.pow(c,v)/(Math.sqrt(d)*Math.pow(u,y));return T=(1+x)*E/T-x,r===9&&(T=1),{rho_slug_per_ft3:m,pamb_psi:a,PWV_psi:n,pair_psi:f,WAR:_,RGAS:h,temp_R:g,hpc:T,delta:c,theta:u,rgrs:d}}function qo(e,t,r,o=.025,s=.01){const n=o-r/1320*s,l=3600/5280,a=n*e,f=1e-4*e*(l*t);return a+f}function Vo(e,t,r,o,s=.025,n=.01){return qo(e,t,r,s,n)*o}function Bo(e,t,r,o,s=1){let n=t,l=o*e/n;s>2&&l>.6&&(n=n*(1+(o-1)*(l-.6)/(1/o-.6)),l=o*e/n);let a=1/o,f=o*e,c=1;return f<n&&(f=n,c=r-(r-1)*l,a=c*e/n),a>1&&(a=1),{work:c,coupling:a,slipRatio:l,zStall:n,engRPM:f}}const $o=10.8;function Or(e){const{tireDia_in:t,tireWidth_in:r,dynamicRWT_lbf:o,tractionIndexAdj:s,bodyStyle:n}=e,l=.92+.08*Math.pow(o/1900,2.15);let a=s*$o*t*(r+1)*l;return n===8&&(a=.5*a),a}function Uo(e){const{weight_lbf:t,tireGrowth:r,dragForce_lbf:o}=e;return(Or(e)/r-o)/t*A}function Jo(){return Se*A}function Qo(e,t,r,o){let s=e,n=t,l=0;return s>o&&(l=1,n=n*(o-(s-o))/s,s=o-(s-o)),s<r&&(n=n*r/s,s=r),{AGS:s,PQWT:n,SLIP:l}}function Ko(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function Xo(e,t,r,o){return e+t*Math.pow(r*o,2)}function jo(e,t,r){return e*t*60/r}function Yo(e,t,r,o,s=!0){let n=o*t*(t-e);n<0&&(n=s?Gr*n:kr*n);const l=Math.pow(2*Xe/60,2)/(12*550*r);return n*l}function Zo(e,t,r,o){let s=o*t*(t-e);s<0&&(s=0);const n=Math.pow(2*Xe/60,2)/(12*550*r);return s*n}function zo(e,t,r,o){const s=Math.PI,n=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));let l=1+n*135e-7*Math.pow(r,1.6);const a=1+n*35e-5*r;a<l&&(l=a);const f=o/32.174,c=l-.035*Math.abs(f),_=c*e*s/12,h=12*_/(2*s),d=2*h,g=h/12;return{growth:l,squat:c,dia_eff_in:d,radius_eff_ft:g,circumference_eff_ft:_}}function en(e,t,r,o,s){const f=(t-1)*r/2*o*(s?1:2)/144;return e+f}function tn(e,t,r,o){if(e>=t-1)return!1;const s=o[e];if(!s||s<=0)return!1;const l=(o[0]??0)>8e3?20:10;return Math.abs(s-r)<l}var qr=(e=>(e[e.NORMAL=0]="NORMAL",e[e.TRIGGERED=1]="TRIGGERED",e[e.EXECUTING=2]="EXECUTING",e))(qr||{});function rn(e,t){switch(e){case 0:return t?{newState:1,executeShift:!1}:{newState:0,executeShift:!1};case 1:return{newState:2,executeShift:!0};case 2:return{newState:0,executeShift:!1};default:return{newState:0,executeShift:!1}}}function on(e){return e?.2:.25}function nn(e,t,r,o){return r>=o||!t||t<=0?!1:H.sub(S(e),S(t))>=0}function sn(e,t=3,r=1){const o=.005*(t-1)+3*(r-1),s=e/1320;return 1.02+o*(1-Math.pow(s,2))}function ln(e,t,r,o,s,n,l=.04,a=.9){const f=e*t*(r-o+l/a*o),c=n*r;return(f+c)/s}function cn(e,t,r,o,s,n,l,a,f=.04,c=.9){const _=ln(r,e,o,s,n,l,f,c);let h=t-_,d=0;h<0&&(d=-h*n/64,h=0);let g=a-h-d;return g<0&&(g=e),{rear_weight_lbf:g,front_weight_lbf:h,wheelie_bar_weight_lbf:d}}function an(e,t,r,o){const s=2*o*r,n=Math.sqrt(e*e+s),l=2*o*r+e*e,a=Math.pow(l,1.5),f=Math.pow(e,3),c=(a-f)/(3*o)+t;return{Vel_ftps:n,Dist_ft:c}}function fn(e,t,r){let o=e,s=1,n=0;if(o>r){n=1;const l=o-r,a=r-l;s=a/o,o=a}return o<t&&(s=t/o,o=t),{AGS_ftps2:o,PQWT_scale:s,slip:n}}function un(e,t){return e/(t*A)}function hn(e,t,r){if(r<=0)return Math.max(.005,Math.min(.05,e));let o=e*Math.pow(t/r,4);return o>.05&&(o=.05),o<.005&&(o=.005),o}function _n(e,t,r,o){const s=t*r/o;let n=e*.11*Math.pow(s,-1/3);return n=n/15,n<.005&&(n=.005),n}function dn(e){if(!e)return 1;const t=e.toUpperCase();return t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")||t.includes("FUEL INJECT")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function gn(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const o=Number(e.torque)*r/5252*t;return{rpm:r,hp:o}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const o=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:o}}return null}function Dt(e,t=1){return e.map(r=>Array.isArray(r)?{rpm:Number(r[0]),hp:Number(r[1])*t}:gn(r,t)).filter(r=>r!==null&&Number.isFinite(r.rpm)&&Number.isFinite(r.hp)).sort((r,o)=>r.rpm-o.rpm)}function mn(e){var f,c,_,h,d;const t=((f=e==null?void 0:e.fuel)==null?void 0:f.hpTorqueMultiplier)??1,r=[],o=(c=e==null?void 0:e.engineParams)==null?void 0:c.powerHP;if(Array.isArray(o)&&(r.push(`engineParams.powerHP(${o.length})`),o.length>=2)){const g=Dt(o,t);if(g.length>=2)return{powerHP:g}}const s=e==null?void 0:e.engineHP;if(Array.isArray(s)&&(r.push(`engineHP(${s.length})`),s.length>=2)){const g=Dt(s,t);if(g.length>=2)return{powerHP:g}}const n=(_=e==null?void 0:e.engineParams)==null?void 0:_.torqueCurve;if(Array.isArray(n)&&(r.push(`engineParams.torqueCurve(${n.length})`),n.length>=2)){const g=Dt(n,t);if(g.length>=2)return{powerHP:g}}const l=(h=e==null?void 0:e.vehicle)==null?void 0:h.torqueCurve;if(Array.isArray(l)&&(r.push(`vehicle.torqueCurve(${l.length})`),l.length>=2)){const g=Dt(l,t);if(g.length>=2)return{powerHP:g}}const a=(d=e==null?void 0:e.vehicle)==null?void 0:d.hpCurve;if(Array.isArray(a)&&(r.push(`vehicle.hpCurve(${a.length})`),a.length>=2)){const g=Dt(a,t);if(g.length>=2)return{powerHP:g}}throw new Error(`RSACLASSIC: missing power curve. Sources found: [${r.join(", ")||"none"}]. Keys(engineParams)=${JSON.stringify(Object.keys((e==null?void 0:e.engineParams)||{}))} Keys(vehicle)=${JSON.stringify(Object.keys((e==null?void 0:e.vehicle)||{}))}`)}function Ie(e,t=0){return Number.isFinite(e)?Number(e):t}function Vr(e,t){const r=t.map(o=>[o.rpm,o.hp]);return Eo(e,r)}function Br(e,t,r){const o=Vr(e,t);if(e<=0)return S(0);const s=H.div(H.mul(S(5252),o),S(e));return H.mul(s,S(r))}function pn(e,t,r,o=t){const s=Number(e);return Number.isFinite(s)?Math.min(r,Math.max(t,s)):o}function Mn(e){return Math.max(.85,Math.min(1,e))}class Pn{constructor(){Ut(this,"id","RSACLASSIC")}simulate(t){var Yr,Zr,or,zr,nr,eo,to,ro;const r=!!((Yr=t==null?void 0:t.flags)!=null&&Yr.vb6Strict);r&&console.log("[RSACLASSIC] VB6-STRICT mode enabled - using Float32 math");const o=Date.now(),s=9e4,n=2e6,l=5e4;let a=0;function f(w,k){if(Date.now()-o>s)throw new Error("simulation wall-time exceeded");if(w>=n)throw new Error("simulation step cap hit");if(w%l===0){const De=k-a;if(console.log("[RSACLASSIC] heartbeat",{step:w,dist_ft:k,gained_ft:De}),w>0&&De<.001)throw new Error("simulation stalled");a=k}}const c=Number((t==null?void 0:t.raceLengthFt)??1320);if(!Number.isFinite(c)||c<=0)throw new Error(`invalid raceLengthFt: ${t==null?void 0:t.raceLengthFt}`);const _=Number((t==null?void 0:t.timeStep)??.002);if(!Number.isFinite(_)||_<=0)throw new Error(`invalid timeStep ${_}`);const d=mn(t).powerHP;if(console.log("[RSACLASSIC] start",{raceLenFt:c,hpPts:d.length}),!Array.isArray(d)||d.length<2)throw new Error(`RSACLASSIC: powerHP invalid (len=${(d==null?void 0:d.length)??0})`);const g=(t==null?void 0:t.drivetrain)??{},u=(t==null?void 0:t.vehicle)??{},P=g.clutch??(t==null?void 0:t.clutch)??u.clutch,m=g.converter??(t==null?void 0:t.converter)??u.converter,p=!!P,R=!!m,E=p?Number(P.slipRPM??P.slipRpm):NaN,v=p?Number(P.launchRPM??P.launchRpm):NaN,y=R?Number(m.stallRPM??m.stallRpm):NaN,x=p?Number(P.slippageFactor??P.slipRatio??1.0025):1,T=R?Number(m.slippageFactor??m.slipRatio??1.05):1;if(!p&&!R)throw new Error("RSACLASSIC: drivetrain must specify clutch or converter");if(p&&!Number.isFinite(E))throw new Error("RSACLASSIC: clutch.slipRPM missing/invalid");if(R&&!Number.isFinite(y))throw new Error("RSACLASSIC: converter.stallRPM missing/invalid");const K=p?Number.isFinite(v)?v:E:y;console.log("[RPM-RESOLVED]",{isClutch:p,isConverter:R,slipRPM:E,launchRPM:v,stallRPM:y,rpmPin:K});const ue=(t==null?void 0:t.tuning)??{},We=Number.isFinite(ue.aeroCdScale)?ue.aeroCdScale:1,je=Number.isFinite(ue.drivelineEffOffset)?ue.drivelineEffOffset:0,{vehicle:M,env:B,raceLength:lt}=t,$=[],re=lt==="EIGHTH"?660:1320,Oe=M.cd,ve=M.frontalArea_ft2,ee=M.transEff,ie=M.finalDrive??M.rearGear,X=M.gearRatios,j=M.gearEff,le=M.shiftRPM;Oe||$.push("Missing vehicle.cd (drag coefficient) - required for VB6 parity"),ve||$.push("Missing vehicle.frontalArea_ft2 - required for VB6 parity"),(!X||X.length===0)&&$.push("Missing vehicle.gearRatios[] - required for VB6 parity"),(!le||le.length===0)&&$.push("Missing vehicle.shiftRPM[] - required for VB6 parity"),ie||$.push("Missing vehicle.finalDrive or vehicle.rearGear - required for VB6 parity"),B.barometerInHg===void 0&&$.push("Missing env.barometerInHg - required for VB6 air density"),B.temperatureF===void 0&&$.push("Missing env.temperatureF - required for VB6 air density"),B.humidityPct===void 0&&$.push("Missing env.humidityPct - required for VB6 air density"),B.elevation===void 0&&$.push("Missing env.elevation - required for VB6 air density");const Re=M.tireRolloutIn??null,Ye=M.tireDiaIn??null,ct=Math.PI;let b=(typeof Re=="number"&&Re>0?Re/ct:null)??Ye??0;(!b||b<=0)&&($.push("Tire diameter is undefined/invalid. Provide tireRolloutIn or tireDiaIn."),b=28);const he=M.rolloutIn;he||$.push("Missing vehicle.rolloutIn - required for VB6 parity");const ce=t.fuel,D=dn(ce),oe=Wr({barometer_inHg:B.barometerInHg??29.92,temperature_F:B.temperatureF??59,relHumidity_pct:B.humidityPct??50,elevation_ft:B.elevation??0,fuelSystem:D}).rho_slug_per_ft3,Tt=To(M.weightLb),Fe=(he??12)/12;let ne=null,I=0;const _e=30,Ze=.01,at=d.reduce((w,k)=>Math.max(w,k.hp),0),de=m?m.torqueMult??1.7:1,Ce=(M.rolloutIn??12)/12,ye=_n(Ce>0?Ce:1,at,de,M.weightLb);let ge=0,F=ye,i=xo(),se=0;const St=[];let ze=0,Ve=0,ae=0;const He=[];let et=!1,Be=0;const tt=[60,330,660,1e3,re];let be=0,me=0,pe=0,Xt=0,jt=0,Yt=0,Gt=0,Le=0,rt=1,Zt;i.rpm=K;const ft=t.fuel;let Rt=1,Ft=1,bt=0,ut=0,C=0,Me=0,U=0,G=0,J=0,q=0,Et=0,Y=0;if(P||m){const w=Jt(K,d,ee??.9),k=K>0?w*K/5252:0,Ne=k>0&&K>0?5252*k/K:0,De=(X??[1])[0]??1,Te=Ne*De*(ee??.9)*(ie??3.73)*(ee??.9)/(1.02*b/24);Y=(m?.96:.88)*Te/M.weightLb,Y<Se&&(Y=Se)}const At=6,zt=5;let N=K,O=0,$e=qr.NORMAL,Pe=0,ht=0;const Pr=w=>j&&j[w]!==void 0?Math.max(.9,Math.min(1,j[w])):ee??.9,wt=()=>{const w=g.overallEff??g.overallEfficiency??ee??.97;return Mn(w+je)},_t=w=>{const k=B.tractionIndex??3;return sn(w,k,1)};for(;;){I++,f(I,i.s_ft);const w=zo(b,M.tireWidthIn??17,i.v_fps,Y),k=w.radius_eff_ft,Ne=w.circumference_eff_ft,De=w.dia_eff_in;let xt=wo(i.v_fps,i.gearIdx,g),It=xt,Te=1,sr=0,oo=0,no=0;const Ge=Pr(i.gearIdx);r?Br(xt,d,Ge):Jt(xt,d,Ge);let kt=1;if(ft==="METHANOL"){const W=B.trackTempF;W!==void 0&&W<80&&i.t_s<.8&&(kt=1.025-.025*i.t_s/.8)}else if(ft==="NITRO"){if(i.t_s<.4)kt=.9;else if(i.t_s<1){const W=(i.t_s-.4)/.6;kt=.9+(1-.9)*W}}Rt=Math.min(Rt,kt),Ft=Math.max(Ft,kt);const Wt=(X??[1])[i.gearIdx]??1,Rr=_t(i.s_ft)*i.v_fps*60/Ne;I===1&&typeof console<"u"&&console.debug&&console.debug("[RPM-DEBUG]",{isClutch:p,isConverter:R,slipRPM:E,launchRPM:v,stallRPM:y,calculated_slipRPM:E,rpm_from_speed:xt});const ot=Rr*Wt*(ie??3.73);let Q=(p?x:T)*ot;const ns=i.gearIdx===0,ss=!0,Ot=p?E:y;(p||R)&&(ns||ss)&&Q<Ot&&(Q=Ot);const ir=Q===Ot&&ot<Ot,so=Ot;if(It=Q,r?Br(Q,d,Ge):Jt(Q,d,Ge),P)Te=Q>1?Math.max(0,Math.min(1,ot/Q)):0,rt=Math.min(rt,Te);else if(m){const W=m.torqueMult??2,V=Bo(ot,y,W,T,I);Te=V.coupling,sr=V.work,oo=V.slipRatio,no=V.zStall,jt+=V.work,Yt+=V.coupling,Gt+=V.slipRatio,Le++,rt=Math.min(rt,Te)}else It=xt;i.rpm=It;const vt=Ie(i.v_fps,0),io=B.windMph??0,is=B.windAngleDeg??0,Fr=io/fe,ls=is*Math.PI/180,cs=Math.sqrt(vt*vt+2*vt*Fr*Math.cos(ls)+Fr*Fr),as=M.bodyStyle===8,lr=en(ve??0,w.growth,b,M.tireWidthIn??17,as);let cr,dt,qt,ar;const br=io!==0?cs:vt;if(r){const W=S(br);cr=H.mul(W,W),dt=H.mul(H.mul(S(.5),S(oe)),cr),qt=H.mul(H.mul(H.mul(dt,S(Oe??0)),S(We)),S(lr)),ar=H.mul(H.mul(dt,S(M.liftCoeff??0)),S(lr))}else cr=br*br,dt=Ie(.5*oe*cr,0),qt=Ie(dt*(Oe??0)*We*lr,0),ar=Ie(dt*(M.liftCoeff??0)*lr,0);const Er=Ie(M.weightLb-ar,M.weightLb),gt=qt,fs=Er,us=M.rrCoeff??mr,hs=Vo(fs,vt,i.s_ft,k,us,.01),Ue=Ie(hs/k,0),_s=1,ds=B.tractionIndex??3,Ar=Ko(ds,_s),gs=I===1?0:Et,ms=M.wheelbaseIn??108,ps=b/2+3.75,Ms=M.staticFrontWeightLb??M.weightLb*.38,Vt=cn(M.weightLb,Ms,gs,ps,k*12,ms,gt+Ue,Er,1.03,wt()),Ct=Vt.rear_weight_lbf,Je=Uo({weight_lbf:M.weightLb,tireDia_in:b,tireWidth_in:M.tireWidthIn??17,dynamicRWT_lbf:Ct,tractionIndexAdj:Ar,tireGrowth:w.growth,dragForce_lbf:gt+Ue,bodyStyle:void 0}),Ee=Jo();if(I<=12&&typeof console<"u"&&console.log){const W=Or({weight_lbf:M.weightLb,tireDia_in:b,tireWidth_in:M.tireWidthIn??17,dynamicRWT_lbf:Ct,tractionIndexAdj:Ar,bodyStyle:void 0});console.log("[TRACTION]",{step:I,CAXI:+Ar.toFixed(4),AX:10.8,tireDia_in:+b.toFixed(2),tireWidth_in:+(M.tireWidthIn??17).toFixed(1),dynamicRWT_lbf:+Ct.toFixed(1),weightFactor:+(.92+.08*Math.pow(Ct/1900,2.15)).toFixed(4),CRTF:+W.toFixed(1),tireGrowth:+w.growth.toFixed(4),dragForce_lbf:+(gt+Ue).toFixed(2),AMin_ftps2:+Ee.toFixed(3),AMax_ftps2:+Je.toFixed(3),AMin_g:+(Ee/A).toFixed(4),AMax_g:+(Je/A).toFixed(4)})}let te,Ae;if(I<=At&&ot<zt){const W=Jt(K,d,Ge),V=R?m.torqueMult??2:1,z=Oo({engineTorque_lbft_atSlip:W,gearRatio:Wt,transEff:Ge,drivelineEff:wt(),finalDrive:ie??3.73,tireDia_in:b,tireSlip:_t(i.s_ft),dragForce_lbf:gt+Ue,vehicleWeight_lbf:M.weightLb,isAutoTrans:!!m,torqueMult:V});Ae=z.netThrust_lbf/M.weightLb*A;const st=Qo(z.Ags0_ftps2,Ae,Ee,Je);if(te=st.AGS,Ae=st.PQWT,I<=10&&typeof console<"u"&&console.debug){const it=z.Ags0_ftps2/A,Bt=Wt*(ie??3.73);console.debug("[STEP]",{step:I,phase:ir?"PINNED":"BOOTSTRAP",v_fps:i.v_fps.toFixed(6),EngRPM:It.toFixed(0),LockRPM:ot.toFixed(2),slipRPM:E.toFixed(0),lockThreshold:so.toFixed(0),rpmIsPinned:ir,clutchSlip:Te.toFixed(6),gear:i.gearIdx+1,GRxFD:Bt.toFixed(3),tireDia_eff_in:De.toFixed(2),tireGrowth:w.growth.toFixed(4),tireSlip:_t(i.s_ft).toFixed(4),RWTdyn_lbf:Ct.toFixed(1),RWTfront_lbf:Vt.front_weight_lbf.toFixed(1),wheelieBar_lbf:Vt.wheelie_bar_weight_lbf.toFixed(1),AGS_g:it.toFixed(4),AGS_ftps2:te.toFixed(4),AMin_ftps2:Ee.toFixed(4),AMax_ftps2:Je.toFixed(4),SLIP:st.SLIP})}}else{let W=r?Vr(Q,d):hr(Q,d);Pe>0&&(W=0,Pe=Math.max(0,Pe-F),Pe===0&&typeof console<"u"&&console.debug&&console.debug("[SHIFT_DWELL_END]",{step:I,t_s:i.t_s.toFixed(4),v_fps:i.v_fps.toFixed(2)}));const V=W,z=r?H.div(H.mul(H.add(S(gt),S(Ue)),S(i.v_fps)),S(550)):(gt+Ue)*i.v_fps/550;I<=12&&typeof console<"u"&&console.log&&console.log("[PRE_HP_CHAIN]",{step:I,EngRPM_out:+Q.toFixed(0),wheelRPM:+Rr.toFixed(2),ClutchSlip:+Te.toFixed(4),...m?{converterWork:+sr.toFixed(4)}:{},HPSave:+V.toFixed(1),DragHP:+z.toFixed(2),F_drag_lbf:+qt.toFixed(2),F_roll_lbf:+Ue.toFixed(2),v_fps:+i.v_fps.toFixed(2),tireSlip:+_t(i.s_ft).toFixed(4),currentGearEff:+Ge.toFixed(4),drivelineEff:+wt().toFixed(4),dt_s:+F.toFixed(4),RPM0:+N.toFixed(0),DSRPM0:+O.toFixed(2)});const st=jo(_t(i.s_ft),i.v_fps,Ne);let it,Bt,fr;if(((Zr=M.pmi)==null?void 0:Zr.engine_flywheel_clutch)!==void 0)it=M.pmi.engine_flywheel_clutch,Bt=M.pmi.transmission_driveshaft??0,fr=M.pmi.tires_wheels_ringgear??0;else{it=500/120;const ke=(X==null?void 0:X.length)??5;Bt=p?ke*it/50:(ke-1)*it/10,fr=2*(1.15*.8*(.08*b*(M.tireWidthIn??17))*Math.pow(b/2,2)/386)}const ho=Xo(fr,Bt,ie??3.73,Wt),yt=Yo(N,Q,F,it,p),Ht=Zo(O,st,F,ho);I<=12&&typeof console<"u"&&console.log&&console.log("[PMI_CALC]",{step:I,EngRPM:+Q.toFixed(0),RPM0:+N.toFixed(0),RPM_delta:+(Q-N).toFixed(0),DSRPM:+st.toFixed(2),DSRPM0:+O.toFixed(2),DSRPM_delta:+(st-O).toFixed(2),enginePMI:+it.toFixed(3),chassisPMI:+ho.toFixed(3),HPEngPMI:+yt.toFixed(1),HPChasPMI:+Ht.toFixed(1)}),N=Q,O=st,U+=yt*550*F,G+=Ht*550*F;let Lt,Qe;const _o=_t(i.s_ft);if(r){Lt=H.mul(H.sub(S(V),S(yt)),S(Te)),Qe=Lt;const Nt=H.mul(H.mul(S(Qe),S(Ge)),S(wt())),ke=H.sub(Nt,S(Ht)),Ke=H.div(ke,S(_o));Qe=H.sub(Ke,S(z))}else Lt=(V-yt)*Te,Qe=Lt,Qe=(Qe*Ge*wt()-Ht)/_o-z;const xr=Qe;ze=V,Ve=xr,ae=z,Ae=r?H.div(H.mul(H.mul(S(550),S(A)),S(Qe)),S(M.weightLb)):550*A*Qe/M.weightLb;let ur=un(Ae,i.v_fps);if(F>0&&F<=.01&&I>1){const Nt=ur/A,ke=Y/A;let Ke=(Nt-ke)/F;if(Ke<pt){Ke=pt;const $t=ke+Ke*F;ur=$t*A,Ae=$t*A*i.v_fps}if(Ke>Mt){Ke=Mt;const $t=ke+Ke*F;ur=$t*A,Ae=$t*A*i.v_fps}}const Ir=fn(ur,Ee,Je);te=Ir.AGS_ftps2,Ae=Ae*Ir.PQWT_scale;const As=Ir.slip;te=pn(te,Ee,Je,Ee);const go=te/A;go>ge&&(ge=go);const mo=Y/A;if(mo>0&&I>1&&(F=hn(ye,ge,mo)),I<=12&&typeof console<"u"&&console.log&&console.log("[CONSOLIDATED_ROW]",{step:I,v_ftps:+i.v_fps.toFixed(3),EngRPM:+Q.toFixed(0),wheelRPM:+Rr.toFixed(2),ClutchSlip:+Te.toFixed(4),HPSave:+V.toFixed(1),HPEngPMI:+yt.toFixed(1),HPChasPMI:+Ht.toFixed(1),DragHP:+z.toFixed(2),HP_afterL1:+Lt.toFixed(1),HP_afterL2:+xr.toFixed(1),PQWT:+Ae.toFixed(1),AMin:+Ee.toFixed(3),AMax:+Je.toFixed(3),AGS_applied:+te.toFixed(3)}),I<=20&&typeof console<"u"&&console.log&&console.log("[AERO_TRACE]",{step:I,v_fps:+vt.toFixed(6),rho_slug_per_ft3:+oe.toFixed(6),q_psf:+dt.toFixed(3),F_drag_lbf:+qt.toFixed(2),F_lift_up_lbf:+ar.toFixed(2),normal_lbf:+Er.toFixed(2),F_roll_lbf:+Ue.toFixed(2),AMin_ftps2:+Ee.toFixed(3),AMax_ftps2:+Je.toFixed(3),AGS_ftps2:+te.toFixed(3)}),I<=10&&typeof console<"u"&&console.debug){const Nt=te/A,ke=Wt*(ie??3.73);console.debug("[STEP]",{step:I,phase:ir?"PINNED":"HP",v_fps:i.v_fps.toFixed(6),EngRPM:It.toFixed(0),LockRPM:ot.toFixed(2),slipRPM:E.toFixed(0),lockThreshold:so.toFixed(0),rpmIsPinned:ir,clutchSlip:Te.toFixed(6),gear:i.gearIdx+1,GRxFD:ke.toFixed(3),tireDia_eff_in:De.toFixed(2),tireGrowth:w.growth.toFixed(4),tireSlip:_t(i.s_ft).toFixed(4),RWTdyn_lbf:Ct.toFixed(1),RWTfront_lbf:Vt.front_weight_lbf.toFixed(1),wheelieBar_lbf:Vt.wheelie_bar_weight_lbf.toFixed(1),rho_slug_ft3:oe.toFixed(6),dragHP:z.toFixed(2),...m?{converterWork:sr.toFixed(4),converterSlipRatio:oo.toFixed(4),converterZStall:no.toFixed(0)}:{},HP_engine:V.toFixed(1),HPEngPMI:yt.toFixed(1),HPChasPMI:Ht.toFixed(1),HP_afterLine1:Lt.toFixed(1),HP_afterLine2:xr.toFixed(1),AGS_g:Nt.toFixed(4),AGS_ftps2:te.toFixed(4),AMin_ftps2:Ee.toFixed(4),AMax_ftps2:Je.toFixed(4),SLIP:As})}}Y=te;const lo=hr(Q,d);bt+=lo*550*F;const co=i.v_fps*F;ut+=gt*co,C+=Ue*co;const Ps=1-Ge,Ts=1-wt(),Ss=Ps+Ts;Me+=lo*550*F*Ss;const Rs=Ie(i.v_fps,0),Fs=Ie(i.s_ft,0),bs=Ie(te,Ee),ao=Ie(Ae,0),nt=an(Rs,Fs,F,ao);if(I<=12&&typeof console<"u"&&console.log&&console.log("[INTEGRATED]",{step:I,Vel_next:+nt.Vel_ftps.toFixed(3),Dist_next:+nt.Dist_ft.toFixed(6)}),!Number.isFinite(nt.Vel_ftps)||!Number.isFinite(nt.Dist_ft))throw new Error(`NaN in state @ step=${I} v=${nt.Vel_ftps} dist=${nt.Dist_ft} AGS=${bs} PQWT=${ao}`);if(i.v_fps=nt.Vel_ftps,i.s_ft=nt.Dist_ft,i.t_s=i.t_s+F,!Number.isFinite(i.v_fps)||!Number.isFinite(i.s_ft)||!Number.isFinite(te))throw new Error(`NaN in state @ step=${I} v=${i.v_fps} dist=${i.s_ft} AGS=${te}`);if(Et=te/A,i.s_ft>=re){ne="DISTANCE";break}if(i.t_s>=_e){ne="TIME_CAP";break}const fo=(X==null?void 0:X.length)??1,Es=(le??[])[i.gearIdx]??0,uo=r?nn(Q,Es,i.gearIdx,fo-1):tn(i.gearIdx,fo,Q,le??[]);let wr=!1;if(r)wr=uo;else{const W=rn($e,uo);$e=W.newState,wr=W.executeShift}if(wr){const W=i.gearIdx,V=Q;i.gearIdx++;const z=on(p);Pe=z,ht+=z,typeof console<"u"&&console.debug&&console.debug("[SHIFT]",{step:I,t_s:i.t_s.toFixed(4),v_fps:i.v_fps.toFixed(2),from_gear:W+1,to_gear:i.gearIdx+1,EngRPM_before:V.toFixed(0),LockRPM:ot.toFixed(0),dwell_s:z.toFixed(3)})}for(!et&&i.s_ft>=Fe&&(et=!0,Be=i.t_s),me===0&&i.s_ft>=594&&(me=i.t_s),pe===0&&i.s_ft>=1254&&(pe=i.t_s);be<tt.length&&i.s_ft>=tt[be];){const W=tt[be],V=et?i.t_s-Be:0,z=i.v_fps*fe;He.push({d_ft:W,t_s:V,v_mph:z}),be++}if(i.t_s>=se){const V=(i.v_fps-Xt)/F/Wo;St.push({t_s:i.t_s,v_mph:i.v_fps*fe,a_g:V,s_ft:i.s_ft,rpm:i.rpm,gear:i.gearIdx+1,hp:Ve>0?Ve:void 0,engineHp:ze>0?ze:void 0,dragHp:ae>0?ae:void 0}),se+=Ze,Xt=i.v_fps}}i.t_s>=_e&&$.push("max_time_exceeded");const er=et?i.t_s-Be:i.t_s,tr=i.v_fps*fe;let Tr,Sr;if(me>0&&i.t_s>me){const k=i.t_s-me;k>0&&(Tr=fe*66/k)}if(pe>0&&i.t_s>pe){const k=i.t_s-pe;k>0&&(Sr=fe*66/k)}J=.5*Tt*i.v_fps*i.v_fps,ne||(ne="SAFETY"),typeof console<"u"&&console.debug&&console.debug("[RSACLASSIC END]",{reason:ne,t_s:i.t_s,steps:I,d_ft:i.s_ft,target_ft:re,totalShiftDwell_s:ht.toFixed(3)}),typeof console<"u"&&console.warn&&ne!=="DISTANCE"&&console.warn("Terminated without crossing finish:",{reason:ne,t_s:i.t_s,d_ft:i.s_ft,target_ft:re}),(He.length===0||He[He.length-1].d_ft!==re)&&He.push({d_ft:re,t_s:er,v_mph:tr});const rr={};Tr!==void 0&&(rr.e660_mph=Tr),Sr!==void 0&&(rr.q1320_mph=Sr);{const w=bt,k=ut+C+Me+U+G,Ne=J+q,De=w-k-Ne;console.log(`
=== ENERGY SUMMARY: ${M.name??"Unknown"} ===`),console.log(`ET: ${er.toFixed(3)}s, Trap MPH: ${tr.toFixed(1)}`),console.log(`
Energy In:`),console.log(`  Engine:           ${(bt/1e3).toFixed(1)} k-ft-lb`),console.log(`
Energy Out:`),console.log(`  Aero Drag:        ${(ut/1e3).toFixed(1)} k-ft-lb (${(100*ut/w).toFixed(1)}%)`),console.log(`  Rolling Resist:   ${(C/1e3).toFixed(1)} k-ft-lb (${(100*C/w).toFixed(1)}%)`),console.log(`  Driveline Loss:   ${(Me/1e3).toFixed(1)} k-ft-lb (${(100*Me/w).toFixed(1)}%)`),console.log(`  Engine PMI:       ${(U/1e3).toFixed(1)} k-ft-lb (${(100*U/w).toFixed(1)}%)`),console.log(`  Chassis PMI:      ${(G/1e3).toFixed(1)} k-ft-lb (${(100*G/w).toFixed(1)}%)`),console.log(`  Total Losses:     ${(k/1e3).toFixed(1)} k-ft-lb (${(100*k/w).toFixed(1)}%)`),console.log(`
Final Kinetic Energy:`),console.log(`  Translational:    ${(J/1e3).toFixed(1)} k-ft-lb (${(100*J/w).toFixed(1)}%)`),console.log(`  Rotational:       ${(q/1e3).toFixed(1)} k-ft-lb (${(100*q/w).toFixed(1)}%)`),console.log(`  Total Kinetic:    ${(Ne/1e3).toFixed(1)} k-ft-lb (${(100*Ne/w).toFixed(1)}%)`),console.log(`
Energy Balance:     ${(De/1e3).toFixed(1)} k-ft-lb (${(100*De/w).toFixed(1)}% error)`),console.log(`===
`)}const Z={et_s:r?vr(er,3):er,mph:r?vr(tr,2):tr,timeslip:He,traces:St.length>0?St:void 0,meta:{model:"RSACLASSIC",steps:Math.floor(i.t_s/F),warnings:$,windowMPH:Object.keys(rr).length>0?rr:void 0,converter:m&&!P?{used:!0,avgTR:Le>0?jt/Le:1,avgETA:Le>0?Yt/Le:1,avgSR:Le>0?Gt/Le:1,deRateMax:.3,parasiticConst:.05,parasiticQuad:1e-6}:void 0,clutch:P?{used:!0,minC:rt,lockupAt_ft:Zt}:void 0,rollout:{rolloutIn:he??12,t_roll_s:Be},fuel:ft?{type:ft,minScale:Rt,maxScale:Ft}:void 0,vb6:{dt_s:F,trapMode:"time",windowsFt:{eighth:{start:594,end:660,distance:66},quarter:{start:1254,end:1320,distance:66}},timeslipPoints:[60,330,660,1e3,1320],rolloutBehavior:"ET clock starts after rollout distance (TIMESLIP.FRM:1380)"},termination:{reason:ne,steps:I,t_s:i.t_s,target_ft:re}}};return console.log("[RSACLASSIC] done",{et_s:+(((zr=(or=Z==null?void 0:Z.et_s)==null?void 0:or.toFixed)==null?void 0:zr.call(or,4))??(Z==null?void 0:Z.et_s)),mph:+(((eo=(nr=Z==null?void 0:Z.mph)==null?void 0:nr.toFixed)==null?void 0:eo.call(nr,1))??(Z==null?void 0:Z.mph)),steps:((ro=(to=Z==null?void 0:Z.meta)==null?void 0:to.termination)==null?void 0:ro.steps)??I,wallMs:Date.now()-o}),Z}}const $r=new Pn;function pr(e,t,r,o,s){let n=0;for(n=0;n<r-1&&!(s<=e[n+1]);n++);n>=r-1&&(n=r-2),n<0&&(n=0);const l=e[n],a=e[n+1],f=t[n],c=t[n+1];if(a===l)return f;const _=(s-l)/(a-l);return f+_*(c-f)}function Ur(e,t,r,o,s){let n,l;if(s)n=1+4e-5*r,l=n*e*Xe/12;else{const a=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));n=1+a*135e-7*Math.pow(r,1.6);const f=1+a*35e-5*r;f<n&&(n=f),l=(n-.035*Math.abs(o))*e*Xe/12}return{TireGrowth:n,TireCirFt:l}}function Jr(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function Qr(e){return e?yo:Go}function Tn(e,t){if(!(t!=null&&t.enabled))return 1;const{activateTime_s:r,duration_s:o,throttlePct:s,rampTime_s:n=0}=t,l=r+o;if(e<r||e>=l)return 1;const a=s/100;if(n>0&&e<r+n){const f=(e-r)/n;return 1-(1-a)*f}if(n>0&&e>l-n){const f=(l-e)/n;return 1-(1-a)*f}return a}function Sn(e,t,r,o,s){const n=e.Gear;let l;const a=e.Gear!==e.PrevGear;if(a)l=t.DTShift,e.PrevGear=e.Gear;else{if(l=o,e.Ags0_g>0&&e.L>1){const F=Math.min(e.AgsMax_g/e.Ags0_g,10);l=o*Math.pow(F,4)}l>.1&&(l=.1)}let f=0;const c=e.time_s-e.Time0_s;c>0&&(f=(e.AGS_g-e.Ags0_g)/c),f<pt&&(f=pt),f>Mt&&(f=Mt),e.Vel0_ftps=e.Vel_ftps,e.Ags0_g=e.AGS_g,e.Time0_s=e.time_s,e.Dist0_ft=e.Dist_ft,e.RPM0=e.EngRPM,e.DSRPM0=e.DSRPM,e.RPM0===t.LaunchRPM&&e.Time0_s===0&&(e.RPM0=t.Stall,t.LaunchRPM<t.Stall&&(e.Time0_s=t.EnginePMI*(t.Stall-t.LaunchRPM)/25e4));const _=Ur(t.TireDia_in,t.TireWidth_in,e.Vel_ftps,e.Ags0_g,r.isLandSpeed);e.TireGrowth=_.TireGrowth,e.TireCirFt=_.TireCirFt;let h;r.isLandSpeed?h=1.01+(r.TractionIndex-1)*.01:h=1.02+(.005*(r.TractionIndex-1)+3*(r.TrackTempEffect-1))*(1-Math.pow(e.Dist0_ft/1320,2));const d=t.TGR[n-1]??1,g=t.TiresPMI+t.TransPMI*Math.pow(t.GearRatio,2)*Math.pow(d,2);let u=e.Vel0_ftps+e.Ags0_g*A*l+f*A*l*l/2;u<e.Vel0_ftps*.9&&e.Vel0_ftps>100&&(u=e.Vel0_ftps),u<0&&(u=0);const P=t.ShiftRPM[n-1]??9e3;if(!a&&(l<.005&&(l=.005),l>.05&&(l=.05),u=e.Vel0_ftps+e.Ags0_g*A*l+f*A*l*l/2,e.Vel0_ftps>0&&e.RPM0>t.Stall&&n<t.NGR)){const F=e.Vel0_ftps*(P+5)/e.RPM0;u>F&&(u=F,e.Ags0_g*A>0&&(l=(u-e.Vel0_ftps)/(e.Ags0_g*A)))}const m=u*u-e.Vel0_ftps*e.Vel0_ftps,p=h*u*60/e.TireCirFt,R=p*t.GearRatio*d;let E=t.Slippage*R,v,y=t.Stall,x=0;t.isClutch?(E<t.Stall&&(n===1||!t.LockUp)&&(E=t.Stall),v=R/E):n===1||!t.LockUp?(y=t.Stall,x=t.Slippage*R/y,e.L>2&&(x>.6&&(y=y*(1+(t.Slippage-1)*(x-.6)/(1/t.Slippage-.6))),x=t.Slippage*R/y),v=1/t.Slippage,E<y&&(E=y,v=(t.TorqueMult-(t.TorqueMult-1)*x)*R/y)):(E=1.005*R,v=R/E),v>1&&(v=1);let T=pr(t.xrpm,t.yhp,t.NHP,1,E);T=t.HPTQMult*T/r.hpc,t.RevLimiterRPM>0&&E>=t.RevLimiterRPM&&(T=T*.05);const K=Tn(e.time_s,s);T=T*K;const ue=T;T=T*v;const We=Math.sqrt(u*u+2*u*(r.WindSpeed_mph/Qt)*Math.cos(Xe*r.WindAngle_deg/180)+Math.pow(r.WindSpeed_mph/Qt,2)),je=Math.sign(We)*r.rho*Math.pow(Math.abs(We),2)/(2*A);let M;t.BodyStyle===8?M=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*t.TireWidth_in/144:M=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*(2*t.TireWidth_in)/144;const B=t.Weight_lbf+t.LiftCoef*M*je,lt=r.isLandSpeed?Lr:mr,$=r.isLandSpeed?Co:vo,re=r.isLandSpeed?Ho:Do,ve=(lt-e.Dist0_ft/1320*$)*B+1e-4*B*(Qt*u)+t.DragCoef*M*je,ee=ve*u/550,ie=12*e.TireCirFt/(2*Xe),X=(e.Ags0_g*t.Weight_lbf*(t.YCG_in-ie+re/t.Efficiency*ie)+ve*t.YCG_in)/t.Wheelbase_in;let j=t.StaticFWt_lbf-X,le=0;j<0&&(le=-j*t.Wheelbase_in/64,j=0);let Re=B-j-le;Re<0&&(Re=t.Weight_lbf);const Ye=Jr(r.TractionIndex,r.TrackTempEffect),ct=Qr(r.isLandSpeed);let qe=Ye*ct*t.TireDia_in*(t.TireWidth_in+1)*(.92+.08*Math.pow(Re/1900,2.15));t.BodyStyle===8&&(qe=.5*qe);const b=(qe/e.TireGrowth-ve)/t.Weight_lbf,he=t.TGEff[n-1]??.99;T=T*he*t.Efficiency/h;const ce=T;T=T-ee;let D=550*A*T/t.Weight_lbf,L=D/(u*A),oe=!1;L>b&&(oe=!0,D=D*(b-(L-b))/L,L=b-(L-b)),L<Se&&(L=Se,D=Se*A*u);let Fe=Math.max(0,m)/(2*D)+e.Time0_s;const ne=r.isLandSpeed?Lo:Gr,I=r.isLandSpeed?No:kr;let _e=t.EnginePMI*E*(E-e.RPM0);_e<0&&(t.isClutch?_e=ne*_e:_e=I*_e);let Ze=g*p*(p-e.DSRPM0);Ze<0&&(Ze=0);let at=0,de=0,Ce=0;for(Ce=1;Ce<=12;Ce++){const F=Fe-e.Time0_s;if(F<=0)break;const i=Math.pow(2*Xe/60,2)/(12*550*F);at=_e*i,de=Ze*i,T=(ue-at)*v,T=(T*he*t.Efficiency-de)/h-ee,D=550*A*T/t.Weight_lbf,L=D/(u*A);let se=0;F!==0&&(se=(L-e.Ags0_g)/F),se<pt&&(se=pt,L=e.Ags0_g+se*F,D=L*A*u),se>Mt&&(se=Mt,L=e.Ags0_g+se*F,D=L*A*u),oe=!1,L>b&&(oe=!0,D=D*(b-(L-b))/L,L=b-(L-b)),L<Se&&(L=Se,D=Se*A*u);const ze=Math.max(0,m)/(2*D)+e.Time0_s,Ve=ze-e.Time0_s;if(Ce===12||Math.abs(100*(Ve-F)/Ve)<=.01){Fe=ze;break}let ae=T/ue;ae<Nr&&(ae=Nr),ae>Dr&&(ae=Dr),Fe=e.Time0_s+F+ae*(Ve-F)}const ye=Fe-e.Time0_s;let ge;if(D<.1||ye<=0){const F=(e.Vel0_ftps+u)/2;ge=e.Dist0_ft+Math.max(0,F*Math.abs(ye))}else{const F=Math.pow(e.Vel0_ftps,3),i=2*D*ye+e.Vel0_ftps*e.Vel0_ftps;if(i<0){const se=(e.Vel0_ftps+u)/2;ge=e.Dist0_ft+se*ye}else ge=(Math.pow(i,1.5)-F)/(3*D)+e.Dist0_ft}return e.L+=1,e.time_s=Fe,e.Vel_ftps=u,e.Dist_ft=ge,e.AGS_g=L,e.EngRPM=E,e.DSRPM=p,e.SLIP=oe,{TimeStep_s:l,VelSqrd:m,LockRPM:R,ClutchSlip:v,zStall:y,SlipRatio:x,TireSlip:h,WindFPS:We,q:je,RefArea2_ft2:M,DownForce_lbf:B,DragForce_lbf:ve,DragHP:ee,DynamicFWT_lbf:j,DynamicRWT_lbf:Re,WheelBarWT_lbf:le,CRTF:qe,AMax_g:b,ChassisPMI:g,EngAccHP:_e,ChasAccHP:Ze,HPSave:ue,HPAtWheels:ce,HP:T,PQWT:D,iterations:Ce}}function Rn(e,t,r){const o=Ur(e.TireDia_in,e.TireWidth_in,0,0,t.isLandSpeed),s=pr(e.xrpm,e.yhp,e.NHP,1,r);let a=5252*(e.HPTQMult*s/t.hpc)/r;const f=e.TGR[0]??1,c=e.TGEff[0]??.99;a=a*e.TorqueMult*f*c;const _=t.isLandSpeed?Lr:mr,h=t.WindSpeed_mph/Qt,d=Math.sign(h)*t.rho*Math.pow(Math.abs(h),2)/(2*A),g=_*e.Weight_lbf+e.DragCoef*e.RefArea_ft2*d;let u;t.isLandSpeed?u=1.01+(t.TractionIndex-1)*.01:u=1.02+(t.TractionIndex-1)*.005+(t.TrackTempEffect-1)*3;const P=a*e.GearRatio*e.Efficiency/(u*e.TireDia_in/24)-g;let p=(e.isClutch?.88:.96)*P/e.Weight_lbf;const E=e.Weight_lbf-e.StaticFWt_lbf,v=Jr(t.TractionIndex,t.TrackTempEffect),y=Qr(t.isLandSpeed);let x=v*y*e.TireDia_in*(e.TireWidth_in+1)*(.92+.08*Math.pow(E/1900,2.15));e.BodyStyle===8&&(x=.5*x);const T=(x-g)/e.Weight_lbf;return p>T&&(p=T),p<Se&&(p=Se),{L:1,time_s:0,Vel_ftps:.001,Dist_ft:0,AGS_g:p,EngRPM:r,DSRPM:0,Gear:1,SLIP:!1,Vel0_ftps:0,Ags0_g:p,Time0_s:0,Dist0_ft:0,RPM0:r,DSRPM0:0,AgsMax_g:p,TireGrowth:o.TireGrowth,TireCirFt:o.TireCirFt,ShiftFlag:0,PrevGear:1}}function Fn(e,t,r,o){let s=e*.11*Math.pow(t*r/o,-.3333333333333333);return s=s/15,s<.005&&(s=.005),s}function Kr(e,t,r){let o=0,s=0,n=r-1;const l=e[0],a=e[r-1];if(t<=l)return o=1,n=1,{KBOTM:s,KTOP:n,JJ:o};if(t>=a)return o=1,s=r-2,n=r-1,{KBOTM:s,KTOP:n,JJ:o};for(;n-s>1;){const f=Math.floor((s+n)/2);t<e[f]?n=f:s=f}return{KBOTM:s,KTOP:n,JJ:o}}function Mr(e,t,r,o,s){if(r<=0)return 0;if(r===1)return t[0];let n=0,l=1;if(r===2)n=0,l=1;else{const f=Kr(e,s,r);n=f.KBOTM,l=f.KTOP;const c=f.JJ;if(n===l)return t[n];c!==1&&o>1&&(l=l+1,(o>=3||l>r-1)&&(l>r-1&&(l=r-1),n=n-1,n<0&&(n=0)))}let a=0;for(let f=n;f<=l;f++){let c=1;const _=e[f];for(let h=n;h<=l;h++)if(h===f)c=c*t[f];else{const d=e[h];c=c*(s-d)/(_-d)}a=a+c}return a}function bn(e,t,r,o,s,n,l,a,f){const c=Kr(t,f,s);let _=c.KBOTM,h=c.KTOP;c.JJ;const d=[],g=[];for(let m=_;m<=h;m++){const p=[];for(let E=0;E<o;E++)p.push(r[m*o+E]);const R=Mr(e,p,o,n,a);d.push(R),g.push(t[m])}const u=h-_+1,P=Math.min(l,u);return Mr(g,d,u,P,f)}function En(e){switch(e){case 1:case 2:return 1;case 3:case 4:return 1.08;case 5:return 5;case 6:return 2*1;case 7:case 9:return 2.5*1.08;case 8:return 1.5*5.5;default:return 1}}function An(e){return e<=5}const wn=[.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],xn=[.7,1.2,1.7,2.5,3.4],In=[.53,.975,1.098,1.13,1.152,1.16,1.153,1.122,1.086,1.045,1,.938,.865,.795,.72,.63,.365,.87,1.018,1.066,1.11,1.129,1.132,1.11,1.079,1.042,1,.935,.855,.762,.66,.54,.24,.79,.96,1.023,1.08,1.106,1.117,1.102,1.074,1.04,1,.932,.845,.736,.612,.474,.1,.7,.894,.972,1.04,1.08,1.096,1.09,1.069,1.037,1,.928,.83,.698,.55,.39,0,.63,.84,.924,1,1.055,1.079,1.082,1.064,1.035,1,.923,.815,.662,.49,.31],Xr=[0,.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],Pt=[0,.7,1.2,1.7,2.5,3.4],vn=[0,0,.61,.8,.9,.98,1.035,1.055,1.06,1.05,1.03,1,.93,.85,.765,.67,.58];function Cn(e,t){return bn(wn,xn,In,16,5,1,1,e,t)}function yn(e){const{peakHP:t,peakRPM:r,displacement_cid:o,fuelSystem:s}=e,n=_r*t/r,l=En(s);let a=t/o/l;s<=5?a<Pt[1]&&(a=Pt[1]):a<Pt[2]&&(a=Pt[2]),a>Pt[5]&&(a=Pt[5]);const f=[0],c=[0],_=[0],h=16;for(let d=1;d<=h;d++){f[d]=Xr[d]*r;let g;s===8?g=vn[d]*n:g=Cn(Xr[d],a)*n,c[d]=f[d]*g/_r,_[d]=g}return{xrpm:f,yhp:c,ztq:_,NHP:h}}function Hn(e){const t=[],r=[];for(let o=1;o<=e.NHP;o++)t.push(e.xrpm[o]),r.push(e.yhp[o]);return{rpm:t,hp:r}}function Ln(e){return e>800?1:8}function Nn(e){switch(e){case 1:return{dragCoef:.66,liftCoef:.8,overhang_in:30};case 2:return{dragCoef:.5,liftCoef:.2,overhang_in:30};case 3:return{dragCoef:.52,liftCoef:.8,overhang_in:40};case 4:return{dragCoef:.52,liftCoef:.1,overhang_in:30};case 5:return{dragCoef:.28,liftCoef:.1,overhang_in:30};case 6:return{dragCoef:.4,liftCoef:.1,overhang_in:24};case 7:return{dragCoef:.46,liftCoef:.1,overhang_in:18};case 8:return{dragCoef:.54,liftCoef:.1,overhang_in:12};default:return{dragCoef:.5,liftCoef:.2,overhang_in:30}}}function Dn(e,t){const r=[];if(t){const o=e>=3?.985:.99;for(let s=1;s<=e;s++)r.push(o-(e-s)*2*.005)}else for(let s=1;s<=e;s++)r.push(.99-(e-s)*.005);return r}function Gn(e,t,r,o,s,n,l){let a,f,c;return An(t)?a=e/120:a=e/90,r?f=(o-1)*a/10:f=o*a/50,c=2*(1.15*.8*(.08*s*n)*Math.pow(s/2,2)/386),l===8&&(a=e/240,f=f/(240/120),c=c/2),{enginePMI:a,transPMI:f,tiresPMI:c}}function kn(e){return e===8?.985:.97}function Wn(e){return 1.0025+e/1e6}function On(e){const t=xe[e];return t?t.lengthFt:e==="EIGHTH"?660:1320}function qn(e){const t=we[e];return t||(e==="EIGHTH"?we.EIGHTH:we.QUARTER)}function Vn(e){if(!e)return 1;const t=e.toUpperCase();return t==="GASOLINE"?1:t==="GASOLINE EFI"?2:t==="METHANOL"?3:t==="METHANOL EFI"?4:t==="NITROMETHANE"?5:t==="SUPERCHARGED GASOLINE"?6:t==="SUPERCHARGED METHANOL"?7:t==="SUPERCHARGED NITRO"?8:t==="E85"||t==="DIESEL"||t==="GAS+CARB"||t==="GASOLINE+CARBURETOR"?1:t==="GAS+INJECT"||t==="GASOLINE+FUEL INJECTION"?2:t==="METHANOL+CARB"||t==="METHANOL+CARBURETOR"?3:t==="METHANOL+INJECT"||t==="METHANOL+FUEL INJECTION"?4:t==="NITRO+INJECT"||t==="NITROMETHANE+FUEL INJECTION"?5:t==="GAS+SUPERCHARGED"||t==="GASOLINE+SUPERCHARGED"?6:t==="METHANOL+SUPERCHARGED"?7:t==="NITRO+SUPERCHARGED"||t==="NITROMETHANE+SUPERCHARGED"?8:t==="ELECTRIC"?9:t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function Bn(e){var _,h,d,g;const t=e.vehicle,r=e.engine??t.engine,o=(r==null?void 0:r.hpCurve)??(r==null?void 0:r.torqueCurve)??t.torqueCurve??t.hpCurve??[];console.log("[VB6Exact] extractHPCurve sources:",{"engine?.hpCurve":(_=r==null?void 0:r.hpCurve)==null?void 0:_.length,"engine?.torqueCurve":(h=r==null?void 0:r.torqueCurve)==null?void 0:h.length,"vehicle.torqueCurve":(d=t.torqueCurve)==null?void 0:d.length,"vehicle.hpCurve":(g=t.hpCurve)==null?void 0:g.length,"resolved hpCurve length":o.length,"first 2 points":o.slice(0,2)});const s=[],n=[];for(const u of o)Array.isArray(u)?(s.push(u[0]),n.push(u[1])):u&&typeof u=="object"&&(s.push(u.rpm),u.hp!==void 0?n.push(u.hp):u.torque!==void 0?n.push(u.torque*u.rpm/5252):u.tq_lbft!==void 0&&n.push(u.tq_lbft*u.rpm/5252));if(s.length>=2)return console.log("[VB6Exact] Using QuarterPro HP curve:",{NHP:s.length,rpmRange:`${Math.min(...s)} - ${Math.max(...s)}`,hpRange:`${Math.min(...n)} - ${Math.max(...n)}`,peakHP:Math.max(...n),curve:s.map((u,P)=>`${u}:${n[P]}`).join(", ")}),{xrpm:s,yhp:n,NHP:s.length,isQuarterJr:!1};const l=Number(t.powerHP??t.peakHP),a=Number(t.rpmAtPeakHP??t.peakRPM??6500),f=Number(t.displacement_cid??t.displacementCID??350),c=e.fuelSystem??t.fuelSystem??1;if(Number.isFinite(l)&&l>0){const u=yn({peakHP:l,peakRPM:a,displacement_cid:f,fuelSystem:c}),{rpm:P,hp:m}=Hn(u);return{xrpm:P,yhp:m,NHP:u.NHP,isQuarterJr:!0,quarterJrParams:{peakHP:l,rpmAtPeakHP:a,displacement_cid:f,fuelSystem:c}}}return{xrpm:[4e3,6500],yhp:[100,150],NHP:2,isQuarterJr:!1}}function $n(e){const t=Math.abs(100-e);let r;return e>100?r=1+25e-7*Math.pow(t,2.5):r=1+2e-6*Math.pow(t,2.5),r>1.04&&(r=1.04),r}function Un(e){var Gt,Le,rt,Zt,ft,Rt,Ft,bt,ut;const t=[],r=[],o=e.vehicle,s=e.env,n=e.raceLength??"QUARTER",l=e.raceLengthFt??On(n),a=((Gt=xe[n])==null?void 0:Gt.category)==="landspeed",f=o.rolloutIn??9,c=o.overhangIn??0;let _=2*f;_<24&&(_=24);let h=(c+.25*_)/12;const d=.5*_/12;h<d&&(h=d);const g=f/12,u=e.drivetrain??o.drivetrain,P=(u==null?void 0:u.clutch)??e.clutch??o.clutch,m=(u==null?void 0:u.converter)??e.converter??o.converter,p=e.engine??o.engine,R=e.pmi??o.pmi,E=e.throttleStop,v=E!=null&&E.enabled?{enabled:!0,activateTime_s:E.activateTime_s,duration_s:E.duration_s,throttlePct:E.throttlePct,rampTime_s:E.rampTime_s}:void 0,y=o.transmissionType??e.transmissionType,x=y==="clutch"?!0:y==="converter"?!1:!m||P&&!m,T=e.fuel,K=typeof T=="string"?T:(T==null?void 0:T.fuelType)??(T==null?void 0:T.fuelSystem)??(T==null?void 0:T.type)??e.fuelType??o.fuelType??e.fuelSystem??o.fuelSystem,ue=Vn(K);console.log("[VB6Exact] Fuel system detection:",{rawFuel:T,fuelString:K,fuelSystemType:ue,"vehicle.fuelType":o.fuelType,"vehicle.fuelSystem":o.fuelSystem});const We=Wr({barometer_inHg:s.barometerInHg??29.92,temperature_F:s.temperatureF??59,relHumidity_pct:s.humidityPct??50,elevation_ft:s.elevation??0,fuelSystem:ue}),je=We.rho_slug_per_ft3*A,M=We.hpc;console.log("[VB6Exact] Air/HPC calculation:",{rho_lbm_ft3:je.toFixed(4),hpc:M.toFixed(4),fuelSystemType:ue});const B=Bn(e),{xrpm:lt,yhp:$,NHP:re,isQuarterJr:Oe,quarterJrParams:ve}=B;re<2&&t.push("HP curve has fewer than 2 points"),Oe&&t.push("Using QuarterJr mode (synthetic HP curve from peak HP)");const ee=(u==null?void 0:u.gearRatios)??o.gearRatios??[2.5,1.8,1.4,1.1,1],ie=(u==null?void 0:u.finalDriveRatio)??o.finalDrive??o.rearGear??3.73,X=ee.length,j=o.tire,le=(j==null?void 0:j.diameter_in)??o.tireDiaIn??32,Re=(j==null?void 0:j.width_in)??o.tireWidthIn??17,Ye=o.bodyStyle??Ln(o.weightLb);let ct,qe,b,he,ce,D,L,oe,Tt,Fe,ne,I;if(Oe&&ve){const{displacement_cid:C,fuelSystem:Me}=ve;ct=Dn(X,!x);const U=o.shiftRPM??(u==null?void 0:u.shiftRPM)??7e3;qe=ee.map(()=>U);const G=(P==null?void 0:P.slipRPM)??(m==null?void 0:m.stallRPM)??o.slipStallRPM??5e3;if(x)he=Wn(G),ce=1,b=G;else{const Et=(m==null?void 0:m.diameter_in)??(m==null?void 0:m.diameter)??o.converterDiameterIn??o.converterDia_in??10;let Y;if(G>220){b=G;const N=Mr(lt,$,re,1,b)*(_r/b)/M;Y=b/1e3*(b/N)}else Y=G,b=G;const At=Y/(200*Math.pow(7/Et,4));he=1.01+At/20+Y/8e3,ce=2.633-Math.pow(At,.3)-Y/1500,ce<1&&(ce=1),ce>2&&(ce=2)}Tt=kn(Ye);const J=Nn(Ye);Fe=J.dragCoef,ne=J.liftCoef,I=J.overhang_in;const q=Gn(C,Me,!x,X,le,Re,Ye);D=q.enginePMI,L=q.transPMI,oe=q.tiresPMI}else{ct=(u==null?void 0:u.perGearEff)??o.gearEfficiencies??null??ee.map(()=>.99),qe=(u==null?void 0:u.shiftRPMs)??(u==null?void 0:u.shiftsRPM)??o.shiftRPMs??ee.map(()=>7e3);const Me=(P==null?void 0:P.slipRPM)??o.clutchSlipRPM??7200,U=(m==null?void 0:m.stallRPM)??o.converterStallRPM??5500;b=x?Me:U;const G=(P==null?void 0:P.slippageFactor)??(P==null?void 0:P.slippage)??o.clutchSlippage??1.0025,J=(m==null?void 0:m.slippageFactor)??(m==null?void 0:m.slippage)??o.converterSlippage??1.06;he=x?G:J,ce=x?1:(m==null?void 0:m.torqueMult)??(m==null?void 0:m.torqueMultiplier)??o.converterTorqueMult??2.2,D=(R==null?void 0:R.engine_flywheel_clutch)??o.enginePMI??(p==null?void 0:p.enginePMI)??4,oe=(R==null?void 0:R.tires_wheels_ringgear)??o.tiresPMI??(p==null?void 0:p.tiresPMI)??.5,L=(R==null?void 0:R.transmission_driveshaft)??o.transPMI??(p==null?void 0:p.transPMI)??.2,Tt=(u==null?void 0:u.overallEfficiency)??o.transEfficiency??.97;const q=e.aero??o.aero;Fe=(q==null?void 0:q.Cd)??(q==null?void 0:q.cd)??o.cd??.35,ne=(q==null?void 0:q.Cl)??(q==null?void 0:q.cl)??o.liftCoeff??0,I=c}const _e=o.cgHeight_in??o.cgHeightIn??le/2+3.75,Ze=o.staticFrontWeight_lb??o.staticFrontWeightLb??o.weightLb*.38,at=Oe?I:c,de={Weight_lbf:o.weightLb,Wheelbase_in:o.wheelbaseIn??100,YCG_in:_e,StaticFWt_lbf:Ze,TireDia_in:le,TireWidth_in:Re,Rollout_in:o.rolloutIn??12,GearRatio:ie,TGR:ee,TGEff:ct,Efficiency:Tt,DTShift:x?.2:.25,Slippage:he,TorqueMult:ce,Stall:b,LockUp:(m==null?void 0:m.lockup)??!1,isClutch:x,RefArea_ft2:((Le=e.aero)==null?void 0:Le.frontalArea_ft2)??o.frontalArea_ft2??o.frontalAreaFt2??20,DragCoef:Fe,LiftCoef:ne,BodyStyle:Ye,EnginePMI:D,TiresPMI:oe,TransPMI:L,xrpm:lt,yhp:$,NHP:re,HPTQMult:o.hpTorqueMultiplier??(p==null?void 0:p.hpTqMult)??1,ShiftRPM:qe,NGR:X,LaunchRPM:x?(P==null?void 0:P.launchRPM)??o.clutchLaunchRPM??b:b,ShiftMode:o.shiftMode??"rpm",ShiftTimes:o.shiftTimes??[],RevLimiterRPM:o.revLimiterRPM??0};if(Oe&&at!==c){let C=2*f;C<24&&(C=24),h=(at+.25*C)/12;const Me=.5*C/12;h<Me&&(h=Me)}const Ce=s.trackTempF??100,ye=a?1:$n(Ce),ge={rho:je,hpc:M,TractionIndex:s.tractionIndex??5,TrackTempEffect:ye,WindSpeed_mph:s.windMph??0,WindAngle_deg:s.windAngleDeg??0,isLandSpeed:a};console.log("[VB6Exact] Simulation parameters:",{weight:o.weightLb,tireDia:le,wheelbase:o.wheelbaseIn,finalDrive:ie,NGR:X,peakHP:Math.max(...$),stallRPM:b,slippage:he,isClutch:x,tractionIndex:ge.TractionIndex,trackTempEffect:ye,pmi:{engine:D,trans:L,tires:oe}});const F=x?(P==null?void 0:P.launchRPM)??b:b,i=Rn(de,ge,F),se=pr(lt,$,re,1,F),St=Fn(60,se,ce,o.weightLb),ze=a?5e4:5e3,Ve=a?300:30,ae={iterations:[],convergenceHistory:[]},He=[],et=qn(n);let Be=0,tt=null,be=null,me=null;for(let C=0;C<ze&&!(i.Dist_ft-g+h>=l+50||i.time_s>=Ve);C++){if(!Number.isFinite(i.Vel_ftps)||!Number.isFinite(i.Dist_ft)||!Number.isFinite(i.AGS_g)){t.push(`NaN detected at step ${C}: Vel=${i.Vel_ftps}, Dist=${i.Dist_ft}, AGS=${i.AGS_g}`);break}const U=Sn(i,de,ge,St,v);if(ae.iterations.push(U.iterations),C<20&&ae.convergenceHistory.push({step:C,iterations:U.iterations,HPSave:U.HPSave,HP:U.HP,PQWT:U.PQWT,AGS_g:i.AGS_g}),tt===null&&i.Dist_ft>=g){const O=(i.Dist_ft-g)/i.Vel_ftps;tt=i.time_s-O}const G=Math.max(0,i.Dist_ft-g+h),J=tt!==null?i.time_s-tt:0,q=de.TGR[i.Gear-1]??1,Et=(U.LockRPM??i.EngRPM)/q,Y=U.TireSlip,At=i.Vel_ftps*Y*fe,zt=(v==null?void 0:v.enabled)&&J>=v.activateTime_s&&J<v.activateTime_s+v.duration_s;if(r.push({t_s:J,s_ft:G,v_fps:i.Vel_ftps,v_mph:i.Vel_ftps*fe,a_g:i.AGS_g,rpm:i.EngRPM,dsrpm:Et,lockRpm:U.LockRPM,gear:i.Gear,slip:i.SLIP,tireSlip:Y,hp:U.HPAtWheels,dragHp:U.DragHP,netHp:U.HP,wheelSpeed_mph:At,throttleStopActive:zt}),be===null&&G>=594){const N=r.length>1?((rt=r[r.length-2])==null?void 0:rt.s_ft)??0:0,O=r.length>1?((Zt=r[r.length-2])==null?void 0:Zt.t_s)??0:0;if(N<594&&G>N){const $e=(594-N)/(G-N);be=O+$e*(J-O)}else be=J}if(me===null&&G>=1254){const N=r.length>1?((ft=r[r.length-2])==null?void 0:ft.s_ft)??0:0,O=r.length>1?((Rt=r[r.length-2])==null?void 0:Rt.t_s)??0:0;if(N<1254&&G>N){const $e=(1254-N)/(G-N);me=O+$e*(J-O)}else me=J}for(;Be<et.length&&G>=et[Be];){const N=et[Be],O=r.length>1?((Ft=r[r.length-2])==null?void 0:Ft.s_ft)??0:0,$e=r.length>1?((bt=r[r.length-2])==null?void 0:bt.t_s)??0:0;let Pe=J;if(O<N&&G>O){const Pr=(N-O)/(G-O);Pe=$e+Pr*(J-$e)}let ht;N===660&&be!==null&&Pe>be?ht=fe*66/(Pe-be):N===1320&&me!==null&&Pe>me?ht=fe*66/(Pe-me):ht=i.Vel_ftps*fe,He.push({d_ft:N,t_s:Pe,v_mph:ht}),Be++}if(i.ShiftFlag===1)i.ShiftFlag=2,i.Gear++;else if(i.ShiftFlag===2)i.ShiftFlag=0;else if(i.Gear<de.NGR)if((de.ShiftMode??"rpm")==="time"){const O=(ut=de.ShiftTimes)==null?void 0:ut[i.Gear-1];O!==void 0&&i.time_s>=O&&(i.ShiftFlag=1)}else{const O=de.ShiftRPM[i.Gear-1]??7e3;i.EngRPM>=O&&(i.ShiftFlag=1)}}const pe=He.find(C=>C.d_ft===l),Xt=(pe==null?void 0:pe.t_s)??i.time_s,jt=(pe==null?void 0:pe.v_mph)??i.Vel_ftps*fe,Yt=r.map(C=>({t_s:C.t_s,s_ft:C.s_ft,v_mph:C.v_mph,v_fps:C.v_fps,a_g:C.a_g,rpm:C.rpm,dsrpm:C.dsrpm,lockRpm:C.lockRpm,gear:C.gear,slip:C.slip,tireSlip:C.tireSlip,hp:C.hp,dragHp:C.dragHp,wheelSpeed_mph:C.wheelSpeed_mph}));return{et_s:Xt,mph:jt,timeslip:He,traces:Yt,meta:{model:"VB6Exact",steps:r.length,warnings:t},vb6Diagnostics:ae}}const Jn="rsa.model.";function Qn(e){try{const t=Jn+e,r=localStorage.getItem(t);if(!r)return;const o=JSON.parse(r);if(!o.w||!o.P||typeof o.n!="number"){console.warn(`Invalid model structure for vehicle ${e}`);return}return o}catch(t){console.error(`Failed to load model for vehicle ${e}:`,t);return}}function Kn(e,t){if(t.length!==e.w.length)throw new Error(`Feature dimension mismatch: expected ${e.w.length}, got ${t.length}`);let r=0;for(let o=0;o<e.w.length;o++)r+=e.w[o]*t[o];return r}class Xn{constructor(){Ut(this,"id","Blend")}simulate(t){const r=$r.simulate(t),o=t.vehicle.id,s=Qn(o);let n=0;const l=[...r.meta.warnings];if(s){const d=[mt(t.env)/1e3,t.vehicle.weightLb/3e3,t.vehicle.tireDiaIn/30,t.vehicle.rearGear/4,(r.et_s-10)/5];n=Kn(s,d)}else l.push("no_learned_model");const a=r.et_s*.8,f=r.et_s*1.2;return{et_s:Math.max(a,Math.min(f,r.et_s+n)),mph:r.mph,timeslip:r.timeslip,traces:r.traces,meta:{model:"Blend",steps:r.meta.steps,warnings:l}}}}const jn=new Xn;class Yn{constructor(){Ut(this,"id","SimpleV1")}simulate(t){const r=Po({vehicle:t.vehicle,env:t.env,raceLength:t.raceLength});return{et_s:r.baseET_s,mph:r.baseMPH,timeslip:r.timeslip,meta:{model:"SimpleV1",steps:r.timeslip.length,warnings:[]}}}}class Zn{constructor(){Ut(this,"id","VB6Exact")}simulate(t){const r=Un(t);return{...r,meta:{...r.meta,model:"VB6Exact"}}}}const zn={SimpleV1:new Yn,RSACLASSIC:$r,VB6Exact:new Zn,Blend:jn};function jr(e){const t=zn[e];if(!t)throw new Error(`Unknown physics model: ${e}`);return t}function es(e){if(e!=null&&e.drivetrain){const t=e.drivetrain;t.shiftsRPM&&!t.shiftRPM&&(t.shiftRPM=t.shiftsRPM),t.overallEfficiency!==void 0&&t.overallEff===void 0&&(t.overallEff=t.overallEfficiency),t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}if(e!=null&&e.vehicle){const t=e.vehicle;t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}return e}function Kt(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const o=Number(e.torque)*r/5252*t;return{rpm:r,hp:o}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const o=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:o}}return null}function ts(e){var o,s,n,l,a,f;if(Array.isArray((o=e==null?void 0:e.engineParams)==null?void 0:o.powerHP)&&e.engineParams.powerHP.length>=2)return e;const t=((s=e==null?void 0:e.fuel)==null?void 0:s.hpTorqueMultiplier)??1;let r=[];if(Array.isArray((n=e==null?void 0:e.vehicle)==null?void 0:n.hpCurve)&&e.vehicle.hpCurve.length>=2&&(r=e.vehicle.hpCurve.map(c=>Kt(c,t)).filter(c=>c!==null&&Number.isFinite(c.rpm)&&Number.isFinite(c.hp)).sort((c,_)=>c.rpm-_.rpm)),r.length<2&&Array.isArray(e==null?void 0:e.engineHP)&&e.engineHP.length>=2&&(r=e.engineHP.map(c=>Array.isArray(c)?{rpm:Number(c[0]),hp:Number(c[1])*t}:Kt(c,t)).filter(c=>c!==null&&Number.isFinite(c.rpm)&&Number.isFinite(c.hp)).sort((c,_)=>c.rpm-_.rpm)),r.length<2&&Array.isArray((l=e==null?void 0:e.engineParams)==null?void 0:l.torqueCurve)&&e.engineParams.torqueCurve.length>=2&&(r=e.engineParams.torqueCurve.map(c=>Kt(c,t)).filter(c=>c!==null&&Number.isFinite(c.rpm)&&Number.isFinite(c.hp)).sort((c,_)=>c.rpm-_.rpm)),r.length<2&&Array.isArray((a=e==null?void 0:e.vehicle)==null?void 0:a.torqueCurve)&&e.vehicle.torqueCurve.length>=2&&(r=e.vehicle.torqueCurve.map(c=>Kt(c,t)).filter(c=>c!==null&&Number.isFinite(c.rpm)&&Number.isFinite(c.hp)).sort((c,_)=>c.rpm-_.rpm)),r.length<2){const c=Number((f=e==null?void 0:e.vehicle)==null?void 0:f.powerHP);Number.isFinite(c)&&c>0&&(r=[{rpm:4e3,hp:c*.85*t},{rpm:5e3,hp:c*.92*t},{rpm:6e3,hp:c*.97*t},{rpm:6500,hp:c*1*t},{rpm:7e3,hp:c*.98*t},{rpm:7500,hp:c*.94*t},{rpm:8e3,hp:c*.88*t}])}return r.length>=2&&(e.engineParams={...e.engineParams??{},powerHP:r}),e}function rs(e){es(e),ts(e)}function os(e){var s,n;if(!Array.isArray(e))return"none";const t=(s=e[0])==null?void 0:s.rpm,r=(n=e[e.length-1])==null?void 0:n.rpm;return`n=${e.length},first=${t},last=${r}`}self.onmessage=async e=>{var t,r,o,s,n,l,a,f,c;try{const _=e.data;if(!(_!=null&&_.model)||!(_!=null&&_.payload))throw new Error("Bad worker message");const h=JSON.parse(JSON.stringify(_.payload));if(_.model==="VB6Exact"){console.log("[WORKER:VB6Exact] Running with SimInputs format",{hasVehicle:!!h.vehicle,vehicleName:(t=h.vehicle)==null?void 0:t.name,powerHP:(r=h.vehicle)==null?void 0:r.powerHP,hasHpCurve:!!((o=h.vehicle)!=null&&o.hpCurve),raceLength:h.raceLength});const p=jr(_.model).simulate(h);self.postMessage({ok:!0,result:p});return}rs(h);const d=(s=h==null?void 0:h.engineParams)==null?void 0:s.powerHP;if(!Array.isArray(d)||d.length<2)throw console.error("[WORKER] bad powerHP",{hpLen:d==null?void 0:d.length,sample:(n=d==null?void 0:d.slice)==null?void 0:n.call(d,0,2)}),new Error("EngineParams must provide either torqueCurve or powerHP");Number.isFinite(h==null?void 0:h.raceLengthFt)||(h.raceLengthFt=(_==null?void 0:_.raceLengthFt)??1320);const g=(h==null?void 0:h.drivetrain)??{};console.log("[WORKER:normalized.input]",{hasEngineParams:!!h.engineParams,hasPowerHP:!!d,raceLengthFt:h.raceLengthFt,hpSummary:os(d),hasClutch:!!g.clutch,hasConverter:!!g.converter,slipRPM:(l=g==null?void 0:g.clutch)==null?void 0:l.slipRPM,stallRPM:(a=g==null?void 0:g.converter)==null?void 0:a.stallRPM});try{h!=null&&h.tuning&&console.debug("[WORKER:TUNING]",!0,h.tuning)}catch{}h.flags===void 0&&(h.flags={}),h.flags.vb6Strict===void 0&&(h.flags.vb6Strict=((c=(f=_.payload)==null?void 0:f.flags)==null?void 0:c.vb6Strict)??!0);const P=jr(_.model).simulate(h);self.postMessage({ok:!0,result:P})}catch(_){console.error("[WORKER ERROR]",_),self.postMessage({ok:!1,error:String((_==null?void 0:_.message)||_)})}}})();
//# sourceMappingURL=index-pJHfdbOP.js.map
