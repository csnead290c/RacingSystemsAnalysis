import{r as o,g as nt,an as lt,s as at,j as t}from"./index-rrhK9oRW.js";function ct({vehicle:r,env:g,raceLength:E,isOpen:et,onClose:y,onApplyToSession:A,onSaveToVehicle:T}){var tt;const[w,G]=o.useState(!1),[,$]=o.useState(null),[D,j]=o.useState(0),[rt,S]=o.useState(""),[M,N]=o.useState([]),[I,V]=o.useState([]),[d,H]=o.useState(null),[m,L]=o.useState(null),[c,W]=o.useState(null),[C,q]=o.useState(null),[z,_]=o.useState(""),[ot,P]=o.useState(!1),[R,J]=o.useState(!1),[K,Q]=o.useState(!1),b=o.useCallback(async e=>{try{const i=nt(e),n=lt(i,E);n.env={elevation:g.elevation??0,barometerInHg:g.barometerInHg??29.92,temperatureF:g.temperatureF??75,humidityPct:g.humidityPct??50,windMph:g.windMph??0,windAngleDeg:g.windAngleDeg??0,trackTempF:g.trackTempF??100,tractionIndex:g.tractionIndex??5};const l=await at("VB6Exact",n);return{et:l.et_s,mph:l.mph}}catch(i){return console.error("Simulation failed:",i),{et:999,mph:0}}},[g,E]),B=o.useCallback(()=>{$(null),j(0),S(""),N([]),V([]),H(null),L(null),W(null),q(null),_(""),P(!1),Q(!1)},[]),U=o.useCallback(async()=>{const e=r.rearGear??3.73,i=Math.max(2,e-2),n=Math.min(6,e+2),l=.05,p=[],h=Math.ceil((n-i)/l);let x=0;for(let u=i;u<=n;u+=l){const s={...r,rearGear:u},f=await b(s);p.push({value:u,et:f.et,mph:f.mph}),x++,j(Math.round(x/h*50)),S(`Testing gear ratio ${u.toFixed(2)}...`)}const a=p.reduce((u,s)=>u.et<s.et?u:s);return N(p),H(a),a},[r,b]),X=o.useCallback(async e=>{const i=e||r;if(i.transmissionType!=="converter")return null;const n=1500,l=6e3,p=200,h=[],x=Math.ceil((l-n)/p);let a=0;for(let s=n;s<=l;s+=p){const f={...i,converterStallRPM:s},v=await b(f);h.push({value:s,et:v.et,mph:v.mph}),a++,j(50+Math.round(a/x*50)),S(`Testing stall speed ${s} RPM...`)}const u=h.reduce((s,f)=>s.et<f.et?s:f);return V(h),L(u),u},[r,b]),Y=o.useCallback(async e=>{q(e),S("Getting baseline ET..."),j(5);const i=await b(r);if(i.et>=e)return W({duration:0,activateTime:0,throttlePct:100,et:i.et,mph:i.mph}),null;const n=i.et*.6,l=30;let p=0,h=5,x=null,a=0;const u=15;for(;a<u&&h-p>.01;){const s=(p+h)/2;a++,j(10+Math.round(a/u*85)),S(`Testing ${s.toFixed(2)}s duration...`);const f={...r,throttleStopEnabled:!0,throttleStopDelay:n,throttleStopDuration:s,throttleStopPct:l},v=await b(f);if(Math.abs(v.et-e)<.005){x={duration:s,activateTime:n,throttlePct:l,et:v.et,mph:v.mph};break}v.et<e?p=s:h=s,x={duration:s,activateTime:n,throttlePct:l,et:v.et,mph:v.mph}}return j(100),W(x),x},[r,b]),k=o.useCallback(async(e,i)=>{B(),G(!0),$(e);try{if((e==="gear"||e==="both")&&await U(),(e==="converter"||e==="both")&&r.transmissionType==="converter"){const n=e==="both"&&d?{...r,rearGear:d.value}:r;await X(n)}e==="throttleStop"&&i&&await Y(i)}finally{G(!1),S("")}},[B,U,X,Y,r,d]),F=o.useCallback(()=>{let e={...r};return d&&(e.rearGear=d.value),m&&(e.converterStallRPM=m.value),e},[r,d,m]),it=o.useCallback(()=>{A(F()),y()},[F,A,y]),st=o.useCallback(async()=>{if(T){J(!0);try{await T(F()),Q(!0),setTimeout(()=>{y()},1e3)}catch(e){console.error("Failed to save vehicle:",e),alert("Failed to save vehicle")}finally{J(!1)}}},[F,T,y]);if(!et)return null;const Z=d||m||c,O=r.transmissionType==="converter";return t.jsxs(t.Fragment,{children:[t.jsx("div",{onClick:y,style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.6)",zIndex:1e3}}),t.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"var(--color-bg)",borderRadius:"12px",boxShadow:"0 20px 60px rgba(0,0,0,0.4)",zIndex:1001,width:"500px",maxWidth:"95vw",maxHeight:"90vh",overflow:"auto"},children:[t.jsxs("div",{style:{padding:"16px 20px",borderBottom:"1px solid var(--color-border)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx("h3",{style:{margin:0,fontSize:"1.1rem",color:"var(--color-text)"},children:"‚ö° Performance Optimizer"}),t.jsx("button",{onClick:y,style:{background:"none",border:"none",fontSize:"1.5rem",cursor:"pointer",color:"var(--color-text-muted)",padding:"0 4px"},children:"√ó"})]}),t.jsxs("div",{style:{padding:"20px"},children:[t.jsxs("div",{style:{padding:"12px",backgroundColor:"var(--color-bg-secondary)",borderRadius:"8px",marginBottom:"16px",fontSize:"0.85rem"},children:[t.jsx("div",{style:{fontWeight:600,color:"var(--color-text)",marginBottom:"4px"},children:r.name}),t.jsxs("div",{style:{color:"var(--color-text-muted)",fontSize:"0.8rem"},children:["Current: ",((tt=r.rearGear)==null?void 0:tt.toFixed(2))??"3.73"," gear ratio",O&&` ‚Ä¢ ${r.converterStallRPM??3e3} RPM stall`]})]}),!w&&!Z&&t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"10px"},children:[t.jsxs("button",{onClick:()=>k("gear"),style:{padding:"14px 16px",fontSize:"0.9rem",borderRadius:"8px",border:"2px solid var(--color-accent)",backgroundColor:"rgba(59, 130, 246, 0.1)",color:"var(--color-accent)",cursor:"pointer",fontWeight:600,display:"flex",alignItems:"center",gap:"10px"},children:[t.jsx("span",{style:{fontSize:"1.2rem"},children:"üéØ"}),t.jsxs("div",{style:{textAlign:"left"},children:[t.jsx("div",{children:"Optimize Gear Ratio"}),t.jsx("div",{style:{fontSize:"0.75rem",fontWeight:400,opacity:.8},children:"Find the best final drive ratio for quickest ET"})]})]}),O&&t.jsxs("button",{onClick:()=>k("converter"),style:{padding:"14px 16px",fontSize:"0.9rem",borderRadius:"8px",border:"2px solid #f59e0b",backgroundColor:"rgba(245, 158, 11, 0.1)",color:"#f59e0b",cursor:"pointer",fontWeight:600,display:"flex",alignItems:"center",gap:"10px"},children:[t.jsx("span",{style:{fontSize:"1.2rem"},children:"üîÑ"}),t.jsxs("div",{style:{textAlign:"left"},children:[t.jsx("div",{children:"Optimize Converter Stall"}),t.jsx("div",{style:{fontSize:"0.75rem",fontWeight:400,opacity:.8},children:"Find the best stall speed for quickest ET"})]})]}),O&&t.jsxs("button",{onClick:()=>k("both"),style:{padding:"14px 16px",fontSize:"0.9rem",borderRadius:"8px",border:"2px solid #22c55e",backgroundColor:"rgba(34, 197, 94, 0.1)",color:"#22c55e",cursor:"pointer",fontWeight:600,display:"flex",alignItems:"center",gap:"10px"},children:[t.jsx("span",{style:{fontSize:"1.2rem"},children:"üöÄ"}),t.jsxs("div",{style:{textAlign:"left"},children:[t.jsx("div",{children:"Optimize Both"}),t.jsx("div",{style:{fontSize:"0.75rem",fontWeight:400,opacity:.8},children:"Find best gear ratio AND converter stall together"})]})]}),t.jsx("div",{style:{borderTop:"1px solid var(--color-border)",marginTop:"10px",paddingTop:"10px"},children:ot?t.jsxs("div",{style:{padding:"16px",backgroundColor:"rgba(236, 72, 153, 0.1)",borderRadius:"8px",border:"2px solid #ec4899"},children:[t.jsx("div",{style:{fontSize:"0.85rem",color:"#ec4899",fontWeight:600,marginBottom:"12px"},children:"‚è±Ô∏è Throttle Stop Optimizer"}),t.jsxs("div",{style:{marginBottom:"12px"},children:[t.jsx("label",{style:{fontSize:"0.8rem",color:"var(--color-text-muted)",display:"block",marginBottom:"4px"},children:"Target ET (your dial-in)"}),t.jsx("input",{type:"number",step:"0.001",placeholder:"e.g., 10.500",value:z,onChange:e=>_(e.target.value),style:{width:"100%",padding:"10px 12px",fontSize:"1rem",borderRadius:"6px",border:"1px solid var(--color-border)",backgroundColor:"var(--color-bg)",color:"var(--color-text)"}})]}),t.jsxs("div",{style:{display:"flex",gap:"8px"},children:[t.jsx("button",{onClick:()=>{const e=parseFloat(z);!isNaN(e)&&e>0&&k("throttleStop",e)},disabled:!z||isNaN(parseFloat(z)),style:{flex:1,padding:"10px 16px",fontSize:"0.85rem",borderRadius:"6px",border:"none",backgroundColor:"#ec4899",color:"white",cursor:z?"pointer":"not-allowed",fontWeight:600,opacity:z?1:.5},children:"Calculate Duration"}),t.jsx("button",{onClick:()=>P(!1),style:{padding:"10px 16px",fontSize:"0.85rem",borderRadius:"6px",border:"1px solid var(--color-border)",backgroundColor:"transparent",color:"var(--color-text-muted)",cursor:"pointer"},children:"Cancel"})]})]}):t.jsxs("button",{onClick:()=>P(!0),style:{width:"100%",padding:"14px 16px",fontSize:"0.9rem",borderRadius:"8px",border:"2px solid #ec4899",backgroundColor:"rgba(236, 72, 153, 0.1)",color:"#ec4899",cursor:"pointer",fontWeight:600,display:"flex",alignItems:"center",gap:"10px"},children:[t.jsx("span",{style:{fontSize:"1.2rem"},children:"‚è±Ô∏è"}),t.jsxs("div",{style:{textAlign:"left"},children:[t.jsx("div",{children:"Throttle Stop Optimizer"}),t.jsx("div",{style:{fontSize:"0.75rem",fontWeight:400,opacity:.8},children:"Calculate duration to hit your dial-in (bracket racing)"})]})]})})]}),w&&t.jsxs("div",{style:{textAlign:"center",padding:"30px 0"},children:[t.jsx("div",{style:{fontSize:"1rem",marginBottom:"12px",color:"var(--color-text)"},children:"Optimizing..."}),t.jsx("div",{style:{width:"100%",height:"10px",backgroundColor:"var(--color-bg-secondary)",borderRadius:"5px",overflow:"hidden",marginBottom:"8px"},children:t.jsx("div",{style:{width:`${D}%`,height:"100%",backgroundColor:"var(--color-accent)",transition:"width 0.2s ease"}})}),t.jsx("div",{style:{fontSize:"0.8rem",color:"var(--color-text-muted)"},children:rt||`${D}% complete`})]}),Z&&!w&&t.jsxs("div",{children:[d&&t.jsxs("div",{style:{padding:"16px",backgroundColor:"rgba(59, 130, 246, 0.1)",borderRadius:"8px",marginBottom:"12px",border:"1px solid rgba(59, 130, 246, 0.3)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"0.75rem",color:"var(--color-accent)",fontWeight:600,marginBottom:"4px"},children:"OPTIMAL GEAR RATIO"}),t.jsx("div",{style:{fontSize:"1.5rem",fontWeight:700,color:"var(--color-text)"},children:d.value.toFixed(2)}),t.jsxs("div",{style:{fontSize:"0.8rem",color:"var(--color-text-muted)",marginTop:"4px"},children:["ET: ",d.et.toFixed(3),"s @ ",d.mph.toFixed(1)," mph"]})]}),t.jsxs("div",{style:{textAlign:"right",fontSize:"0.8rem"},children:[t.jsxs("div",{style:{color:"var(--color-text-muted)"},children:["Current: ",(r.rearGear??3.73).toFixed(2)]}),t.jsxs("div",{style:{color:d.value!==(r.rearGear??3.73)?"#22c55e":"var(--color-text-muted)",fontWeight:600},children:[d.value-(r.rearGear??3.73)>=0?"+":"",(d.value-(r.rearGear??3.73)).toFixed(2)]})]})]}),t.jsx("div",{style:{marginTop:"12px"},children:t.jsx("div",{style:{display:"flex",alignItems:"flex-end",gap:"1px",height:"30px"},children:M.map((e,i)=>{const n=Math.min(...M.map(a=>a.et)),l=Math.max(...M.map(a=>a.et)),p=l-n||.1,h=(l-e.et)/p*100,x=e.value===d.value;return t.jsx("div",{style:{flex:1,height:`${Math.max(5,h)}%`,backgroundColor:x?"#22c55e":"var(--color-accent)",opacity:x?1:.3},title:`${e.value.toFixed(2)}: ${e.et.toFixed(3)}s`},i)})})})]}),m&&t.jsxs("div",{style:{padding:"16px",backgroundColor:"rgba(245, 158, 11, 0.1)",borderRadius:"8px",marginBottom:"12px",border:"1px solid rgba(245, 158, 11, 0.3)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"0.75rem",color:"#f59e0b",fontWeight:600,marginBottom:"4px"},children:"OPTIMAL CONVERTER STALL"}),t.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:700,color:"var(--color-text)"},children:[m.value.toFixed(0)," RPM"]}),t.jsxs("div",{style:{fontSize:"0.8rem",color:"var(--color-text-muted)",marginTop:"4px"},children:["ET: ",m.et.toFixed(3),"s @ ",m.mph.toFixed(1)," mph"]})]}),t.jsxs("div",{style:{textAlign:"right",fontSize:"0.8rem"},children:[t.jsxs("div",{style:{color:"var(--color-text-muted)"},children:["Current: ",r.converterStallRPM??3e3," RPM"]}),t.jsxs("div",{style:{color:m.value!==(r.converterStallRPM??3e3)?"#22c55e":"var(--color-text-muted)",fontWeight:600},children:[m.value-(r.converterStallRPM??3e3)>=0?"+":"",(m.value-(r.converterStallRPM??3e3)).toFixed(0)," RPM"]})]})]}),t.jsx("div",{style:{marginTop:"12px"},children:t.jsx("div",{style:{display:"flex",alignItems:"flex-end",gap:"1px",height:"30px"},children:I.map((e,i)=>{const n=Math.min(...I.map(a=>a.et)),l=Math.max(...I.map(a=>a.et)),p=l-n||.1,h=(l-e.et)/p*100,x=e.value===m.value;return t.jsx("div",{style:{flex:1,height:`${Math.max(5,h)}%`,backgroundColor:x?"#22c55e":"#f59e0b",opacity:x?1:.3},title:`${e.value} RPM: ${e.et.toFixed(3)}s`},i)})})})]}),c&&t.jsxs("div",{style:{padding:"16px",backgroundColor:"rgba(236, 72, 153, 0.1)",borderRadius:"8px",marginBottom:"12px",border:"1px solid rgba(236, 72, 153, 0.3)"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"0.75rem",color:"#ec4899",fontWeight:600,marginBottom:"4px"},children:"‚è±Ô∏è THROTTLE STOP SETTINGS"}),c.duration===0?t.jsxs("div",{style:{fontSize:"1rem",color:"var(--color-text-muted)"},children:["No throttle stop needed - car already runs ",c.et.toFixed(3),"s"]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:700,color:"var(--color-text)"},children:[c.duration.toFixed(2),"s duration"]}),t.jsxs("div",{style:{fontSize:"0.8rem",color:"var(--color-text-muted)",marginTop:"4px"},children:["Activate at ",c.activateTime.toFixed(2),"s ‚Ä¢ ",c.throttlePct,"% throttle"]})]})]}),t.jsxs("div",{style:{textAlign:"right",fontSize:"0.8rem"},children:[t.jsxs("div",{style:{color:"var(--color-text-muted)"},children:["Target: ",C==null?void 0:C.toFixed(3),"s"]}),t.jsxs("div",{style:{color:Math.abs(c.et-(C??0))<.01?"#22c55e":"#f59e0b",fontWeight:600},children:["Result: ",c.et.toFixed(3),"s"]}),t.jsxs("div",{style:{color:"var(--color-text-muted)",marginTop:"4px"},children:["@ ",c.mph.toFixed(1)," mph"]})]})]}),c.duration>0&&t.jsxs("div",{style:{marginTop:"12px",padding:"10px",backgroundColor:"var(--color-bg)",borderRadius:"6px",fontSize:"0.8rem"},children:[t.jsx("div",{style:{fontWeight:600,marginBottom:"6px",color:"var(--color-text)"},children:"Recommended Settings:"}),t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px"},children:[t.jsxs("div",{children:[t.jsx("span",{style:{color:"var(--color-text-muted)"},children:"Activate:"})," ",t.jsxs("span",{style:{color:"#ec4899",fontWeight:600},children:[c.activateTime.toFixed(2),"s"]})]}),t.jsxs("div",{children:[t.jsx("span",{style:{color:"var(--color-text-muted)"},children:"Duration:"})," ",t.jsxs("span",{style:{color:"#ec4899",fontWeight:600},children:[c.duration.toFixed(2),"s"]})]}),t.jsxs("div",{children:[t.jsx("span",{style:{color:"var(--color-text-muted)"},children:"Throttle:"})," ",t.jsxs("span",{style:{color:"#ec4899",fontWeight:600},children:[c.throttlePct,"%"]})]}),t.jsxs("div",{children:[t.jsx("span",{style:{color:"var(--color-text-muted)"},children:"Predicted ET:"})," ",t.jsxs("span",{style:{color:"#22c55e",fontWeight:600},children:[c.et.toFixed(3),"s"]})]})]})]})]}),t.jsxs("div",{style:{display:"flex",gap:"10px",marginTop:"16px"},children:[t.jsx("button",{onClick:it,style:{flex:1,padding:"12px 16px",fontSize:"0.9rem",borderRadius:"8px",border:"none",backgroundColor:"var(--color-accent)",color:"white",cursor:"pointer",fontWeight:600},children:"Apply to Session"}),T&&t.jsx("button",{onClick:st,disabled:R,style:{flex:1,padding:"12px 16px",fontSize:"0.9rem",borderRadius:"8px",border:"none",backgroundColor:"#22c55e",color:"white",cursor:R?"wait":"pointer",fontWeight:600,opacity:R?.7:1},children:K?"‚úì Saved!":R?"Saving...":"Save to Vehicle"})]}),t.jsx("button",{onClick:B,style:{width:"100%",marginTop:"10px",padding:"10px 16px",fontSize:"0.85rem",borderRadius:"8px",border:"1px solid var(--color-border)",backgroundColor:"transparent",color:"var(--color-text-muted)",cursor:"pointer"},children:"Run Another Optimization"})]})]})]})]})}function xt({onClick:r}){return t.jsxs("button",{onClick:r,style:{padding:"6px 12px",fontSize:"0.75rem",borderRadius:"4px",border:"1px solid var(--color-accent)",backgroundColor:"rgba(59, 130, 246, 0.1)",color:"var(--color-accent)",cursor:"pointer",fontWeight:500,display:"flex",alignItems:"center",gap:"6px"},title:"Open Performance Optimizer",children:[t.jsx("span",{children:"‚ö°"}),t.jsx("span",{children:"Optimize"})]})}export{xt as OptimizerButton,ct as default};
//# sourceMappingURL=OptimizerModal-B7yMfgGB.js.map
