var xs=Object.defineProperty;var Is=(we,xe,Rt)=>xe in we?xs(we,xe,{enumerable:!0,configurable:!0,writable:!0,value:Rt}):we[xe]=Rt;var fr=(we,xe,Rt)=>Is(we,typeof xe!="symbol"?xe+"":xe,Rt);(function(){"use strict";const we={EIGHTH:[60,330,660],THOUSAND:[60,330,660,1e3],QUARTER:[60,330,660,1e3,1320],ONE_MILE:[660,1320,2640,3960,5280],EL_MIRAGE:[660,1320,2640,3960,5280,6864],MUROC:[660,1320,2640,3960,5280,6600,7920],TWO_MILE:[660,1320,2640,5280,7920,10560],BONNEVILLE_SHORT:[660,1320,2640,5280,10560,15840],BONNEVILLE_LONG:[660,1320,2640,5280,10560,15840,21120,26400],TEN_MILE:[660,1320,2640,5280,10560,26400,52800]},xe={EIGHTH:{label:"1/8 Mile",shortLabel:"1/8",category:"drag",lengthFt:660,lengthMiles:.125},THOUSAND:{label:"1000 Foot",shortLabel:"1000'",category:"drag",lengthFt:1e3,lengthMiles:.189},QUARTER:{label:"1/4 Mile",shortLabel:"1/4",category:"drag",lengthFt:1320,lengthMiles:.25},ONE_MILE:{label:"One Mile Asphalt",shortLabel:"1 Mi",category:"landspeed",lengthFt:5280,lengthMiles:1},EL_MIRAGE:{label:"El Mirage Dry Lake",shortLabel:"El Mirage",category:"landspeed",lengthFt:6864,lengthMiles:1.3},MUROC:{label:"Muroc Dry Lake (EAFB)",shortLabel:"Muroc",category:"landspeed",lengthFt:7920,lengthMiles:1.5},TWO_MILE:{label:"Two Mile Asphalt",shortLabel:"2 Mi",category:"landspeed",lengthFt:10560,lengthMiles:2},BONNEVILLE_SHORT:{label:"Bonneville - 3 Miles",shortLabel:"BV 3Mi",category:"landspeed",lengthFt:15840,lengthMiles:3},BONNEVILLE_LONG:{label:"Bonneville - 5 Miles",shortLabel:"BV 5Mi",category:"landspeed",lengthFt:26400,lengthMiles:5},TEN_MILE:{label:"Ten Mile Test Track",shortLabel:"10 Mi",category:"landspeed",lengthFt:52800,lengthMiles:10}};function Rt(e){const r=e.elevation+(29.92-e.barometerInHg)*1e3,o=59-r/1e3*3.5,n=(e.temperatureF-o)*120,s=e.humidityPct/10*50*(e.temperatureF/80);return r+n+s}function Mo(e){const r=.0061*Math.exp(17.27*(e.temperatureF-32)/1.8/(237.3+(e.temperatureF-32)/1.8))*(e.humidityPct/100),o=7e3*.622*(r/(e.barometerInHg-r));return Math.max(0,Math.min(o,500))}function Po(e){const o=518.6700000000001,n=e.temperatureF+459.67,s=e.barometerInHg/29.92,i=o/n;let c=s*i;const l=1-Mo(e)/5e3;return c*=l,Math.max(.7,Math.min(c,1.15))}function To(e){const{vehicle:t,env:r,raceLength:o}=e;if(t.weightLb<=0||t.powerHP<=0)throw new Error("Invalid vehicle params");const n=we[o];if(!n)throw new Error(`Invalid race length: ${o}`);const s=Po(r),i=t.powerHP*s,c=Math.max(1,i),a=Math.max(1,t.weightLb),l=5.825*Math.cbrt(a/c),u=234*Math.cbrt(c/a),h=l*.64,_=u*.8;let g,d;if(o==="EIGHTH"?(g=h,d=_):(g=l,d=u),!Number.isFinite(g)||!Number.isFinite(d))throw new Error("Invalid ET or MPH calculation");const M=5.825*Math.cbrt(a/Math.max(1,t.powerHP)),p=g-M,m={60:.16,330:.44,660:.79,1e3:.93,1320:1},S=n.map(C=>{const H=m[C]??1,x=g*H,F=C/n[n.length-1],K=d*F;return{d_ft:C,t_s:Math.max(0,x),v_mph:Math.max(0,K)}}),E=[{name:"Weather (HP)",delta_s:p}];return{baseET_s:Math.max(0,g),baseMPH:Math.max(0,d),timeslip:S,factors:E}}function So(e){return e/32.174}function Ro(e,t,r){return e+(t-e)*r}function Fo(e){var r;const t=(Array.isArray(e)?e:e==null?void 0:e.powerHP)??((r=e==null?void 0:e.engineParams)==null?void 0:r.powerHP);if(!Array.isArray(t)||t.length<2){const o=e&&typeof e=="object"?Object.keys(e):[];throw new Error(`EngineParams must provide either torqueCurve or powerHP (got keys=${JSON.stringify(o)}, len=${(t==null?void 0:t.length)??0})`)}return t}function Rr(e,t){const r=Fo(t);if(e<=r[0].rpm)return r[0].hp;if(e>=r[r.length-1].rpm)return r[r.length-1].hp;let o=0,n=r.length-1;for(;n-o>1;){const a=o+n>>1;r[a].rpm<=e?o=a:n=a}const s=r[o],i=r[n],c=(e-s.rpm)/(i.rpm-s.rpm);return s.hp+c*(i.hp-s.hp)}function ur(e,t,r){if("corr"in t&&typeof t.corr=="number"){const s=t;let i;if(s.torqueCurve&&s.torqueCurve.length>0)i=bo(e,s.torqueCurve);else if(s.powerHP!==void 0){const a=Math.max(e,1e3);i=s.powerHP*5252/a}else throw new Error("EngineParams must provide either torqueCurve or powerHP");return i*s.corr}const o=Rr(e,t);return(e>0?5252*o/e:0)*(Number.isFinite(r)?r:1)}function bo(e,t){const o=[...t.map(n=>{if(n.tq_lbft!==void 0)return{rpm:n.rpm,tq_lbft:n.tq_lbft};if(n.hp!==void 0&&n.rpm>0)return{rpm:n.rpm,tq_lbft:n.hp*5252/n.rpm};throw new Error(`Invalid torque curve point: ${JSON.stringify(n)}`)})].sort((n,s)=>n.rpm-s.rpm);if(e<=o[0].rpm)return o[0].tq_lbft;if(e>=o[o.length-1].rpm)return o[o.length-1].tq_lbft;for(let n=0;n<o.length-1;n++){const s=o[n],i=o[n+1];if(e>=s.rpm&&e<=i.rpm){const c=(e-s.rpm)/(i.rpm-s.rpm);return Ro(s.tq_lbft,i.tq_lbft,c)}}return o[o.length-1].tq_lbft}const R=e=>Math.fround(e),G={add:(e,t)=>Math.fround(Math.fround(e)+Math.fround(t)),sub:(e,t)=>Math.fround(Math.fround(e)-Math.fround(t)),mul:(e,t)=>Math.fround(Math.fround(e)*Math.fround(t)),div:(e,t)=>Math.fround(Math.fround(e)/Math.fround(t)),sqrt:e=>Math.fround(Math.sqrt(Math.fround(e))),pow:(e,t)=>Math.fround(Math.pow(Math.fround(e),Math.fround(t))),exp:e=>Math.fround(Math.exp(Math.fround(e))),log:e=>Math.fround(Math.log(Math.fround(e))),clamp:(e,t,r)=>Math.fround(Math.min(Math.max(Math.fround(e),Math.fround(t)),Math.fround(r))),abs:e=>Math.fround(Math.abs(Math.fround(e))),neg:e=>Math.fround(-Math.fround(e))};function kr(e,t=0){const r=Math.pow(10,t),o=Math.fround(e*r),n=Math.floor(o),s=o-n;return s>.5?(n+1)/r:s<.5?n/r:(n%2===0?n:n+1)/r}function Eo(e,t,r,o,n){const s=R(e),i=R(t),c=R(r),a=R(o),l=R(n);if(c===i)return a;const u=G.div(G.sub(s,i),G.sub(c,i));return G.add(a,G.mul(u,G.sub(l,a)))}function Ao(e,t){if(t.length===0)return R(0);if(t.length===1)return R(t[0][1]);const r=R(e);if(r<=R(t[0][0]))return R(t[0][1]);if(r>=R(t[t.length-1][0]))return R(t[t.length-1][1]);for(let o=0;o<t.length-1;o++){const n=R(t[o][0]),s=R(t[o+1][0]);if(r>=n&&r<=s)return Eo(r,n,s,t[o][1],t[o+1][1])}return R(t[t.length-1][1])}function wo(e){return Array.isArray(e==null?void 0:e.ratios)&&e.ratios.length>0?e.ratios:Array.isArray(e==null?void 0:e.gearRatios)&&e.gearRatios.length>0?e.gearRatios:[]}function xo(e,t,r,o=0){const n=(r.tireDiaIn??28)/12,s=Math.PI*n,c=e/s*60,a=wo(r),l=a.length>0?a[Math.min(t,a.length-1)]??1:1;return c*l*(r.finalDrive??3.73)*(1+o)}function Io(){return{t_s:0,v_fps:0,s_ft:0,rpm:0,gearIdx:0,warnings:[]}}const Ye=3.141593,I=32.174,Fr=60/(2*Ye)*550,br=519.67,Wr=14.696,vo=29.92,Er=28.9669,Or=18.016,qr=1545.32,hr=3600/5280,Ar=.025,Co=.01,Vr=.03,yo=0,Ho=9.7,Lo=1.01,No=0,Do=0,Pe=.004,Ft=-4,bt=2,$r=.92,Br=1.08,Ur=.15,Qr=.25,Go=1.03,ko=10.8,_e=3600/5280,Wo=459.67,Oo=I;function qo(e){const{engineTorque_lbft_atSlip:t,gearRatio:r,transEff:o,drivelineEff:n,finalDrive:s,tireDia_in:i,tireSlip:c,dragForce_lbf:a,vehicleWeight_lbf:l,isAutoTrans:u,torqueMult:h=1}=e,_=t*h*r*o,g=i/24,M=_*s*n/(c*g)-a;return{Ags0_ftps2:(u?.96:.88)*(M/l)*I,netThrust_lbf:M,wheelTorque_lbft:_}}function Jr(e){const t=e.elevation_ft??0,r=e.fuelSystem??1,o=[.0205558,.00118163,154988e-10,40245e-11,434856e-15,2096e-14],n=o[0]+o[1]*e.temperature_F+o[2]*e.temperature_F**2+o[3]*e.temperature_F**3+o[4]*e.temperature_F**4+o[5]*e.temperature_F**5,s=e.relHumidity_pct/100*n,i=Math.pow((br-.00356616*t)/br,5.25588),c=Wr*e.barometer_inHg/vo*i,a=c-s,l=a/Wr,u=s*Or/(a*Er),h=qr*(1/Er+u/Or)/(1+u),_=h/(qr/Er),g=e.temperature_F+Wo,d=g/br,p=144*c/(h*g)/32.174;let m,S;switch(r){case 1:m=1,S=1;break;case 2:m=1,S=2;break;case 3:m=2,S=1;break;case 4:m=2,S=2;break;case 5:m=3,S=2;break;case 6:m=1,S=3;break;case 7:case 9:m=2,S=3;break;case 8:m=3,S=3;break;default:m=1,S=1;break}const E=1+2.48*Math.pow(u,1.5);let C,H,x;switch(m){case 1:C=1,H=.6,x=.15;break;case 2:C=1,H=.3,x=.13;break;case 3:C=.85,H=.5,x=.055;break;default:C=1,H=.6,x=.15;break}if(S===2&&(x=x-.005),S===3){const K=.3050108932461874;C=.95-K*H,H=H+K,x=.6*x}let F=Math.pow(l,C)/(Math.sqrt(_)*Math.pow(d,H));return F=(1+x)*E/F-x,r===9&&(F=1),{rho_slug_per_ft3:p,pamb_psi:c,PWV_psi:s,pair_psi:a,WAR:u,RGAS:h,temp_R:g,hpc:F,delta:l,theta:d,rgrs:_}}function Vo(e,t,r,o=.025,n=.01){const s=o-r/1320*n,i=3600/5280,c=s*e,a=1e-4*e*(i*t);return c+a}function $o(e,t,r,o,n=.025,s=.01){return Vo(e,t,r,n,s)*o}function Bo(e,t,r,o,n=1){let s=t,i=o*e/s;n>2&&i>.6&&(s=s*(1+(o-1)*(i-.6)/(1/o-.6)),i=o*e/s);let c=1/o,a=o*e,l=1;return a<s&&(a=s,l=r-(r-1)*i,c=l*e/s),c>1&&(c=1),{work:l,coupling:c,slipRatio:i,zStall:s,engRPM:a}}const Uo=10.8;function Kr(e){const{tireDia_in:t,tireWidth_in:r,dynamicRWT_lbf:o,tractionIndexAdj:n,bodyStyle:s}=e,i=.92+.08*Math.pow(o/1900,2.15);let c=n*Uo*t*(r+1)*i;return s===8&&(c=.5*c),c}function Qo(e){const{weight_lbf:t,tireGrowth:r,dragForce_lbf:o}=e;return(Kr(e)/r-o)/t*I}function Jo(){return Pe*I}function Ko(e,t,r,o){let n=e,s=t,i=0;return n>o&&(i=1,s=s*(o-(n-o))/n,n=o-(n-o)),n<r&&(s=s*r/n,n=r),{AGS:n,PQWT:s,SLIP:i}}function Xo(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function jo(e,t,r,o){return e+t*Math.pow(r*o,2)}function Yo(e,t,r){return e*t*60/r}function Zo(e,t,r,o,n=!0){let s=o*t*(t-e);s<0&&(s=n?Ur*s:Qr*s);const i=Math.pow(2*Ye/60,2)/(12*550*r);return s*i}function zo(e,t,r,o){let n=o*t*(t-e);n<0&&(n=0);const s=Math.pow(2*Ye/60,2)/(12*550*r);return n*s}function en(e,t,r,o){const n=Math.PI,s=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));let i=1+s*135e-7*Math.pow(r,1.6);const c=1+s*35e-5*r;c<i&&(i=c);const a=o/32.174,l=i-.035*Math.abs(a),u=l*e*n/12,h=12*u/(2*n),_=2*h,g=h/12;return{growth:i,squat:l,dia_eff_in:_,radius_eff_ft:g,circumference_eff_ft:u}}function tn(e,t,r,o,n){const a=(t-1)*r/2*o*(n?1:2)/144;return e+a}function rn(e,t,r,o){if(e>=t-1)return!1;const n=o[e];if(!n||n<=0)return!1;const i=(o[0]??0)>8e3?20:10;return Math.abs(n-r)<i}var Xr=(e=>(e[e.NORMAL=0]="NORMAL",e[e.TRIGGERED=1]="TRIGGERED",e[e.EXECUTING=2]="EXECUTING",e))(Xr||{});function on(e,t){switch(e){case 0:return t?{newState:1,executeShift:!1}:{newState:0,executeShift:!1};case 1:return{newState:2,executeShift:!0};case 2:return{newState:0,executeShift:!1};default:return{newState:0,executeShift:!1}}}function nn(e){return e?.2:.25}function sn(e,t,r,o){return r>=o||!t||t<=0?!1:G.sub(R(e),R(t))>=0}function ln(e,t=3,r=1){const o=.005*(t-1)+3*(r-1),n=e/1320;return 1.02+o*(1-Math.pow(n,2))}function cn(e,t,r,o,n,s,i=.04,c=.9){const a=e*t*(r-o+i/c*o),l=s*r;return(a+l)/n}function an(e,t,r,o,n,s,i,c,a=.04,l=.9){const u=cn(r,e,o,n,s,i,a,l);let h=t-u,_=0;h<0&&(_=-h*s/64,h=0);let g=c-h-_;return g<0&&(g=e),{rear_weight_lbf:g,front_weight_lbf:h,wheelie_bar_weight_lbf:_}}function fn(e,t,r,o){const n=2*o*r,s=Math.sqrt(e*e+n),i=2*o*r+e*e,c=Math.pow(i,1.5),a=Math.pow(e,3),l=(c-a)/(3*o)+t;return{Vel_ftps:s,Dist_ft:l}}function un(e,t,r){let o=e,n=1,s=0;if(o>r){s=1;const i=o-r,c=r-i;n=c/o,o=c}return o<t&&(n=t/o,o=t),{AGS_ftps2:o,PQWT_scale:n,slip:s}}function hn(e,t){return e/(t*I)}function _n(e,t,r){if(r<=0)return Math.max(.005,Math.min(.05,e));let o=e*Math.pow(t/r,4);return o>.05&&(o=.05),o<.005&&(o=.005),o}function dn(e,t,r,o){const n=t*r/o;let s=e*.11*Math.pow(n,-1/3);return s=s/15,s<.005&&(s=.005),s}function gn(e){if(!e)return 1;const t=e.toUpperCase();return t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")||t.includes("FUEL INJECT")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function pn(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const o=Number(e.torque)*r/5252*t;return{rpm:r,hp:o}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const o=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:o}}return null}function Jt(e,t=1){return e.map(r=>Array.isArray(r)?{rpm:Number(r[0]),hp:Number(r[1])*t}:pn(r,t)).filter(r=>r!==null&&Number.isFinite(r.rpm)&&Number.isFinite(r.hp)).sort((r,o)=>r.rpm-o.rpm)}function mn(e){var a,l,u,h,_;const t=((a=e==null?void 0:e.fuel)==null?void 0:a.hpTorqueMultiplier)??1,r=[],o=(l=e==null?void 0:e.engineParams)==null?void 0:l.powerHP;if(Array.isArray(o)&&(r.push(`engineParams.powerHP(${o.length})`),o.length>=2)){const g=Jt(o,t);if(g.length>=2)return{powerHP:g}}const n=e==null?void 0:e.engineHP;if(Array.isArray(n)&&(r.push(`engineHP(${n.length})`),n.length>=2)){const g=Jt(n,t);if(g.length>=2)return{powerHP:g}}const s=(u=e==null?void 0:e.engineParams)==null?void 0:u.torqueCurve;if(Array.isArray(s)&&(r.push(`engineParams.torqueCurve(${s.length})`),s.length>=2)){const g=Jt(s,t);if(g.length>=2)return{powerHP:g}}const i=(h=e==null?void 0:e.vehicle)==null?void 0:h.torqueCurve;if(Array.isArray(i)&&(r.push(`vehicle.torqueCurve(${i.length})`),i.length>=2)){const g=Jt(i,t);if(g.length>=2)return{powerHP:g}}const c=(_=e==null?void 0:e.vehicle)==null?void 0:_.hpCurve;if(Array.isArray(c)&&(r.push(`vehicle.hpCurve(${c.length})`),c.length>=2)){const g=Jt(c,t);if(g.length>=2)return{powerHP:g}}throw new Error(`RSACLASSIC: missing power curve. Sources found: [${r.join(", ")||"none"}]. Keys(engineParams)=${JSON.stringify(Object.keys((e==null?void 0:e.engineParams)||{}))} Keys(vehicle)=${JSON.stringify(Object.keys((e==null?void 0:e.vehicle)||{}))}`)}function Ie(e,t=0){return Number.isFinite(e)?Number(e):t}function jr(e,t){const r=t.map(o=>[o.rpm,o.hp]);return Ao(e,r)}function Yr(e,t,r){const o=jr(e,t);if(e<=0)return R(0);const n=G.div(G.mul(R(5252),o),R(e));return G.mul(n,R(r))}function Mn(e,t,r,o=t){const n=Number(e);return Number.isFinite(n)?Math.min(r,Math.max(t,n)):o}function Pn(e){return Math.max(.85,Math.min(1,e))}class Tn{constructor(){fr(this,"id","RSACLASSIC")}simulate(t){var tr,rr,Mt,or,y,he,Q,O;const r=!!((tr=t==null?void 0:t.flags)!=null&&tr.vb6Strict);r&&console.log("[RSACLASSIC] VB6-STRICT mode enabled - using Float32 math");const o=Date.now(),n=9e4,s=2e6,i=5e4;let c=0;function a(P,L){if(Date.now()-o>n)throw new Error("simulation wall-time exceeded");if(P>=s)throw new Error("simulation step cap hit");if(P%i===0){const N=L-c;if(console.log("[RSACLASSIC] heartbeat",{step:P,dist_ft:L,gained_ft:N}),P>0&&N<.001)throw new Error("simulation stalled");c=L}}const l=Number((t==null?void 0:t.raceLengthFt)??1320);if(!Number.isFinite(l)||l<=0)throw new Error(`invalid raceLengthFt: ${t==null?void 0:t.raceLengthFt}`);const u=Number((t==null?void 0:t.timeStep)??.002);if(!Number.isFinite(u)||u<=0)throw new Error(`invalid timeStep ${u}`);const _=mn(t).powerHP;if(console.log("[RSACLASSIC] start",{raceLenFt:l,hpPts:_.length}),!Array.isArray(_)||_.length<2)throw new Error(`RSACLASSIC: powerHP invalid (len=${(_==null?void 0:_.length)??0})`);const g=(t==null?void 0:t.drivetrain)??{},d=(t==null?void 0:t.vehicle)??{},M=g.clutch??(t==null?void 0:t.clutch)??d.clutch,p=g.converter??(t==null?void 0:t.converter)??d.converter,m=!!M,S=!!p,E=m?Number(M.slipRPM??M.slipRpm):NaN,C=m?Number(M.launchRPM??M.launchRpm):NaN,H=S?Number(p.stallRPM??p.stallRpm):NaN,x=m?Number(M.slippageFactor??M.slipRatio??1.0025):1,F=S?Number(p.slippageFactor??p.slipRatio??1.05):1;if(!m&&!S)throw new Error("RSACLASSIC: drivetrain must specify clutch or converter");if(m&&!Number.isFinite(E))throw new Error("RSACLASSIC: clutch.slipRPM missing/invalid");if(S&&!Number.isFinite(H))throw new Error("RSACLASSIC: converter.stallRPM missing/invalid");const K=m?Number.isFinite(C)?C:E:H;console.log("[RPM-RESOLVED]",{isClutch:m,isConverter:S,slipRPM:E,launchRPM:C,stallRPM:H,rpmPin:K});const Te=(t==null?void 0:t.tuning)??{},Ge=Number.isFinite(Te.aeroCdScale)?Te.aeroCdScale:1,ke=Number.isFinite(Te.drivelineEffOffset)?Te.drivelineEffOffset:0,{vehicle:T,env:U,raceLength:ve}=t,V=[],Z=ve==="EIGHTH"?660:1320,We=T.cd,Ce=T.frontalArea_ft2,j=T.transEff,ce=T.finalDrive??T.rearGear,Y=T.gearRatios,z=T.gearEff,oe=T.shiftRPM;We||V.push("Missing vehicle.cd (drag coefficient) - required for VB6 parity"),Ce||V.push("Missing vehicle.frontalArea_ft2 - required for VB6 parity"),(!Y||Y.length===0)&&V.push("Missing vehicle.gearRatios[] - required for VB6 parity"),(!oe||oe.length===0)&&V.push("Missing vehicle.shiftRPM[] - required for VB6 parity"),ce||V.push("Missing vehicle.finalDrive or vehicle.rearGear - required for VB6 parity"),U.barometerInHg===void 0&&V.push("Missing env.barometerInHg - required for VB6 air density"),U.temperatureF===void 0&&V.push("Missing env.temperatureF - required for VB6 air density"),U.humidityPct===void 0&&V.push("Missing env.humidityPct - required for VB6 air density"),U.elevation===void 0&&V.push("Missing env.elevation - required for VB6 air density");const Se=T.tireRolloutIn??null,Ze=T.tireDiaIn??null,ze=Math.PI;let w=(typeof Se=="number"&&Se>0?Se/ze:null)??Ze??0;(!w||w<=0)&&(V.push("Tire diameter is undefined/invalid. Provide tireRolloutIn or tireDiaIn."),w=28);const de=T.rolloutIn;de||V.push("Missing vehicle.rolloutIn - required for VB6 parity");const ae=t.fuel,W=gn(ae),fe=Jr({barometer_inHg:U.barometerInHg??29.92,temperature_F:U.temperatureF??59,relHumidity_pct:U.humidityPct??50,elevation_ft:U.elevation??0,fuelSystem:W}).rho_slug_per_ft3,et=So(T.weightLb),ge=(de??12)/12;let ue=null,v=0;const ne=30,tt=.01,At=_.reduce((P,L)=>Math.max(P,L.hp),0),Kt=p?p.torqueMult??1.7:1,Re=(T.rolloutIn??12)/12,Oe=dn(Re>0?Re:1,At,Kt,T.weightLb);let He=0,A=Oe,f=Io(),se=0;const Xt=[];let at=0,qe=0,Le=0;const ft=[];let rt=!1,wt=0;const jt=[60,330,660,1e3,Z];let ut=0,ht=0,xt=0,It=0,xr=0,Yt=0,Ir=0,Ne=0,ot=1,ee;f.rpm=K;const vt=t.fuel;let Ct=1,_t=1,yt=0,b=0,dt=0,Ht=0,Lt=0,Nt=0,Dt=0,Zt=0,Gt=0,Fe=0;if(M||p){const P=ur(K,_,j??.9),L=K>0?P*K/5252:0,te=L>0&&K>0?5252*L/K:0,N=(Y??[1])[0]??1,D=te*N*(j??.9)*(ce??3.73)*(j??.9)/(1.02*w/24);Fe=(p?.96:.88)*D/T.weightLb,Fe<Pe&&(Fe=Pe)}const zt=6,kt=5;let pe=K,me=0,Ve=Xr.NORMAL,Me=0,er=0;const gr=P=>z&&z[P]!==void 0?Math.max(.9,Math.min(1,z[P])):j??.9,nt=()=>{const P=g.overallEff??g.overallEfficiency??j??.97;return Pn(P+ke)},$e=P=>{const L=U.tractionIndex??3;return ln(P,L,1)};for(;;){v++,a(v,f.s_ft);const P=en(w,T.tireWidthIn??17,f.v_fps,Fe),L=P.radius_eff_ft,te=P.circumference_eff_ft,N=P.dia_eff_in;let be=xo(f.v_fps,f.gearIdx,g),Be=be,D=1,$=0,Ue=0,Qe=0;const ie=gr(f.gearIdx);r?Yr(be,_,ie):ur(be,_,ie);let Pt=1;if(vt==="METHANOL"){const q=U.trackTempF;q!==void 0&&q<80&&f.t_s<.8&&(Pt=1.025-.025*f.t_s/.8)}else if(vt==="NITRO"){if(f.t_s<.4)Pt=.9;else if(f.t_s<1){const q=(f.t_s-.4)/.6;Pt=.9+(1-.9)*q}}Ct=Math.min(Ct,Pt),_t=Math.max(_t,Pt);const nr=(Y??[1])[f.gearIdx]??1,vr=$e(f.s_ft)*f.v_fps*60/te;v===1&&typeof console<"u"&&console.debug&&console.debug("[RPM-DEBUG]",{isClutch:m,isConverter:S,slipRPM:E,launchRPM:C,stallRPM:H,calculated_slipRPM:E,rpm_from_speed:be});const st=vr*nr*(ce??3.73);let J=(m?x:F)*st;const ss=f.gearIdx===0,is=!0,sr=m?E:H;(m||S)&&(ss||is)&&J<sr&&(J=sr);const pr=J===sr&&st<sr,io=sr;if(Be=J,r?Yr(J,_,ie):ur(J,_,ie),M)D=J>1?Math.max(0,Math.min(1,st/J)):0,ot=Math.min(ot,D);else if(p){const q=p.torqueMult??2,B=Bo(st,H,q,F,v);D=B.coupling,$=B.work,Ue=B.slipRatio,Qe=B.zStall,xr+=B.work,Yt+=B.coupling,Ir+=B.slipRatio,Ne++,ot=Math.min(ot,D)}else Be=be;f.rpm=Be;const qt=Ie(f.v_fps,0),lo=U.windMph??0,ls=U.windAngleDeg??0,Cr=lo/_e,cs=ls*Math.PI/180,as=Math.sqrt(qt*qt+2*qt*Cr*Math.cos(cs)+Cr*Cr),fs=T.bodyStyle===8,mr=tn(Ce??0,P.growth,w,T.tireWidthIn??17,fs);let Mr,Tt,ir,Pr;const yr=lo!==0?as:qt;if(r){const q=R(yr);Mr=G.mul(q,q),Tt=G.mul(G.mul(R(.5),R(fe)),Mr),ir=G.mul(G.mul(G.mul(Tt,R(We??0)),R(Ge)),R(mr)),Pr=G.mul(G.mul(Tt,R(T.liftCoeff??0)),R(mr))}else Mr=yr*yr,Tt=Ie(.5*fe*Mr,0),ir=Ie(Tt*(We??0)*Ge*mr,0),Pr=Ie(Tt*(T.liftCoeff??0)*mr,0);const Hr=Ie(T.weightLb-Pr,T.weightLb),St=ir,us=Hr,hs=T.rrCoeff??Ar,_s=$o(us,qt,f.s_ft,L,hs,.01),Je=Ie(_s/L,0),ds=1,gs=U.tractionIndex??3,Lr=Xo(gs,ds),ps=v===1?0:Gt,ms=T.wheelbaseIn??108,Ms=w/2+3.75,Ps=T.staticFrontWeightLb??T.weightLb*.38,lr=an(T.weightLb,Ps,ps,Ms,L*12,ms,St+Je,Hr,1.03,nt()),Vt=lr.rear_weight_lbf,Ke=Qo({weight_lbf:T.weightLb,tireDia_in:w,tireWidth_in:T.tireWidthIn??17,dynamicRWT_lbf:Vt,tractionIndexAdj:Lr,tireGrowth:P.growth,dragForce_lbf:St+Je,bodyStyle:void 0}),Ee=Jo();if(v<=12&&typeof console<"u"&&console.log){const q=Kr({weight_lbf:T.weightLb,tireDia_in:w,tireWidth_in:T.tireWidthIn??17,dynamicRWT_lbf:Vt,tractionIndexAdj:Lr,bodyStyle:void 0});console.log("[TRACTION]",{step:v,CAXI:+Lr.toFixed(4),AX:10.8,tireDia_in:+w.toFixed(2),tireWidth_in:+(T.tireWidthIn??17).toFixed(1),dynamicRWT_lbf:+Vt.toFixed(1),weightFactor:+(.92+.08*Math.pow(Vt/1900,2.15)).toFixed(4),CRTF:+q.toFixed(1),tireGrowth:+P.growth.toFixed(4),dragForce_lbf:+(St+Je).toFixed(2),AMin_ftps2:+Ee.toFixed(3),AMax_ftps2:+Ke.toFixed(3),AMin_g:+(Ee/I).toFixed(4),AMax_g:+(Ke/I).toFixed(4)})}let le,Ae;if(v<=zt&&st<kt){const q=ur(K,_,ie),B=S?p.torqueMult??2:1,re=qo({engineTorque_lbft_atSlip:q,gearRatio:nr,transEff:ie,drivelineEff:nt(),finalDrive:ce??3.73,tireDia_in:w,tireSlip:$e(f.s_ft),dragForce_lbf:St+Je,vehicleWeight_lbf:T.weightLb,isAutoTrans:!!p,torqueMult:B});Ae=re.netThrust_lbf/T.weightLb*I;const lt=Ko(re.Ags0_ftps2,Ae,Ee,Ke);if(le=lt.AGS,Ae=lt.PQWT,v<=10&&typeof console<"u"&&console.debug){const ct=re.Ags0_ftps2/I,cr=nr*(ce??3.73);console.debug("[STEP]",{step:v,phase:pr?"PINNED":"BOOTSTRAP",v_fps:f.v_fps.toFixed(6),EngRPM:Be.toFixed(0),LockRPM:st.toFixed(2),slipRPM:E.toFixed(0),lockThreshold:io.toFixed(0),rpmIsPinned:pr,clutchSlip:D.toFixed(6),gear:f.gearIdx+1,GRxFD:cr.toFixed(3),tireDia_eff_in:N.toFixed(2),tireGrowth:P.growth.toFixed(4),tireSlip:$e(f.s_ft).toFixed(4),RWTdyn_lbf:Vt.toFixed(1),RWTfront_lbf:lr.front_weight_lbf.toFixed(1),wheelieBar_lbf:lr.wheelie_bar_weight_lbf.toFixed(1),AGS_g:ct.toFixed(4),AGS_ftps2:le.toFixed(4),AMin_ftps2:Ee.toFixed(4),AMax_ftps2:Ke.toFixed(4),SLIP:lt.SLIP})}}else{let q=r?jr(J,_):Rr(J,_);Me>0&&(q=0,Me=Math.max(0,Me-A),Me===0&&typeof console<"u"&&console.debug&&console.debug("[SHIFT_DWELL_END]",{step:v,t_s:f.t_s.toFixed(4),v_fps:f.v_fps.toFixed(2)}));const B=q,re=r?G.div(G.mul(G.add(R(St),R(Je)),R(f.v_fps)),R(550)):(St+Je)*f.v_fps/550;v<=12&&typeof console<"u"&&console.log&&console.log("[PRE_HP_CHAIN]",{step:v,EngRPM_out:+J.toFixed(0),wheelRPM:+vr.toFixed(2),ClutchSlip:+D.toFixed(4),...p?{converterWork:+$.toFixed(4)}:{},HPSave:+B.toFixed(1),DragHP:+re.toFixed(2),F_drag_lbf:+ir.toFixed(2),F_roll_lbf:+Je.toFixed(2),v_fps:+f.v_fps.toFixed(2),tireSlip:+$e(f.s_ft).toFixed(4),currentGearEff:+ie.toFixed(4),drivelineEff:+nt().toFixed(4),dt_s:+A.toFixed(4),RPM0:+pe.toFixed(0),DSRPM0:+me.toFixed(2)});const lt=Yo($e(f.s_ft),f.v_fps,te);let ct,cr,Tr;if(((rr=T.pmi)==null?void 0:rr.engine_flywheel_clutch)!==void 0)ct=T.pmi.engine_flywheel_clutch,cr=T.pmi.transmission_driveshaft??0,Tr=T.pmi.tires_wheels_ringgear??0;else{ct=500/120;const De=(Y==null?void 0:Y.length)??5;cr=m?De*ct/50:(De-1)*ct/10,Tr=2*(1.15*.8*(.08*w*(T.tireWidthIn??17))*Math.pow(w/2,2)/386)}const _o=jo(Tr,cr,ce??3.73,nr),$t=Zo(pe,J,A,ct,m),Bt=zo(me,lt,A,_o);v<=12&&typeof console<"u"&&console.log&&console.log("[PMI_CALC]",{step:v,EngRPM:+J.toFixed(0),RPM0:+pe.toFixed(0),RPM_delta:+(J-pe).toFixed(0),DSRPM:+lt.toFixed(2),DSRPM0:+me.toFixed(2),DSRPM_delta:+(lt-me).toFixed(2),enginePMI:+ct.toFixed(3),chassisPMI:+_o.toFixed(3),HPEngPMI:+$t.toFixed(1),HPChasPMI:+Bt.toFixed(1)}),pe=J,me=lt,Lt+=$t*550*A,Nt+=Bt*550*A;let Ut,Xe;const go=$e(f.s_ft);if(r){Ut=G.mul(G.sub(R(B),R($t)),R(D)),Xe=Ut;const Qt=G.mul(G.mul(R(Xe),R(ie)),R(nt())),De=G.sub(Qt,R(Bt)),je=G.div(De,R(go));Xe=G.sub(je,R(re))}else Ut=(B-$t)*D,Xe=Ut,Xe=(Xe*ie*nt()-Bt)/go-re;const Dr=Xe;at=B,qe=Dr,Le=re,Ae=r?G.div(G.mul(G.mul(R(550),R(I)),R(Xe)),R(T.weightLb)):550*I*Xe/T.weightLb;let Sr=hn(Ae,f.v_fps);if(A>0&&A<=.01&&v>1){const Qt=Sr/I,De=Fe/I;let je=(Qt-De)/A;if(je<Ft){je=Ft;const ar=De+je*A;Sr=ar*I,Ae=ar*I*f.v_fps}if(je>bt){je=bt;const ar=De+je*A;Sr=ar*I,Ae=ar*I*f.v_fps}}const Gr=un(Sr,Ee,Ke);le=Gr.AGS_ftps2,Ae=Ae*Gr.PQWT_scale;const ws=Gr.slip;le=Mn(le,Ee,Ke,Ee);const po=le/I;po>He&&(He=po);const mo=Fe/I;if(mo>0&&v>1&&(A=_n(Oe,He,mo)),v<=12&&typeof console<"u"&&console.log&&console.log("[CONSOLIDATED_ROW]",{step:v,v_ftps:+f.v_fps.toFixed(3),EngRPM:+J.toFixed(0),wheelRPM:+vr.toFixed(2),ClutchSlip:+D.toFixed(4),HPSave:+B.toFixed(1),HPEngPMI:+$t.toFixed(1),HPChasPMI:+Bt.toFixed(1),DragHP:+re.toFixed(2),HP_afterL1:+Ut.toFixed(1),HP_afterL2:+Dr.toFixed(1),PQWT:+Ae.toFixed(1),AMin:+Ee.toFixed(3),AMax:+Ke.toFixed(3),AGS_applied:+le.toFixed(3)}),v<=20&&typeof console<"u"&&console.log&&console.log("[AERO_TRACE]",{step:v,v_fps:+qt.toFixed(6),rho_slug_per_ft3:+fe.toFixed(6),q_psf:+Tt.toFixed(3),F_drag_lbf:+ir.toFixed(2),F_lift_up_lbf:+Pr.toFixed(2),normal_lbf:+Hr.toFixed(2),F_roll_lbf:+Je.toFixed(2),AMin_ftps2:+Ee.toFixed(3),AMax_ftps2:+Ke.toFixed(3),AGS_ftps2:+le.toFixed(3)}),v<=10&&typeof console<"u"&&console.debug){const Qt=le/I,De=nr*(ce??3.73);console.debug("[STEP]",{step:v,phase:pr?"PINNED":"HP",v_fps:f.v_fps.toFixed(6),EngRPM:Be.toFixed(0),LockRPM:st.toFixed(2),slipRPM:E.toFixed(0),lockThreshold:io.toFixed(0),rpmIsPinned:pr,clutchSlip:D.toFixed(6),gear:f.gearIdx+1,GRxFD:De.toFixed(3),tireDia_eff_in:N.toFixed(2),tireGrowth:P.growth.toFixed(4),tireSlip:$e(f.s_ft).toFixed(4),RWTdyn_lbf:Vt.toFixed(1),RWTfront_lbf:lr.front_weight_lbf.toFixed(1),wheelieBar_lbf:lr.wheelie_bar_weight_lbf.toFixed(1),rho_slug_ft3:fe.toFixed(6),dragHP:re.toFixed(2),...p?{converterWork:$.toFixed(4),converterSlipRatio:Ue.toFixed(4),converterZStall:Qe.toFixed(0)}:{},HP_engine:B.toFixed(1),HPEngPMI:$t.toFixed(1),HPChasPMI:Bt.toFixed(1),HP_afterLine1:Ut.toFixed(1),HP_afterLine2:Dr.toFixed(1),AGS_g:Qt.toFixed(4),AGS_ftps2:le.toFixed(4),AMin_ftps2:Ee.toFixed(4),AMax_ftps2:Ke.toFixed(4),SLIP:ws})}}Fe=le;const co=Rr(J,_);yt+=co*550*A;const ao=f.v_fps*A;b+=St*ao,dt+=Je*ao;const Ts=1-ie,Ss=1-nt(),Rs=Ts+Ss;Ht+=co*550*A*Rs;const Fs=Ie(f.v_fps,0),bs=Ie(f.s_ft,0),Es=Ie(le,Ee),fo=Ie(Ae,0),it=fn(Fs,bs,A,fo);if(v<=12&&typeof console<"u"&&console.log&&console.log("[INTEGRATED]",{step:v,Vel_next:+it.Vel_ftps.toFixed(3),Dist_next:+it.Dist_ft.toFixed(6)}),!Number.isFinite(it.Vel_ftps)||!Number.isFinite(it.Dist_ft))throw new Error(`NaN in state @ step=${v} v=${it.Vel_ftps} dist=${it.Dist_ft} AGS=${Es} PQWT=${fo}`);if(f.v_fps=it.Vel_ftps,f.s_ft=it.Dist_ft,f.t_s=f.t_s+A,!Number.isFinite(f.v_fps)||!Number.isFinite(f.s_ft)||!Number.isFinite(le))throw new Error(`NaN in state @ step=${v} v=${f.v_fps} dist=${f.s_ft} AGS=${le}`);if(Gt=le/I,f.s_ft>=Z){ue="DISTANCE";break}if(f.t_s>=ne){ue="TIME_CAP";break}const uo=(Y==null?void 0:Y.length)??1,As=(oe??[])[f.gearIdx]??0,ho=r?sn(J,As,f.gearIdx,uo-1):rn(f.gearIdx,uo,J,oe??[]);let Nr=!1;if(r)Nr=ho;else{const q=on(Ve,ho);Ve=q.newState,Nr=q.executeShift}if(Nr){const q=f.gearIdx,B=J;f.gearIdx++;const re=nn(m);Me=re,er+=re,typeof console<"u"&&console.debug&&console.debug("[SHIFT]",{step:v,t_s:f.t_s.toFixed(4),v_fps:f.v_fps.toFixed(2),from_gear:q+1,to_gear:f.gearIdx+1,EngRPM_before:B.toFixed(0),LockRPM:st.toFixed(0),dwell_s:re.toFixed(3)})}for(!rt&&f.s_ft>=ge&&(rt=!0,wt=f.t_s),ht===0&&f.s_ft>=594&&(ht=f.t_s),xt===0&&f.s_ft>=1254&&(xt=f.t_s);ut<jt.length&&f.s_ft>=jt[ut];){const q=jt[ut],B=rt?f.t_s-wt:0,re=f.v_fps*_e;ft.push({d_ft:q,t_s:B,v_mph:re}),ut++}if(f.t_s>=se){const B=(f.v_fps-It)/A/Oo;Xt.push({t_s:f.t_s,v_mph:f.v_fps*_e,a_g:B,s_ft:f.s_ft,rpm:f.rpm,gear:f.gearIdx+1,hp:qe>0?qe:void 0,engineHp:at>0?at:void 0,dragHp:Le>0?Le:void 0}),se+=tt,It=f.v_fps}}f.t_s>=ne&&V.push("max_time_exceeded");const gt=rt?f.t_s-wt:f.t_s,pt=f.v_fps*_e;let Wt,Ot;if(ht>0&&f.t_s>ht){const L=f.t_s-ht;L>0&&(Wt=_e*66/L)}if(xt>0&&f.t_s>xt){const L=f.t_s-xt;L>0&&(Ot=_e*66/L)}Dt=.5*et*f.v_fps*f.v_fps,ue||(ue="SAFETY"),typeof console<"u"&&console.debug&&console.debug("[RSACLASSIC END]",{reason:ue,t_s:f.t_s,steps:v,d_ft:f.s_ft,target_ft:Z,totalShiftDwell_s:er.toFixed(3)}),typeof console<"u"&&console.warn&&ue!=="DISTANCE"&&console.warn("Terminated without crossing finish:",{reason:ue,t_s:f.t_s,d_ft:f.s_ft,target_ft:Z}),(ft.length===0||ft[ft.length-1].d_ft!==Z)&&ft.push({d_ft:Z,t_s:gt,v_mph:pt});const mt={};Wt!==void 0&&(mt.e660_mph=Wt),Ot!==void 0&&(mt.q1320_mph=Ot);{const P=yt,L=b+dt+Ht+Lt+Nt,te=Dt+Zt,N=P-L-te;console.log(`
=== ENERGY SUMMARY: ${T.name??"Unknown"} ===`),console.log(`ET: ${gt.toFixed(3)}s, Trap MPH: ${pt.toFixed(1)}`),console.log(`
Energy In:`),console.log(`  Engine:           ${(yt/1e3).toFixed(1)} k-ft-lb`),console.log(`
Energy Out:`),console.log(`  Aero Drag:        ${(b/1e3).toFixed(1)} k-ft-lb (${(100*b/P).toFixed(1)}%)`),console.log(`  Rolling Resist:   ${(dt/1e3).toFixed(1)} k-ft-lb (${(100*dt/P).toFixed(1)}%)`),console.log(`  Driveline Loss:   ${(Ht/1e3).toFixed(1)} k-ft-lb (${(100*Ht/P).toFixed(1)}%)`),console.log(`  Engine PMI:       ${(Lt/1e3).toFixed(1)} k-ft-lb (${(100*Lt/P).toFixed(1)}%)`),console.log(`  Chassis PMI:      ${(Nt/1e3).toFixed(1)} k-ft-lb (${(100*Nt/P).toFixed(1)}%)`),console.log(`  Total Losses:     ${(L/1e3).toFixed(1)} k-ft-lb (${(100*L/P).toFixed(1)}%)`),console.log(`
Final Kinetic Energy:`),console.log(`  Translational:    ${(Dt/1e3).toFixed(1)} k-ft-lb (${(100*Dt/P).toFixed(1)}%)`),console.log(`  Rotational:       ${(Zt/1e3).toFixed(1)} k-ft-lb (${(100*Zt/P).toFixed(1)}%)`),console.log(`  Total Kinetic:    ${(te/1e3).toFixed(1)} k-ft-lb (${(100*te/P).toFixed(1)}%)`),console.log(`
Energy Balance:     ${(N/1e3).toFixed(1)} k-ft-lb (${(100*N/P).toFixed(1)}% error)`),console.log(`===
`)}const X={et_s:r?kr(gt,3):gt,mph:r?kr(pt,2):pt,timeslip:ft,traces:Xt.length>0?Xt:void 0,meta:{model:"RSACLASSIC",steps:Math.floor(f.t_s/A),warnings:V,windowMPH:Object.keys(mt).length>0?mt:void 0,converter:p&&!M?{used:!0,avgTR:Ne>0?xr/Ne:1,avgETA:Ne>0?Yt/Ne:1,avgSR:Ne>0?Ir/Ne:1,deRateMax:.3,parasiticConst:.05,parasiticQuad:1e-6}:void 0,clutch:M?{used:!0,minC:ot,lockupAt_ft:ee}:void 0,rollout:{rolloutIn:de??12,t_roll_s:wt},fuel:vt?{type:vt,minScale:Ct,maxScale:_t}:void 0,vb6:{dt_s:A,trapMode:"time",windowsFt:{eighth:{start:594,end:660,distance:66},quarter:{start:1254,end:1320,distance:66}},timeslipPoints:[60,330,660,1e3,1320],rolloutBehavior:"ET clock starts after rollout distance (TIMESLIP.FRM:1380)"},termination:{reason:ue,steps:v,t_s:f.t_s,target_ft:Z}}};return console.log("[RSACLASSIC] done",{et_s:+(((or=(Mt=X==null?void 0:X.et_s)==null?void 0:Mt.toFixed)==null?void 0:or.call(Mt,4))??(X==null?void 0:X.et_s)),mph:+(((he=(y=X==null?void 0:X.mph)==null?void 0:y.toFixed)==null?void 0:he.call(y,1))??(X==null?void 0:X.mph)),steps:((O=(Q=X==null?void 0:X.meta)==null?void 0:Q.termination)==null?void 0:O.steps)??v,wallMs:Date.now()-o}),X}}const Zr=new Tn;function _r(e,t,r,o,n){let s=0;for(s=0;s<r-1&&!(n<=e[s+1]);s++);s>=r-1&&(s=r-2),s<0&&(s=0);const i=e[s],c=e[s+1],a=t[s],l=t[s+1];if(c===i)return a;const u=(n-i)/(c-i);return a+u*(l-a)}function zr(e,t,r,o,n){let s,i;if(n)s=1+4e-5*r,i=s*e*Ye/12;else{const c=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));s=1+c*135e-7*Math.pow(r,1.6);const a=1+c*35e-5*r;a<s&&(s=a),i=(s-.035*Math.abs(o))*e*Ye/12}return{TireGrowth:s,TireCirFt:i}}function eo(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function to(e){return e?Ho:ko}function Sn(e,t){if(!(t!=null&&t.enabled))return 1;const{activateTime_s:r,duration_s:o,throttlePct:n,rampTime_s:s=0}=t,i=r+o;if(e<r||e>=i)return 1;const c=n/100;if(s>0&&e<r+s){const a=(e-r)/s;return 1-(1-c)*a}if(s>0&&e>i-s){const a=(i-e)/s;return 1-(1-c)*a}return c}function Rn(e,t,r,o,n){const s=e.Gear;let i;const c=e.Gear!==e.PrevGear;if(c)i=t.DTShift,e.PrevGear=e.Gear;else{if(i=o,e.Ags0_g>0&&e.L>1){const A=Math.min(e.AgsMax_g/e.Ags0_g,10);i=o*Math.pow(A,4)}i>.1&&(i=.1)}let a=0;const l=e.time_s-e.Time0_s;l>0&&(a=(e.AGS_g-e.Ags0_g)/l),a<Ft&&(a=Ft),a>bt&&(a=bt),e.Vel0_ftps=e.Vel_ftps,e.Ags0_g=e.AGS_g,e.Time0_s=e.time_s,e.Dist0_ft=e.Dist_ft,e.RPM0=e.EngRPM,e.DSRPM0=e.DSRPM,e.RPM0===t.LaunchRPM&&e.Time0_s===0&&(e.RPM0=t.Stall,t.LaunchRPM<t.Stall&&(e.Time0_s=t.EnginePMI*(t.Stall-t.LaunchRPM)/25e4));const u=zr(t.TireDia_in,t.TireWidth_in,e.Vel_ftps,e.Ags0_g,r.isLandSpeed);e.TireGrowth=u.TireGrowth,e.TireCirFt=u.TireCirFt;let h;r.isLandSpeed?h=1.01+(r.TractionIndex-1)*.01:h=1.02+(.005*(r.TractionIndex-1)+3*(r.TrackTempEffect-1))*(1-Math.pow(e.Dist0_ft/1320,2));const _=t.TGR[s-1]??1,g=t.TiresPMI+t.TransPMI*Math.pow(t.GearRatio,2)*Math.pow(_,2);let d=e.Vel0_ftps+e.Ags0_g*I*i+a*I*i*i/2;d<e.Vel0_ftps*.9&&e.Vel0_ftps>100&&(d=e.Vel0_ftps),d<0&&(d=0);const M=t.ShiftRPM[s-1]??9e3;if(!c&&(i<.005&&(i=.005),i>.05&&(i=.05),d=e.Vel0_ftps+e.Ags0_g*I*i+a*I*i*i/2,e.Vel0_ftps>0&&e.RPM0>t.Stall&&s<t.NGR)){const A=e.Vel0_ftps*(M+5)/e.RPM0;d>A&&(d=A,e.Ags0_g*I>0&&(i=(d-e.Vel0_ftps)/(e.Ags0_g*I)))}const p=d*d-e.Vel0_ftps*e.Vel0_ftps,m=h*d*60/e.TireCirFt,S=m*t.GearRatio*_;let E=t.Slippage*S,C,H=t.Stall,x=0;t.isClutch?(E<t.Stall&&(s===1||!t.LockUp)&&(E=t.Stall),C=S/E):s===1||!t.LockUp?(H=t.Stall,x=t.Slippage*S/H,e.L>2&&(x>.6&&(H=H*(1+(t.Slippage-1)*(x-.6)/(1/t.Slippage-.6))),x=t.Slippage*S/H),C=1/t.Slippage,E<H&&(E=H,C=(t.TorqueMult-(t.TorqueMult-1)*x)*S/H)):(E=1.005*S,C=S/E),C>1&&(C=1);let F=_r(t.xrpm,t.yhp,t.NHP,1,E);F=t.HPTQMult*F/r.hpc,t.RevLimiterRPM>0&&E>=t.RevLimiterRPM&&(F=F*.05);const K=Sn(e.time_s,n);F=F*K;const Te=F;F=F*C;const Ge=Math.sqrt(d*d+2*d*(r.WindSpeed_mph/hr)*Math.cos(Ye*r.WindAngle_deg/180)+Math.pow(r.WindSpeed_mph/hr,2)),ke=Math.sign(Ge)*r.rho*Math.pow(Math.abs(Ge),2)/(2*I);let T;t.BodyStyle===8?T=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*t.TireWidth_in/144:T=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*(2*t.TireWidth_in)/144;const U=t.Weight_lbf+t.LiftCoef*T*ke,ve=r.isLandSpeed?Vr:Ar,V=r.isLandSpeed?yo:Co,Z=r.isLandSpeed?Lo:Go,Ce=(ve-e.Dist0_ft/1320*V)*U+1e-4*U*(hr*d)+t.DragCoef*T*ke,j=Ce*d/550,ce=12*e.TireCirFt/(2*Ye),Y=(e.Ags0_g*t.Weight_lbf*(t.YCG_in-ce+Z/t.Efficiency*ce)+Ce*t.YCG_in)/t.Wheelbase_in;let z=t.StaticFWt_lbf-Y,oe=0;z<0&&(oe=-z*t.Wheelbase_in/64,z=0);let Se=U-z-oe;Se<0&&(Se=t.Weight_lbf);const Ze=eo(r.TractionIndex,r.TrackTempEffect),ze=to(r.isLandSpeed);let ye=Ze*ze*t.TireDia_in*(t.TireWidth_in+1)*(.92+.08*Math.pow(Se/1900,2.15));t.BodyStyle===8&&(ye=.5*ye);const w=(ye/e.TireGrowth-Ce)/t.Weight_lbf,de=t.TGEff[s-1]??.99;F=F*de*t.Efficiency/h;const ae=F;F=F-j;let W=550*I*F/t.Weight_lbf,k=W/(d*I),fe=!1;k>w&&(fe=!0,W=W*(w-(k-w))/k,k=w-(k-w)),k<Pe&&(k=Pe,W=Pe*I*d);let ge=Math.max(0,p)/(2*W)+e.Time0_s;const ue=r.isLandSpeed?No:Ur,v=r.isLandSpeed?Do:Qr;let ne=t.EnginePMI*E*(E-e.RPM0);ne<0&&(t.isClutch?ne=ue*ne:ne=v*ne);let tt=g*m*(m-e.DSRPM0);tt<0&&(tt=0);let At=0,Kt=0,Re=0;for(Re=1;Re<=12;Re++){const A=ge-e.Time0_s;if(A<=0)break;const f=Math.pow(2*Ye/60,2)/(12*550*A);At=ne*f,Kt=tt*f,F=(Te-At)*C,F=(F*de*t.Efficiency-Kt)/h-j,W=550*I*F/t.Weight_lbf,k=W/(d*I);let se=0;A!==0&&(se=(k-e.Ags0_g)/A),se<Ft&&(se=Ft,k=e.Ags0_g+se*A,W=k*I*d),se>bt&&(se=bt,k=e.Ags0_g+se*A,W=k*I*d),fe=!1,k>w&&(fe=!0,W=W*(w-(k-w))/k,k=w-(k-w)),k<Pe&&(W=W*Pe/k,k=Pe);const at=Math.max(0,p)/(2*W)+e.Time0_s,qe=at-e.Time0_s;if(Re===12||Math.abs(100*(qe-A)/qe)<=.01){ge=at;break}let Le=F/Te;Le<$r&&(Le=$r),Le>Br&&(Le=Br),ge=e.Time0_s+A+Le*(qe-A)}const Oe=ge-e.Time0_s;let He;if(W<.1||Oe<=0){const A=(e.Vel0_ftps+d)/2;He=e.Dist0_ft+Math.max(0,A*Math.abs(Oe))}else{const A=Math.pow(e.Vel0_ftps,3),f=2*W*Oe+e.Vel0_ftps*e.Vel0_ftps;if(f<0){const se=(e.Vel0_ftps+d)/2;He=e.Dist0_ft+se*Oe}else He=(Math.pow(f,1.5)-A)/(3*W)+e.Dist0_ft}return e.L+=1,e.time_s=ge,e.Vel_ftps=d,e.Dist_ft=He,e.AGS_g=k,e.EngRPM=E,e.DSRPM=m,e.SLIP=fe,{TimeStep_s:i,VelSqrd:p,LockRPM:S,ClutchSlip:C,zStall:H,SlipRatio:x,TireSlip:h,WindFPS:Ge,q:ke,RefArea2_ft2:T,DownForce_lbf:U,DragForce_lbf:Ce,DragHP:j,DynamicFWT_lbf:z,DynamicRWT_lbf:Se,WheelBarWT_lbf:oe,CRTF:ye,AMax_g:w,ChassisPMI:g,EngAccHP:ne,ChasAccHP:tt,HPSave:Te,HPAtWheels:ae,HP:F,PQWT:W,iterations:Re}}function Fn(e,t,r){const o=zr(e.TireDia_in,e.TireWidth_in,0,0,t.isLandSpeed),n=_r(e.xrpm,e.yhp,e.NHP,1,r);let c=5252*(e.HPTQMult*n/t.hpc)/r;const a=e.TGR[0]??1,l=e.TGEff[0]??.99;c=c*e.TorqueMult*a*l;const u=t.isLandSpeed?Vr:Ar,h=t.WindSpeed_mph/hr,_=Math.sign(h)*t.rho*Math.pow(Math.abs(h),2)/(2*I),g=u*e.Weight_lbf+e.DragCoef*e.RefArea_ft2*_;let d;t.isLandSpeed?d=1.01+(t.TractionIndex-1)*.01:d=1.02+(t.TractionIndex-1)*.005+(t.TrackTempEffect-1)*3;const M=c*e.GearRatio*e.Efficiency/(d*e.TireDia_in/24)-g;let m=(e.isClutch?.88:.96)*M/e.Weight_lbf,E=e.Weight_lbf-e.StaticFWt_lbf;E<0&&(E=e.Weight_lbf);const C=eo(t.TractionIndex,t.TrackTempEffect),H=to(t.isLandSpeed);let x=C*H*e.TireDia_in*(e.TireWidth_in+1)*(.92+.08*Math.pow(E/1900,2.15));e.BodyStyle===8&&(x=.5*x);const F=(x-g)/e.Weight_lbf;return m>F&&(m=F),m<Pe&&(m=Pe),{L:1,time_s:0,Vel_ftps:.001,Dist_ft:0,AGS_g:m,EngRPM:r,DSRPM:0,Gear:1,SLIP:!1,Vel0_ftps:0,Ags0_g:m,Time0_s:0,Dist0_ft:0,RPM0:r,DSRPM0:0,AgsMax_g:m,TireGrowth:o.TireGrowth,TireCirFt:o.TireCirFt,ShiftFlag:0,PrevGear:1}}function bn(e,t,r,o){let n=e*.11*Math.pow(t*r/o,-.3333333333333333);return n=n/15,n<.005&&(n=.005),n}function ro(e,t,r){let o=0,n=0,s=r-1;const i=e[0],c=e[r-1];if(t<=i)return o=1,s=1,{KBOTM:n,KTOP:s,JJ:o};if(t>=c)return o=1,n=r-2,s=r-1,{KBOTM:n,KTOP:s,JJ:o};for(;s-n>1;){const a=Math.floor((n+s)/2);t<e[a]?s=a:n=a}return{KBOTM:n,KTOP:s,JJ:o}}function wr(e,t,r,o,n){if(r<=0)return 0;if(r===1)return t[0];let s=0,i=1;if(r===2)s=0,i=1;else{const a=ro(e,n,r);s=a.KBOTM,i=a.KTOP;const l=a.JJ;if(s===i)return t[s];l!==1&&o>1&&(i=i+1,(o>=3||i>r-1)&&(i>r-1&&(i=r-1),s=s-1,s<0&&(s=0)))}let c=0;for(let a=s;a<=i;a++){let l=1;const u=e[a];for(let h=s;h<=i;h++)if(h===a)l=l*t[a];else{const _=e[h];l=l*(n-_)/(u-_)}c=c+l}return c}function En(e,t,r,o,n,s,i,c,a){const l=ro(t,a,n);let u=l.KBOTM,h=l.KTOP;l.JJ;const _=[],g=[];for(let p=u;p<=h;p++){const m=[];for(let E=0;E<o;E++)m.push(r[p*o+E]);const S=wr(e,m,o,s,c);_.push(S),g.push(t[p])}const d=h-u+1,M=Math.min(i,d);return wr(g,_,d,M,a)}function An(e){switch(e){case 1:case 2:return 1;case 3:case 4:return 1.08;case 5:return 5;case 6:return 2*1;case 7:case 9:return 2.5*1.08;case 8:return 1.5*5.5;default:return 1}}function wn(e){return e<=5}const xn=[.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],In=[.7,1.2,1.7,2.5,3.4],vn=[.53,.975,1.098,1.13,1.152,1.16,1.153,1.122,1.086,1.045,1,.938,.865,.795,.72,.63,.365,.87,1.018,1.066,1.11,1.129,1.132,1.11,1.079,1.042,1,.935,.855,.762,.66,.54,.24,.79,.96,1.023,1.08,1.106,1.117,1.102,1.074,1.04,1,.932,.845,.736,.612,.474,.1,.7,.894,.972,1.04,1.08,1.096,1.09,1.069,1.037,1,.928,.83,.698,.55,.39,0,.63,.84,.924,1,1.055,1.079,1.082,1.064,1.035,1,.923,.815,.662,.49,.31],oo=[0,.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],Et=[0,.7,1.2,1.7,2.5,3.4],Cn=[0,0,.61,.8,.9,.98,1.035,1.055,1.06,1.05,1.03,1,.93,.85,.765,.67,.58];function yn(e,t){return En(xn,In,vn,16,5,1,1,e,t)}function Hn(e){const{peakHP:t,peakRPM:r,displacement_cid:o,fuelSystem:n}=e,s=Fr*t/r,i=An(n);let c=t/o/i;n<=5?c<Et[1]&&(c=Et[1]):c<Et[2]&&(c=Et[2]),c>Et[5]&&(c=Et[5]);const a=[0],l=[0],u=[0],h=16;for(let _=1;_<=h;_++){a[_]=oo[_]*r;let g;n===8?g=Cn[_]*s:g=yn(oo[_],c)*s,l[_]=a[_]*g/Fr,u[_]=g}return{xrpm:a,yhp:l,ztq:u,NHP:h}}function Ln(e){const t=[],r=[];for(let o=1;o<=e.NHP;o++)t.push(e.xrpm[o]),r.push(e.yhp[o]);return{rpm:t,hp:r}}function Nn(e){return e>800?1:8}function Dn(e){switch(e){case 1:return{dragCoef:.66,liftCoef:.8,overhang_in:30};case 2:return{dragCoef:.5,liftCoef:.2,overhang_in:30};case 3:return{dragCoef:.52,liftCoef:.8,overhang_in:40};case 4:return{dragCoef:.52,liftCoef:.1,overhang_in:30};case 5:return{dragCoef:.28,liftCoef:.1,overhang_in:30};case 6:return{dragCoef:.4,liftCoef:.1,overhang_in:24};case 7:return{dragCoef:.46,liftCoef:.1,overhang_in:18};case 8:return{dragCoef:.54,liftCoef:.1,overhang_in:12};default:return{dragCoef:.5,liftCoef:.2,overhang_in:30}}}function Gn(e,t){const r=[];if(t){const o=e>=3?.985:.99;for(let n=1;n<=e;n++)r.push(o-(e-n)*2*.005)}else for(let n=1;n<=e;n++)r.push(.99-(e-n)*.005);return r}function kn(e,t,r,o,n,s,i){let c,a,l;return wn(t)?c=e/120:c=e/90,r?a=(o-1)*c/10:a=o*c/50,l=2*(1.15*.8*(.08*n*s)*Math.pow(n/2,2)/386),i===8&&(c=e/240,a=a/(240/120),l=l/2),{enginePMI:c,transPMI:a,tiresPMI:l}}function Wn(e){return e===8?.985:.97}function On(e){return 1.0025+e/1e6}function qn(e){const t=xe[e];return t?t.lengthFt:e==="EIGHTH"?660:1320}function Vn(e){const t=we[e];return t||(e==="EIGHTH"?we.EIGHTH:we.QUARTER)}function $n(e){if(!e)return 1;const t=e.toUpperCase();return t==="GASOLINE"?1:t==="GASOLINE EFI"?2:t==="METHANOL"?3:t==="METHANOL EFI"?4:t==="NITROMETHANE"?5:t==="SUPERCHARGED GASOLINE"?6:t==="SUPERCHARGED METHANOL"?7:t==="SUPERCHARGED NITRO"?8:t==="E85"||t==="DIESEL"||t==="GAS+CARB"||t==="GASOLINE+CARBURETOR"?1:t==="GAS+INJECT"||t==="GASOLINE+FUEL INJECTION"?2:t==="METHANOL+CARB"||t==="METHANOL+CARBURETOR"?3:t==="METHANOL+INJECT"||t==="METHANOL+FUEL INJECTION"?4:t==="NITRO+INJECT"||t==="NITROMETHANE+FUEL INJECTION"?5:t==="GAS+SUPERCHARGED"||t==="GASOLINE+SUPERCHARGED"?6:t==="METHANOL+SUPERCHARGED"?7:t==="NITRO+SUPERCHARGED"||t==="NITROMETHANE+SUPERCHARGED"?8:t==="ELECTRIC"?9:t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function Bn(e){const t=e.vehicle,r=e.engine??t.engine,o=(r==null?void 0:r.hpCurve)??(r==null?void 0:r.torqueCurve)??t.torqueCurve??t.hpCurve??[],n=[],s=[];for(const u of o)Array.isArray(u)?(n.push(u[0]),s.push(u[1])):u&&typeof u=="object"&&(n.push(u.rpm),u.hp!==void 0?s.push(u.hp):u.torque!==void 0?s.push(u.torque*u.rpm/5252):u.tq_lbft!==void 0&&s.push(u.tq_lbft*u.rpm/5252));if(n.length>=2)return{xrpm:n,yhp:s,NHP:n.length,isQuarterJr:!1};const i=Number(t.powerHP??t.peakHP),c=Number(t.rpmAtPeakHP??t.peakRPM??6500),a=Number(t.displacement_cid??t.displacementCID??350),l=e.fuelSystem??t.fuelSystem??1;if(Number.isFinite(i)&&i>0){const u=Hn({peakHP:i,peakRPM:c,displacement_cid:a,fuelSystem:l}),{rpm:h,hp:_}=Ln(u);return{xrpm:h,yhp:_,NHP:u.NHP,isQuarterJr:!0,quarterJrParams:{peakHP:i,rpmAtPeakHP:c,displacement_cid:a,fuelSystem:l}}}return{xrpm:[4e3,6500],yhp:[100,150],NHP:2,isQuarterJr:!1}}function no(e){const t=Math.abs(100-e);let r;return e>100?r=1+25e-7*Math.pow(t,2.5):r=1+2e-6*Math.pow(t,2.5),r>1.04&&(r=1.04),r}function Un(e,t){const r=[];r.push("  Time     Distance    MPH  Accel   Gear    RPM");const o=t/12;let n=!1,s=-.25;for(let i=0;i<e.length;i++){const c=e[i],a=c.t_s,l=c.s_ft,u=c.v_mph,h=c.a_g,_=c.gear,g=c.rpm;if(!n&&l>=o){n=!0;const S=c.slip?"(s)":"";r.push(`${a.toFixed(2).padStart(5)}/0.00 Rollout  ${u.toFixed(1).padStart(6)}  ${h.toFixed(2)}${S.padEnd(4)}    ${_}  ${g.toFixed(0).padStart(6)}`),s=a;continue}const d=i===0,M=a-s>=.24,p=i>0&&_!==e[i-1].gear,m=i===e.length-1;if(d||M||p||m){const S=c.slip?"(s)":"",E=l.toFixed(0).padStart(7);r.push(`${a.toFixed(2).padStart(6)}  ${E}  ${u.toFixed(1).padStart(6)}  ${h.toFixed(2)}${S.padEnd(4)}    ${_}  ${g.toFixed(0).padStart(6)}`),s=a}}return r.join(`
`)}function Qn(e){var gt,pt,Wt,Ot,mt,X,tr,rr,Mt,or;const t=[],r=[],o=e.vehicle,n=e.env,s=e.raceLength??"QUARTER",i=e.raceLengthFt??qn(s),c=((gt=xe[s])==null?void 0:gt.category)==="landspeed",a=o.rolloutIn??9,l=o.overhangIn??0;let u=2*a;u<24&&(u=24);let h=(l+.25*u)/12;const _=.5*u/12;h<_&&(h=_);const g=a/12,d=e.drivetrain??o.drivetrain,M=(d==null?void 0:d.clutch)??e.clutch??o.clutch,p=(d==null?void 0:d.converter)??e.converter??o.converter,m=e.engine??o.engine,S=e.pmi??o.pmi,E=e.throttleStop,C=E!=null&&E.enabled?{enabled:!0,activateTime_s:E.activateTime_s,duration_s:E.duration_s,throttlePct:E.throttlePct,rampTime_s:E.rampTime_s}:void 0,H=o.transmissionType??e.transmissionType,x=H==="clutch"?!0:H==="converter"?!1:!p||M&&!p,F=e.fuel,K=typeof F=="string"?F:(F==null?void 0:F.fuelType)??(F==null?void 0:F.fuelSystem)??(F==null?void 0:F.type)??e.fuelType??o.fuelType??e.fuelSystem??o.fuelSystem,Te=$n(K),Ge=Jr({barometer_inHg:n.barometerInHg??29.92,temperature_F:n.temperatureF??59,relHumidity_pct:n.humidityPct??50,elevation_ft:n.elevation??0,fuelSystem:Te}),ke=Ge.rho_slug_per_ft3*I,T=Ge.hpc,U=Bn(e),{xrpm:ve,yhp:V,NHP:Z,isQuarterJr:We,quarterJrParams:Ce}=U;Z<2&&t.push("HP curve has fewer than 2 points"),We&&t.push("Using QuarterJr mode (synthetic HP curve from peak HP)");const j=(d==null?void 0:d.gearRatios)??o.gearRatios??[2.5,1.8,1.4,1.1,1],ce=(d==null?void 0:d.finalDriveRatio)??o.finalDrive??o.rearGear??3.73,Y=j.length,z=o.tire,oe=(z==null?void 0:z.diameter_in)??o.tireDiaIn??32,Se=(z==null?void 0:z.width_in)??o.tireWidthIn??17,Ze=o.bodyStyle??Nn(o.weightLb);let ze,ye,w,de,ae,W,k,fe,et,ge,ue,v;if(We&&Ce){const{displacement_cid:y,fuelSystem:he}=Ce;ze=Gn(Y,!x);const Q=o.shiftRPM??(d==null?void 0:d.shiftRPM)??7e3;ye=j.map(()=>Q);const O=(M==null?void 0:M.slipRPM)??(p==null?void 0:p.stallRPM)??o.slipStallRPM??5e3;if(x)de=On(O),ae=1,w=O;else{const te=(p==null?void 0:p.diameter_in)??(p==null?void 0:p.diameter)??o.converterDiameterIn??o.converterDia_in??10;let N;if(O>220){w=O;const D=wr(ve,V,Z,1,w)*(Fr/w)/T;N=w/1e3*(w/D)}else N=O,w=O;const be=N/(200*Math.pow(7/te,4));de=1.01+be/20+N/8e3,ae=2.633-Math.pow(be,.3)-N/1500,ae<1&&(ae=1),ae>2&&(ae=2)}et=Wn(Ze);const P=Dn(Ze);ge=P.dragCoef,ue=P.liftCoef,v=P.overhang_in;const L=kn(y,he,!x,Y,oe,Se,Ze);W=L.enginePMI,k=L.transPMI,fe=L.tiresPMI}else{ze=(d==null?void 0:d.perGearEff)??o.gearEfficiencies??o.gearEff??null??j.map(()=>.99);const he=(d==null?void 0:d.shiftRPMs)??(d==null?void 0:d.shiftsRPM)??o.shiftRPMs??o.shiftsRPM??o.shiftRPM??j.map(()=>7e3),Q=j.length-1;Array.isArray(he)&&he.length>Q?(ye=he.slice(0,Q),t.push(`Shift RPMs trimmed from ${he.length} to ${Q} values`)):ye=he;const O=(M==null?void 0:M.slipRPM)??o.clutchSlipRPM??7200,P=(p==null?void 0:p.stallRPM)??o.converterStallRPM??5500;w=x?O:P;const L=(M==null?void 0:M.slippageFactor)??(M==null?void 0:M.slippage)??(M==null?void 0:M.slipRatio)??o.clutchSlippage??1.0025,te=(p==null?void 0:p.slippageFactor)??(p==null?void 0:p.slippage)??o.converterSlippage??1.06;de=x?L:te,ae=x?1:(p==null?void 0:p.torqueMult)??(p==null?void 0:p.torqueMultiplier)??o.converterTorqueMult??2.2,W=(S==null?void 0:S.engine_flywheel_clutch)??o.enginePMI??(m==null?void 0:m.enginePMI)??4,fe=(S==null?void 0:S.tires_wheels_ringgear)??o.tiresPMI??(m==null?void 0:m.tiresPMI)??.5,k=(S==null?void 0:S.transmission_driveshaft)??o.transPMI??(m==null?void 0:m.transPMI)??.2,et=(d==null?void 0:d.overallEfficiency)??o.transEfficiency??.97;const N=e.aero??o.aero;ge=(N==null?void 0:N.Cd)??(N==null?void 0:N.cd)??o.cd??.35,ue=(N==null?void 0:N.Cl)??(N==null?void 0:N.cl)??o.liftCoeff??0,v=l}const ne=oe/2+3.75,tt=n.trackTempF??100,At=c?1:no(tt),Re=1.02+((n.tractionIndex??5)-1)*.005+(At-1)*3,Oe=1.03,He=.025,A=o.wheelbaseIn??100,f=o.weightLb,se=x?(M==null?void 0:M.launchRPM)??o.clutchLaunchRPM??w:w,qe=5252*(_r(ve,V,Z,1,se)/T)/se*ae*j[0]*ze[0],rt=(n.windMph??0)/.681818,wt=rt>0?ke*rt*rt/(2*I):0,jt=((pt=e.aero)==null?void 0:pt.frontalArea_ft2)??o.frontalArea_ft2??o.frontalAreaFt2??20,ut=He*f+ge*jt*wt,ht=qe*ce*et/(Re*oe/24)-ut,It=(x?.88:.96)*ht/f,Yt=(1-.035*Math.abs(It))*oe/2,Ne=(It*f*(ne-Yt+Oe/et*Yt)+ut*ne)/A,ot=We?v:l,ee={Weight_lbf:o.weightLb,Wheelbase_in:o.wheelbaseIn??100,YCG_in:ne,StaticFWt_lbf:Ne,TireDia_in:oe,TireWidth_in:Se,Rollout_in:o.rolloutIn??12,GearRatio:ce,TGR:j,TGEff:ze,Efficiency:et,DTShift:x?.2:.25,Slippage:de,TorqueMult:ae,Stall:w,LockUp:(p==null?void 0:p.lockup)??!1,isClutch:x,RefArea_ft2:((Wt=e.aero)==null?void 0:Wt.frontalArea_ft2)??o.frontalArea_ft2??o.frontalAreaFt2??20,DragCoef:ge,LiftCoef:ue,BodyStyle:Ze,EnginePMI:W,TiresPMI:fe,TransPMI:k,xrpm:ve,yhp:V,NHP:Z,HPTQMult:o.hpTorqueMultiplier??(m==null?void 0:m.hpTqMult)??1,ShiftRPM:ye,NGR:Y,LaunchRPM:x?(M==null?void 0:M.launchRPM)??o.clutchLaunchRPM??w:w,ShiftMode:o.shiftMode??"rpm",ShiftTimes:o.shiftTimes??[],RevLimiterRPM:o.revLimiterRPM??0};if(We&&ot!==l){let y=2*a;y<24&&(y=24),h=(ot+.25*y)/12;const he=.5*y/12;h<he&&(h=he)}const vt=n.trackTempF??100,Ct=c?1:no(vt),_t={rho:ke,hpc:T,TractionIndex:n.tractionIndex??5,TrackTempEffect:Ct,WindSpeed_mph:n.windMph??0,WindAngle_deg:n.windAngleDeg??0,isLandSpeed:c},yt=x?(M==null?void 0:M.launchRPM)??w:w,b=Fn(ee,_t,yt),dt=(o.rolloutIn??12)/12,Ht=dt>0?dt:1,Lt=_r(ve,V,Z,1,yt),Nt=bn(Ht,Lt,ae,o.weightLb),Dt=c?5e4:5e3,Zt=c?300:30,Gt={iterations:[],convergenceHistory:[]},Fe=[],zt=Vn(s);let kt=0,pe=null,me=null,Ve=null;for(let y=0;y<Dt&&!(b.Dist_ft-g+h>=i+50||b.time_s>=Zt);y++){if(!Number.isFinite(b.Vel_ftps)||!Number.isFinite(b.Dist_ft)||!Number.isFinite(b.AGS_g)){t.push(`NaN detected at step ${y}: Vel=${b.Vel_ftps}, Dist=${b.Dist_ft}, AGS=${b.AGS_g}`);break}const Q=Rn(b,ee,_t,Nt,C);if(Gt.iterations.push(Q.iterations),y<20&&Gt.convergenceHistory.push({step:y,iterations:Q.iterations,HPSave:Q.HPSave,HP:Q.HP,PQWT:Q.PQWT,AGS_g:b.AGS_g}),pe===null&&b.Dist_ft>=g){const $=(b.Dist_ft-g)/b.Vel_ftps;pe=b.time_s-$}let O,P;pe!==null?(O=b.Dist_ft-g+h,P=b.time_s-pe):(O=0,P=0);const L=ee.TGR[b.Gear-1]??1,te=(Q.LockRPM??b.EngRPM)/L,N=Q.TireSlip,be=b.Vel_ftps*N*_e,Be=(C==null?void 0:C.enabled)&&P>=C.activateTime_s&&P<C.activateTime_s+C.duration_s;if(r.push({t_s:P,s_ft:O,v_fps:b.Vel_ftps,v_mph:b.Vel_ftps*_e,a_g:b.AGS_g,rpm:b.EngRPM,dsrpm:te,lockRpm:Q.LockRPM,gear:b.Gear,slip:b.SLIP,tireSlip:N,hp:Q.HPAtWheels,dragHp:Q.DragHP,netHp:Q.HP,wheelSpeed_mph:be,throttleStopActive:Be}),me===null&&O>=594){const D=r.length>1?((Ot=r[r.length-2])==null?void 0:Ot.s_ft)??0:0,$=r.length>1?((mt=r[r.length-2])==null?void 0:mt.t_s)??0:0;if(D<594&&O>D){const Ue=(594-D)/(O-D);me=$+Ue*(P-$)}else me=P}if(Ve===null&&O>=1254){const D=r.length>1?((X=r[r.length-2])==null?void 0:X.s_ft)??0:0,$=r.length>1?((tr=r[r.length-2])==null?void 0:tr.t_s)??0:0;if(D<1254&&O>D){const Ue=(1254-D)/(O-D);Ve=$+Ue*(P-$)}else Ve=P}for(;kt<zt.length&&O>=zt[kt];){const D=zt[kt],$=r.length>1?((rr=r[r.length-2])==null?void 0:rr.s_ft)??0:0,Ue=r.length>1?((Mt=r[r.length-2])==null?void 0:Mt.t_s)??0:0;let Qe=P;if($<D&&O>$){const Pt=(D-$)/(O-$);Qe=Ue+Pt*(P-Ue)}let ie;D===660&&me!==null&&Qe>me?ie=_e*66/(Qe-me):D===1320&&Ve!==null&&Qe>Ve?ie=_e*66/(Qe-Ve):ie=b.Vel_ftps*_e,Fe.push({d_ft:D,t_s:Qe,v_mph:ie}),kt++}if(b.ShiftFlag===1)b.ShiftFlag=2,b.Gear++;else if(b.ShiftFlag===2)b.ShiftFlag=0;else if(b.Gear<ee.NGR)if((ee.ShiftMode??"rpm")==="time"){const $=(or=ee.ShiftTimes)==null?void 0:or[b.Gear-1];$!==void 0&&b.time_s>=$&&(b.ShiftFlag=1)}else{const $=ee.ShiftRPM[b.Gear-1]??7e3;b.EngRPM>=$&&(b.ShiftFlag=1)}}const Me=Fe.find(y=>y.d_ft===i),er=(Me==null?void 0:Me.t_s)??b.time_s,gr=(Me==null?void 0:Me.v_mph)??b.Vel_ftps*_e,nt=r.map(y=>({t_s:y.t_s,s_ft:y.s_ft,v_mph:y.v_mph,v_fps:y.v_fps,a_g:y.a_g,rpm:y.rpm,dsrpm:y.dsrpm,lockRpm:y.lockRpm,gear:y.gear,slip:y.slip,tireSlip:y.tireSlip,hp:y.hp,dragHp:y.dragHp,wheelSpeed_mph:y.wheelSpeed_mph})),$e={fuelType:{resolved:K??"unknown",fuelSystemType:Te,vehicleFuelType:o.fuelType,vehicleFuelSystem:o.fuelSystem},hpCurve:{length:Z,peakHP:Math.max(...V),rpmRange:`${Math.min(...ve)} - ${Math.max(...ve)}`},airCalc:{rho_lbm_ft3:ke,hpc:T},simParams:{weight:o.weightLb,tireDia:oe,wheelbase:o.wheelbaseIn??100,finalDrive:ce,NGR:Y,shiftRPMs:ee.ShiftRPM,peakHP:Math.max(...V),stallRPM:w,slippage:de,slippageSource:(M==null?void 0:M.slippageFactor)!==void 0?"clutch.slippageFactor":(M==null?void 0:M.slippage)!==void 0?"clutch.slippage":o.clutchSlippage!==void 0?"vehicle.clutchSlippage":"default",vehicleClutchSlippage:o.clutchSlippage,isClutch:x,tractionIndex:_t.TractionIndex,trackTempEffect:Ct,pmi:{engine:W,trans:k,tires:fe},aero:{frontalArea:ee.RefArea_ft2,cd:ee.DragCoef,cl:ee.LiftCoef},launchRPM:ee.LaunchRPM,ycg:ne,staticFWt:Ne,ags0:It,tireSlipAtLaunch:Re,rolloutTime_s:pe??0,rolloutIn:a,gearEfficiencies:ee.TGEff,overallEfficiency:ee.Efficiency,overhangIn:o.overhangIn??l},result:{et:er,mph:gr,rolloutTime_s:pe??0},runTrace:Un(r,a)};return{et_s:er,mph:gr,timeslip:Fe,traces:nt,meta:{model:"VB6Exact",steps:r.length,warnings:t},vb6Diagnostics:Gt,debugData:$e}}const Jn="rsa.model.";function Kn(e){try{const t=Jn+e,r=localStorage.getItem(t);if(!r)return;const o=JSON.parse(r);if(!o.w||!o.P||typeof o.n!="number"){console.warn(`Invalid model structure for vehicle ${e}`);return}return o}catch(t){console.error(`Failed to load model for vehicle ${e}:`,t);return}}function Xn(e,t){if(t.length!==e.w.length)throw new Error(`Feature dimension mismatch: expected ${e.w.length}, got ${t.length}`);let r=0;for(let o=0;o<e.w.length;o++)r+=e.w[o]*t[o];return r}class jn{constructor(){fr(this,"id","Blend")}simulate(t){const r=Zr.simulate(t),o=t.vehicle.id,n=Kn(o);let s=0;const i=[...r.meta.warnings];if(n){const _=[Rt(t.env)/1e3,t.vehicle.weightLb/3e3,t.vehicle.tireDiaIn/30,t.vehicle.rearGear/4,(r.et_s-10)/5];s=Xn(n,_)}else i.push("no_learned_model");const c=r.et_s*.8,a=r.et_s*1.2;return{et_s:Math.max(c,Math.min(a,r.et_s+s)),mph:r.mph,timeslip:r.timeslip,traces:r.traces,meta:{model:"Blend",steps:r.meta.steps,warnings:i}}}}const Yn=new jn;class Zn{constructor(){fr(this,"id","SimpleV1")}simulate(t){const r=To({vehicle:t.vehicle,env:t.env,raceLength:t.raceLength});return{et_s:r.baseET_s,mph:r.baseMPH,timeslip:r.timeslip,meta:{model:"SimpleV1",steps:r.timeslip.length,warnings:[]}}}}class zn{constructor(){fr(this,"id","VB6Exact")}simulate(t){const r=Qn(t);return{...r,meta:{...r.meta,model:"VB6Exact"}}}}const es={SimpleV1:new Zn,RSACLASSIC:Zr,VB6Exact:new zn,Blend:Yn};function so(e){const t=es[e];if(!t)throw new Error(`Unknown physics model: ${e}`);return t}function ts(e){if(e!=null&&e.drivetrain){const t=e.drivetrain;t.shiftsRPM&&!t.shiftRPM&&(t.shiftRPM=t.shiftsRPM),t.overallEfficiency!==void 0&&t.overallEff===void 0&&(t.overallEff=t.overallEfficiency),t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}if(e!=null&&e.vehicle){const t=e.vehicle;t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}return e}function dr(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const o=Number(e.torque)*r/5252*t;return{rpm:r,hp:o}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const o=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:o}}return null}function rs(e){var o,n,s,i,c,a;if(Array.isArray((o=e==null?void 0:e.engineParams)==null?void 0:o.powerHP)&&e.engineParams.powerHP.length>=2)return e;const t=((n=e==null?void 0:e.fuel)==null?void 0:n.hpTorqueMultiplier)??1;let r=[];if(Array.isArray((s=e==null?void 0:e.vehicle)==null?void 0:s.hpCurve)&&e.vehicle.hpCurve.length>=2&&(r=e.vehicle.hpCurve.map(l=>dr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2&&Array.isArray(e==null?void 0:e.engineHP)&&e.engineHP.length>=2&&(r=e.engineHP.map(l=>Array.isArray(l)?{rpm:Number(l[0]),hp:Number(l[1])*t}:dr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2&&Array.isArray((i=e==null?void 0:e.engineParams)==null?void 0:i.torqueCurve)&&e.engineParams.torqueCurve.length>=2&&(r=e.engineParams.torqueCurve.map(l=>dr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2&&Array.isArray((c=e==null?void 0:e.vehicle)==null?void 0:c.torqueCurve)&&e.vehicle.torqueCurve.length>=2&&(r=e.vehicle.torqueCurve.map(l=>dr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2){const l=Number((a=e==null?void 0:e.vehicle)==null?void 0:a.powerHP);Number.isFinite(l)&&l>0&&(r=[{rpm:4e3,hp:l*.85*t},{rpm:5e3,hp:l*.92*t},{rpm:6e3,hp:l*.97*t},{rpm:6500,hp:l*1*t},{rpm:7e3,hp:l*.98*t},{rpm:7500,hp:l*.94*t},{rpm:8e3,hp:l*.88*t}])}return r.length>=2&&(e.engineParams={...e.engineParams??{},powerHP:r}),e}function os(e){ts(e),rs(e)}function ns(e){var n,s;if(!Array.isArray(e))return"none";const t=(n=e[0])==null?void 0:n.rpm,r=(s=e[e.length-1])==null?void 0:s.rpm;return`n=${e.length},first=${t},last=${r}`}self.onmessage=async e=>{var t,r,o,n,s,i,c,a,l;try{const u=e.data;if(!(u!=null&&u.model)||!(u!=null&&u.payload))throw new Error("Bad worker message");const h=JSON.parse(JSON.stringify(u.payload));if(u.model==="VB6Exact"){console.log("[WORKER:VB6Exact] Running with SimInputs format",{hasVehicle:!!h.vehicle,vehicleName:(t=h.vehicle)==null?void 0:t.name,powerHP:(r=h.vehicle)==null?void 0:r.powerHP,hasHpCurve:!!((o=h.vehicle)!=null&&o.hpCurve),raceLength:h.raceLength});const m=so(u.model).simulate(h);self.postMessage({ok:!0,result:m});return}os(h);const _=(n=h==null?void 0:h.engineParams)==null?void 0:n.powerHP;if(!Array.isArray(_)||_.length<2)throw console.error("[WORKER] bad powerHP",{hpLen:_==null?void 0:_.length,sample:(s=_==null?void 0:_.slice)==null?void 0:s.call(_,0,2)}),new Error("EngineParams must provide either torqueCurve or powerHP");Number.isFinite(h==null?void 0:h.raceLengthFt)||(h.raceLengthFt=(u==null?void 0:u.raceLengthFt)??1320);const g=(h==null?void 0:h.drivetrain)??{};console.log("[WORKER:normalized.input]",{hasEngineParams:!!h.engineParams,hasPowerHP:!!_,raceLengthFt:h.raceLengthFt,hpSummary:ns(_),hasClutch:!!g.clutch,hasConverter:!!g.converter,slipRPM:(i=g==null?void 0:g.clutch)==null?void 0:i.slipRPM,stallRPM:(c=g==null?void 0:g.converter)==null?void 0:c.stallRPM});try{h!=null&&h.tuning&&console.debug("[WORKER:TUNING]",!0,h.tuning)}catch{}h.flags===void 0&&(h.flags={}),h.flags.vb6Strict===void 0&&(h.flags.vb6Strict=((l=(a=u.payload)==null?void 0:a.flags)==null?void 0:l.vb6Strict)??!0);const M=so(u.model).simulate(h);self.postMessage({ok:!0,result:M})}catch(u){console.error("[WORKER ERROR]",u),self.postMessage({ok:!1,error:String((u==null?void 0:u.message)||u)})}}})();
//# sourceMappingURL=index-D4ewWM6A.js.map
