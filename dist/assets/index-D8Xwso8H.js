var Fs=Object.defineProperty;var bs=(Re,Fe,gt)=>Fe in Re?Fs(Re,Fe,{enumerable:!0,configurable:!0,writable:!0,value:gt}):Re[Fe]=gt;var Ot=(Re,Fe,gt)=>bs(Re,typeof Fe!="symbol"?Fe+"":Fe,gt);(function(){"use strict";const Re={EIGHTH:[60,330,660],QUARTER:[60,330,660,1e3,1320],ONE_MILE:[660,1320,2640,3960,5280],EL_MIRAGE:[660,1320,2640,3960,5280,6864],MUROC:[660,1320,2640,3960,5280,6600,7920],TWO_MILE:[660,1320,2640,5280,7920,10560],BONNEVILLE_SHORT:[660,1320,2640,5280,10560,15840],BONNEVILLE_LONG:[660,1320,2640,5280,10560,15840,21120,26400],TEN_MILE:[660,1320,2640,5280,10560,26400,52800]},Fe={EIGHTH:{label:"1/8 Mile",shortLabel:"1/8",category:"drag",lengthFt:660,lengthMiles:.125},QUARTER:{label:"1/4 Mile",shortLabel:"1/4",category:"drag",lengthFt:1320,lengthMiles:.25},ONE_MILE:{label:"One Mile Asphalt",shortLabel:"1 Mi",category:"landspeed",lengthFt:5280,lengthMiles:1},EL_MIRAGE:{label:"El Mirage Dry Lake",shortLabel:"El Mirage",category:"landspeed",lengthFt:6864,lengthMiles:1.3},MUROC:{label:"Muroc Dry Lake (EAFB)",shortLabel:"Muroc",category:"landspeed",lengthFt:7920,lengthMiles:1.5},TWO_MILE:{label:"Two Mile Asphalt",shortLabel:"2 Mi",category:"landspeed",lengthFt:10560,lengthMiles:2},BONNEVILLE_SHORT:{label:"Bonneville - 3 Miles",shortLabel:"BV 3Mi",category:"landspeed",lengthFt:15840,lengthMiles:3},BONNEVILLE_LONG:{label:"Bonneville - 5 Miles",shortLabel:"BV 5Mi",category:"landspeed",lengthFt:26400,lengthMiles:5},TEN_MILE:{label:"Ten Mile Test Track",shortLabel:"10 Mi",category:"landspeed",lengthFt:52800,lengthMiles:10}};function gt(e){const r=e.elevation+(29.92-e.barometerInHg)*1e3,o=59-r/1e3*3.5,s=(e.temperatureF-o)*120,n=e.humidityPct/10*50*(e.temperatureF/80);return r+s+n}function _o(e){const r=.0061*Math.exp(17.27*(e.temperatureF-32)/1.8/(237.3+(e.temperatureF-32)/1.8))*(e.humidityPct/100),o=7e3*.622*(r/(e.barometerInHg-r));return Math.max(0,Math.min(o,500))}function ho(e){const o=518.6700000000001,s=e.temperatureF+459.67,n=e.barometerInHg/29.92,l=o/s;let c=n*l;const i=1-_o(e)/5e3;return c*=i,Math.max(.7,Math.min(c,1.15))}function go(e){const{vehicle:t,env:r,raceLength:o}=e;if(t.weightLb<=0||t.powerHP<=0)throw new Error("Invalid vehicle params");const s=Re[o];if(!s)throw new Error(`Invalid race length: ${o}`);const n=ho(r),l=t.powerHP*n,c=Math.max(1,l),a=Math.max(1,t.weightLb),i=5.825*Math.cbrt(a/c),f=234*Math.cbrt(c/a),_=i*.64,d=f*.8;let h,m;if(o==="EIGHTH"?(h=_,m=d):(h=i,m=f),!Number.isFinite(h)||!Number.isFinite(m))throw new Error("Invalid ET or MPH calculation");const M=5.825*Math.cbrt(a/Math.max(1,t.powerHP)),g=h-M,p={60:.16,330:.44,660:.79,1e3:.93,1320:1},P=s.map(b=>{const E=p[b]??1,w=h*E,Y=b/s[s.length-1],V=m*Y;return{d_ft:b,t_s:Math.max(0,w),v_mph:Math.max(0,V)}}),v=[{name:"Weather (HP)",delta_s:g}];return{baseET_s:Math.max(0,h),baseMPH:Math.max(0,m),timeslip:P,factors:v}}function po(e){return e/32.174}function mo(e,t,r){return e+(t-e)*r}function Mo(e){var r;const t=(Array.isArray(e)?e:e==null?void 0:e.powerHP)??((r=e==null?void 0:e.engineParams)==null?void 0:r.powerHP);if(!Array.isArray(t)||t.length<2){const o=e&&typeof e=="object"?Object.keys(e):[];throw new Error(`EngineParams must provide either torqueCurve or powerHP (got keys=${JSON.stringify(o)}, len=${(t==null?void 0:t.length)??0})`)}return t}function ar(e,t){const r=Mo(t);if(e<=r[0].rpm)return r[0].hp;if(e>=r[r.length-1].rpm)return r[r.length-1].hp;let o=0,s=r.length-1;for(;s-o>1;){const a=o+s>>1;r[a].rpm<=e?o=a:s=a}const n=r[o],l=r[s],c=(e-n.rpm)/(l.rpm-n.rpm);return n.hp+c*(l.hp-n.hp)}function Vt(e,t,r){if("corr"in t&&typeof t.corr=="number"){const n=t;let l;if(n.torqueCurve&&n.torqueCurve.length>0)l=Po(e,n.torqueCurve);else if(n.powerHP!==void 0){const a=Math.max(e,1e3);l=n.powerHP*5252/a}else throw new Error("EngineParams must provide either torqueCurve or powerHP");return l*n.corr}const o=ar(e,t);return(e>0?5252*o/e:0)*(Number.isFinite(r)?r:1)}function Po(e,t){const o=[...t.map(s=>{if(s.tq_lbft!==void 0)return{rpm:s.rpm,tq_lbft:s.tq_lbft};if(s.hp!==void 0&&s.rpm>0)return{rpm:s.rpm,tq_lbft:s.hp*5252/s.rpm};throw new Error(`Invalid torque curve point: ${JSON.stringify(s)}`)})].sort((s,n)=>s.rpm-n.rpm);if(e<=o[0].rpm)return o[0].tq_lbft;if(e>=o[o.length-1].rpm)return o[o.length-1].tq_lbft;for(let s=0;s<o.length-1;s++){const n=o[s],l=o[s+1];if(e>=n.rpm&&e<=l.rpm){const c=(e-n.rpm)/(l.rpm-n.rpm);return mo(n.tq_lbft,l.tq_lbft,c)}}return o[o.length-1].tq_lbft}const R=e=>Math.fround(e),y={add:(e,t)=>Math.fround(Math.fround(e)+Math.fround(t)),sub:(e,t)=>Math.fround(Math.fround(e)-Math.fround(t)),mul:(e,t)=>Math.fround(Math.fround(e)*Math.fround(t)),div:(e,t)=>Math.fround(Math.fround(e)/Math.fround(t)),sqrt:e=>Math.fround(Math.sqrt(Math.fround(e))),pow:(e,t)=>Math.fround(Math.pow(Math.fround(e),Math.fround(t))),exp:e=>Math.fround(Math.exp(Math.fround(e))),log:e=>Math.fround(Math.log(Math.fround(e))),clamp:(e,t,r)=>Math.fround(Math.min(Math.max(Math.fround(e),Math.fround(t)),Math.fround(r))),abs:e=>Math.fround(Math.abs(Math.fround(e))),neg:e=>Math.fround(-Math.fround(e))};function Er(e,t=0){const r=Math.pow(10,t),o=Math.fround(e*r),s=Math.floor(o),n=o-s;return n>.5?(s+1)/r:n<.5?s/r:(s%2===0?s:s+1)/r}function To(e,t,r,o,s){const n=R(e),l=R(t),c=R(r),a=R(o),i=R(s);if(c===l)return a;const f=y.div(y.sub(n,l),y.sub(c,l));return y.add(a,y.mul(f,y.sub(i,a)))}function So(e,t){if(t.length===0)return R(0);if(t.length===1)return R(t[0][1]);const r=R(e);if(r<=R(t[0][0]))return R(t[0][1]);if(r>=R(t[t.length-1][0]))return R(t[t.length-1][1]);for(let o=0;o<t.length-1;o++){const s=R(t[o][0]),n=R(t[o+1][0]);if(r>=s&&r<=n)return To(r,s,n,t[o][1],t[o+1][1])}return R(t[t.length-1][1])}function Ro(e){return Array.isArray(e==null?void 0:e.ratios)&&e.ratios.length>0?e.ratios:Array.isArray(e==null?void 0:e.gearRatios)&&e.gearRatios.length>0?e.gearRatios:[]}function Fo(e,t,r,o=0){const s=(r.tireDiaIn??28)/12,n=Math.PI*s,c=e/n*60,a=Ro(r),i=a.length>0?a[Math.min(t,a.length-1)]??1:1;return c*i*(r.finalDrive??3.73)*(1+o)}function bo(){return{t_s:0,v_fps:0,s_ft:0,rpm:0,gearIdx:0,warnings:[]}}const Je=3.141593,F=32.174,fr=60/(2*Je)*550,ur=519.67,wr=14.696,Eo=29.92,_r=28.9669,Ar=18.016,xr=1545.32,Bt=3600/5280,hr=.025,wo=.01,Ir=.03,Ao=0,xo=9.7,Io=1.01,Co=0,yo=0,ge=.004,pt=-4,mt=2,Cr=.92,yr=1.08,vr=.15,Hr=.25,vo=1.03,Ho=10.8,ae=3600/5280,Lo=459.67,No=F;function Do(e){const{engineTorque_lbft_atSlip:t,gearRatio:r,transEff:o,drivelineEff:s,finalDrive:n,tireDia_in:l,tireSlip:c,dragForce_lbf:a,vehicleWeight_lbf:i,isAutoTrans:f,torqueMult:_=1}=e,d=t*_*r*o,h=l/24,M=d*n*s/(c*h)-a;return{Ags0_ftps2:(f?.96:.88)*(M/i)*F,netThrust_lbf:M,wheelTorque_lbft:d}}function Lr(e){const t=e.elevation_ft??0,r=e.fuelSystem??1,o=[.0205558,.00118163,154988e-10,40245e-11,434856e-15,2096e-14],s=o[0]+o[1]*e.temperature_F+o[2]*e.temperature_F**2+o[3]*e.temperature_F**3+o[4]*e.temperature_F**4+o[5]*e.temperature_F**5,n=e.relHumidity_pct/100*s,l=Math.pow((ur-.00356616*t)/ur,5.25588),c=wr*e.barometer_inHg/Eo*l,a=c-n,i=a/wr,f=n*Ar/(a*_r),_=xr*(1/_r+f/Ar)/(1+f),d=_/(xr/_r),h=e.temperature_F+Lo,m=h/ur,g=144*c/(_*h)/32.174;let p,P;switch(r){case 1:p=1,P=1;break;case 2:p=1,P=2;break;case 3:p=2,P=1;break;case 4:p=2,P=2;break;case 5:p=3,P=2;break;case 6:p=1,P=3;break;case 7:case 9:p=2,P=3;break;case 8:p=3,P=3;break;default:p=1,P=1;break}const v=1+2.48*Math.pow(f,1.5);let b,E,w;switch(p){case 1:b=1,E=.6,w=.15;break;case 2:b=1,E=.3,w=.13;break;case 3:b=.85,E=.5,w=.055;break;default:b=1,E=.6,w=.15;break}if(P===2&&(w=w-.005),P===3){const V=.3050108932461874;b=.95-V*E,E=E+V,w=.6*w}let Y=Math.pow(i,b)/(Math.sqrt(d)*Math.pow(m,E));return Y=(1+w)*v/Y-w,r===9&&(Y=1),{rho_slug_per_ft3:g,pamb_psi:c,PWV_psi:n,pair_psi:a,WAR:f,RGAS:_,temp_R:h,hpc:Y,delta:i,theta:m,rgrs:d}}function Go(e,t,r,o=.025,s=.01){const n=o-r/1320*s,l=3600/5280,c=n*e,a=1e-4*e*(l*t);return c+a}function ko(e,t,r,o,s=.025,n=.01){return Go(e,t,r,s,n)*o}function Wo(e,t,r,o,s=1){let n=t,l=o*e/n;s>2&&l>.6&&(n=n*(1+(o-1)*(l-.6)/(1/o-.6)),l=o*e/n);let c=1/o,a=o*e,i=1;return a<n&&(a=n,i=r-(r-1)*l,c=i*e/n),c>1&&(c=1),{work:i,coupling:c,slipRatio:l,zStall:n,engRPM:a}}const qo=10.8;function Nr(e){const{tireDia_in:t,tireWidth_in:r,dynamicRWT_lbf:o,tractionIndexAdj:s,bodyStyle:n}=e,l=.92+.08*Math.pow(o/1900,2.15);let c=s*qo*t*(r+1)*l;return n===8&&(c=.5*c),c}function Oo(e){const{weight_lbf:t,tireGrowth:r,dragForce_lbf:o}=e;return(Nr(e)/r-o)/t*F}function Vo(){return ge*F}function Bo(e,t,r,o){let s=e,n=t,l=0;return s>o&&(l=1,n=n*(o-(s-o))/s,s=o-(s-o)),s<r&&(n=n*r/s,s=r),{AGS:s,PQWT:n,SLIP:l}}function $o(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function Uo(e,t,r,o){return e+t*Math.pow(r*o,2)}function Jo(e,t,r){return e*t*60/r}function Qo(e,t,r,o,s=!0){let n=o*t*(t-e);n<0&&(n=s?vr*n:Hr*n);const l=Math.pow(2*Je/60,2)/(12*550*r);return n*l}function Ko(e,t,r,o){let s=o*t*(t-e);s<0&&(s=0);const n=Math.pow(2*Je/60,2)/(12*550*r);return s*n}function Xo(e,t,r,o){const s=Math.PI,n=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));let l=1+n*135e-7*Math.pow(r,1.6);const c=1+n*35e-5*r;c<l&&(l=c);const a=o/32.174,i=l-.035*Math.abs(a),f=i*e*s/12,_=12*f/(2*s),d=2*_,h=_/12;return{growth:l,squat:i,dia_eff_in:d,radius_eff_ft:h,circumference_eff_ft:f}}function jo(e,t,r,o,s){const a=(t-1)*r/2*o*(s?1:2)/144;return e+a}function Yo(e,t,r,o){if(e>=t-1)return!1;const s=o[e];if(!s||s<=0)return!1;const l=(o[0]??0)>8e3?20:10;return Math.abs(s-r)<l}var Dr=(e=>(e[e.NORMAL=0]="NORMAL",e[e.TRIGGERED=1]="TRIGGERED",e[e.EXECUTING=2]="EXECUTING",e))(Dr||{});function Zo(e,t){switch(e){case 0:return t?{newState:1,executeShift:!1}:{newState:0,executeShift:!1};case 1:return{newState:2,executeShift:!0};case 2:return{newState:0,executeShift:!1};default:return{newState:0,executeShift:!1}}}function zo(e){return e?.2:.25}function en(e,t,r,o){return r>=o||!t||t<=0?!1:y.sub(R(e),R(t))>=0}function tn(e,t=3,r=1){const o=.005*(t-1)+3*(r-1),s=e/1320;return 1.02+o*(1-Math.pow(s,2))}function rn(e,t,r,o,s,n,l=.04,c=.9){const a=e*t*(r-o+l/c*o),i=n*r;return(a+i)/s}function on(e,t,r,o,s,n,l,c,a=.04,i=.9){const f=rn(r,e,o,s,n,l,a,i);let _=t-f,d=0;_<0&&(d=-_*n/64,_=0);let h=c-_-d;return h<0&&(h=e),{rear_weight_lbf:h,front_weight_lbf:_,wheelie_bar_weight_lbf:d}}function nn(e,t,r,o){const s=2*o*r,n=Math.sqrt(e*e+s),l=2*o*r+e*e,c=Math.pow(l,1.5),a=Math.pow(e,3),i=(c-a)/(3*o)+t;return{Vel_ftps:n,Dist_ft:i}}function sn(e,t,r){let o=e,s=1,n=0;if(o>r){n=1;const l=o-r,c=r-l;s=c/o,o=c}return o<t&&(s=t/o,o=t),{AGS_ftps2:o,PQWT_scale:s,slip:n}}function ln(e,t){return e/(t*F)}function cn(e,t,r){if(r<=0)return Math.max(.005,Math.min(.05,e));let o=e*Math.pow(t/r,4);return o>.05&&(o=.05),o<.005&&(o=.005),o}function an(e,t,r,o){const s=t*r/o;let n=e*.11*Math.pow(s,-1/3);return n=n/15,n<.005&&(n=.005),n}function fn(e){if(!e)return 1;const t=e.toUpperCase();return t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")||t.includes("FUEL INJECT")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function un(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const o=Number(e.torque)*r/5252*t;return{rpm:r,hp:o}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const o=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:o}}return null}function $t(e,t=1){return e.map(r=>Array.isArray(r)?{rpm:Number(r[0]),hp:Number(r[1])*t}:un(r,t)).filter(r=>r!==null&&Number.isFinite(r.rpm)&&Number.isFinite(r.hp)).sort((r,o)=>r.rpm-o.rpm)}function _n(e){var c,a,i,f;const t=((c=e==null?void 0:e.fuel)==null?void 0:c.hpTorqueMultiplier)??1,r=[],o=(a=e==null?void 0:e.engineParams)==null?void 0:a.powerHP;if(Array.isArray(o)&&(r.push(`engineParams.powerHP(${o.length})`),o.length>=2)){const _=$t(o,t);if(_.length>=2)return{powerHP:_}}const s=e==null?void 0:e.engineHP;if(Array.isArray(s)&&(r.push(`engineHP(${s.length})`),s.length>=2)){const _=$t(s,t);if(_.length>=2)return{powerHP:_}}const n=(i=e==null?void 0:e.engineParams)==null?void 0:i.torqueCurve;if(Array.isArray(n)&&(r.push(`engineParams.torqueCurve(${n.length})`),n.length>=2)){const _=$t(n,t);if(_.length>=2)return{powerHP:_}}const l=(f=e==null?void 0:e.vehicle)==null?void 0:f.torqueCurve;if(Array.isArray(l)&&(r.push(`vehicle.torqueCurve(${l.length})`),l.length>=2)){const _=$t(l,t);if(_.length>=2)return{powerHP:_}}throw new Error(`RSACLASSIC: missing power curve. Sources found: [${r.join(", ")||"none"}]. Keys(engineParams)=${JSON.stringify(Object.keys((e==null?void 0:e.engineParams)||{}))} Keys(vehicle)=${JSON.stringify(Object.keys((e==null?void 0:e.vehicle)||{}))}`)}function be(e,t=0){return Number.isFinite(e)?Number(e):t}function Gr(e,t){const r=t.map(o=>[o.rpm,o.hp]);return So(e,r)}function kr(e,t,r){const o=Gr(e,t);if(e<=0)return R(0);const s=y.div(y.mul(R(5252),o),R(e));return y.mul(s,R(r))}function hn(e,t,r,o=t){const s=Number(e);return Number.isFinite(s)?Math.min(r,Math.max(t,s)):o}function dn(e){return Math.max(.85,Math.min(1,e))}class gn{constructor(){Ot(this,"id","RSACLASSIC")}simulate(t){var Jr,Qr,er,Kr,tr,Xr,jr,Yr;const r=!!((Jr=t==null?void 0:t.flags)!=null&&Jr.vb6Strict);r&&console.log("[RSACLASSIC] VB6-STRICT mode enabled - using Float32 math");const o=Date.now(),s=9e4,n=2e6,l=5e4;let c=0;function a(x,W){if(Date.now()-o>s)throw new Error("simulation wall-time exceeded");if(x>=n)throw new Error("simulation step cap hit");if(x%l===0){const He=W-c;if(console.log("[RSACLASSIC] heartbeat",{step:x,dist_ft:W,gained_ft:He}),x>0&&He<.001)throw new Error("simulation stalled");c=W}}const i=Number((t==null?void 0:t.raceLengthFt)??1320);if(!Number.isFinite(i)||i<=0)throw new Error(`invalid raceLengthFt: ${t==null?void 0:t.raceLengthFt}`);const f=Number((t==null?void 0:t.timeStep)??.002);if(!Number.isFinite(f)||f<=0)throw new Error(`invalid timeStep ${f}`);const d=_n(t).powerHP;if(console.log("[RSACLASSIC] start",{raceLenFt:i,hpPts:d.length}),!Array.isArray(d)||d.length<2)throw new Error(`RSACLASSIC: powerHP invalid (len=${(d==null?void 0:d.length)??0})`);const h=(t==null?void 0:t.drivetrain)??{},m=(t==null?void 0:t.vehicle)??{},M=h.clutch??(t==null?void 0:t.clutch)??m.clutch,g=h.converter??(t==null?void 0:t.converter)??m.converter,p=!!M,P=!!g,v=p?Number(M.slipRPM??M.slipRpm):NaN,b=p?Number(M.launchRPM??M.launchRpm):NaN,E=P?Number(g.stallRPM??g.stallRpm):NaN,w=p?Number(M.slippageFactor??M.slipRatio??1.0025):1,Y=P?Number(g.slippageFactor??g.slipRatio??1.05):1;if(!p&&!P)throw new Error("RSACLASSIC: drivetrain must specify clutch or converter");if(p&&!Number.isFinite(v))throw new Error("RSACLASSIC: clutch.slipRPM missing/invalid");if(P&&!Number.isFinite(E))throw new Error("RSACLASSIC: converter.stallRPM missing/invalid");const V=p?Number.isFinite(b)?b:v:E;console.log("[RPM-RESOLVED]",{isClutch:p,isConverter:P,slipRPM:v,launchRPM:b,stallRPM:E,rpmPin:V});const Ee=(t==null?void 0:t.tuning)??{},pe=Number.isFinite(Ee.aeroCdScale)?Ee.aeroCdScale:1,Qe=Number.isFinite(Ee.drivelineEffOffset)?Ee.drivelineEffOffset:0,{vehicle:T,env:X,raceLength:Ke}=t,j=[],ne=Ke==="EIGHTH"?660:1320,ce=T.cd,it=T.frontalArea_ft2,me=T.transEff,U=T.finalDrive??T.rearGear,Z=T.gearRatios,Me=T.gearEff,Pe=T.shiftRPM;ce||j.push("Missing vehicle.cd (drag coefficient) - required for VB6 parity"),it||j.push("Missing vehicle.frontalArea_ft2 - required for VB6 parity"),(!Z||Z.length===0)&&j.push("Missing vehicle.gearRatios[] - required for VB6 parity"),(!Pe||Pe.length===0)&&j.push("Missing vehicle.shiftRPM[] - required for VB6 parity"),U||j.push("Missing vehicle.finalDrive or vehicle.rearGear - required for VB6 parity"),X.barometerInHg===void 0&&j.push("Missing env.barometerInHg - required for VB6 air density"),X.temperatureF===void 0&&j.push("Missing env.temperatureF - required for VB6 air density"),X.humidityPct===void 0&&j.push("Missing env.humidityPct - required for VB6 air density"),X.elevation===void 0&&j.push("Missing env.elevation - required for VB6 air density");const De=T.tireRolloutIn??null,we=T.tireDiaIn??null,H=Math.PI;let D=(typeof De=="number"&&De>0?De/H:null)??we??0;(!D||D<=0)&&(j.push("Tire diameter is undefined/invalid. Provide tireRolloutIn or tireDiaIn."),D=28);const G=T.rolloutIn;G||j.push("Missing vehicle.rolloutIn - required for VB6 parity");const L=t.fuel,Ae=fn(L),le=Lr({barometer_inHg:X.barometerInHg??29.92,temperature_F:X.temperatureF??59,relHumidity_pct:X.humidityPct??50,elevation_ft:X.elevation??0,fuelSystem:Ae}).rho_slug_per_ft3,lt=po(T.weightLb),ct=(G??12)/12;let z=null,A=0;const je=30,xe=.01,Ge=d.reduce((x,W)=>Math.max(x,W.hp),0),Ye=g?g.torqueMult??1.7:1,Ie=(T.rolloutIn??12)/12,N=an(Ie>0?Ie:1,Ge,Ye,T.weightLb);let S=0,C=N,u=bo(),at=0;const ke=[],te=[];let Ze=!1,ze=0;const et=[60,330,660,1e3,ne];let We=0,fe=0,ue=0,qe=0,Jt=0,Qt=0,Kt=0,Ce=0,tt=1,Xt;u.rpm=V;const ft=t.fuel;let Pt=1,Tt=1,St=0,ut=0,I=0,_e=0,J=0,k=0,ee=0,O=0,Rt=0,re=0;if(M||g){const x=Vt(V,d,me??.9),W=V>0?x*V/5252:0,ve=W>0&&V>0?5252*W/V:0,He=(Z??[1])[0]??1,de=ve*He*(me??.9)*(U??3.73)*(me??.9)/(1.02*D/24);re=(g?.96:.88)*de/T.weightLb,re<ge&&(re=ge)}const Ft=6,B=5;let Q=V,he=0,Oe=Dr.NORMAL,ye=0,jt=0;const zn=x=>Me&&Me[x]!==void 0?Math.max(.9,Math.min(1,Me[x])):me??.9,bt=()=>{const x=h.overallEff??h.overallEfficiency??me??.97;return dn(x+Qe)},_t=x=>{const W=X.tractionIndex??3;return tn(x,W,1)};for(;;){A++,a(A,u.s_ft);const x=Xo(D,T.tireWidthIn??17,u.v_fps,re),W=x.radius_eff_ft,ve=x.circumference_eff_ft,He=x.dia_eff_in;let Et=Fo(u.v_fps,u.gearIdx,h),wt=Et,de=1,rr=0,Zr=0,zr=0;const Le=zn(u.gearIdx);r?kr(Et,d,Le):Vt(Et,d,Le);let Lt=1;if(ft==="METHANOL"){const q=X.trackTempF;q!==void 0&&q<80&&u.t_s<.8&&(Lt=1.025-.025*u.t_s/.8)}else if(ft==="NITRO"){if(u.t_s<.4)Lt=.9;else if(u.t_s<1){const q=(u.t_s-.4)/.6;Lt=.9+(1-.9)*q}}Pt=Math.min(Pt,Lt),Tt=Math.max(Tt,Lt);const Nt=(Z??[1])[u.gearIdx]??1,Mr=_t(u.s_ft)*u.v_fps*60/ve;A===1&&typeof console<"u"&&console.debug&&console.debug("[RPM-DEBUG]",{isClutch:p,isConverter:P,slipRPM:v,launchRPM:b,stallRPM:E,calculated_slipRPM:v,rpm_from_speed:Et});const rt=Mr*Nt*(U??3.73);let K=(p?w:Y)*rt;const es=u.gearIdx===0,ts=!0,Dt=p?v:E;(p||P)&&(es||ts)&&K<Dt&&(K=Dt);const or=K===Dt&&rt<Dt,eo=Dt;if(wt=K,r?kr(K,d,Le):Vt(K,d,Le),M)de=K>1?Math.max(0,Math.min(1,rt/K)):0,tt=Math.min(tt,de);else if(g){const q=g.torqueMult??2,$=Wo(rt,E,q,Y,A);de=$.coupling,rr=$.work,Zr=$.slipRatio,zr=$.zStall,Jt+=$.work,Qt+=$.coupling,Kt+=$.slipRatio,Ce++,tt=Math.min(tt,de)}else wt=Et;u.rpm=wt;const At=be(u.v_fps,0),to=X.windMph??0,rs=X.windAngleDeg??0,Pr=to/ae,os=rs*Math.PI/180,ns=Math.sqrt(At*At+2*At*Pr*Math.cos(os)+Pr*Pr),ss=T.bodyStyle===8,nr=jo(it??0,x.growth,D,T.tireWidthIn??17,ss);let sr,ht,Gt,ir;const Tr=to!==0?ns:At;if(r){const q=R(Tr);sr=y.mul(q,q),ht=y.mul(y.mul(R(.5),R(le)),sr),Gt=y.mul(y.mul(y.mul(ht,R(ce??0)),R(pe)),R(nr)),ir=y.mul(y.mul(ht,R(T.liftCoeff??0)),R(nr))}else sr=Tr*Tr,ht=be(.5*le*sr,0),Gt=be(ht*(ce??0)*pe*nr,0),ir=be(ht*(T.liftCoeff??0)*nr,0);const Sr=be(T.weightLb-ir,T.weightLb),dt=Gt,is=Sr,ls=T.rrCoeff??hr,cs=ko(is,At,u.s_ft,W,ls,.01),Ve=be(cs/W,0),as=1,fs=X.tractionIndex??3,Rr=$o(fs,as),us=A===1?0:Rt,_s=T.wheelbaseIn??108,hs=D/2+3.75,ds=T.staticFrontWeightLb??T.weightLb*.38,kt=on(T.weightLb,ds,us,hs,W*12,_s,dt+Ve,Sr,1.03,bt()),xt=kt.rear_weight_lbf,Be=Oo({weight_lbf:T.weightLb,tireDia_in:D,tireWidth_in:T.tireWidthIn??17,dynamicRWT_lbf:xt,tractionIndexAdj:Rr,tireGrowth:x.growth,dragForce_lbf:dt+Ve,bodyStyle:void 0}),Te=Vo();if(A<=12&&typeof console<"u"&&console.log){const q=Nr({weight_lbf:T.weightLb,tireDia_in:D,tireWidth_in:T.tireWidthIn??17,dynamicRWT_lbf:xt,tractionIndexAdj:Rr,bodyStyle:void 0});console.log("[TRACTION]",{step:A,CAXI:+Rr.toFixed(4),AX:10.8,tireDia_in:+D.toFixed(2),tireWidth_in:+(T.tireWidthIn??17).toFixed(1),dynamicRWT_lbf:+xt.toFixed(1),weightFactor:+(.92+.08*Math.pow(xt/1900,2.15)).toFixed(4),CRTF:+q.toFixed(1),tireGrowth:+x.growth.toFixed(4),dragForce_lbf:+(dt+Ve).toFixed(2),AMin_ftps2:+Te.toFixed(3),AMax_ftps2:+Be.toFixed(3),AMin_g:+(Te/F).toFixed(4),AMax_g:+(Be/F).toFixed(4)})}let se,Se;if(A<=Ft&&rt<B){const q=Vt(V,d,Le),$=P?g.torqueMult??2:1,ie=Do({engineTorque_lbft_atSlip:q,gearRatio:Nt,transEff:Le,drivelineEff:bt(),finalDrive:U??3.73,tireDia_in:D,tireSlip:_t(u.s_ft),dragForce_lbf:dt+Ve,vehicleWeight_lbf:T.weightLb,isAutoTrans:!!g,torqueMult:$});Se=ie.netThrust_lbf/T.weightLb*F;const nt=Bo(ie.Ags0_ftps2,Se,Te,Be);if(se=nt.AGS,Se=nt.PQWT,A<=10&&typeof console<"u"&&console.debug){const st=ie.Ags0_ftps2/F,Wt=Nt*(U??3.73);console.debug("[STEP]",{step:A,phase:or?"PINNED":"BOOTSTRAP",v_fps:u.v_fps.toFixed(6),EngRPM:wt.toFixed(0),LockRPM:rt.toFixed(2),slipRPM:v.toFixed(0),lockThreshold:eo.toFixed(0),rpmIsPinned:or,clutchSlip:de.toFixed(6),gear:u.gearIdx+1,GRxFD:Wt.toFixed(3),tireDia_eff_in:He.toFixed(2),tireGrowth:x.growth.toFixed(4),tireSlip:_t(u.s_ft).toFixed(4),RWTdyn_lbf:xt.toFixed(1),RWTfront_lbf:kt.front_weight_lbf.toFixed(1),wheelieBar_lbf:kt.wheelie_bar_weight_lbf.toFixed(1),AGS_g:st.toFixed(4),AGS_ftps2:se.toFixed(4),AMin_ftps2:Te.toFixed(4),AMax_ftps2:Be.toFixed(4),SLIP:nt.SLIP})}}else{let q=r?Gr(K,d):ar(K,d);ye>0&&(q=0,ye=Math.max(0,ye-C),ye===0&&typeof console<"u"&&console.debug&&console.debug("[SHIFT_DWELL_END]",{step:A,t_s:u.t_s.toFixed(4),v_fps:u.v_fps.toFixed(2)}));const $=q,ie=r?y.div(y.mul(y.add(R(dt),R(Ve)),R(u.v_fps)),R(550)):(dt+Ve)*u.v_fps/550;A<=12&&typeof console<"u"&&console.log&&console.log("[PRE_HP_CHAIN]",{step:A,EngRPM_out:+K.toFixed(0),wheelRPM:+Mr.toFixed(2),ClutchSlip:+de.toFixed(4),...g?{converterWork:+rr.toFixed(4)}:{},HPSave:+$.toFixed(1),DragHP:+ie.toFixed(2),F_drag_lbf:+Gt.toFixed(2),F_roll_lbf:+Ve.toFixed(2),v_fps:+u.v_fps.toFixed(2),tireSlip:+_t(u.s_ft).toFixed(4),currentGearEff:+Le.toFixed(4),drivelineEff:+bt().toFixed(4),dt_s:+C.toFixed(4),RPM0:+Q.toFixed(0),DSRPM0:+he.toFixed(2)});const nt=Jo(_t(u.s_ft),u.v_fps,ve);let st,Wt,lr;if(((Qr=T.pmi)==null?void 0:Qr.engine_flywheel_clutch)!==void 0)st=T.pmi.engine_flywheel_clutch,Wt=T.pmi.transmission_driveshaft??0,lr=T.pmi.tires_wheels_ringgear??0;else{st=500/120;const Ne=(Z==null?void 0:Z.length)??5;Wt=p?Ne*st/50:(Ne-1)*st/10,lr=2*(1.15*.8*(.08*D*(T.tireWidthIn??17))*Math.pow(D/2,2)/386)}const lo=Uo(lr,Wt,U??3.73,Nt),It=Qo(Q,K,C,st,p),Ct=Ko(he,nt,C,lo);A<=12&&typeof console<"u"&&console.log&&console.log("[PMI_CALC]",{step:A,EngRPM:+K.toFixed(0),RPM0:+Q.toFixed(0),RPM_delta:+(K-Q).toFixed(0),DSRPM:+nt.toFixed(2),DSRPM0:+he.toFixed(2),DSRPM_delta:+(nt-he).toFixed(2),enginePMI:+st.toFixed(3),chassisPMI:+lo.toFixed(3),HPEngPMI:+It.toFixed(1),HPChasPMI:+Ct.toFixed(1)}),Q=K,he=nt,J+=It*550*C,k+=Ct*550*C;let yt,$e;const co=_t(u.s_ft);if(r){yt=y.mul(y.sub(R($),R(It)),R(de)),$e=yt;const vt=y.mul(y.mul(R($e),R(Le)),R(bt())),Ne=y.sub(vt,R(Ct)),Ue=y.div(Ne,R(co));$e=y.sub(Ue,R(ie))}else yt=($-It)*de,$e=yt,$e=($e*Le*bt()-Ct)/co-ie;const ao=$e;Se=r?y.div(y.mul(y.mul(R(550),R(F)),R($e)),R(T.weightLb)):550*F*$e/T.weightLb;let cr=ln(Se,u.v_fps);if(C>0&&C<=.01&&A>1){const vt=cr/F,Ne=re/F;let Ue=(vt-Ne)/C;if(Ue<pt){Ue=pt;const qt=Ne+Ue*C;cr=qt*F,Se=qt*F*u.v_fps}if(Ue>mt){Ue=mt;const qt=Ne+Ue*C;cr=qt*F,Se=qt*F*u.v_fps}}const br=sn(cr,Te,Be);se=br.AGS_ftps2,Se=Se*br.PQWT_scale;const Rs=br.slip;se=hn(se,Te,Be,Te);const fo=se/F;fo>S&&(S=fo);const uo=re/F;if(uo>0&&A>1&&(C=cn(N,S,uo)),A<=12&&typeof console<"u"&&console.log&&console.log("[CONSOLIDATED_ROW]",{step:A,v_ftps:+u.v_fps.toFixed(3),EngRPM:+K.toFixed(0),wheelRPM:+Mr.toFixed(2),ClutchSlip:+de.toFixed(4),HPSave:+$.toFixed(1),HPEngPMI:+It.toFixed(1),HPChasPMI:+Ct.toFixed(1),DragHP:+ie.toFixed(2),HP_afterL1:+yt.toFixed(1),HP_afterL2:+ao.toFixed(1),PQWT:+Se.toFixed(1),AMin:+Te.toFixed(3),AMax:+Be.toFixed(3),AGS_applied:+se.toFixed(3)}),A<=20&&typeof console<"u"&&console.log&&console.log("[AERO_TRACE]",{step:A,v_fps:+At.toFixed(6),rho_slug_per_ft3:+le.toFixed(6),q_psf:+ht.toFixed(3),F_drag_lbf:+Gt.toFixed(2),F_lift_up_lbf:+ir.toFixed(2),normal_lbf:+Sr.toFixed(2),F_roll_lbf:+Ve.toFixed(2),AMin_ftps2:+Te.toFixed(3),AMax_ftps2:+Be.toFixed(3),AGS_ftps2:+se.toFixed(3)}),A<=10&&typeof console<"u"&&console.debug){const vt=se/F,Ne=Nt*(U??3.73);console.debug("[STEP]",{step:A,phase:or?"PINNED":"HP",v_fps:u.v_fps.toFixed(6),EngRPM:wt.toFixed(0),LockRPM:rt.toFixed(2),slipRPM:v.toFixed(0),lockThreshold:eo.toFixed(0),rpmIsPinned:or,clutchSlip:de.toFixed(6),gear:u.gearIdx+1,GRxFD:Ne.toFixed(3),tireDia_eff_in:He.toFixed(2),tireGrowth:x.growth.toFixed(4),tireSlip:_t(u.s_ft).toFixed(4),RWTdyn_lbf:xt.toFixed(1),RWTfront_lbf:kt.front_weight_lbf.toFixed(1),wheelieBar_lbf:kt.wheelie_bar_weight_lbf.toFixed(1),rho_slug_ft3:le.toFixed(6),dragHP:ie.toFixed(2),...g?{converterWork:rr.toFixed(4),converterSlipRatio:Zr.toFixed(4),converterZStall:zr.toFixed(0)}:{},HP_engine:$.toFixed(1),HPEngPMI:It.toFixed(1),HPChasPMI:Ct.toFixed(1),HP_afterLine1:yt.toFixed(1),HP_afterLine2:ao.toFixed(1),AGS_g:vt.toFixed(4),AGS_ftps2:se.toFixed(4),AMin_ftps2:Te.toFixed(4),AMax_ftps2:Be.toFixed(4),SLIP:Rs})}}re=se;const ro=ar(K,d);St+=ro*550*C;const oo=u.v_fps*C;ut+=dt*oo,I+=Ve*oo;const gs=1-Le,ps=1-bt(),ms=gs+ps;_e+=ro*550*C*ms;const Ms=be(u.v_fps,0),Ps=be(u.s_ft,0),Ts=be(se,Te),no=be(Se,0),ot=nn(Ms,Ps,C,no);if(A<=12&&typeof console<"u"&&console.log&&console.log("[INTEGRATED]",{step:A,Vel_next:+ot.Vel_ftps.toFixed(3),Dist_next:+ot.Dist_ft.toFixed(6)}),!Number.isFinite(ot.Vel_ftps)||!Number.isFinite(ot.Dist_ft))throw new Error(`NaN in state @ step=${A} v=${ot.Vel_ftps} dist=${ot.Dist_ft} AGS=${Ts} PQWT=${no}`);if(u.v_fps=ot.Vel_ftps,u.s_ft=ot.Dist_ft,u.t_s=u.t_s+C,!Number.isFinite(u.v_fps)||!Number.isFinite(u.s_ft)||!Number.isFinite(se))throw new Error(`NaN in state @ step=${A} v=${u.v_fps} dist=${u.s_ft} AGS=${se}`);if(Rt=se/F,u.s_ft>=ne){z="DISTANCE";break}if(u.t_s>=je){z="TIME_CAP";break}const so=(Z==null?void 0:Z.length)??1,Ss=(Pe??[])[u.gearIdx]??0,io=r?en(K,Ss,u.gearIdx,so-1):Yo(u.gearIdx,so,K,Pe??[]);let Fr=!1;if(r)Fr=io;else{const q=Zo(Oe,io);Oe=q.newState,Fr=q.executeShift}if(Fr){const q=u.gearIdx,$=K;u.gearIdx++;const ie=zo(p);ye=ie,jt+=ie,typeof console<"u"&&console.debug&&console.debug("[SHIFT]",{step:A,t_s:u.t_s.toFixed(4),v_fps:u.v_fps.toFixed(2),from_gear:q+1,to_gear:u.gearIdx+1,EngRPM_before:$.toFixed(0),LockRPM:rt.toFixed(0),dwell_s:ie.toFixed(3)})}for(!Ze&&u.s_ft>=ct&&(Ze=!0,ze=u.t_s),fe===0&&u.s_ft>=594&&(fe=u.t_s),ue===0&&u.s_ft>=1254&&(ue=u.t_s);We<et.length&&u.s_ft>=et[We];){const q=et[We],$=Ze?u.t_s-ze:0,ie=u.v_fps*ae;te.push({d_ft:q,t_s:$,v_mph:ie}),We++}if(u.t_s>=at){const $=(u.v_fps-qe)/C/No;ke.push({t_s:u.t_s,v_mph:u.v_fps*ae,a_g:$,s_ft:u.s_ft,rpm:u.rpm,gear:u.gearIdx+1}),at+=xe,qe=u.v_fps}}u.t_s>=je&&j.push("max_time_exceeded");const Yt=Ze?u.t_s-ze:u.t_s,Zt=u.v_fps*ae;let pr,mr;if(fe>0&&u.t_s>fe){const W=u.t_s-fe;W>0&&(pr=ae*66/W)}if(ue>0&&u.t_s>ue){const W=u.t_s-ue;W>0&&(mr=ae*66/W)}ee=.5*lt*u.v_fps*u.v_fps,z||(z="SAFETY"),typeof console<"u"&&console.debug&&console.debug("[RSACLASSIC END]",{reason:z,t_s:u.t_s,steps:A,d_ft:u.s_ft,target_ft:ne,totalShiftDwell_s:jt.toFixed(3)}),typeof console<"u"&&console.warn&&z!=="DISTANCE"&&console.warn("Terminated without crossing finish:",{reason:z,t_s:u.t_s,d_ft:u.s_ft,target_ft:ne}),(te.length===0||te[te.length-1].d_ft!==ne)&&te.push({d_ft:ne,t_s:Yt,v_mph:Zt});const zt={};pr!==void 0&&(zt.e660_mph=pr),mr!==void 0&&(zt.q1320_mph=mr);{const x=St,W=ut+I+_e+J+k,ve=ee+O,He=x-W-ve;console.log(`
=== ENERGY SUMMARY: ${T.name??"Unknown"} ===`),console.log(`ET: ${Yt.toFixed(3)}s, Trap MPH: ${Zt.toFixed(1)}`),console.log(`
Energy In:`),console.log(`  Engine:           ${(St/1e3).toFixed(1)} k-ft-lb`),console.log(`
Energy Out:`),console.log(`  Aero Drag:        ${(ut/1e3).toFixed(1)} k-ft-lb (${(100*ut/x).toFixed(1)}%)`),console.log(`  Rolling Resist:   ${(I/1e3).toFixed(1)} k-ft-lb (${(100*I/x).toFixed(1)}%)`),console.log(`  Driveline Loss:   ${(_e/1e3).toFixed(1)} k-ft-lb (${(100*_e/x).toFixed(1)}%)`),console.log(`  Engine PMI:       ${(J/1e3).toFixed(1)} k-ft-lb (${(100*J/x).toFixed(1)}%)`),console.log(`  Chassis PMI:      ${(k/1e3).toFixed(1)} k-ft-lb (${(100*k/x).toFixed(1)}%)`),console.log(`  Total Losses:     ${(W/1e3).toFixed(1)} k-ft-lb (${(100*W/x).toFixed(1)}%)`),console.log(`
Final Kinetic Energy:`),console.log(`  Translational:    ${(ee/1e3).toFixed(1)} k-ft-lb (${(100*ee/x).toFixed(1)}%)`),console.log(`  Rotational:       ${(O/1e3).toFixed(1)} k-ft-lb (${(100*O/x).toFixed(1)}%)`),console.log(`  Total Kinetic:    ${(ve/1e3).toFixed(1)} k-ft-lb (${(100*ve/x).toFixed(1)}%)`),console.log(`
Energy Balance:     ${(He/1e3).toFixed(1)} k-ft-lb (${(100*He/x).toFixed(1)}% error)`),console.log(`===
`)}const oe={et_s:r?Er(Yt,3):Yt,mph:r?Er(Zt,2):Zt,timeslip:te,traces:ke.length>0?ke:void 0,meta:{model:"RSACLASSIC",steps:Math.floor(u.t_s/C),warnings:j,windowMPH:Object.keys(zt).length>0?zt:void 0,converter:g&&!M?{used:!0,avgTR:Ce>0?Jt/Ce:1,avgETA:Ce>0?Qt/Ce:1,avgSR:Ce>0?Kt/Ce:1,deRateMax:.3,parasiticConst:.05,parasiticQuad:1e-6}:void 0,clutch:M?{used:!0,minC:tt,lockupAt_ft:Xt}:void 0,rollout:{rolloutIn:G??12,t_roll_s:ze},fuel:ft?{type:ft,minScale:Pt,maxScale:Tt}:void 0,vb6:{dt_s:C,trapMode:"time",windowsFt:{eighth:{start:594,end:660,distance:66},quarter:{start:1254,end:1320,distance:66}},timeslipPoints:[60,330,660,1e3,1320],rolloutBehavior:"ET clock starts after rollout distance (TIMESLIP.FRM:1380)"},termination:{reason:z,steps:A,t_s:u.t_s,target_ft:ne}}};return console.log("[RSACLASSIC] done",{et_s:+(((Kr=(er=oe==null?void 0:oe.et_s)==null?void 0:er.toFixed)==null?void 0:Kr.call(er,4))??(oe==null?void 0:oe.et_s)),mph:+(((Xr=(tr=oe==null?void 0:oe.mph)==null?void 0:tr.toFixed)==null?void 0:Xr.call(tr,1))??(oe==null?void 0:oe.mph)),steps:((Yr=(jr=oe==null?void 0:oe.meta)==null?void 0:jr.termination)==null?void 0:Yr.steps)??A,wallMs:Date.now()-o}),oe}}const Wr=new gn;function dr(e,t,r,o,s){let n=0;for(n=0;n<r-1&&!(s<=e[n+1]);n++);n>=r-1&&(n=r-2),n<0&&(n=0);const l=e[n],c=e[n+1],a=t[n],i=t[n+1];if(c===l)return a;const f=(s-l)/(c-l);return a+f*(i-a)}function qr(e,t,r,o,s){let n,l;if(s)n=1+4e-5*r,l=n*e*Je/12;else{const c=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));n=1+c*135e-7*Math.pow(r,1.6);const a=1+c*35e-5*r;a<n&&(n=a),l=(n-.035*Math.abs(o))*e*Je/12}return{TireGrowth:n,TireCirFt:l}}function Or(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function Vr(e){return e?xo:Ho}function pn(e,t,r,o){const s=e.Gear;let n;const l=e.Gear!==e.PrevGear;if(l)n=t.DTShift,e.PrevGear=e.Gear;else{if(n=o,e.Ags0_g>0&&e.L>1){const N=Math.min(e.AgsMax_g/e.Ags0_g,10);n=o*Math.pow(N,4)}n>.1&&(n=.1)}let c=0;const a=e.time_s-e.Time0_s;a>0&&(c=(e.AGS_g-e.Ags0_g)/a),c<pt&&(c=pt),c>mt&&(c=mt),e.Vel0_ftps=e.Vel_ftps,e.Ags0_g=e.AGS_g,e.Time0_s=e.time_s,e.Dist0_ft=e.Dist_ft,e.RPM0=e.EngRPM,e.DSRPM0=e.DSRPM,e.RPM0===t.LaunchRPM&&e.Time0_s===0&&(e.RPM0=t.Stall,t.LaunchRPM<t.Stall&&(e.Time0_s=t.EnginePMI*(t.Stall-t.LaunchRPM)/25e4));const i=qr(t.TireDia_in,t.TireWidth_in,e.Vel_ftps,e.Ags0_g,r.isLandSpeed);e.TireGrowth=i.TireGrowth,e.TireCirFt=i.TireCirFt;let f;r.isLandSpeed?f=1.01+(r.TractionIndex-1)*.01:f=1.02+(.005*(r.TractionIndex-1)+3*(r.TrackTempEffect-1))*(1-Math.pow(e.Dist0_ft/1320,2));const _=t.TGR[s-1]??1,d=t.TiresPMI+t.TransPMI*Math.pow(t.GearRatio,2)*Math.pow(_,2);let h=e.Vel0_ftps+e.Ags0_g*F*n+c*F*n*n/2;h<e.Vel0_ftps*.9&&e.Vel0_ftps>100&&(h=e.Vel0_ftps),h<0&&(h=0);const m=t.ShiftRPM[s-1]??9e3;if(!l&&(n<.005&&(n=.005),n>.05&&(n=.05),h=e.Vel0_ftps+e.Ags0_g*F*n+c*F*n*n/2,e.Vel0_ftps>0&&e.RPM0>t.Stall&&s<t.NGR)){const N=e.Vel0_ftps*(m+5)/e.RPM0;h>N&&(h=N,e.Ags0_g*F>0&&(n=(h-e.Vel0_ftps)/(e.Ags0_g*F)))}const M=h*h-e.Vel0_ftps*e.Vel0_ftps,g=f*h*60/e.TireCirFt,p=g*t.GearRatio*_;let P=t.Slippage*p,v,b=t.Stall,E=0;t.isClutch?(P<t.Stall&&(s===1||!t.LockUp)&&(P=t.Stall),v=p/P):s===1||!t.LockUp?(b=t.Stall,E=t.Slippage*p/b,e.L>2&&(E>.6&&(b=b*(1+(t.Slippage-1)*(E-.6)/(1/t.Slippage-.6))),E=t.Slippage*p/b),v=1/t.Slippage,P<b&&(P=b,v=(t.TorqueMult-(t.TorqueMult-1)*E)*p/b)):(P=1.005*p,v=p/P),v>1&&(v=1);let w=dr(t.xrpm,t.yhp,t.NHP,1,P);w=t.HPTQMult*w/r.hpc;const Y=w;w=w*v;const V=Math.sqrt(h*h+2*h*(r.WindSpeed_mph/Bt)*Math.cos(Je*r.WindAngle_deg/180)+Math.pow(r.WindSpeed_mph/Bt,2)),Ee=Math.sign(V)*r.rho*Math.pow(Math.abs(V),2)/(2*F);let pe;t.BodyStyle===8?pe=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*t.TireWidth_in/144:pe=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*(2*t.TireWidth_in)/144;const Qe=t.Weight_lbf+t.LiftCoef*pe*Ee,T=r.isLandSpeed?Ir:hr,X=r.isLandSpeed?Ao:wo,Ke=r.isLandSpeed?Io:vo,ne=(T-e.Dist0_ft/1320*X)*Qe+1e-4*Qe*(Bt*h)+t.DragCoef*pe*Ee,ce=ne*h/550,it=12*e.TireCirFt/(2*Je),me=(e.Ags0_g*t.Weight_lbf*(t.YCG_in-it+Ke/t.Efficiency*it)+ne*t.YCG_in)/t.Wheelbase_in;let U=t.StaticFWt_lbf-me,Z=0;U<0&&(Z=-U*t.Wheelbase_in/64,U=0);let Me=Qe-U-Z;Me<0&&(Me=t.Weight_lbf);const Pe=Or(r.TractionIndex,r.TrackTempEffect),De=Vr(r.isLandSpeed);let we=Pe*De*t.TireDia_in*(t.TireWidth_in+1)*(.92+.08*Math.pow(Me/1900,2.15));t.BodyStyle===8&&(we=.5*we);const H=(we/e.TireGrowth-ne)/t.Weight_lbf,Xe=t.TGEff[s-1]??.99;w=w*Xe*t.Efficiency/f;const D=w;w=w-ce;let G=550*F*w/t.Weight_lbf,L=G/(h*F),Ae=!1;L>H&&(Ae=!0,G=G*(H-(L-H))/L,L=H-(L-H)),L<ge&&(L=ge,G=ge*F*h);let le=Math.max(0,M)/(2*G)+e.Time0_s;const lt=r.isLandSpeed?Co:vr,ct=r.isLandSpeed?yo:Hr;let z=t.EnginePMI*P*(P-e.RPM0);z<0&&(t.isClutch?z=lt*z:z=ct*z);let A=d*g*(g-e.DSRPM0);A<0&&(A=0);let je=0,xe=0,Ge=0;for(Ge=1;Ge<=12;Ge++){const N=le-e.Time0_s;if(N<=0)break;const S=Math.pow(2*Je/60,2)/(12*550*N);je=z*S,xe=A*S,w=(Y-je)*v,w=(w*Xe*t.Efficiency-xe)/f-ce,G=550*F*w/t.Weight_lbf,L=G/(h*F);let C=0;N!==0&&(C=(L-e.Ags0_g)/N),C<pt&&(C=pt,L=e.Ags0_g+C*N,G=L*F*h),C>mt&&(C=mt,L=e.Ags0_g+C*N,G=L*F*h),Ae=!1,L>H&&(Ae=!0,G=G*(H-(L-H))/L,L=H-(L-H)),L<ge&&(L=ge,G=ge*F*h);const at=Math.max(0,M)/(2*G)+e.Time0_s,ke=at-e.Time0_s;if(Ge===12||Math.abs(100*(ke-N)/ke)<=.01){le=at;break}let te=w/Y;te<Cr&&(te=Cr),te>yr&&(te=yr),le=e.Time0_s+N+te*(ke-N)}const Ye=le-e.Time0_s;let Ie;if(G<.1||Ye<=0){const N=(e.Vel0_ftps+h)/2;Ie=e.Dist0_ft+Math.max(0,N*Math.abs(Ye))}else{const N=Math.pow(e.Vel0_ftps,3),S=2*G*Ye+e.Vel0_ftps*e.Vel0_ftps;if(S<0){const C=(e.Vel0_ftps+h)/2;Ie=e.Dist0_ft+C*Ye}else Ie=(Math.pow(S,1.5)-N)/(3*G)+e.Dist0_ft}return e.L+=1,e.time_s=le,e.Vel_ftps=h,e.Dist_ft=Ie,e.AGS_g=L,e.EngRPM=P,e.DSRPM=g,e.SLIP=Ae,{TimeStep_s:n,VelSqrd:M,LockRPM:p,ClutchSlip:v,zStall:b,SlipRatio:E,TireSlip:f,WindFPS:V,q:Ee,RefArea2_ft2:pe,DownForce_lbf:Qe,DragForce_lbf:ne,DragHP:ce,DynamicFWT_lbf:U,DynamicRWT_lbf:Me,WheelBarWT_lbf:Z,CRTF:we,AMax_g:H,ChassisPMI:d,EngAccHP:z,ChasAccHP:A,HPSave:Y,HPAtWheels:D,HP:w,PQWT:G,iterations:Ge}}function mn(e,t,r){const o=qr(e.TireDia_in,e.TireWidth_in,0,0,t.isLandSpeed),s=dr(e.xrpm,e.yhp,e.NHP,1,r);let c=5252*(e.HPTQMult*s/t.hpc)/r;const a=e.TGR[0]??1,i=e.TGEff[0]??.99;c=c*e.TorqueMult*a*i;const f=t.isLandSpeed?Ir:hr,_=t.WindSpeed_mph/Bt,d=Math.sign(_)*t.rho*Math.pow(Math.abs(_),2)/(2*F),h=f*e.Weight_lbf+e.DragCoef*e.RefArea_ft2*d;let m;t.isLandSpeed?m=1.01+(t.TractionIndex-1)*.01:m=1.02+(t.TractionIndex-1)*.005+(t.TrackTempEffect-1)*3;const M=c*e.GearRatio*e.Efficiency/(m*e.TireDia_in/24)-h;let p=(e.isClutch?.88:.96)*M/e.Weight_lbf;const v=e.Weight_lbf-e.StaticFWt_lbf,b=Or(t.TractionIndex,t.TrackTempEffect),E=Vr(t.isLandSpeed);let w=b*E*e.TireDia_in*(e.TireWidth_in+1)*(.92+.08*Math.pow(v/1900,2.15));e.BodyStyle===8&&(w=.5*w);const Y=(w-h)/e.Weight_lbf;return p>Y&&(p=Y),p<ge&&(p=ge),{L:1,time_s:0,Vel_ftps:.001,Dist_ft:0,AGS_g:p,EngRPM:r,DSRPM:0,Gear:1,SLIP:!1,Vel0_ftps:0,Ags0_g:p,Time0_s:0,Dist0_ft:0,RPM0:r,DSRPM0:0,AgsMax_g:p,TireGrowth:o.TireGrowth,TireCirFt:o.TireCirFt,ShiftFlag:0,PrevGear:1}}function Mn(e,t,r,o){let s=e*.11*Math.pow(t*r/o,-.3333333333333333);return s=s/15,s<.005&&(s=.005),s}function Br(e,t,r){let o=0,s=0,n=r-1;const l=e[0],c=e[r-1];if(t<=l)return o=1,n=1,{KBOTM:s,KTOP:n,JJ:o};if(t>=c)return o=1,s=r-2,n=r-1,{KBOTM:s,KTOP:n,JJ:o};for(;n-s>1;){const a=Math.floor((s+n)/2);t<e[a]?n=a:s=a}return{KBOTM:s,KTOP:n,JJ:o}}function gr(e,t,r,o,s){if(r<=0)return 0;if(r===1)return t[0];let n=0,l=1;if(r===2)n=0,l=1;else{const a=Br(e,s,r);n=a.KBOTM,l=a.KTOP;const i=a.JJ;if(n===l)return t[n];i!==1&&o>1&&(l=l+1,(o>=3||l>r-1)&&(l>r-1&&(l=r-1),n=n-1,n<0&&(n=0)))}let c=0;for(let a=n;a<=l;a++){let i=1;const f=e[a];for(let _=n;_<=l;_++)if(_===a)i=i*t[a];else{const d=e[_];i=i*(s-d)/(f-d)}c=c+i}return c}function Pn(e,t,r,o,s,n,l,c,a){const i=Br(t,a,s);let f=i.KBOTM,_=i.KTOP;i.JJ;const d=[],h=[];for(let g=f;g<=_;g++){const p=[];for(let v=0;v<o;v++)p.push(r[g*o+v]);const P=gr(e,p,o,n,c);d.push(P),h.push(t[g])}const m=_-f+1,M=Math.min(l,m);return gr(h,d,m,M,a)}function Tn(e){switch(e){case 1:case 2:return 1;case 3:case 4:return 1.08;case 5:return 5;case 6:return 2*1;case 7:case 9:return 2.5*1.08;case 8:return 1.5*5.5;default:return 1}}function Sn(e){return e<=5}const Rn=[.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],Fn=[.7,1.2,1.7,2.5,3.4],bn=[.53,.975,1.098,1.13,1.152,1.16,1.153,1.122,1.086,1.045,1,.938,.865,.795,.72,.63,.365,.87,1.018,1.066,1.11,1.129,1.132,1.11,1.079,1.042,1,.935,.855,.762,.66,.54,.24,.79,.96,1.023,1.08,1.106,1.117,1.102,1.074,1.04,1,.932,.845,.736,.612,.474,.1,.7,.894,.972,1.04,1.08,1.096,1.09,1.069,1.037,1,.928,.83,.698,.55,.39,0,.63,.84,.924,1,1.055,1.079,1.082,1.064,1.035,1,.923,.815,.662,.49,.31],$r=[0,.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],Mt=[0,.7,1.2,1.7,2.5,3.4],En=[0,0,.61,.8,.9,.98,1.035,1.055,1.06,1.05,1.03,1,.93,.85,.765,.67,.58];function wn(e,t){return Pn(Rn,Fn,bn,16,5,1,1,e,t)}function An(e){const{peakHP:t,peakRPM:r,displacement_cid:o,fuelSystem:s}=e,n=fr*t/r,l=Tn(s);let c=t/o/l;s<=5?c<Mt[1]&&(c=Mt[1]):c<Mt[2]&&(c=Mt[2]),c>Mt[5]&&(c=Mt[5]);const a=[0],i=[0],f=[0],_=16;for(let d=1;d<=_;d++){a[d]=$r[d]*r;let h;s===8?h=En[d]*n:h=wn($r[d],c)*n,i[d]=a[d]*h/fr,f[d]=h}return{xrpm:a,yhp:i,ztq:f,NHP:_}}function xn(e){const t=[],r=[];for(let o=1;o<=e.NHP;o++)t.push(e.xrpm[o]),r.push(e.yhp[o]);return{rpm:t,hp:r}}function In(e){return e>800?1:8}function Cn(e){switch(e){case 1:return{dragCoef:.66,liftCoef:.8,overhang_in:30};case 2:return{dragCoef:.5,liftCoef:.2,overhang_in:30};case 3:return{dragCoef:.52,liftCoef:.8,overhang_in:40};case 4:return{dragCoef:.52,liftCoef:.1,overhang_in:30};case 5:return{dragCoef:.28,liftCoef:.1,overhang_in:30};case 6:return{dragCoef:.4,liftCoef:.1,overhang_in:24};case 7:return{dragCoef:.46,liftCoef:.1,overhang_in:18};case 8:return{dragCoef:.54,liftCoef:.1,overhang_in:12};default:return{dragCoef:.5,liftCoef:.2,overhang_in:30}}}function yn(e,t){const r=[];if(t){const o=e>=3?.985:.99;for(let s=1;s<=e;s++)r.push(o-(e-s)*2*.005)}else for(let s=1;s<=e;s++)r.push(.99-(e-s)*.005);return r}function vn(e,t,r,o,s,n,l){let c,a,i;return Sn(t)?c=e/120:c=e/90,r?a=(o-1)*c/10:a=o*c/50,i=2*(1.15*.8*(.08*s*n)*Math.pow(s/2,2)/386),l===8&&(c=e/240,a=a/(240/120),i=i/2),{enginePMI:c,transPMI:a,tiresPMI:i}}function Hn(e){return e===8?.985:.97}function Ln(e){return 1.0025+e/1e6}function Nn(e){const t=Fe[e];return t?t.lengthFt:e==="EIGHTH"?660:1320}function Dn(e){const t=Re[e];return t||(e==="EIGHTH"?Re.EIGHTH:Re.QUARTER)}function Gn(e){if(!e)return 1;const t=e.toUpperCase();return t==="GAS+CARB"||t==="GASOLINE+CARBURETOR"?1:t==="GAS+INJECT"||t==="GASOLINE+FUEL INJECTION"?2:t==="METHANOL+CARB"||t==="METHANOL+CARBURETOR"?3:t==="METHANOL+INJECT"||t==="METHANOL+FUEL INJECTION"?4:t==="NITRO+INJECT"||t==="NITROMETHANE+FUEL INJECTION"?5:t==="GAS+SUPERCHARGED"||t==="GASOLINE+SUPERCHARGED"?6:t==="METHANOL+SUPERCHARGED"?7:t==="NITRO+SUPERCHARGED"||t==="NITROMETHANE+SUPERCHARGED"?8:t==="ELECTRIC"?9:t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function kn(e){const t=e.vehicle,r=e.engine??t.engine,o=(r==null?void 0:r.hpCurve)??(r==null?void 0:r.torqueCurve)??t.torqueCurve??t.hpCurve??[],s=[],n=[];for(const f of o)Array.isArray(f)?(s.push(f[0]),n.push(f[1])):f&&typeof f=="object"&&(s.push(f.rpm),f.hp!==void 0?n.push(f.hp):f.torque!==void 0?n.push(f.torque*f.rpm/5252):f.tq_lbft!==void 0&&n.push(f.tq_lbft*f.rpm/5252));if(s.length>=2)return{xrpm:s,yhp:n,NHP:s.length,isQuarterJr:!1};const l=Number(t.powerHP??t.peakHP),c=Number(t.rpmAtPeakHP??t.peakRPM??6500),a=Number(t.displacement_cid??t.displacementCID??350),i=e.fuelSystem??t.fuelSystem??1;if(Number.isFinite(l)&&l>0){const f=An({peakHP:l,peakRPM:c,displacement_cid:a,fuelSystem:i}),{rpm:_,hp:d}=xn(f);return{xrpm:_,yhp:d,NHP:f.NHP,isQuarterJr:!0,quarterJrParams:{peakHP:l,rpmAtPeakHP:c,displacement_cid:a,fuelSystem:i}}}return{xrpm:[4e3,6500],yhp:[100,150],NHP:2,isQuarterJr:!1}}function Wn(e){const t=Math.abs(100-e);let r;return e>100?r=1+25e-7*Math.pow(t,2.5):r=1+2e-6*Math.pow(t,2.5),r>1.04&&(r=1.04),r}function qn(e){var Ce,tt,Xt,ft,Pt,Tt,St,ut;const t=[],r=[],o=e.vehicle,s=e.env,n=e.raceLength??"QUARTER",l=e.raceLengthFt??Nn(n),c=((Ce=Fe[n])==null?void 0:Ce.category)==="landspeed",a=o.rolloutIn??9,i=o.overhangIn??0;let f=2*a;f<24&&(f=24);let _=(i+.25*f)/12;const d=.5*f/12;_<d&&(_=d);const h=a/12,m=e.drivetrain??o.drivetrain,M=(m==null?void 0:m.clutch)??e.clutch??o.clutch,g=(m==null?void 0:m.converter)??e.converter??o.converter,p=e.engine??o.engine,P=e.pmi??o.pmi,v=o.transmissionType??e.transmissionType,b=v==="clutch"?!0:v==="converter"?!1:!g||M&&!g,E=e.fuel,w=typeof E=="string"?E:(E==null?void 0:E.fuelType)??(E==null?void 0:E.fuelSystem)??(E==null?void 0:E.type)??e.fuelType??e.fuelSystem??o.fuelSystem,Y=Gn(w),V=Lr({barometer_inHg:s.barometerInHg??29.92,temperature_F:s.temperatureF??59,relHumidity_pct:s.humidityPct??50,elevation_ft:s.elevation??0,fuelSystem:Y}),Ee=V.rho_slug_per_ft3*F,pe=V.hpc,Qe=kn(e),{xrpm:T,yhp:X,NHP:Ke,isQuarterJr:j,quarterJrParams:ne}=Qe;Ke<2&&t.push("HP curve has fewer than 2 points"),j&&t.push("Using QuarterJr mode (synthetic HP curve from peak HP)");const ce=(m==null?void 0:m.gearRatios)??o.gearRatios??[2.5,1.8,1.4,1.1,1],it=(m==null?void 0:m.finalDriveRatio)??o.finalDrive??o.rearGear??3.73,me=ce.length,U=o.tire,Z=(U==null?void 0:U.diameter_in)??o.tireDiaIn??32,Me=(U==null?void 0:U.width_in)??o.tireWidthIn??17,Pe=o.bodyStyle??In(o.weightLb);let De,we,H,Xe,D,G,L,Ae,Ht,le,lt,ct;if(j&&ne){const{displacement_cid:I,fuelSystem:_e}=ne;De=yn(me,!b);const J=o.shiftRPM??(m==null?void 0:m.shiftRPM)??7e3;we=ce.map(()=>J);const k=(M==null?void 0:M.slipRPM)??(g==null?void 0:g.stallRPM)??o.slipStallRPM??5e3;if(b)Xe=Ln(k),D=1,H=k;else{const Rt=(g==null?void 0:g.diameter_in)??(g==null?void 0:g.diameter)??o.converterDiameterIn??o.converterDia_in??10;let re;if(k>220){H=k;const Q=gr(T,X,Ke,1,H)*(fr/H)/pe;re=H/1e3*(H/Q)}else re=k,H=k;const Ft=re/(200*Math.pow(7/Rt,4));Xe=1.01+Ft/20+re/8e3,D=2.633-Math.pow(Ft,.3)-re/1500,D<1&&(D=1),D>2&&(D=2)}Ht=Hn(Pe);const ee=Cn(Pe);le=ee.dragCoef,lt=ee.liftCoef,ct=ee.overhang_in;const O=vn(I,_e,!b,me,Z,Me,Pe);G=O.enginePMI,L=O.transPMI,Ae=O.tiresPMI}else{De=(m==null?void 0:m.perGearEff)??o.gearEfficiencies??null??ce.map(()=>.99),we=(m==null?void 0:m.shiftRPMs)??(m==null?void 0:m.shiftsRPM)??o.shiftRPMs??ce.map(()=>7e3);const _e=(M==null?void 0:M.slipRPM)??o.clutchSlipRPM??7200,J=(g==null?void 0:g.stallRPM)??o.converterStallRPM??5500;H=b?_e:J;const k=(M==null?void 0:M.slippageFactor)??(M==null?void 0:M.slippage)??(M==null?void 0:M.slipRatio)??o.clutchSlippage??1.0025,ee=(g==null?void 0:g.slippageFactor)??(g==null?void 0:g.slippage)??(g==null?void 0:g.slipRatio)??o.converterSlippage??1.06;Xe=b?k:ee,D=b?1:(g==null?void 0:g.torqueMult)??(g==null?void 0:g.torqueMultiplier)??o.converterTorqueMult??2.2,G=(P==null?void 0:P.engine_flywheel_clutch)??o.enginePMI??(p==null?void 0:p.enginePMI)??4,Ae=(P==null?void 0:P.tires_wheels_ringgear)??o.tiresPMI??(p==null?void 0:p.tiresPMI)??.5,L=(P==null?void 0:P.transmission_driveshaft)??o.transPMI??(p==null?void 0:p.transPMI)??.2,Ht=(m==null?void 0:m.overallEfficiency)??o.transEfficiency??.97;const O=e.aero??o.aero;le=(O==null?void 0:O.Cd)??(O==null?void 0:O.cd)??o.cd??.35,lt=(O==null?void 0:O.Cl)??(O==null?void 0:O.cl)??o.liftCoeff??0,ct=i}const z=o.cgHeight_in??o.cgHeightIn??Z/2+3.75,A=o.staticFrontWeight_lb??o.staticFrontWeightLb??o.weightLb*.38,je=j?ct:i,xe={Weight_lbf:o.weightLb,Wheelbase_in:o.wheelbaseIn??100,YCG_in:z,StaticFWt_lbf:A,TireDia_in:Z,TireWidth_in:Me,Rollout_in:o.rolloutIn??12,GearRatio:it,TGR:ce,TGEff:De,Efficiency:Ht,DTShift:b?.2:.25,Slippage:Xe,TorqueMult:D,Stall:H,LockUp:(g==null?void 0:g.lockup)??!1,isClutch:b,RefArea_ft2:((tt=e.aero)==null?void 0:tt.frontalArea_ft2)??o.frontalArea_ft2??o.frontalAreaFt2??20,DragCoef:le,LiftCoef:lt,BodyStyle:Pe,EnginePMI:G,TiresPMI:Ae,TransPMI:L,xrpm:T,yhp:X,NHP:Ke,HPTQMult:o.hpTorqueMultiplier??(p==null?void 0:p.hpTqMult)??1,ShiftRPM:we,NGR:me,LaunchRPM:b?(M==null?void 0:M.launchRPM)??o.clutchLaunchRPM??H:H};if(j&&je!==i){let I=2*a;I<24&&(I=24),_=(je+.25*I)/12;const _e=.5*I/12;_<_e&&(_=_e)}const Ge=s.trackTempF??100,Ye=c?1:Wn(Ge),Ie={rho:Ee,hpc:pe,TractionIndex:s.tractionIndex??5,TrackTempEffect:Ye,WindSpeed_mph:s.windMph??0,WindAngle_deg:s.windAngleDeg??0,isLandSpeed:c},N=b?(M==null?void 0:M.launchRPM)??H:H,S=mn(xe,Ie,N),C=dr(T,X,Ke,1,N),u=Mn(60,C,D,o.weightLb),at=c?5e4:5e3,ke=c?300:30,te={iterations:[],convergenceHistory:[]},Ze=[],ze=Dn(n);let et=0,We=null,fe=null,ue=null;for(let I=0;I<at&&!(S.Dist_ft-h+_>=l+50||S.time_s>=ke);I++){if(!Number.isFinite(S.Vel_ftps)||!Number.isFinite(S.Dist_ft)||!Number.isFinite(S.AGS_g)){t.push(`NaN detected at step ${I}: Vel=${S.Vel_ftps}, Dist=${S.Dist_ft}, AGS=${S.AGS_g}`);break}const J=pn(S,xe,Ie,u);if(te.iterations.push(J.iterations),I<20&&te.convergenceHistory.push({step:I,iterations:J.iterations,HPSave:J.HPSave,HP:J.HP,PQWT:J.PQWT,AGS_g:S.AGS_g}),We===null&&S.Dist_ft>=h){const Q=(S.Dist_ft-h)/S.Vel_ftps;We=S.time_s-Q}const k=Math.max(0,S.Dist_ft-h+_),ee=We!==null?S.time_s-We:0,O=xe.TGR[S.Gear-1]??1,Rt=(J.LockRPM??S.EngRPM)/O,re=J.TireSlip,Ft=S.Vel_ftps*re*ae;if(r.push({t_s:ee,s_ft:k,v_fps:S.Vel_ftps,v_mph:S.Vel_ftps*ae,a_g:S.AGS_g,rpm:S.EngRPM,dsrpm:Rt,lockRpm:J.LockRPM,gear:S.Gear,slip:S.SLIP,tireSlip:re,hp:J.HPAtWheels,dragHp:J.DragHP,netHp:J.HP,wheelSpeed_mph:Ft}),fe===null&&k>=594){const B=r.length>1?((Xt=r[r.length-2])==null?void 0:Xt.s_ft)??0:0,Q=r.length>1?((ft=r[r.length-2])==null?void 0:ft.t_s)??0:0;if(B<594&&k>B){const he=(594-B)/(k-B);fe=Q+he*(ee-Q)}else fe=ee}if(ue===null&&k>=1254){const B=r.length>1?((Pt=r[r.length-2])==null?void 0:Pt.s_ft)??0:0,Q=r.length>1?((Tt=r[r.length-2])==null?void 0:Tt.t_s)??0:0;if(B<1254&&k>B){const he=(1254-B)/(k-B);ue=Q+he*(ee-Q)}else ue=ee}for(;et<ze.length&&k>=ze[et];){const B=ze[et],Q=r.length>1?((St=r[r.length-2])==null?void 0:St.s_ft)??0:0,he=r.length>1?((ut=r[r.length-2])==null?void 0:ut.t_s)??0:0;let Oe=ee;if(Q<B&&k>Q){const jt=(B-Q)/(k-Q);Oe=he+jt*(ee-he)}let ye;B===660&&fe!==null&&Oe>fe?ye=ae*66/(Oe-fe):B===1320&&ue!==null&&Oe>ue?ye=ae*66/(Oe-ue):ye=S.Vel_ftps*ae,Ze.push({d_ft:B,t_s:Oe,v_mph:ye}),et++}if(S.ShiftFlag===1)S.ShiftFlag=2,S.Gear++;else if(S.ShiftFlag===2)S.ShiftFlag=0;else if(S.Gear<xe.NGR){const B=xe.ShiftRPM[S.Gear-1]??7e3;S.EngRPM>=B&&(S.ShiftFlag=1)}}const qe=Ze.find(I=>I.d_ft===l),Jt=(qe==null?void 0:qe.t_s)??S.time_s,Qt=(qe==null?void 0:qe.v_mph)??S.Vel_ftps*ae,Kt=r.map(I=>({t_s:I.t_s,s_ft:I.s_ft,v_mph:I.v_mph,v_fps:I.v_fps,a_g:I.a_g,rpm:I.rpm,dsrpm:I.dsrpm,lockRpm:I.lockRpm,gear:I.gear,slip:I.slip,tireSlip:I.tireSlip,hp:I.hp,dragHp:I.dragHp,wheelSpeed_mph:I.wheelSpeed_mph}));return{et_s:Jt,mph:Qt,timeslip:Ze,traces:Kt,meta:{model:"VB6Exact",steps:r.length,warnings:t},vb6Diagnostics:te}}const On="rsa.model.";function Vn(e){try{const t=On+e,r=localStorage.getItem(t);if(!r)return;const o=JSON.parse(r);if(!o.w||!o.P||typeof o.n!="number"){console.warn(`Invalid model structure for vehicle ${e}`);return}return o}catch(t){console.error(`Failed to load model for vehicle ${e}:`,t);return}}function Bn(e,t){if(t.length!==e.w.length)throw new Error(`Feature dimension mismatch: expected ${e.w.length}, got ${t.length}`);let r=0;for(let o=0;o<e.w.length;o++)r+=e.w[o]*t[o];return r}class $n{constructor(){Ot(this,"id","Blend")}simulate(t){const r=Wr.simulate(t),o=t.vehicle.id,s=Vn(o);let n=0;const l=[...r.meta.warnings];if(s){const d=[gt(t.env)/1e3,t.vehicle.weightLb/3e3,t.vehicle.tireDiaIn/30,t.vehicle.rearGear/4,(r.et_s-10)/5];n=Bn(s,d)}else l.push("no_learned_model");const c=r.et_s*.8,a=r.et_s*1.2;return{et_s:Math.max(c,Math.min(a,r.et_s+n)),mph:r.mph,timeslip:r.timeslip,traces:r.traces,meta:{model:"Blend",steps:r.meta.steps,warnings:l}}}}const Un=new $n;class Jn{constructor(){Ot(this,"id","SimpleV1")}simulate(t){const r=go({vehicle:t.vehicle,env:t.env,raceLength:t.raceLength});return{et_s:r.baseET_s,mph:r.baseMPH,timeslip:r.timeslip,meta:{model:"SimpleV1",steps:r.timeslip.length,warnings:[]}}}}class Qn{constructor(){Ot(this,"id","VB6Exact")}simulate(t){const r=qn(t);return{...r,meta:{...r.meta,model:"VB6Exact"}}}}const Kn={SimpleV1:new Jn,RSACLASSIC:Wr,VB6Exact:new Qn,Blend:Un};function Ur(e){const t=Kn[e];if(!t)throw new Error(`Unknown physics model: ${e}`);return t}function Xn(e){if(e!=null&&e.drivetrain){const t=e.drivetrain;t.shiftsRPM&&!t.shiftRPM&&(t.shiftRPM=t.shiftsRPM),t.overallEfficiency!==void 0&&t.overallEff===void 0&&(t.overallEff=t.overallEfficiency),t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}if(e!=null&&e.vehicle){const t=e.vehicle;t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}return e}function Ut(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const o=Number(e.torque)*r/5252*t;return{rpm:r,hp:o}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const o=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:o}}return null}function jn(e){var o,s,n,l,c,a;if(Array.isArray((o=e==null?void 0:e.engineParams)==null?void 0:o.powerHP)&&e.engineParams.powerHP.length>=2)return e;const t=((s=e==null?void 0:e.fuel)==null?void 0:s.hpTorqueMultiplier)??1;let r=[];if(Array.isArray((n=e==null?void 0:e.vehicle)==null?void 0:n.hpCurve)&&e.vehicle.hpCurve.length>=2&&(r=e.vehicle.hpCurve.map(i=>Ut(i,t)).filter(i=>i!==null&&Number.isFinite(i.rpm)&&Number.isFinite(i.hp)).sort((i,f)=>i.rpm-f.rpm)),r.length<2&&Array.isArray(e==null?void 0:e.engineHP)&&e.engineHP.length>=2&&(r=e.engineHP.map(i=>Array.isArray(i)?{rpm:Number(i[0]),hp:Number(i[1])*t}:Ut(i,t)).filter(i=>i!==null&&Number.isFinite(i.rpm)&&Number.isFinite(i.hp)).sort((i,f)=>i.rpm-f.rpm)),r.length<2&&Array.isArray((l=e==null?void 0:e.engineParams)==null?void 0:l.torqueCurve)&&e.engineParams.torqueCurve.length>=2&&(r=e.engineParams.torqueCurve.map(i=>Ut(i,t)).filter(i=>i!==null&&Number.isFinite(i.rpm)&&Number.isFinite(i.hp)).sort((i,f)=>i.rpm-f.rpm)),r.length<2&&Array.isArray((c=e==null?void 0:e.vehicle)==null?void 0:c.torqueCurve)&&e.vehicle.torqueCurve.length>=2&&(r=e.vehicle.torqueCurve.map(i=>Ut(i,t)).filter(i=>i!==null&&Number.isFinite(i.rpm)&&Number.isFinite(i.hp)).sort((i,f)=>i.rpm-f.rpm)),r.length<2){const i=Number((a=e==null?void 0:e.vehicle)==null?void 0:a.powerHP);Number.isFinite(i)&&i>0&&(r=[{rpm:4e3,hp:i*.85*t},{rpm:5e3,hp:i*.92*t},{rpm:6e3,hp:i*.97*t},{rpm:6500,hp:i*1*t},{rpm:7e3,hp:i*.98*t},{rpm:7500,hp:i*.94*t},{rpm:8e3,hp:i*.88*t}])}return r.length>=2&&(e.engineParams={...e.engineParams??{},powerHP:r}),e}function Yn(e){Xn(e),jn(e)}function Zn(e){var s,n;if(!Array.isArray(e))return"none";const t=(s=e[0])==null?void 0:s.rpm,r=(n=e[e.length-1])==null?void 0:n.rpm;return`n=${e.length},first=${t},last=${r}`}self.onmessage=async e=>{var t,r,o,s,n,l,c,a,i;try{const f=e.data;if(!(f!=null&&f.model)||!(f!=null&&f.payload))throw new Error("Bad worker message");const _=JSON.parse(JSON.stringify(f.payload));if(f.model==="VB6Exact"){console.log("[WORKER:VB6Exact] Running with SimInputs format",{hasVehicle:!!_.vehicle,vehicleName:(t=_.vehicle)==null?void 0:t.name,powerHP:(r=_.vehicle)==null?void 0:r.powerHP,hasHpCurve:!!((o=_.vehicle)!=null&&o.hpCurve),raceLength:_.raceLength});const p=Ur(f.model).simulate(_);self.postMessage({ok:!0,result:p});return}Yn(_);const d=(s=_==null?void 0:_.engineParams)==null?void 0:s.powerHP;if(!Array.isArray(d)||d.length<2)throw console.error("[WORKER] bad powerHP",{hpLen:d==null?void 0:d.length,sample:(n=d==null?void 0:d.slice)==null?void 0:n.call(d,0,2)}),new Error("EngineParams must provide either torqueCurve or powerHP");Number.isFinite(_==null?void 0:_.raceLengthFt)||(_.raceLengthFt=(f==null?void 0:f.raceLengthFt)??1320);const h=(_==null?void 0:_.drivetrain)??{};console.log("[WORKER:normalized.input]",{hasEngineParams:!!_.engineParams,hasPowerHP:!!d,raceLengthFt:_.raceLengthFt,hpSummary:Zn(d),hasClutch:!!h.clutch,hasConverter:!!h.converter,slipRPM:(l=h==null?void 0:h.clutch)==null?void 0:l.slipRPM,stallRPM:(c=h==null?void 0:h.converter)==null?void 0:c.stallRPM});try{_!=null&&_.tuning&&console.debug("[WORKER:TUNING]",!0,_.tuning)}catch{}_.flags===void 0&&(_.flags={}),_.flags.vb6Strict===void 0&&(_.flags.vb6Strict=((i=(a=f.payload)==null?void 0:a.flags)==null?void 0:i.vb6Strict)??!0);const M=Ur(f.model).simulate(_);self.postMessage({ok:!0,result:M})}catch(f){console.error("[WORKER ERROR]",f),self.postMessage({ok:!1,error:String((f==null?void 0:f.message)||f)})}}})();
//# sourceMappingURL=index-D8Xwso8H.js.map
