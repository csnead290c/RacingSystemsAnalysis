var Kn=Object.defineProperty;var Un=(Ce,pe,qe)=>pe in Ce?Kn(Ce,pe,{enumerable:!0,configurable:!0,writable:!0,value:qe}):Ce[pe]=qe;var mt=(Ce,pe,qe)=>Un(Ce,typeof pe!="symbol"?pe+"":pe,qe);(function(){"use strict";const Ce={EIGHTH:[60,330,660],QUARTER:[60,330,660,1e3,1320]};function pe(e){const o=e.elevation+(29.92-e.barometerInHg)*1e3,r=59-o/1e3*3.5,i=(e.temperatureF-r)*120,n=e.humidityPct/10*50*(e.temperatureF/80);return o+i+n}function qe(e){const o=.0061*Math.exp(17.27*(e.temperatureF-32)/1.8/(237.3+(e.temperatureF-32)/1.8))*(e.humidityPct/100),r=7e3*.622*(o/(e.barometerInHg-o));return Math.max(0,Math.min(r,500))}function nr(e){const r=518.6700000000001,i=e.temperatureF+459.67,n=e.barometerInHg/29.92,s=r/i;let c=n*s;const l=1-qe(e)/5e3;return c*=l,Math.max(.7,Math.min(c,1.15))}function ir(e){const{vehicle:t,env:o,raceLength:r}=e;if(t.weightLb<=0||t.powerHP<=0)throw new Error("Invalid vehicle params");const i=Ce[r];if(!i)throw new Error(`Invalid race length: ${r}`);const n=nr(o),s=t.powerHP*n,c=Math.max(1,s),f=Math.max(1,t.weightLb),l=5.825*Math.cbrt(f/c),_=234*Math.cbrt(c/f),u=l*.64,h=_*.8;let d,N;if(r==="EIGHTH"?(d=u,N=h):(d=l,N=_),!Number.isFinite(d)||!Number.isFinite(N))throw new Error("Invalid ET or MPH calculation");const x=5.825*Math.cbrt(f/Math.max(1,t.powerHP)),P=d-x,m={60:.16,330:.44,660:.79,1e3:.93,1320:1},F=i.map(I=>{const T=m[I]??1,L=d*T,U=I/i[i.length-1],v=N*U;return{d_ft:I,t_s:Math.max(0,L),v_mph:Math.max(0,v)}}),E=[{name:"Weather (HP)",delta_s:P}];return{baseET_s:Math.max(0,d),baseMPH:Math.max(0,N),timeslip:F,factors:E}}function sr(e){return e/32.174}function cr(e,t,o){return e+(t-e)*o}function lr(e){var o;const t=(Array.isArray(e)?e:e==null?void 0:e.powerHP)??((o=e==null?void 0:e.engineParams)==null?void 0:o.powerHP);if(!Array.isArray(t)||t.length<2){const r=e&&typeof e=="object"?Object.keys(e):[];throw new Error(`EngineParams must provide either torqueCurve or powerHP (got keys=${JSON.stringify(r)}, len=${(t==null?void 0:t.length)??0})`)}return t}function Bt(e,t){const o=lr(t);if(e<=o[0].rpm)return o[0].hp;if(e>=o[o.length-1].rpm)return o[o.length-1].hp;let r=0,i=o.length-1;for(;i-r>1;){const f=r+i>>1;o[f].rpm<=e?r=f:i=f}const n=o[r],s=o[i],c=(e-n.rpm)/(s.rpm-n.rpm);return n.hp+c*(s.hp-n.hp)}function pt(e,t,o){if("corr"in t&&typeof t.corr=="number"){const n=t;let s;if(n.torqueCurve&&n.torqueCurve.length>0)s=ar(e,n.torqueCurve);else if(n.powerHP!==void 0){const f=Math.max(e,1e3);s=n.powerHP*5252/f}else throw new Error("EngineParams must provide either torqueCurve or powerHP");return s*n.corr}const r=Bt(e,t);return(e>0?5252*r/e:0)*(Number.isFinite(o)?o:1)}function ar(e,t){const r=[...t.map(i=>{if(i.tq_lbft!==void 0)return{rpm:i.rpm,tq_lbft:i.tq_lbft};if(i.hp!==void 0&&i.rpm>0)return{rpm:i.rpm,tq_lbft:i.hp*5252/i.rpm};throw new Error(`Invalid torque curve point: ${JSON.stringify(i)}`)})].sort((i,n)=>i.rpm-n.rpm);if(e<=r[0].rpm)return r[0].tq_lbft;if(e>=r[r.length-1].rpm)return r[r.length-1].tq_lbft;for(let i=0;i<r.length-1;i++){const n=r[i],s=r[i+1];if(e>=n.rpm&&e<=s.rpm){const c=(e-n.rpm)/(s.rpm-n.rpm);return cr(n.tq_lbft,s.tq_lbft,c)}}return r[r.length-1].tq_lbft}const p=e=>Math.fround(e),w={add:(e,t)=>Math.fround(Math.fround(e)+Math.fround(t)),sub:(e,t)=>Math.fround(Math.fround(e)-Math.fround(t)),mul:(e,t)=>Math.fround(Math.fround(e)*Math.fround(t)),div:(e,t)=>Math.fround(Math.fround(e)/Math.fround(t)),sqrt:e=>Math.fround(Math.sqrt(Math.fround(e))),pow:(e,t)=>Math.fround(Math.pow(Math.fround(e),Math.fround(t))),exp:e=>Math.fround(Math.exp(Math.fround(e))),log:e=>Math.fround(Math.log(Math.fround(e))),clamp:(e,t,o)=>Math.fround(Math.min(Math.max(Math.fround(e),Math.fround(t)),Math.fround(o))),abs:e=>Math.fround(Math.abs(Math.fround(e))),neg:e=>Math.fround(-Math.fround(e))};function _o(e,t=0){const o=Math.pow(10,t),r=Math.fround(e*o),i=Math.floor(r),n=r-i;return n>.5?(i+1)/o:n<.5?i/o:(i%2===0?i:i+1)/o}function fr(e,t,o,r,i){const n=p(e),s=p(t),c=p(o),f=p(r),l=p(i);if(c===s)return f;const _=w.div(w.sub(n,s),w.sub(c,s));return w.add(f,w.mul(_,w.sub(l,f)))}function _r(e,t){if(t.length===0)return p(0);if(t.length===1)return p(t[0][1]);const o=p(e);if(o<=p(t[0][0]))return p(t[0][1]);if(o>=p(t[t.length-1][0]))return p(t[t.length-1][1]);for(let r=0;r<t.length-1;r++){const i=p(t[r][0]),n=p(t[r+1][0]);if(o>=i&&o<=n)return fr(o,i,n,t[r][1],t[r+1][1])}return p(t[t.length-1][1])}function ur(e){return Array.isArray(e==null?void 0:e.ratios)&&e.ratios.length>0?e.ratios:Array.isArray(e==null?void 0:e.gearRatios)&&e.gearRatios.length>0?e.gearRatios:[]}function hr(e,t,o,r=0){const i=(o.tireDiaIn??28)/12,n=Math.PI*i,c=e/n*60,f=ur(o),l=f.length>0?f[Math.min(t,f.length-1)]??1:1;return c*l*(o.finalDrive??3.73)*(1+r)}function dr(){return{t_s:0,v_fps:0,s_ft:0,rpm:0,gearIdx:0,warnings:[]}}const Oe=3.141593,b=32.174,Xt=519.67,uo=14.696,gr=29.92,Qt=28.9669,ho=18.016,go=1545.32,Mt=3600/5280,Kt=.025,mr=.01,te=.004,Ve=-4,$e=2,mo=.92,po=1.08,Mo=.15,Po=.25,pr=1.03,Mr=10.8,Me=3600/5280,Pr=459.67,Fr=b;function Tr(e){const{engineTorque_lbft_atSlip:t,gearRatio:o,transEff:r,drivelineEff:i,finalDrive:n,tireDia_in:s,tireSlip:c,dragForce_lbf:f,vehicleWeight_lbf:l,isAutoTrans:_,torqueMult:u=1}=e,h=t*u*o*r,d=s/24,x=h*n*i/(c*d)-f;return{Ags0_ftps2:(_?.96:.88)*(x/l)*b,netThrust_lbf:x,wheelTorque_lbft:h}}function Fo(e){const t=e.elevation_ft??0,o=e.fuelSystem??1,r=[.0205558,.00118163,154988e-10,40245e-11,434856e-15,2096e-14],i=r[0]+r[1]*e.temperature_F+r[2]*e.temperature_F**2+r[3]*e.temperature_F**3+r[4]*e.temperature_F**4+r[5]*e.temperature_F**5,n=e.relHumidity_pct/100*i,s=Math.pow((Xt-.00356616*t)/Xt,5.25588),c=uo*e.barometer_inHg/gr*s,f=c-n,l=f/uo,_=n*ho/(f*Qt),u=go*(1/Qt+_/ho)/(1+_),h=u/(go/Qt),d=e.temperature_F+Pr,N=d/Xt,P=144*c/(u*d)/32.174;let m,F;switch(o){case 1:m=1,F=1;break;case 2:m=1,F=2;break;case 3:m=2,F=1;break;case 4:m=2,F=2;break;case 5:m=3,F=2;break;case 6:m=1,F=3;break;case 7:case 9:m=2,F=3;break;case 8:m=3,F=3;break;default:m=1,F=1;break}const E=1+2.48*Math.pow(_,1.5);let I,T,L;switch(m){case 1:I=1,T=.6,L=.15;break;case 2:I=1,T=.3,L=.13;break;case 3:I=.85,T=.5,L=.055;break;default:I=1,T=.6,L=.15;break}if(F===2&&(L=L-.005),F===3){const v=.3050108932461874;I=.95-v*T,T=T+v,L=.6*L}let U=Math.pow(l,I)/(Math.sqrt(h)*Math.pow(N,T));return U=(1+L)*E/U-L,o===9&&(U=1),{rho_slug_per_ft3:P,pamb_psi:c,PWV_psi:n,pair_psi:f,WAR:_,RGAS:u,temp_R:d,hpc:U,delta:l,theta:N,rgrs:h}}function Sr(e,t,o,r=.025,i=.01){const n=r-o/1320*i,s=3600/5280,c=n*e,f=1e-4*e*(s*t);return c+f}function br(e,t,o,r,i=.025,n=.01){return Sr(e,t,o,i,n)*r}function Rr(e,t,o,r,i=1){let n=t,s=r*e/n;i>2&&s>.6&&(n=n*(1+(r-1)*(s-.6)/(1/r-.6)),s=r*e/n);let c=1/r,f=r*e,l=1;return f<n&&(f=n,l=o-(o-1)*s,c=l*e/n),c>1&&(c=1),{work:l,coupling:c,slipRatio:s,zStall:n,engRPM:f}}const wr=10.8;function To(e){const{tireDia_in:t,tireWidth_in:o,dynamicRWT_lbf:r,tractionIndexAdj:i,bodyStyle:n}=e,s=.92+.08*Math.pow(r/1900,2.15);let c=i*wr*t*(o+1)*s;return n===8&&(c=.5*c),c}function Ar(e){const{weight_lbf:t,tireGrowth:o,dragForce_lbf:r}=e;return(To(e)/o-r)/t*b}function xr(){return te*b}function Er(e,t,o,r){let i=e,n=t,s=0;return i>r&&(s=1,n=n*(r-(i-r))/i,i=r-(i-r)),i<o&&(n=n*o/i,i=o),{AGS:i,PQWT:n,SLIP:s}}function Ir(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function vr(e,t,o,r){return e+t*Math.pow(o*r,2)}function Cr(e,t,o){return e*t*60/o}function yr(e,t,o,r,i=!0){let n=r*t*(t-e);n<0&&(n=i?Mo*n:Po*n);const s=Math.pow(2*Oe/60,2)/(12*550*o);return n*s}function Hr(e,t,o,r){let i=r*t*(t-e);i<0&&(i=0);const n=Math.pow(2*Oe/60,2)/(12*550*o);return i*n}function Lr(e,t,o,r){const i=Math.PI,n=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));let s=1+n*135e-7*Math.pow(o,1.6);const c=1+n*35e-5*o;c<s&&(s=c);const f=r/32.174,l=s-.035*Math.abs(f),_=l*e*i/12,u=12*_/(2*i),h=2*u,d=u/12;return{growth:s,squat:l,dia_eff_in:h,radius_eff_ft:d,circumference_eff_ft:_}}function Dr(e,t,o,r,i){const f=(t-1)*o/2*r*(i?1:2)/144;return e+f}function Nr(e,t,o,r){if(e>=t-1)return!1;const i=r[e];if(!i||i<=0)return!1;const s=(r[0]??0)>8e3?20:10;return Math.abs(i-o)<s}var So=(e=>(e[e.NORMAL=0]="NORMAL",e[e.TRIGGERED=1]="TRIGGERED",e[e.EXECUTING=2]="EXECUTING",e))(So||{});function Gr(e,t){switch(e){case 0:return t?{newState:1,executeShift:!1}:{newState:0,executeShift:!1};case 1:return{newState:2,executeShift:!0};case 2:return{newState:0,executeShift:!1};default:return{newState:0,executeShift:!1}}}function Wr(e){return e?.2:.25}function kr(e,t,o,r){return o>=r||!t||t<=0?!1:w.sub(p(e),p(t))>=0}function qr(e,t=3,o=1){const r=.005*(t-1)+3*(o-1),i=e/1320;return 1.02+r*(1-Math.pow(i,2))}function Or(e,t,o,r,i,n,s=.04,c=.9){const f=e*t*(o-r+s/c*r),l=n*o;return(f+l)/i}function Vr(e,t,o,r,i,n,s,c,f=.04,l=.9){const _=Or(o,e,r,i,n,s,f,l);let u=t-_,h=0;u<0&&(h=-u*n/64,u=0);let d=c-u-h;return d<0&&(d=e),{rear_weight_lbf:d,front_weight_lbf:u,wheelie_bar_weight_lbf:h}}function $r(e,t,o,r){const i=2*r*o,n=Math.sqrt(e*e+i),s=2*r*o+e*e,c=Math.pow(s,1.5),f=Math.pow(e,3),l=(c-f)/(3*r)+t;return{Vel_ftps:n,Dist_ft:l}}function Br(e,t,o){let r=e,i=1,n=0;if(r>o){n=1;const s=r-o,c=o-s;i=c/r,r=c}return r<t&&(i=t/r,r=t),{AGS_ftps2:r,PQWT_scale:i,slip:n}}function Xr(e,t){return e/(t*b)}function Qr(e,t,o){if(o<=0)return Math.max(.005,Math.min(.05,e));let r=e*Math.pow(t/o,4);return r>.05&&(r=.05),r<.005&&(r=.005),r}function Kr(e,t,o,r){const i=t*o/r;let n=e*.11*Math.pow(i,-1/3);return n=n/15,n<.005&&(n=.005),n}function Ur(e){if(!e)return 1;const t=e.toUpperCase();return t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")||t.includes("FUEL INJECT")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function Jr(e,t){const o=Number(e==null?void 0:e.rpm);if(!Number.isFinite(o))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:o,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const r=Number(e.torque)*o/5252*t;return{rpm:o,hp:r}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const r=Number(e.tq_lbft)*o/5252*t;return{rpm:o,hp:r}}return null}function Pt(e,t=1){return e.map(o=>Array.isArray(o)?{rpm:Number(o[0]),hp:Number(o[1])*t}:Jr(o,t)).filter(o=>o!==null&&Number.isFinite(o.rpm)&&Number.isFinite(o.hp)).sort((o,r)=>o.rpm-r.rpm)}function jr(e){var c,f,l,_;const t=((c=e==null?void 0:e.fuel)==null?void 0:c.hpTorqueMultiplier)??1,o=[],r=(f=e==null?void 0:e.engineParams)==null?void 0:f.powerHP;if(Array.isArray(r)&&(o.push(`engineParams.powerHP(${r.length})`),r.length>=2)){const u=Pt(r,t);if(u.length>=2)return{powerHP:u}}const i=e==null?void 0:e.engineHP;if(Array.isArray(i)&&(o.push(`engineHP(${i.length})`),i.length>=2)){const u=Pt(i,t);if(u.length>=2)return{powerHP:u}}const n=(l=e==null?void 0:e.engineParams)==null?void 0:l.torqueCurve;if(Array.isArray(n)&&(o.push(`engineParams.torqueCurve(${n.length})`),n.length>=2)){const u=Pt(n,t);if(u.length>=2)return{powerHP:u}}const s=(_=e==null?void 0:e.vehicle)==null?void 0:_.torqueCurve;if(Array.isArray(s)&&(o.push(`vehicle.torqueCurve(${s.length})`),s.length>=2)){const u=Pt(s,t);if(u.length>=2)return{powerHP:u}}throw new Error(`RSACLASSIC: missing power curve. Sources found: [${o.join(", ")||"none"}]. Keys(engineParams)=${JSON.stringify(Object.keys((e==null?void 0:e.engineParams)||{}))} Keys(vehicle)=${JSON.stringify(Object.keys((e==null?void 0:e.vehicle)||{}))}`)}function se(e,t=0){return Number.isFinite(e)?Number(e):t}function bo(e,t){const o=t.map(r=>[r.rpm,r.hp]);return _r(e,o)}function Ro(e,t,o){const r=bo(e,t);if(e<=0)return p(0);const i=w.div(w.mul(p(5252),r),p(e));return w.mul(i,p(o))}function Yr(e,t,o,r=t){const i=Number(e);return Number.isFinite(i)?Math.min(o,Math.max(t,i)):r}function zr(e){return Math.max(.85,Math.min(1,e))}class Zr{constructor(){mt(this,"id","RSACLASSIC")}simulate(t){var Wo,ko,Dt,qo,Nt,Oo,Vo,$o;const o=!!((Wo=t==null?void 0:t.flags)!=null&&Wo.vb6Strict);o&&console.log("[RSACLASSIC] VB6-STRICT mode enabled - using Float32 math");const r=Date.now(),i=9e4,n=2e6,s=5e4;let c=0;function f(S,y){if(Date.now()-r>i)throw new Error("simulation wall-time exceeded");if(S>=n)throw new Error("simulation step cap hit");if(S%s===0){const de=y-c;if(console.log("[RSACLASSIC] heartbeat",{step:S,dist_ft:y,gained_ft:de}),S>0&&de<.001)throw new Error("simulation stalled");c=y}}const l=Number((t==null?void 0:t.raceLengthFt)??1320);if(!Number.isFinite(l)||l<=0)throw new Error(`invalid raceLengthFt: ${t==null?void 0:t.raceLengthFt}`);const _=Number((t==null?void 0:t.timeStep)??.002);if(!Number.isFinite(_)||_<=0)throw new Error(`invalid timeStep ${_}`);const h=jr(t).powerHP;if(console.log("[RSACLASSIC] start",{raceLenFt:l,hpPts:h.length}),!Array.isArray(h)||h.length<2)throw new Error(`RSACLASSIC: powerHP invalid (len=${(h==null?void 0:h.length)??0})`);const d=(t==null?void 0:t.drivetrain)??{},N=(t==null?void 0:t.vehicle)??{},x=d.clutch??(t==null?void 0:t.clutch)??N.clutch,P=d.converter??(t==null?void 0:t.converter)??N.converter,m=!!x,F=!!P,E=m?Number(x.slipRPM??x.slipRpm):NaN,I=m?Number(x.launchRPM??x.launchRpm):NaN,T=F?Number(P.stallRPM??P.stallRpm):NaN,L=m?Number(x.slippageFactor??x.slipRatio??1.0025):1,U=F?Number(P.slippageFactor??P.slipRatio??1.05):1;if(!m&&!F)throw new Error("RSACLASSIC: drivetrain must specify clutch or converter");if(m&&!Number.isFinite(E))throw new Error("RSACLASSIC: clutch.slipRPM missing/invalid");if(F&&!Number.isFinite(T))throw new Error("RSACLASSIC: converter.stallRPM missing/invalid");const v=m?Number.isFinite(I)?I:E:T;console.log("[RPM-RESOLVED]",{isClutch:m,isConverter:F,slipRPM:E,launchRPM:I,stallRPM:T,rpmPin:v});const Y=(t==null?void 0:t.tuning)??{},Pe=Number.isFinite(Y.aeroCdScale)?Y.aeroCdScale:1,ot=Number.isFinite(Y.drivelineEffOffset)?Y.drivelineEffOffset:0,{vehicle:g,env:W,raceLength:ye}=t,$=[],Q=ye==="EIGHTH"?660:1320,ce=g.cd,le=g.frontalArea_ft2,ae=g.transEff,z=g.finalDrive??g.rearGear,k=g.gearRatios,B=g.gearEff,Fe=g.shiftRPM;ce||$.push("Missing vehicle.cd (drag coefficient) - required for VB6 parity"),le||$.push("Missing vehicle.frontalArea_ft2 - required for VB6 parity"),(!k||k.length===0)&&$.push("Missing vehicle.gearRatios[] - required for VB6 parity"),(!Fe||Fe.length===0)&&$.push("Missing vehicle.shiftRPM[] - required for VB6 parity"),z||$.push("Missing vehicle.finalDrive or vehicle.rearGear - required for VB6 parity"),W.barometerInHg===void 0&&$.push("Missing env.barometerInHg - required for VB6 air density"),W.temperatureF===void 0&&$.push("Missing env.temperatureF - required for VB6 air density"),W.humidityPct===void 0&&$.push("Missing env.humidityPct - required for VB6 air density"),W.elevation===void 0&&$.push("Missing env.elevation - required for VB6 air density");const C=g.tireRolloutIn??null,A=g.tireDiaIn??null,R=Math.PI;let D=(typeof C=="number"&&C>0?C/R:null)??A??0;(!D||D<=0)&&($.push("Tire diameter is undefined/invalid. Provide tireRolloutIn or tireDiaIn."),D=28);const fe=g.rolloutIn;fe||$.push("Missing vehicle.rolloutIn - required for VB6 parity");const Be=t.fuel,Xe=Ur(Be),ue=Fo({barometer_inHg:W.barometerInHg??29.92,temperature_F:W.temperatureF??59,relHumidity_pct:W.humidityPct??50,elevation_ft:W.elevation??0,fuelSystem:Xe}).rho_slug_per_ft3,He=sr(g.weightLb),Ae=(fe??12)/12;let X=null,M=0;const Le=30,oe=.01,V=h.reduce((S,y)=>Math.max(S,y.hp),0),re=P?P.torqueMult??1.7:1,Z=(g.rolloutIn??12)/12,Tt=Kr(Z>0?Z:1,V,re,g.weightLb);let Jt=0,q=Tt,a=dr(),vo=0;const jt=[],Qe=[];let St=!1,bt=0;const Yt=[60,330,660,1e3,Q];let Rt=0,rt=0,nt=0,Co=0,yo=0,Ho=0,Lo=0,De=0,it=1,Fn;a.rpm=v;const wt=t.fuel;let zt=1,Zt=1,eo=0,At=0,xt=0,Et=0,It=0,vt=0,Ct=0,to=0,Do=0,Ne=0;if(x||P){const S=pt(v,h,ae??.9),y=v>0?S*v/5252:0,he=y>0&&v>0?5252*y/v:0,de=(k??[1])[0]??1,ee=he*de*(ae??.9)*(z??3.73)*(ae??.9)/(1.02*D/24);Ne=(P?.96:.88)*ee/g.weightLb,Ne<te&&(Ne=te)}const Tn=6,Sn=5;let st=v,ct=0,No=So.NORMAL,lt=0,Go=0;const bn=S=>B&&B[S]!==void 0?Math.max(.9,Math.min(1,B[S])):ae??.9,Ke=()=>{const S=d.overallEff??d.overallEfficiency??ae??.97;return zr(S+ot)},Ge=S=>{const y=W.tractionIndex??3;return qr(S,y,1)};for(;;){M++,f(M,a.s_ft);const S=Lr(D,g.tireWidthIn??17,a.v_fps,Ne),y=S.radius_eff_ft,he=S.circumference_eff_ft,de=S.dia_eff_in;let Ue=hr(a.v_fps,a.gearIdx,d),Je=Ue,ee=1,Gt=0,Bo=0,Xo=0;const ge=bn(a.gearIdx);o?Ro(Ue,h,ge):pt(Ue,h,ge);let at=1;if(wt==="METHANOL"){const H=W.trackTempF;H!==void 0&&H<80&&a.t_s<.8&&(at=1.025-.025*a.t_s/.8)}else if(wt==="NITRO"){if(a.t_s<.4)at=.9;else if(a.t_s<1){const H=(a.t_s-.4)/.6;at=.9+(1-.9)*H}}zt=Math.min(zt,at),Zt=Math.max(Zt,at);const ft=(k??[1])[a.gearIdx]??1,no=Ge(a.s_ft)*a.v_fps*60/he;M===1&&typeof console<"u"&&console.debug&&console.debug("[RPM-DEBUG]",{isClutch:m,isConverter:F,slipRPM:E,launchRPM:I,stallRPM:T,calculated_slipRPM:E,rpm_from_speed:Ue});const xe=no*ft*(z??3.73);let O=(m?L:U)*xe;const Rn=a.gearIdx===0,wn=!0,_t=m?E:T;(m||F)&&(Rn||wn)&&O<_t&&(O=_t);const Wt=O===_t&&xe<_t,Qo=_t;if(Je=O,o?Ro(O,h,ge):pt(O,h,ge),x)ee=O>1?Math.max(0,Math.min(1,xe/O)):0,it=Math.min(it,ee);else if(P){const H=P.torqueMult??2,G=Rr(xe,T,H,U,M);ee=G.coupling,Gt=G.work,Bo=G.slipRatio,Xo=G.zStall,yo+=G.work,Ho+=G.coupling,Lo+=G.slipRatio,De++,it=Math.min(it,ee)}else Je=Ue;a.rpm=Je;const je=se(a.v_fps,0),Ko=W.windMph??0,An=W.windAngleDeg??0,io=Ko/Me,xn=An*Math.PI/180,En=Math.sqrt(je*je+2*je*io*Math.cos(xn)+io*io),In=g.bodyStyle===8,kt=Dr(le??0,S.growth,D,g.tireWidthIn??17,In);let qt,We,ut,Ot;const so=Ko!==0?En:je;if(o){const H=p(so);qt=w.mul(H,H),We=w.mul(w.mul(p(.5),p(ue)),qt),ut=w.mul(w.mul(w.mul(We,p(ce??0)),p(Pe)),p(kt)),Ot=w.mul(w.mul(We,p(g.liftCoeff??0)),p(kt))}else qt=so*so,We=se(.5*ue*qt,0),ut=se(We*(ce??0)*Pe*kt,0),Ot=se(We*(g.liftCoeff??0)*kt,0);const co=se(g.weightLb-Ot,g.weightLb),ke=ut,vn=co,Cn=g.rrCoeff??Kt,yn=br(vn,je,a.s_ft,y,Cn,.01),Te=se(yn/y,0),Hn=1,Ln=W.tractionIndex??3,lo=Ir(Ln,Hn),Dn=M===1?0:Do,Nn=g.wheelbaseIn??108,Gn=D/2+3.75,Wn=g.staticFrontWeightLb??g.weightLb*.38,ht=Vr(g.weightLb,Wn,Dn,Gn,y*12,Nn,ke+Te,co,1.03,Ke()),Ye=ht.rear_weight_lbf,Se=Ar({weight_lbf:g.weightLb,tireDia_in:D,tireWidth_in:g.tireWidthIn??17,dynamicRWT_lbf:Ye,tractionIndexAdj:lo,tireGrowth:S.growth,dragForce_lbf:ke+Te,bodyStyle:void 0}),ne=xr();if(M<=12&&typeof console<"u"&&console.log){const H=To({weight_lbf:g.weightLb,tireDia_in:D,tireWidth_in:g.tireWidthIn??17,dynamicRWT_lbf:Ye,tractionIndexAdj:lo,bodyStyle:void 0});console.log("[TRACTION]",{step:M,CAXI:+lo.toFixed(4),AX:10.8,tireDia_in:+D.toFixed(2),tireWidth_in:+(g.tireWidthIn??17).toFixed(1),dynamicRWT_lbf:+Ye.toFixed(1),weightFactor:+(.92+.08*Math.pow(Ye/1900,2.15)).toFixed(4),CRTF:+H.toFixed(1),tireGrowth:+S.growth.toFixed(4),dragForce_lbf:+(ke+Te).toFixed(2),AMin_ftps2:+ne.toFixed(3),AMax_ftps2:+Se.toFixed(3),AMin_g:+(ne/b).toFixed(4),AMax_g:+(Se/b).toFixed(4)})}let J,ie;if(M<=Tn&&xe<Sn){const H=pt(v,h,ge),G=F?P.torqueMult??2:1,j=Tr({engineTorque_lbft_atSlip:H,gearRatio:ft,transEff:ge,drivelineEff:Ke(),finalDrive:z??3.73,tireDia_in:D,tireSlip:Ge(a.s_ft),dragForce_lbf:ke+Te,vehicleWeight_lbf:g.weightLb,isAutoTrans:!!P,torqueMult:G});ie=j.netThrust_lbf/g.weightLb*b;const Ie=Er(j.Ags0_ftps2,ie,ne,Se);if(J=Ie.AGS,ie=Ie.PQWT,M<=10&&typeof console<"u"&&console.debug){const ve=j.Ags0_ftps2/b,dt=ft*(z??3.73);console.debug("[STEP]",{step:M,phase:Wt?"PINNED":"BOOTSTRAP",v_fps:a.v_fps.toFixed(6),EngRPM:Je.toFixed(0),LockRPM:xe.toFixed(2),slipRPM:E.toFixed(0),lockThreshold:Qo.toFixed(0),rpmIsPinned:Wt,clutchSlip:ee.toFixed(6),gear:a.gearIdx+1,GRxFD:dt.toFixed(3),tireDia_eff_in:de.toFixed(2),tireGrowth:S.growth.toFixed(4),tireSlip:Ge(a.s_ft).toFixed(4),RWTdyn_lbf:Ye.toFixed(1),RWTfront_lbf:ht.front_weight_lbf.toFixed(1),wheelieBar_lbf:ht.wheelie_bar_weight_lbf.toFixed(1),AGS_g:ve.toFixed(4),AGS_ftps2:J.toFixed(4),AMin_ftps2:ne.toFixed(4),AMax_ftps2:Se.toFixed(4),SLIP:Ie.SLIP})}}else{let H=o?bo(O,h):Bt(O,h);lt>0&&(H=0,lt=Math.max(0,lt-q),lt===0&&typeof console<"u"&&console.debug&&console.debug("[SHIFT_DWELL_END]",{step:M,t_s:a.t_s.toFixed(4),v_fps:a.v_fps.toFixed(2)}));const G=H,j=o?w.div(w.mul(w.add(p(ke),p(Te)),p(a.v_fps)),p(550)):(ke+Te)*a.v_fps/550;M<=12&&typeof console<"u"&&console.log&&console.log("[PRE_HP_CHAIN]",{step:M,EngRPM_out:+O.toFixed(0),wheelRPM:+no.toFixed(2),ClutchSlip:+ee.toFixed(4),...P?{converterWork:+Gt.toFixed(4)}:{},HPSave:+G.toFixed(1),DragHP:+j.toFixed(2),F_drag_lbf:+ut.toFixed(2),F_roll_lbf:+Te.toFixed(2),v_fps:+a.v_fps.toFixed(2),tireSlip:+Ge(a.s_ft).toFixed(4),currentGearEff:+ge.toFixed(4),drivelineEff:+Ke().toFixed(4),dt_s:+q.toFixed(4),RPM0:+st.toFixed(0),DSRPM0:+ct.toFixed(2)});const Ie=Cr(Ge(a.s_ft),a.v_fps,he);let ve,dt,Vt;if(((ko=g.pmi)==null?void 0:ko.engine_flywheel_clutch)!==void 0)ve=g.pmi.engine_flywheel_clutch,dt=g.pmi.transmission_driveshaft??0,Vt=g.pmi.tires_wheels_ringgear??0;else{ve=500/120;const me=(k==null?void 0:k.length)??5;dt=m?me*ve/50:(me-1)*ve/10,Vt=2*(1.15*.8*(.08*D*(g.tireWidthIn??17))*Math.pow(D/2,2)/386)}const Zo=vr(Vt,dt,z??3.73,ft),ze=yr(st,O,q,ve,m),Ze=Hr(ct,Ie,q,Zo);M<=12&&typeof console<"u"&&console.log&&console.log("[PMI_CALC]",{step:M,EngRPM:+O.toFixed(0),RPM0:+st.toFixed(0),RPM_delta:+(O-st).toFixed(0),DSRPM:+Ie.toFixed(2),DSRPM0:+ct.toFixed(2),DSRPM_delta:+(Ie-ct).toFixed(2),enginePMI:+ve.toFixed(3),chassisPMI:+Zo.toFixed(3),HPEngPMI:+ze.toFixed(1),HPChasPMI:+Ze.toFixed(1)}),st=O,ct=Ie,It+=ze*550*q,vt+=Ze*550*q;let et,be;const er=Ge(a.s_ft);if(o){et=w.mul(w.sub(p(G),p(ze)),p(ee)),be=et;const tt=w.mul(w.mul(p(be),p(ge)),p(Ke())),me=w.sub(tt,p(Ze)),Re=w.div(me,p(er));be=w.sub(Re,p(j))}else et=(G-ze)*ee,be=et,be=(be*ge*Ke()-Ze)/er-j;const tr=be;ie=o?w.div(w.mul(w.mul(p(550),p(b)),p(be)),p(g.weightLb)):550*b*be/g.weightLb;let $t=Xr(ie,a.v_fps);if(q>0&&q<=.01&&M>1){const tt=$t/b,me=Ne/b;let Re=(tt-me)/q;if(Re<Ve){Re=Ve;const gt=me+Re*q;$t=gt*b,ie=gt*b*a.v_fps}if(Re>$e){Re=$e;const gt=me+Re*q;$t=gt*b,ie=gt*b*a.v_fps}}const fo=Br($t,ne,Se);J=fo.AGS_ftps2,ie=ie*fo.PQWT_scale;const Qn=fo.slip;J=Yr(J,ne,Se,ne);const or=J/b;or>Jt&&(Jt=or);const rr=Ne/b;if(rr>0&&M>1&&(q=Qr(Tt,Jt,rr)),M<=12&&typeof console<"u"&&console.log&&console.log("[CONSOLIDATED_ROW]",{step:M,v_ftps:+a.v_fps.toFixed(3),EngRPM:+O.toFixed(0),wheelRPM:+no.toFixed(2),ClutchSlip:+ee.toFixed(4),HPSave:+G.toFixed(1),HPEngPMI:+ze.toFixed(1),HPChasPMI:+Ze.toFixed(1),DragHP:+j.toFixed(2),HP_afterL1:+et.toFixed(1),HP_afterL2:+tr.toFixed(1),PQWT:+ie.toFixed(1),AMin:+ne.toFixed(3),AMax:+Se.toFixed(3),AGS_applied:+J.toFixed(3)}),M<=20&&typeof console<"u"&&console.log&&console.log("[AERO_TRACE]",{step:M,v_fps:+je.toFixed(6),rho_slug_per_ft3:+ue.toFixed(6),q_psf:+We.toFixed(3),F_drag_lbf:+ut.toFixed(2),F_lift_up_lbf:+Ot.toFixed(2),normal_lbf:+co.toFixed(2),F_roll_lbf:+Te.toFixed(2),AMin_ftps2:+ne.toFixed(3),AMax_ftps2:+Se.toFixed(3),AGS_ftps2:+J.toFixed(3)}),M<=10&&typeof console<"u"&&console.debug){const tt=J/b,me=ft*(z??3.73);console.debug("[STEP]",{step:M,phase:Wt?"PINNED":"HP",v_fps:a.v_fps.toFixed(6),EngRPM:Je.toFixed(0),LockRPM:xe.toFixed(2),slipRPM:E.toFixed(0),lockThreshold:Qo.toFixed(0),rpmIsPinned:Wt,clutchSlip:ee.toFixed(6),gear:a.gearIdx+1,GRxFD:me.toFixed(3),tireDia_eff_in:de.toFixed(2),tireGrowth:S.growth.toFixed(4),tireSlip:Ge(a.s_ft).toFixed(4),RWTdyn_lbf:Ye.toFixed(1),RWTfront_lbf:ht.front_weight_lbf.toFixed(1),wheelieBar_lbf:ht.wheelie_bar_weight_lbf.toFixed(1),rho_slug_ft3:ue.toFixed(6),dragHP:j.toFixed(2),...P?{converterWork:Gt.toFixed(4),converterSlipRatio:Bo.toFixed(4),converterZStall:Xo.toFixed(0)}:{},HP_engine:G.toFixed(1),HPEngPMI:ze.toFixed(1),HPChasPMI:Ze.toFixed(1),HP_afterLine1:et.toFixed(1),HP_afterLine2:tr.toFixed(1),AGS_g:tt.toFixed(4),AGS_ftps2:J.toFixed(4),AMin_ftps2:ne.toFixed(4),AMax_ftps2:Se.toFixed(4),SLIP:Qn})}}Ne=J;const Uo=Bt(O,h);eo+=Uo*550*q;const Jo=a.v_fps*q;At+=ke*Jo,xt+=Te*Jo;const kn=1-ge,qn=1-Ke(),On=kn+qn;Et+=Uo*550*q*On;const Vn=se(a.v_fps,0),$n=se(a.s_ft,0),Bn=se(J,ne),jo=se(ie,0),Ee=$r(Vn,$n,q,jo);if(M<=12&&typeof console<"u"&&console.log&&console.log("[INTEGRATED]",{step:M,Vel_next:+Ee.Vel_ftps.toFixed(3),Dist_next:+Ee.Dist_ft.toFixed(6)}),!Number.isFinite(Ee.Vel_ftps)||!Number.isFinite(Ee.Dist_ft))throw new Error(`NaN in state @ step=${M} v=${Ee.Vel_ftps} dist=${Ee.Dist_ft} AGS=${Bn} PQWT=${jo}`);if(a.v_fps=Ee.Vel_ftps,a.s_ft=Ee.Dist_ft,a.t_s=a.t_s+q,!Number.isFinite(a.v_fps)||!Number.isFinite(a.s_ft)||!Number.isFinite(J))throw new Error(`NaN in state @ step=${M} v=${a.v_fps} dist=${a.s_ft} AGS=${J}`);if(Do=J/b,a.s_ft>=Q){X="DISTANCE";break}if(a.t_s>=Le){X="TIME_CAP";break}const Yo=(k==null?void 0:k.length)??1,Xn=(Fe??[])[a.gearIdx]??0,zo=o?kr(O,Xn,a.gearIdx,Yo-1):Nr(a.gearIdx,Yo,O,Fe??[]);let ao=!1;if(o)ao=zo;else{const H=Gr(No,zo);No=H.newState,ao=H.executeShift}if(ao){const H=a.gearIdx,G=O;a.gearIdx++;const j=Wr(m);lt=j,Go+=j,typeof console<"u"&&console.debug&&console.debug("[SHIFT]",{step:M,t_s:a.t_s.toFixed(4),v_fps:a.v_fps.toFixed(2),from_gear:H+1,to_gear:a.gearIdx+1,EngRPM_before:G.toFixed(0),LockRPM:xe.toFixed(0),dwell_s:j.toFixed(3)})}for(!St&&a.s_ft>=Ae&&(St=!0,bt=a.t_s),rt===0&&a.s_ft>=594&&(rt=a.t_s),nt===0&&a.s_ft>=1254&&(nt=a.t_s);Rt<Yt.length&&a.s_ft>=Yt[Rt];){const H=Yt[Rt],G=St?a.t_s-bt:0,j=a.v_fps*Me;Qe.push({d_ft:H,t_s:G,v_mph:j}),Rt++}if(a.t_s>=vo){const G=(a.v_fps-Co)/q/Fr;jt.push({t_s:a.t_s,v_mph:a.v_fps*Me,a_g:G,s_ft:a.s_ft,rpm:a.rpm,gear:a.gearIdx+1}),vo+=oe,Co=a.v_fps}}a.t_s>=Le&&$.push("max_time_exceeded");const yt=St?a.t_s-bt:a.t_s,Ht=a.v_fps*Me;let oo,ro;if(rt>0&&a.t_s>rt){const y=a.t_s-rt;y>0&&(oo=Me*66/y)}if(nt>0&&a.t_s>nt){const y=a.t_s-nt;y>0&&(ro=Me*66/y)}Ct=.5*He*a.v_fps*a.v_fps,X||(X="SAFETY"),typeof console<"u"&&console.debug&&console.debug("[RSACLASSIC END]",{reason:X,t_s:a.t_s,steps:M,d_ft:a.s_ft,target_ft:Q,totalShiftDwell_s:Go.toFixed(3)}),typeof console<"u"&&console.warn&&X!=="DISTANCE"&&console.warn("Terminated without crossing finish:",{reason:X,t_s:a.t_s,d_ft:a.s_ft,target_ft:Q}),(Qe.length===0||Qe[Qe.length-1].d_ft!==Q)&&Qe.push({d_ft:Q,t_s:yt,v_mph:Ht});const Lt={};oo!==void 0&&(Lt.e660_mph=oo),ro!==void 0&&(Lt.q1320_mph=ro);{const S=eo,y=At+xt+Et+It+vt,he=Ct+to,de=S-y-he;console.log(`
=== ENERGY SUMMARY: ${g.name??"Unknown"} ===`),console.log(`ET: ${yt.toFixed(3)}s, Trap MPH: ${Ht.toFixed(1)}`),console.log(`
Energy In:`),console.log(`  Engine:           ${(eo/1e3).toFixed(1)} k-ft-lb`),console.log(`
Energy Out:`),console.log(`  Aero Drag:        ${(At/1e3).toFixed(1)} k-ft-lb (${(100*At/S).toFixed(1)}%)`),console.log(`  Rolling Resist:   ${(xt/1e3).toFixed(1)} k-ft-lb (${(100*xt/S).toFixed(1)}%)`),console.log(`  Driveline Loss:   ${(Et/1e3).toFixed(1)} k-ft-lb (${(100*Et/S).toFixed(1)}%)`),console.log(`  Engine PMI:       ${(It/1e3).toFixed(1)} k-ft-lb (${(100*It/S).toFixed(1)}%)`),console.log(`  Chassis PMI:      ${(vt/1e3).toFixed(1)} k-ft-lb (${(100*vt/S).toFixed(1)}%)`),console.log(`  Total Losses:     ${(y/1e3).toFixed(1)} k-ft-lb (${(100*y/S).toFixed(1)}%)`),console.log(`
Final Kinetic Energy:`),console.log(`  Translational:    ${(Ct/1e3).toFixed(1)} k-ft-lb (${(100*Ct/S).toFixed(1)}%)`),console.log(`  Rotational:       ${(to/1e3).toFixed(1)} k-ft-lb (${(100*to/S).toFixed(1)}%)`),console.log(`  Total Kinetic:    ${(he/1e3).toFixed(1)} k-ft-lb (${(100*he/S).toFixed(1)}%)`),console.log(`
Energy Balance:     ${(de/1e3).toFixed(1)} k-ft-lb (${(100*de/S).toFixed(1)}% error)`),console.log(`===
`)}const K={et_s:o?_o(yt,3):yt,mph:o?_o(Ht,2):Ht,timeslip:Qe,traces:jt.length>0?jt:void 0,meta:{model:"RSACLASSIC",steps:Math.floor(a.t_s/q),warnings:$,windowMPH:Object.keys(Lt).length>0?Lt:void 0,converter:P&&!x?{used:!0,avgTR:De>0?yo/De:1,avgETA:De>0?Ho/De:1,avgSR:De>0?Lo/De:1,deRateMax:.3,parasiticConst:.05,parasiticQuad:1e-6}:void 0,clutch:x?{used:!0,minC:it,lockupAt_ft:Fn}:void 0,rollout:{rolloutIn:fe??12,t_roll_s:bt},fuel:wt?{type:wt,minScale:zt,maxScale:Zt}:void 0,vb6:{dt_s:q,trapMode:"time",windowsFt:{eighth:{start:594,end:660,distance:66},quarter:{start:1254,end:1320,distance:66}},timeslipPoints:[60,330,660,1e3,1320],rolloutBehavior:"ET clock starts after rollout distance (TIMESLIP.FRM:1380)"},termination:{reason:X,steps:M,t_s:a.t_s,target_ft:Q}}};return console.log("[RSACLASSIC] done",{et_s:+(((qo=(Dt=K==null?void 0:K.et_s)==null?void 0:Dt.toFixed)==null?void 0:qo.call(Dt,4))??(K==null?void 0:K.et_s)),mph:+(((Oo=(Nt=K==null?void 0:K.mph)==null?void 0:Nt.toFixed)==null?void 0:Oo.call(Nt,1))??(K==null?void 0:K.mph)),steps:(($o=(Vo=K==null?void 0:K.meta)==null?void 0:Vo.termination)==null?void 0:$o.steps)??M,wallMs:Date.now()-r}),K}}const wo=new Zr;function Ut(e,t,o,r,i){let n=0;for(n=0;n<o-1&&!(i<=e[n+1]);n++);n>=o-1&&(n=o-2),n<0&&(n=0);const s=e[n],c=e[n+1],f=t[n],l=t[n+1];if(c===s)return f;const _=(i-s)/(c-s);return f+_*(l-f)}function Ao(e,t,o,r){const i=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));let n=1+i*135e-7*Math.pow(o,1.6);const s=1+i*35e-5*o;s<n&&(n=s);const f=(n-.035*Math.abs(r))*e*Oe/12;return{TireGrowth:n,TireCirFt:f}}function xo(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function Eo(){return Mr}function en(e,t,o,r){const i=e.Gear;let n=r;e.Ags0_g>0&&e.L>1&&(n=r*Math.pow(e.AgsMax_g/e.Ags0_g,4));let s=0;const c=e.time_s-e.Time0_s;c>0&&(s=(e.AGS_g-e.Ags0_g)/c),s<Ve&&(s=Ve),s>$e&&(s=$e),e.Vel0_ftps=e.Vel_ftps,e.Ags0_g=e.AGS_g,e.Time0_s=e.time_s,e.Dist0_ft=e.Dist_ft,e.RPM0=e.EngRPM,e.DSRPM0=e.DSRPM,e.RPM0===t.LaunchRPM&&e.Time0_s===0&&(e.RPM0=t.Stall,t.LaunchRPM<t.Stall&&(e.Time0_s=t.EnginePMI*(t.Stall-t.LaunchRPM)/25e4));const f=Ao(t.TireDia_in,t.TireWidth_in,e.Vel_ftps,e.Ags0_g);e.TireGrowth=f.TireGrowth,e.TireCirFt=f.TireCirFt;const _=1.02+(.005*(o.TractionIndex-1)+3*(o.TrackTempEffect-1))*(1-Math.pow(e.Dist0_ft/1320,2)),u=t.TGR[i-1]??1,h=t.TiresPMI+t.TransPMI*Math.pow(t.GearRatio,2)*Math.pow(u,2);let d=e.Vel0_ftps+e.Ags0_g*b*n+s*b*n*n/2;n>.05&&(n=.05),d=e.Vel0_ftps+e.Ags0_g*b*n+s*b*n*n/2;const N=d*d-e.Vel0_ftps*e.Vel0_ftps,x=_*d*60/e.TireCirFt,P=x*t.GearRatio*u;let m=t.Slippage*P,F,E=t.Stall,I=0;t.isClutch?(m<t.Stall&&(i===1||!t.LockUp)&&(m=t.Stall),F=P/m):i===1||!t.LockUp?(E=t.Stall,I=t.Slippage*P/E,e.L>2&&(I>.6&&(E=E*(1+(t.Slippage-1)*(I-.6)/(1/t.Slippage-.6))),I=t.Slippage*P/E),F=1/t.Slippage,m<E&&(m=E,F=(t.TorqueMult-(t.TorqueMult-1)*I)*P/E)):(m=1.005*P,F=P/m),F>1&&(F=1);let T=Ut(t.xrpm,t.yhp,t.NHP,1,m);T=t.HPTQMult*T/o.hpc;const L=T;T=T*F;const U=Math.sqrt(d*d+2*d*(o.WindSpeed_mph/Mt)*Math.cos(Oe*o.WindAngle_deg/180)+Math.pow(o.WindSpeed_mph/Mt,2)),v=Math.sign(U)*o.rho*Math.pow(Math.abs(U),2)/(2*b);let Y;t.BodyStyle===8?Y=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*t.TireWidth_in/144:Y=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*(2*t.TireWidth_in)/144;const Pe=t.Weight_lbf+t.LiftCoef*Y*v,g=(Kt-e.Dist0_ft/1320*mr)*Pe+1e-4*Pe*(Mt*d)+t.DragCoef*Y*v,W=g*d/550,ye=12*e.TireCirFt/(2*Oe),$=(e.Ags0_g*t.Weight_lbf*(t.YCG_in-ye+pr/t.Efficiency*ye)+g*t.YCG_in)/t.Wheelbase_in;let Q=t.StaticFWt_lbf-$,ce=0;Q<0&&(ce=-Q*t.Wheelbase_in/64,Q=0);let le=Pe-Q-ce;le<0&&(le=t.Weight_lbf);const ae=xo(o.TractionIndex,o.TrackTempEffect),z=Eo();let k=ae*z*t.TireDia_in*(t.TireWidth_in+1)*(.92+.08*Math.pow(le/1900,2.15));t.BodyStyle===8&&(k=.5*k);const B=(k/e.TireGrowth-g)/t.Weight_lbf,Fe=t.TGEff[i-1]??.99;T=T*Fe*t.Efficiency/_,T=T-W;let C=550*b*T/t.Weight_lbf,A=C/(d*b),R=!1;A>B&&(R=!0,C=C*(B-(A-B))/A,A=B-(A-B)),A<te&&(C=C*te/A,A=te);let we=N/(2*C)+e.Time0_s,D=t.EnginePMI*m*(m-e.RPM0);D<0&&(t.isClutch?D=Mo*D:D=Po*D);let fe=h*x*(x-e.DSRPM0);fe<0&&(fe=0);let Be=0,Xe=0,_e=0;for(_e=1;_e<=12;_e++){const M=we-e.Time0_s;if(M<=0)break;const Le=Math.pow(2*Oe/60,2)/(12*550*M);Be=D*Le,Xe=fe*Le,T=(L-Be)*F,T=(T*Fe*t.Efficiency-Xe)/_-W,C=550*b*T/t.Weight_lbf,A=C/(d*b);let oe=0;M!==0&&(oe=(A-e.Ags0_g)/M),oe<Ve&&(oe=Ve,A=e.Ags0_g+oe*M,C=A*b*d),oe>$e&&(oe=$e,A=e.Ags0_g+oe*M,C=A*b*d),R=!1,A>B&&(R=!0,C=C*(B-(A-B))/A,A=B-(A-B)),A<te&&(C=C*te/A,A=te);const V=N/(2*C)+e.Time0_s,re=V-e.Time0_s;if(_e===12||Math.abs(100*(re-M)/re)<=.01){we=V;break}let Z=T/L;Z<mo&&(Z=mo),Z>po&&(Z=po),we=e.Time0_s+M+Z*(re-M)}const ue=we-e.Time0_s,He=Math.pow(e.Vel0_ftps,3),Ae=2*C*ue+e.Vel0_ftps*e.Vel0_ftps,X=(Math.pow(Ae,1.5)-He)/(3*C)+e.Dist0_ft;return e.L+=1,e.time_s=we,e.Vel_ftps=d,e.Dist_ft=X,e.AGS_g=A,e.EngRPM=m,e.DSRPM=x,e.SLIP=R,A>e.AgsMax_g&&(e.AgsMax_g=A),{TimeStep_s:n,VelSqrd:N,LockRPM:P,ClutchSlip:F,zStall:E,SlipRatio:I,TireSlip:_,WindFPS:U,q:v,RefArea2_ft2:Y,DownForce_lbf:Pe,DragForce_lbf:g,DragHP:W,DynamicFWT_lbf:Q,DynamicRWT_lbf:le,WheelBarWT_lbf:ce,CRTF:k,AMax_g:B,ChassisPMI:h,EngAccHP:D,ChasAccHP:fe,HPSave:L,HP:T,PQWT:C,iterations:_e}}function tn(e,t,o){const r=Ao(e.TireDia_in,e.TireWidth_in,0,0),i=Ut(e.xrpm,e.yhp,e.NHP,1,o);let c=5252*(e.HPTQMult*i/t.hpc)/o;const f=e.TGR[0]??1,l=e.TGEff[0]??.99;c=c*e.TorqueMult*f*l;const _=t.WindSpeed_mph/Mt,u=Math.sign(_)*t.rho*Math.pow(Math.abs(_),2)/(2*b),h=Kt*e.Weight_lbf+e.DragCoef*e.RefArea_ft2*u,N=c*e.GearRatio*e.Efficiency/(1.02*e.TireDia_in/24)-h;let P=(e.isClutch?.88:.96)*N/e.Weight_lbf;const F=e.Weight_lbf-e.StaticFWt_lbf,E=xo(t.TractionIndex,t.TrackTempEffect),I=Eo();let T=E*I*e.TireDia_in*(e.TireWidth_in+1)*(.92+.08*Math.pow(F/1900,2.15));e.BodyStyle===8&&(T=.5*T);const L=(T-h)/e.Weight_lbf;return P>L&&(P=L),P<te&&(P=te),{L:1,time_s:0,Vel_ftps:.001,Dist_ft:0,AGS_g:P,EngRPM:o,DSRPM:0,Gear:1,SLIP:!1,Vel0_ftps:0,Ags0_g:P,Time0_s:0,Dist0_ft:0,RPM0:o,DSRPM0:0,AgsMax_g:P,TireGrowth:r.TireGrowth,TireCirFt:r.TireCirFt}}function on(e,t,o,r){let i=e*.11*Math.pow(t*o/r,-.3333333333333333);return i=i/15,i<.005&&(i=.005),i}function rn(e){if(!e)return 1;const t=e.toUpperCase();return t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function nn(e){const t=e.vehicle,o=e.engine??t.engine,r=(o==null?void 0:o.hpCurve)??(o==null?void 0:o.torqueCurve)??t.torqueCurve??t.hpCurve??[],i=[],n=[];for(const s of r)Array.isArray(s)?(i.push(s[0]),n.push(s[1])):s&&typeof s=="object"&&(i.push(s.rpm),s.hp!==void 0?n.push(s.hp):s.torque!==void 0?n.push(s.torque*s.rpm/5252):s.tq_lbft!==void 0&&n.push(s.tq_lbft*s.rpm/5252));if(i.length<2){const s=Number(t.powerHP);if(Number.isFinite(s)&&s>0){const c=[{rpm:4e3,hp:s*.85},{rpm:5e3,hp:s*.92},{rpm:6e3,hp:s*.97},{rpm:6500,hp:s*1},{rpm:7e3,hp:s*.98},{rpm:7500,hp:s*.94},{rpm:8e3,hp:s*.88}];for(const f of c)i.push(f.rpm),n.push(f.hp)}}return{xrpm:i,yhp:n,NHP:i.length}}function sn(e){return 1+(e-100)*.001}function cn(e){const t=[],o=[],r=e.vehicle,i=e.env,n=e.drivetrain??r.drivetrain,s=e.clutch??r.clutch,c=e.converter??r.converter,f=e.engine??r.engine,l=!c||s&&!c,_=e.fuel,u=rn(_),h=Fo({barometer_inHg:i.barometerInHg??29.92,temperature_F:i.temperatureF??59,relHumidity_pct:i.humidityPct??50,elevation_ft:i.elevation??0,fuelSystem:u}),d=h.rho_slug_per_ft3*b,N=h.hpc,{xrpm:x,yhp:P,NHP:m}=nn(e);m<2&&t.push("HP curve has fewer than 2 points");const F=(n==null?void 0:n.gearRatios)??r.gearRatios??[2.5,1.8,1.4,1.1,1],E=(n==null?void 0:n.finalDriveRatio)??r.finalDrive??r.rearGear??3.73,T=(n==null?void 0:n.perGearEff)??r.gearEfficiencies??null??F.map(()=>.99),L=(s==null?void 0:s.slipRPM)??r.clutchSlipRPM??7200,U=(c==null?void 0:c.stallRPM)??r.converterStallRPM??5500,v=l?L:U,Y=(s==null?void 0:s.slippage)??(s==null?void 0:s.slipRatio)??r.clutchSlippage??1.0025,Pe=(c==null?void 0:c.slippage)??(c==null?void 0:c.slipRatio)??r.converterSlippage??1.06,ot=l?Y:Pe,g=(c==null?void 0:c.torqueMultiplier)??(c==null?void 0:c.torqueMult)??r.converterTorqueMult??2.2,W=(n==null?void 0:n.shiftRPMs)??(n==null?void 0:n.shiftsRPM)??r.shiftRPMs??r.shiftRPM??F.map(()=>7e3),ye=r.enginePMI??(f==null?void 0:f.enginePMI)??4,$=r.tiresPMI??(f==null?void 0:f.tiresPMI)??.5,Q=r.transPMI??(f==null?void 0:f.transPMI)??.2,ce=r.tireDiaIn??32,le=r.cgHeightIn??ce/2+3.75,ae=r.staticFrontWeightLb??r.weightLb*.38,z=(n==null?void 0:n.overallEfficiency)??r.transEfficiency??.97;console.log("[VB6Exact] Extracted params:",{gearRatios:F,finalDrive:E,TGEff:T,stallRPM:v,slippage:ot,shiftRPMs:W,enginePMI:ye,tiresPMI:$,transPMI:Q,YCG_in:le,staticFWt:ae,overallEfficiency:z,NHP:m,xrpm:x.slice(0,3),yhp:P.slice(0,3)});const k={Weight_lbf:r.weightLb,Wheelbase_in:r.wheelbaseIn??100,YCG_in:le,StaticFWt_lbf:ae,TireDia_in:ce,TireWidth_in:r.tireWidthIn??17,Rollout_in:r.rolloutIn??12,GearRatio:E,TGR:F,TGEff:T,Efficiency:z,Slippage:ot,TorqueMult:g,Stall:v,LockUp:(c==null?void 0:c.lockup)??!1,isClutch:l,RefArea_ft2:r.frontalArea_ft2??20,DragCoef:r.cd??.35,LiftCoef:r.liftCoeff??0,BodyStyle:r.bodyStyle??1,EnginePMI:ye,TiresPMI:$,TransPMI:Q,xrpm:x,yhp:P,NHP:m,HPTQMult:r.hpTorqueMultiplier??(f==null?void 0:f.hpTqMult)??1,ShiftRPM:W,NGR:F.length,LaunchRPM:l?(s==null?void 0:s.launchRPM)??r.clutchLaunchRPM??v:v},B=i.trackTempF??100,Fe=sn(B),C={rho:d,hpc:N,TractionIndex:i.tractionIndex??5,TrackTempEffect:Fe,WindSpeed_mph:i.windMph??0,WindAngle_deg:i.windAngleDeg??0},A=l?(s==null?void 0:s.launchRPM)??v:v,R=tn(k,C,A),we=Ut(x,P,m,1,A),D=on(60,we,g,r.weightLb),fe=5e3,Be=1400,Xe=30,_e={iterations:[],convergenceHistory:[]},ue=[],He=[60,330,660,1e3,1320];let Ae=0;for(let V=0;V<fe&&!(R.Dist_ft>=Be||R.time_s>=Xe);V++){if(!Number.isFinite(R.Vel_ftps)||!Number.isFinite(R.Dist_ft)||!Number.isFinite(R.AGS_g)){t.push(`NaN detected at step ${V}: Vel=${R.Vel_ftps}, Dist=${R.Dist_ft}, AGS=${R.AGS_g}`);break}const re=en(R,k,C,D);for(_e.iterations.push(re.iterations),V<20&&_e.convergenceHistory.push({step:V,iterations:re.iterations,HPSave:re.HPSave,HP:re.HP,PQWT:re.PQWT,AGS_g:R.AGS_g}),o.push({t_s:R.time_s,s_ft:R.Dist_ft,v_fps:R.Vel_ftps,a_g:R.AGS_g,rpm:R.EngRPM,gear:R.Gear,slip:R.SLIP});Ae<He.length&&R.Dist_ft>=He[Ae];){const Z=He[Ae],Tt=R.Vel_ftps*Me;ue.push({d_ft:Z,t_s:R.time_s,v_mph:Tt}),Ae++}if(R.Gear<k.NGR){const Z=k.ShiftRPM[R.Gear-1]??7e3;R.EngRPM>=Z&&R.Gear++}}const X=ue.find(V=>V.d_ft===1320),M=(X==null?void 0:X.t_s)??R.time_s,Le=(X==null?void 0:X.v_mph)??R.Vel_ftps*Me,oe=o.map(V=>({t_s:V.t_s,v_mph:V.v_fps*Me,a_g:V.a_g,s_ft:V.s_ft,rpm:V.rpm,gear:V.gear}));return{et_s:M,mph:Le,timeslip:ue,traces:oe,meta:{model:"RSACLASSIC",steps:o.length,warnings:t},vb6Diagnostics:_e}}const ln="rsa.model.";function an(e){try{const t=ln+e,o=localStorage.getItem(t);if(!o)return;const r=JSON.parse(o);if(!r.w||!r.P||typeof r.n!="number"){console.warn(`Invalid model structure for vehicle ${e}`);return}return r}catch(t){console.error(`Failed to load model for vehicle ${e}:`,t);return}}function fn(e,t){if(t.length!==e.w.length)throw new Error(`Feature dimension mismatch: expected ${e.w.length}, got ${t.length}`);let o=0;for(let r=0;r<e.w.length;r++)o+=e.w[r]*t[r];return o}class _n{constructor(){mt(this,"id","Blend")}simulate(t){const o=wo.simulate(t),r=t.vehicle.id,i=an(r);let n=0;const s=[...o.meta.warnings];if(i){const h=[pe(t.env)/1e3,t.vehicle.weightLb/3e3,t.vehicle.tireDiaIn/30,t.vehicle.rearGear/4,(o.et_s-10)/5];n=fn(i,h)}else s.push("no_learned_model");const c=o.et_s*.8,f=o.et_s*1.2;return{et_s:Math.max(c,Math.min(f,o.et_s+n)),mph:o.mph,timeslip:o.timeslip,traces:o.traces,meta:{model:"Blend",steps:o.meta.steps,warnings:s}}}}const un=new _n;class hn{constructor(){mt(this,"id","SimpleV1")}simulate(t){const o=ir({vehicle:t.vehicle,env:t.env,raceLength:t.raceLength});return{et_s:o.baseET_s,mph:o.baseMPH,timeslip:o.timeslip,meta:{model:"SimpleV1",steps:o.timeslip.length,warnings:[]}}}}class dn{constructor(){mt(this,"id","VB6Exact")}simulate(t){const o=cn(t);return{...o,meta:{...o.meta,model:"VB6Exact"}}}}const gn={SimpleV1:new hn,RSACLASSIC:wo,VB6Exact:new dn,Blend:un};function Io(e){const t=gn[e];if(!t)throw new Error(`Unknown physics model: ${e}`);return t}function mn(e){if(e!=null&&e.drivetrain){const t=e.drivetrain;t.shiftsRPM&&!t.shiftRPM&&(t.shiftRPM=t.shiftsRPM),t.overallEfficiency!==void 0&&t.overallEff===void 0&&(t.overallEff=t.overallEfficiency),t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}if(e!=null&&e.vehicle){const t=e.vehicle;t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}return e}function Ft(e,t){const o=Number(e==null?void 0:e.rpm);if(!Number.isFinite(o))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:o,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const r=Number(e.torque)*o/5252*t;return{rpm:o,hp:r}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const r=Number(e.tq_lbft)*o/5252*t;return{rpm:o,hp:r}}return null}function pn(e){var r,i,n,s,c,f;if(Array.isArray((r=e==null?void 0:e.engineParams)==null?void 0:r.powerHP)&&e.engineParams.powerHP.length>=2)return e;const t=((i=e==null?void 0:e.fuel)==null?void 0:i.hpTorqueMultiplier)??1;let o=[];if(Array.isArray((n=e==null?void 0:e.vehicle)==null?void 0:n.hpCurve)&&e.vehicle.hpCurve.length>=2&&(o=e.vehicle.hpCurve.map(l=>Ft(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,_)=>l.rpm-_.rpm)),o.length<2&&Array.isArray(e==null?void 0:e.engineHP)&&e.engineHP.length>=2&&(o=e.engineHP.map(l=>Array.isArray(l)?{rpm:Number(l[0]),hp:Number(l[1])*t}:Ft(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,_)=>l.rpm-_.rpm)),o.length<2&&Array.isArray((s=e==null?void 0:e.engineParams)==null?void 0:s.torqueCurve)&&e.engineParams.torqueCurve.length>=2&&(o=e.engineParams.torqueCurve.map(l=>Ft(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,_)=>l.rpm-_.rpm)),o.length<2&&Array.isArray((c=e==null?void 0:e.vehicle)==null?void 0:c.torqueCurve)&&e.vehicle.torqueCurve.length>=2&&(o=e.vehicle.torqueCurve.map(l=>Ft(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,_)=>l.rpm-_.rpm)),o.length<2){const l=Number((f=e==null?void 0:e.vehicle)==null?void 0:f.powerHP);Number.isFinite(l)&&l>0&&(o=[{rpm:4e3,hp:l*.85*t},{rpm:5e3,hp:l*.92*t},{rpm:6e3,hp:l*.97*t},{rpm:6500,hp:l*1*t},{rpm:7e3,hp:l*.98*t},{rpm:7500,hp:l*.94*t},{rpm:8e3,hp:l*.88*t}])}return o.length>=2&&(e.engineParams={...e.engineParams??{},powerHP:o}),e}function Mn(e){mn(e),pn(e)}function Pn(e){var i,n;if(!Array.isArray(e))return"none";const t=(i=e[0])==null?void 0:i.rpm,o=(n=e[e.length-1])==null?void 0:n.rpm;return`n=${e.length},first=${t},last=${o}`}self.onmessage=async e=>{var t,o,r,i,n,s,c,f,l;try{const _=e.data;if(!(_!=null&&_.model)||!(_!=null&&_.payload))throw new Error("Bad worker message");const u=JSON.parse(JSON.stringify(_.payload));if(_.model==="VB6Exact"){console.log("[WORKER:VB6Exact] Running with SimInputs format",{hasVehicle:!!u.vehicle,vehicleName:(t=u.vehicle)==null?void 0:t.name,powerHP:(o=u.vehicle)==null?void 0:o.powerHP,hasHpCurve:!!((r=u.vehicle)!=null&&r.hpCurve),raceLength:u.raceLength});const m=Io(_.model).simulate(u);self.postMessage({ok:!0,result:m});return}Mn(u);const h=(i=u==null?void 0:u.engineParams)==null?void 0:i.powerHP;if(!Array.isArray(h)||h.length<2)throw console.error("[WORKER] bad powerHP",{hpLen:h==null?void 0:h.length,sample:(n=h==null?void 0:h.slice)==null?void 0:n.call(h,0,2)}),new Error("EngineParams must provide either torqueCurve or powerHP");Number.isFinite(u==null?void 0:u.raceLengthFt)||(u.raceLengthFt=(_==null?void 0:_.raceLengthFt)??1320);const d=(u==null?void 0:u.drivetrain)??{};console.log("[WORKER:normalized.input]",{hasEngineParams:!!u.engineParams,hasPowerHP:!!h,raceLengthFt:u.raceLengthFt,hpSummary:Pn(h),hasClutch:!!d.clutch,hasConverter:!!d.converter,slipRPM:(s=d==null?void 0:d.clutch)==null?void 0:s.slipRPM,stallRPM:(c=d==null?void 0:d.converter)==null?void 0:c.stallRPM});try{u!=null&&u.tuning&&console.debug("[WORKER:TUNING]",!0,u.tuning)}catch{}u.flags===void 0&&(u.flags={}),u.flags.vb6Strict===void 0&&(u.flags.vb6Strict=((l=(f=_.payload)==null?void 0:f.flags)==null?void 0:l.vb6Strict)??!0);const x=Io(_.model).simulate(u);self.postMessage({ok:!0,result:x})}catch(_){console.error("[WORKER ERROR]",_),self.postMessage({ok:!1,error:String((_==null?void 0:_.message)||_)})}}})();
//# sourceMappingURL=index-Bq1sSRcN.js.map
