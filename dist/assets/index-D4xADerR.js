var bs=Object.defineProperty;var Es=(Ee,we,Pt)=>we in Ee?bs(Ee,we,{enumerable:!0,configurable:!0,writable:!0,value:Pt}):Ee[we]=Pt;var Jt=(Ee,we,Pt)=>Es(Ee,typeof we!="symbol"?we+"":we,Pt);(function(){"use strict";const Ee={EIGHTH:[60,330,660],THOUSAND:[60,330,660,1e3],QUARTER:[60,330,660,1e3,1320],ONE_MILE:[660,1320,2640,3960,5280],EL_MIRAGE:[660,1320,2640,3960,5280,6864],MUROC:[660,1320,2640,3960,5280,6600,7920],TWO_MILE:[660,1320,2640,5280,7920,10560],BONNEVILLE_SHORT:[660,1320,2640,5280,10560,15840],BONNEVILLE_LONG:[660,1320,2640,5280,10560,15840,21120,26400],TEN_MILE:[660,1320,2640,5280,10560,26400,52800]},we={EIGHTH:{label:"1/8 Mile",shortLabel:"1/8",category:"drag",lengthFt:660,lengthMiles:.125},THOUSAND:{label:"1000 Foot",shortLabel:"1000'",category:"drag",lengthFt:1e3,lengthMiles:.189},QUARTER:{label:"1/4 Mile",shortLabel:"1/4",category:"drag",lengthFt:1320,lengthMiles:.25},ONE_MILE:{label:"One Mile Asphalt",shortLabel:"1 Mi",category:"landspeed",lengthFt:5280,lengthMiles:1},EL_MIRAGE:{label:"El Mirage Dry Lake",shortLabel:"El Mirage",category:"landspeed",lengthFt:6864,lengthMiles:1.3},MUROC:{label:"Muroc Dry Lake (EAFB)",shortLabel:"Muroc",category:"landspeed",lengthFt:7920,lengthMiles:1.5},TWO_MILE:{label:"Two Mile Asphalt",shortLabel:"2 Mi",category:"landspeed",lengthFt:10560,lengthMiles:2},BONNEVILLE_SHORT:{label:"Bonneville - 3 Miles",shortLabel:"BV 3Mi",category:"landspeed",lengthFt:15840,lengthMiles:3},BONNEVILLE_LONG:{label:"Bonneville - 5 Miles",shortLabel:"BV 5Mi",category:"landspeed",lengthFt:26400,lengthMiles:5},TEN_MILE:{label:"Ten Mile Test Track",shortLabel:"10 Mi",category:"landspeed",lengthFt:52800,lengthMiles:10}};function Pt(e){const r=e.elevation+(29.92-e.barometerInHg)*1e3,o=59-r/1e3*3.5,s=(e.temperatureF-o)*120,n=e.humidityPct/10*50*(e.temperatureF/80);return r+s+n}function ho(e){const r=.0061*Math.exp(17.27*(e.temperatureF-32)/1.8/(237.3+(e.temperatureF-32)/1.8))*(e.humidityPct/100),o=7e3*.622*(r/(e.barometerInHg-r));return Math.max(0,Math.min(o,500))}function go(e){const o=518.6700000000001,s=e.temperatureF+459.67,n=e.barometerInHg/29.92,l=o/s;let a=n*l;const c=1-ho(e)/5e3;return a*=c,Math.max(.7,Math.min(a,1.15))}function mo(e){const{vehicle:t,env:r,raceLength:o}=e;if(t.weightLb<=0||t.powerHP<=0)throw new Error("Invalid vehicle params");const s=Ee[o];if(!s)throw new Error(`Invalid race length: ${o}`);const n=go(r),l=t.powerHP*n,a=Math.max(1,l),f=Math.max(1,t.weightLb),c=5.825*Math.cbrt(f/a),u=234*Math.cbrt(a/f),_=c*.64,d=u*.8;let p,h;if(o==="EIGHTH"?(p=_,h=d):(p=c,h=u),!Number.isFinite(p)||!Number.isFinite(h))throw new Error("Invalid ET or MPH calculation");const P=5.825*Math.cbrt(f/Math.max(1,t.powerHP)),g=p-P,m={60:.16,330:.44,660:.79,1e3:.93,1320:1},R=s.map(C=>{const y=m[C]??1,I=p*y,S=C/s[s.length-1],K=h*S;return{d_ft:C,t_s:Math.max(0,I),v_mph:Math.max(0,K)}}),b=[{name:"Weather (HP)",delta_s:g}];return{baseET_s:Math.max(0,p),baseMPH:Math.max(0,h),timeslip:R,factors:b}}function po(e){return e/32.174}function Mo(e,t,r){return e+(t-e)*r}function Po(e){var r;const t=(Array.isArray(e)?e:e==null?void 0:e.powerHP)??((r=e==null?void 0:e.engineParams)==null?void 0:r.powerHP);if(!Array.isArray(t)||t.length<2){const o=e&&typeof e=="object"?Object.keys(e):[];throw new Error(`EngineParams must provide either torqueCurve or powerHP (got keys=${JSON.stringify(o)}, len=${(t==null?void 0:t.length)??0})`)}return t}function fr(e,t){const r=Po(t);if(e<=r[0].rpm)return r[0].hp;if(e>=r[r.length-1].rpm)return r[r.length-1].hp;let o=0,s=r.length-1;for(;s-o>1;){const f=o+s>>1;r[f].rpm<=e?o=f:s=f}const n=r[o],l=r[s],a=(e-n.rpm)/(l.rpm-n.rpm);return n.hp+a*(l.hp-n.hp)}function Qt(e,t,r){if("corr"in t&&typeof t.corr=="number"){const n=t;let l;if(n.torqueCurve&&n.torqueCurve.length>0)l=To(e,n.torqueCurve);else if(n.powerHP!==void 0){const f=Math.max(e,1e3);l=n.powerHP*5252/f}else throw new Error("EngineParams must provide either torqueCurve or powerHP");return l*n.corr}const o=fr(e,t);return(e>0?5252*o/e:0)*(Number.isFinite(r)?r:1)}function To(e,t){const o=[...t.map(s=>{if(s.tq_lbft!==void 0)return{rpm:s.rpm,tq_lbft:s.tq_lbft};if(s.hp!==void 0&&s.rpm>0)return{rpm:s.rpm,tq_lbft:s.hp*5252/s.rpm};throw new Error(`Invalid torque curve point: ${JSON.stringify(s)}`)})].sort((s,n)=>s.rpm-n.rpm);if(e<=o[0].rpm)return o[0].tq_lbft;if(e>=o[o.length-1].rpm)return o[o.length-1].tq_lbft;for(let s=0;s<o.length-1;s++){const n=o[s],l=o[s+1];if(e>=n.rpm&&e<=l.rpm){const a=(e-n.rpm)/(l.rpm-n.rpm);return Mo(n.tq_lbft,l.tq_lbft,a)}}return o[o.length-1].tq_lbft}const T=e=>Math.fround(e),H={add:(e,t)=>Math.fround(Math.fround(e)+Math.fround(t)),sub:(e,t)=>Math.fround(Math.fround(e)-Math.fround(t)),mul:(e,t)=>Math.fround(Math.fround(e)*Math.fround(t)),div:(e,t)=>Math.fround(Math.fround(e)/Math.fround(t)),sqrt:e=>Math.fround(Math.sqrt(Math.fround(e))),pow:(e,t)=>Math.fround(Math.pow(Math.fround(e),Math.fround(t))),exp:e=>Math.fround(Math.exp(Math.fround(e))),log:e=>Math.fround(Math.log(Math.fround(e))),clamp:(e,t,r)=>Math.fround(Math.min(Math.max(Math.fround(e),Math.fround(t)),Math.fround(r))),abs:e=>Math.fround(Math.abs(Math.fround(e))),neg:e=>Math.fround(-Math.fround(e))};function wr(e,t=0){const r=Math.pow(10,t),o=Math.fround(e*r),s=Math.floor(o),n=o-s;return n>.5?(s+1)/r:n<.5?s/r:(s%2===0?s:s+1)/r}function So(e,t,r,o,s){const n=T(e),l=T(t),a=T(r),f=T(o),c=T(s);if(a===l)return f;const u=H.div(H.sub(n,l),H.sub(a,l));return H.add(f,H.mul(u,H.sub(c,f)))}function Ro(e,t){if(t.length===0)return T(0);if(t.length===1)return T(t[0][1]);const r=T(e);if(r<=T(t[0][0]))return T(t[0][1]);if(r>=T(t[t.length-1][0]))return T(t[t.length-1][1]);for(let o=0;o<t.length-1;o++){const s=T(t[o][0]),n=T(t[o+1][0]);if(r>=s&&r<=n)return So(r,s,n,t[o][1],t[o+1][1])}return T(t[t.length-1][1])}function Fo(e){return Array.isArray(e==null?void 0:e.ratios)&&e.ratios.length>0?e.ratios:Array.isArray(e==null?void 0:e.gearRatios)&&e.gearRatios.length>0?e.gearRatios:[]}function bo(e,t,r,o=0){const s=(r.tireDiaIn??28)/12,n=Math.PI*s,a=e/n*60,f=Fo(r),c=f.length>0?f[Math.min(t,f.length-1)]??1:1;return a*c*(r.finalDrive??3.73)*(1+o)}function Eo(){return{t_s:0,v_fps:0,s_ft:0,rpm:0,gearIdx:0,warnings:[]}}const Ye=3.141593,w=32.174,ur=60/(2*Ye)*550,_r=519.67,Ar=14.696,wo=29.92,hr=28.9669,xr=18.016,Ir=1545.32,Kt=3600/5280,dr=.025,Ao=.01,Cr=.03,xo=0,Io=9.7,Co=1.01,vo=0,yo=0,pe=.004,Tt=-4,St=2,vr=.92,yr=1.08,Hr=.15,Lr=.25,Ho=1.03,Lo=10.8,ae=3600/5280,No=459.67,Do=w;function Go(e){const{engineTorque_lbft_atSlip:t,gearRatio:r,transEff:o,drivelineEff:s,finalDrive:n,tireDia_in:l,tireSlip:a,dragForce_lbf:f,vehicleWeight_lbf:c,isAutoTrans:u,torqueMult:_=1}=e,d=t*_*r*o,p=l/24,P=d*n*s/(a*p)-f;return{Ags0_ftps2:(u?.96:.88)*(P/c)*w,netThrust_lbf:P,wheelTorque_lbft:d}}function Nr(e){const t=e.elevation_ft??0,r=e.fuelSystem??1,o=[.0205558,.00118163,154988e-10,40245e-11,434856e-15,2096e-14],s=o[0]+o[1]*e.temperature_F+o[2]*e.temperature_F**2+o[3]*e.temperature_F**3+o[4]*e.temperature_F**4+o[5]*e.temperature_F**5,n=e.relHumidity_pct/100*s,l=Math.pow((_r-.00356616*t)/_r,5.25588),a=Ar*e.barometer_inHg/wo*l,f=a-n,c=f/Ar,u=n*xr/(f*hr),_=Ir*(1/hr+u/xr)/(1+u),d=_/(Ir/hr),p=e.temperature_F+No,h=p/_r,g=144*a/(_*p)/32.174;let m,R;switch(r){case 1:m=1,R=1;break;case 2:m=1,R=2;break;case 3:m=2,R=1;break;case 4:m=2,R=2;break;case 5:m=3,R=2;break;case 6:m=1,R=3;break;case 7:case 9:m=2,R=3;break;case 8:m=3,R=3;break;default:m=1,R=1;break}const b=1+2.48*Math.pow(u,1.5);let C,y,I;switch(m){case 1:C=1,y=.6,I=.15;break;case 2:C=1,y=.3,I=.13;break;case 3:C=.85,y=.5,I=.055;break;default:C=1,y=.6,I=.15;break}if(R===2&&(I=I-.005),R===3){const K=.3050108932461874;C=.95-K*y,y=y+K,I=.6*I}let S=Math.pow(c,C)/(Math.sqrt(d)*Math.pow(h,y));return S=(1+I)*b/S-I,r===9&&(S=1),{rho_slug_per_ft3:g,pamb_psi:a,PWV_psi:n,pair_psi:f,WAR:u,RGAS:_,temp_R:p,hpc:S,delta:c,theta:h,rgrs:d}}function ko(e,t,r,o=.025,s=.01){const n=o-r/1320*s,l=3600/5280,a=n*e,f=1e-4*e*(l*t);return a+f}function Wo(e,t,r,o,s=.025,n=.01){return ko(e,t,r,s,n)*o}function qo(e,t,r,o,s=1){let n=t,l=o*e/n;s>2&&l>.6&&(n=n*(1+(o-1)*(l-.6)/(1/o-.6)),l=o*e/n);let a=1/o,f=o*e,c=1;return f<n&&(f=n,c=r-(r-1)*l,a=c*e/n),a>1&&(a=1),{work:c,coupling:a,slipRatio:l,zStall:n,engRPM:f}}const Oo=10.8;function Dr(e){const{tireDia_in:t,tireWidth_in:r,dynamicRWT_lbf:o,tractionIndexAdj:s,bodyStyle:n}=e,l=.92+.08*Math.pow(o/1900,2.15);let a=s*Oo*t*(r+1)*l;return n===8&&(a=.5*a),a}function Vo(e){const{weight_lbf:t,tireGrowth:r,dragForce_lbf:o}=e;return(Dr(e)/r-o)/t*w}function Bo(){return pe*w}function $o(e,t,r,o){let s=e,n=t,l=0;return s>o&&(l=1,n=n*(o-(s-o))/s,s=o-(s-o)),s<r&&(n=n*r/s,s=r),{AGS:s,PQWT:n,SLIP:l}}function Uo(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function Jo(e,t,r,o){return e+t*Math.pow(r*o,2)}function Qo(e,t,r){return e*t*60/r}function Ko(e,t,r,o,s=!0){let n=o*t*(t-e);n<0&&(n=s?Hr*n:Lr*n);const l=Math.pow(2*Ye/60,2)/(12*550*r);return n*l}function Xo(e,t,r,o){let s=o*t*(t-e);s<0&&(s=0);const n=Math.pow(2*Ye/60,2)/(12*550*r);return s*n}function jo(e,t,r,o){const s=Math.PI,n=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));let l=1+n*135e-7*Math.pow(r,1.6);const a=1+n*35e-5*r;a<l&&(l=a);const f=o/32.174,c=l-.035*Math.abs(f),u=c*e*s/12,_=12*u/(2*s),d=2*_,p=_/12;return{growth:l,squat:c,dia_eff_in:d,radius_eff_ft:p,circumference_eff_ft:u}}function Yo(e,t,r,o,s){const f=(t-1)*r/2*o*(s?1:2)/144;return e+f}function Zo(e,t,r,o){if(e>=t-1)return!1;const s=o[e];if(!s||s<=0)return!1;const l=(o[0]??0)>8e3?20:10;return Math.abs(s-r)<l}var Gr=(e=>(e[e.NORMAL=0]="NORMAL",e[e.TRIGGERED=1]="TRIGGERED",e[e.EXECUTING=2]="EXECUTING",e))(Gr||{});function zo(e,t){switch(e){case 0:return t?{newState:1,executeShift:!1}:{newState:0,executeShift:!1};case 1:return{newState:2,executeShift:!0};case 2:return{newState:0,executeShift:!1};default:return{newState:0,executeShift:!1}}}function en(e){return e?.2:.25}function tn(e,t,r,o){return r>=o||!t||t<=0?!1:H.sub(T(e),T(t))>=0}function rn(e,t=3,r=1){const o=.005*(t-1)+3*(r-1),s=e/1320;return 1.02+o*(1-Math.pow(s,2))}function on(e,t,r,o,s,n,l=.04,a=.9){const f=e*t*(r-o+l/a*o),c=n*r;return(f+c)/s}function nn(e,t,r,o,s,n,l,a,f=.04,c=.9){const u=on(r,e,o,s,n,l,f,c);let _=t-u,d=0;_<0&&(d=-_*n/64,_=0);let p=a-_-d;return p<0&&(p=e),{rear_weight_lbf:p,front_weight_lbf:_,wheelie_bar_weight_lbf:d}}function sn(e,t,r,o){const s=2*o*r,n=Math.sqrt(e*e+s),l=2*o*r+e*e,a=Math.pow(l,1.5),f=Math.pow(e,3),c=(a-f)/(3*o)+t;return{Vel_ftps:n,Dist_ft:c}}function ln(e,t,r){let o=e,s=1,n=0;if(o>r){n=1;const l=o-r,a=r-l;s=a/o,o=a}return o<t&&(s=t/o,o=t),{AGS_ftps2:o,PQWT_scale:s,slip:n}}function cn(e,t){return e/(t*w)}function an(e,t,r){if(r<=0)return Math.max(.005,Math.min(.05,e));let o=e*Math.pow(t/r,4);return o>.05&&(o=.05),o<.005&&(o=.005),o}function fn(e,t,r,o){const s=t*r/o;let n=e*.11*Math.pow(s,-1/3);return n=n/15,n<.005&&(n=.005),n}function un(e){if(!e)return 1;const t=e.toUpperCase();return t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")||t.includes("FUEL INJECT")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function _n(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const o=Number(e.torque)*r/5252*t;return{rpm:r,hp:o}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const o=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:o}}return null}function Xt(e,t=1){return e.map(r=>Array.isArray(r)?{rpm:Number(r[0]),hp:Number(r[1])*t}:_n(r,t)).filter(r=>r!==null&&Number.isFinite(r.rpm)&&Number.isFinite(r.hp)).sort((r,o)=>r.rpm-o.rpm)}function hn(e){var a,f,c,u;const t=((a=e==null?void 0:e.fuel)==null?void 0:a.hpTorqueMultiplier)??1,r=[],o=(f=e==null?void 0:e.engineParams)==null?void 0:f.powerHP;if(Array.isArray(o)&&(r.push(`engineParams.powerHP(${o.length})`),o.length>=2)){const _=Xt(o,t);if(_.length>=2)return{powerHP:_}}const s=e==null?void 0:e.engineHP;if(Array.isArray(s)&&(r.push(`engineHP(${s.length})`),s.length>=2)){const _=Xt(s,t);if(_.length>=2)return{powerHP:_}}const n=(c=e==null?void 0:e.engineParams)==null?void 0:c.torqueCurve;if(Array.isArray(n)&&(r.push(`engineParams.torqueCurve(${n.length})`),n.length>=2)){const _=Xt(n,t);if(_.length>=2)return{powerHP:_}}const l=(u=e==null?void 0:e.vehicle)==null?void 0:u.torqueCurve;if(Array.isArray(l)&&(r.push(`vehicle.torqueCurve(${l.length})`),l.length>=2)){const _=Xt(l,t);if(_.length>=2)return{powerHP:_}}throw new Error(`RSACLASSIC: missing power curve. Sources found: [${r.join(", ")||"none"}]. Keys(engineParams)=${JSON.stringify(Object.keys((e==null?void 0:e.engineParams)||{}))} Keys(vehicle)=${JSON.stringify(Object.keys((e==null?void 0:e.vehicle)||{}))}`)}function Ae(e,t=0){return Number.isFinite(e)?Number(e):t}function kr(e,t){const r=t.map(o=>[o.rpm,o.hp]);return Ro(e,r)}function Wr(e,t,r){const o=kr(e,t);if(e<=0)return T(0);const s=H.div(H.mul(T(5252),o),T(e));return H.mul(s,T(r))}function dn(e,t,r,o=t){const s=Number(e);return Number.isFinite(s)?Math.min(r,Math.max(t,s)):o}function gn(e){return Math.max(.85,Math.min(1,e))}class mn{constructor(){Jt(this,"id","RSACLASSIC")}simulate(t){var Qr,Kr,tr,Xr,rr,jr,Yr,Zr;const r=!!((Qr=t==null?void 0:t.flags)!=null&&Qr.vb6Strict);r&&console.log("[RSACLASSIC] VB6-STRICT mode enabled - using Float32 math");const o=Date.now(),s=9e4,n=2e6,l=5e4;let a=0;function f(A,D){if(Date.now()-o>s)throw new Error("simulation wall-time exceeded");if(A>=n)throw new Error("simulation step cap hit");if(A%l===0){const De=D-a;if(console.log("[RSACLASSIC] heartbeat",{step:A,dist_ft:D,gained_ft:De}),A>0&&De<.001)throw new Error("simulation stalled");a=D}}const c=Number((t==null?void 0:t.raceLengthFt)??1320);if(!Number.isFinite(c)||c<=0)throw new Error(`invalid raceLengthFt: ${t==null?void 0:t.raceLengthFt}`);const u=Number((t==null?void 0:t.timeStep)??.002);if(!Number.isFinite(u)||u<=0)throw new Error(`invalid timeStep ${u}`);const d=hn(t).powerHP;if(console.log("[RSACLASSIC] start",{raceLenFt:c,hpPts:d.length}),!Array.isArray(d)||d.length<2)throw new Error(`RSACLASSIC: powerHP invalid (len=${(d==null?void 0:d.length)??0})`);const p=(t==null?void 0:t.drivetrain)??{},h=(t==null?void 0:t.vehicle)??{},P=p.clutch??(t==null?void 0:t.clutch)??h.clutch,g=p.converter??(t==null?void 0:t.converter)??h.converter,m=!!P,R=!!g,b=m?Number(P.slipRPM??P.slipRpm):NaN,C=m?Number(P.launchRPM??P.launchRpm):NaN,y=R?Number(g.stallRPM??g.stallRpm):NaN,I=m?Number(P.slippageFactor??P.slipRatio??1.0025):1,S=R?Number(g.slippageFactor??g.slipRatio??1.05):1;if(!m&&!R)throw new Error("RSACLASSIC: drivetrain must specify clutch or converter");if(m&&!Number.isFinite(b))throw new Error("RSACLASSIC: clutch.slipRPM missing/invalid");if(R&&!Number.isFinite(y))throw new Error("RSACLASSIC: converter.stallRPM missing/invalid");const K=m?Number.isFinite(C)?C:b:y;console.log("[RPM-RESOLVED]",{isClutch:m,isConverter:R,slipRPM:b,launchRPM:C,stallRPM:y,rpmPin:K});const xe=(t==null?void 0:t.tuning)??{},We=Number.isFinite(xe.aeroCdScale)?xe.aeroCdScale:1,it=Number.isFinite(xe.drivelineEffOffset)?xe.drivelineEffOffset:0,{vehicle:M,env:V,raceLength:lt}=t,J=[],te=lt==="EIGHTH"?660:1320,qe=M.cd,Ie=M.frontalArea_ft2,Z=M.transEff,fe=M.finalDrive??M.rearGear,X=M.gearRatios,j=M.gearEff,ue=M.shiftRPM;qe||J.push("Missing vehicle.cd (drag coefficient) - required for VB6 parity"),Ie||J.push("Missing vehicle.frontalArea_ft2 - required for VB6 parity"),(!X||X.length===0)&&J.push("Missing vehicle.gearRatios[] - required for VB6 parity"),(!ue||ue.length===0)&&J.push("Missing vehicle.shiftRPM[] - required for VB6 parity"),fe||J.push("Missing vehicle.finalDrive or vehicle.rearGear - required for VB6 parity"),V.barometerInHg===void 0&&J.push("Missing env.barometerInHg - required for VB6 air density"),V.temperatureF===void 0&&J.push("Missing env.temperatureF - required for VB6 air density"),V.humidityPct===void 0&&J.push("Missing env.humidityPct - required for VB6 air density"),V.elevation===void 0&&J.push("Missing env.elevation - required for VB6 air density");const Me=M.tireRolloutIn??null,Ze=M.tireDiaIn??null,ct=Math.PI;let E=(typeof Me=="number"&&Me>0?Me/ct:null)??Ze??0;(!E||E<=0)&&(J.push("Tire diameter is undefined/invalid. Provide tireRolloutIn or tireDiaIn."),E=28);const Pe=M.rolloutIn;Pe||J.push("Missing vehicle.rolloutIn - required for VB6 parity");const ie=t.fuel,k=un(ie),le=Nr({barometer_inHg:V.barometerInHg??29.92,temperature_F:V.temperatureF??59,relHumidity_pct:V.humidityPct??50,elevation_ft:V.elevation??0,fuelSystem:k}).rho_slug_per_ft3,Ft=po(M.weightLb),Te=(Pe??12)/12;let re=null,x=0;const _e=30,ze=.01,at=d.reduce((A,D)=>Math.max(A,D.hp),0),he=g?g.torqueMult??1.7:1,Ce=(M.rolloutIn??12)/12,Ve=fn(Ce>0?Ce:1,at,he,M.weightLb);let Se=0,F=Ve,i=Eo(),oe=0;const bt=[],Re=[];let ve=!1,ne=0;const ft=[60,330,660,1e3,te];let et=0,ye=0,He=0,Be=0,$e=0,Ue=0,Yt=0,Je=0,ut=1,Zt;i.rpm=K;const _t=t.fuel;let Et=1,wt=1,At=0,ht=0,dt=0,gt=0,mt=0,v=0,de=0,Q=0,q=0,W=0;if(P||g){const A=Qt(K,d,Z??.9),D=K>0?A*K/5252:0,Ne=D>0&&K>0?5252*D/K:0,De=(X??[1])[0]??1,me=Ne*De*(Z??.9)*(fe??3.73)*(Z??.9)/(1.02*E/24);W=(g?.96:.88)*me/M.weightLb,W<pe&&(W=pe)}const B=6,Gt=5;let se=K,Le=0,kt=Gr.NORMAL,N=0,$=0;const tt=A=>j&&j[A]!==void 0?Math.max(.9,Math.min(1,j[A])):Z??.9,ce=()=>{const A=p.overallEff??p.overallEfficiency??Z??.97;return gn(A+it)},ge=A=>{const D=V.tractionIndex??3;return rn(A,D,1)};for(;;){x++,f(x,i.s_ft);const A=jo(E,M.tireWidthIn??17,i.v_fps,W),D=A.radius_eff_ft,Ne=A.circumference_eff_ft,De=A.dia_eff_in;let It=bo(i.v_fps,i.gearIdx,p),Ct=It,me=1,or=0,zr=0,eo=0;const Ge=tt(i.gearIdx);r?Wr(It,d,Ge):Qt(It,d,Ge);let Wt=1;if(_t==="METHANOL"){const G=V.trackTempF;G!==void 0&&G<80&&i.t_s<.8&&(Wt=1.025-.025*i.t_s/.8)}else if(_t==="NITRO"){if(i.t_s<.4)Wt=.9;else if(i.t_s<1){const G=(i.t_s-.4)/.6;Wt=.9+(1-.9)*G}}Et=Math.min(Et,Wt),wt=Math.max(wt,Wt);const qt=(X??[1])[i.gearIdx]??1,Pr=ge(i.s_ft)*i.v_fps*60/Ne;x===1&&typeof console<"u"&&console.debug&&console.debug("[RPM-DEBUG]",{isClutch:m,isConverter:R,slipRPM:b,launchRPM:C,stallRPM:y,calculated_slipRPM:b,rpm_from_speed:It});const rt=Pr*qt*(fe??3.73);let U=(m?I:S)*rt;const ts=i.gearIdx===0,rs=!0,Ot=m?b:y;(m||R)&&(ts||rs)&&U<Ot&&(U=Ot);const nr=U===Ot&&rt<Ot,to=Ot;if(Ct=U,r?Wr(U,d,Ge):Qt(U,d,Ge),P)me=U>1?Math.max(0,Math.min(1,rt/U)):0,ut=Math.min(ut,me);else if(g){const G=g.torqueMult??2,O=qo(rt,y,G,S,x);me=O.coupling,or=O.work,zr=O.slipRatio,eo=O.zStall,$e+=O.work,Ue+=O.coupling,Yt+=O.slipRatio,Je++,ut=Math.min(ut,me)}else Ct=It;i.rpm=Ct;const vt=Ae(i.v_fps,0),ro=V.windMph??0,os=V.windAngleDeg??0,Tr=ro/ae,ns=os*Math.PI/180,ss=Math.sqrt(vt*vt+2*vt*Tr*Math.cos(ns)+Tr*Tr),is=M.bodyStyle===8,sr=Yo(Ie??0,A.growth,E,M.tireWidthIn??17,is);let ir,pt,Vt,lr;const Sr=ro!==0?ss:vt;if(r){const G=T(Sr);ir=H.mul(G,G),pt=H.mul(H.mul(T(.5),T(le)),ir),Vt=H.mul(H.mul(H.mul(pt,T(qe??0)),T(We)),T(sr)),lr=H.mul(H.mul(pt,T(M.liftCoeff??0)),T(sr))}else ir=Sr*Sr,pt=Ae(.5*le*ir,0),Vt=Ae(pt*(qe??0)*We*sr,0),lr=Ae(pt*(M.liftCoeff??0)*sr,0);const Rr=Ae(M.weightLb-lr,M.weightLb),Mt=Vt,ls=Rr,cs=M.rrCoeff??dr,as=Wo(ls,vt,i.s_ft,D,cs,.01),Qe=Ae(as/D,0),fs=1,us=V.tractionIndex??3,Fr=Uo(us,fs),_s=x===1?0:q,hs=M.wheelbaseIn??108,ds=E/2+3.75,gs=M.staticFrontWeightLb??M.weightLb*.38,Bt=nn(M.weightLb,gs,_s,ds,D*12,hs,Mt+Qe,Rr,1.03,ce()),yt=Bt.rear_weight_lbf,Ke=Vo({weight_lbf:M.weightLb,tireDia_in:E,tireWidth_in:M.tireWidthIn??17,dynamicRWT_lbf:yt,tractionIndexAdj:Fr,tireGrowth:A.growth,dragForce_lbf:Mt+Qe,bodyStyle:void 0}),Fe=Bo();if(x<=12&&typeof console<"u"&&console.log){const G=Dr({weight_lbf:M.weightLb,tireDia_in:E,tireWidth_in:M.tireWidthIn??17,dynamicRWT_lbf:yt,tractionIndexAdj:Fr,bodyStyle:void 0});console.log("[TRACTION]",{step:x,CAXI:+Fr.toFixed(4),AX:10.8,tireDia_in:+E.toFixed(2),tireWidth_in:+(M.tireWidthIn??17).toFixed(1),dynamicRWT_lbf:+yt.toFixed(1),weightFactor:+(.92+.08*Math.pow(yt/1900,2.15)).toFixed(4),CRTF:+G.toFixed(1),tireGrowth:+A.growth.toFixed(4),dragForce_lbf:+(Mt+Qe).toFixed(2),AMin_ftps2:+Fe.toFixed(3),AMax_ftps2:+Ke.toFixed(3),AMin_g:+(Fe/w).toFixed(4),AMax_g:+(Ke/w).toFixed(4)})}let z,be;if(x<=B&&rt<Gt){const G=Qt(K,d,Ge),O=R?g.torqueMult??2:1,ee=Go({engineTorque_lbft_atSlip:G,gearRatio:qt,transEff:Ge,drivelineEff:ce(),finalDrive:fe??3.73,tireDia_in:E,tireSlip:ge(i.s_ft),dragForce_lbf:Mt+Qe,vehicleWeight_lbf:M.weightLb,isAutoTrans:!!g,torqueMult:O});be=ee.netThrust_lbf/M.weightLb*w;const nt=$o(ee.Ags0_ftps2,be,Fe,Ke);if(z=nt.AGS,be=nt.PQWT,x<=10&&typeof console<"u"&&console.debug){const st=ee.Ags0_ftps2/w,$t=qt*(fe??3.73);console.debug("[STEP]",{step:x,phase:nr?"PINNED":"BOOTSTRAP",v_fps:i.v_fps.toFixed(6),EngRPM:Ct.toFixed(0),LockRPM:rt.toFixed(2),slipRPM:b.toFixed(0),lockThreshold:to.toFixed(0),rpmIsPinned:nr,clutchSlip:me.toFixed(6),gear:i.gearIdx+1,GRxFD:$t.toFixed(3),tireDia_eff_in:De.toFixed(2),tireGrowth:A.growth.toFixed(4),tireSlip:ge(i.s_ft).toFixed(4),RWTdyn_lbf:yt.toFixed(1),RWTfront_lbf:Bt.front_weight_lbf.toFixed(1),wheelieBar_lbf:Bt.wheelie_bar_weight_lbf.toFixed(1),AGS_g:st.toFixed(4),AGS_ftps2:z.toFixed(4),AMin_ftps2:Fe.toFixed(4),AMax_ftps2:Ke.toFixed(4),SLIP:nt.SLIP})}}else{let G=r?kr(U,d):fr(U,d);N>0&&(G=0,N=Math.max(0,N-F),N===0&&typeof console<"u"&&console.debug&&console.debug("[SHIFT_DWELL_END]",{step:x,t_s:i.t_s.toFixed(4),v_fps:i.v_fps.toFixed(2)}));const O=G,ee=r?H.div(H.mul(H.add(T(Mt),T(Qe)),T(i.v_fps)),T(550)):(Mt+Qe)*i.v_fps/550;x<=12&&typeof console<"u"&&console.log&&console.log("[PRE_HP_CHAIN]",{step:x,EngRPM_out:+U.toFixed(0),wheelRPM:+Pr.toFixed(2),ClutchSlip:+me.toFixed(4),...g?{converterWork:+or.toFixed(4)}:{},HPSave:+O.toFixed(1),DragHP:+ee.toFixed(2),F_drag_lbf:+Vt.toFixed(2),F_roll_lbf:+Qe.toFixed(2),v_fps:+i.v_fps.toFixed(2),tireSlip:+ge(i.s_ft).toFixed(4),currentGearEff:+Ge.toFixed(4),drivelineEff:+ce().toFixed(4),dt_s:+F.toFixed(4),RPM0:+se.toFixed(0),DSRPM0:+Le.toFixed(2)});const nt=Qo(ge(i.s_ft),i.v_fps,Ne);let st,$t,cr;if(((Kr=M.pmi)==null?void 0:Kr.engine_flywheel_clutch)!==void 0)st=M.pmi.engine_flywheel_clutch,$t=M.pmi.transmission_driveshaft??0,cr=M.pmi.tires_wheels_ringgear??0;else{st=500/120;const ke=(X==null?void 0:X.length)??5;$t=m?ke*st/50:(ke-1)*st/10,cr=2*(1.15*.8*(.08*E*(M.tireWidthIn??17))*Math.pow(E/2,2)/386)}const co=Jo(cr,$t,fe??3.73,qt),Ht=Ko(se,U,F,st,m),Lt=Xo(Le,nt,F,co);x<=12&&typeof console<"u"&&console.log&&console.log("[PMI_CALC]",{step:x,EngRPM:+U.toFixed(0),RPM0:+se.toFixed(0),RPM_delta:+(U-se).toFixed(0),DSRPM:+nt.toFixed(2),DSRPM0:+Le.toFixed(2),DSRPM_delta:+(nt-Le).toFixed(2),enginePMI:+st.toFixed(3),chassisPMI:+co.toFixed(3),HPEngPMI:+Ht.toFixed(1),HPChasPMI:+Lt.toFixed(1)}),se=U,Le=nt,mt+=Ht*550*F,v+=Lt*550*F;let Nt,Xe;const ao=ge(i.s_ft);if(r){Nt=H.mul(H.sub(T(O),T(Ht)),T(me)),Xe=Nt;const Dt=H.mul(H.mul(T(Xe),T(Ge)),T(ce())),ke=H.sub(Dt,T(Lt)),je=H.div(ke,T(ao));Xe=H.sub(je,T(ee))}else Nt=(O-Ht)*me,Xe=Nt,Xe=(Xe*Ge*ce()-Lt)/ao-ee;const fo=Xe;be=r?H.div(H.mul(H.mul(T(550),T(w)),T(Xe)),T(M.weightLb)):550*w*Xe/M.weightLb;let ar=cn(be,i.v_fps);if(F>0&&F<=.01&&x>1){const Dt=ar/w,ke=W/w;let je=(Dt-ke)/F;if(je<Tt){je=Tt;const Ut=ke+je*F;ar=Ut*w,be=Ut*w*i.v_fps}if(je>St){je=St;const Ut=ke+je*F;ar=Ut*w,be=Ut*w*i.v_fps}}const Er=ln(ar,Fe,Ke);z=Er.AGS_ftps2,be=be*Er.PQWT_scale;const Fs=Er.slip;z=dn(z,Fe,Ke,Fe);const uo=z/w;uo>Se&&(Se=uo);const _o=W/w;if(_o>0&&x>1&&(F=an(Ve,Se,_o)),x<=12&&typeof console<"u"&&console.log&&console.log("[CONSOLIDATED_ROW]",{step:x,v_ftps:+i.v_fps.toFixed(3),EngRPM:+U.toFixed(0),wheelRPM:+Pr.toFixed(2),ClutchSlip:+me.toFixed(4),HPSave:+O.toFixed(1),HPEngPMI:+Ht.toFixed(1),HPChasPMI:+Lt.toFixed(1),DragHP:+ee.toFixed(2),HP_afterL1:+Nt.toFixed(1),HP_afterL2:+fo.toFixed(1),PQWT:+be.toFixed(1),AMin:+Fe.toFixed(3),AMax:+Ke.toFixed(3),AGS_applied:+z.toFixed(3)}),x<=20&&typeof console<"u"&&console.log&&console.log("[AERO_TRACE]",{step:x,v_fps:+vt.toFixed(6),rho_slug_per_ft3:+le.toFixed(6),q_psf:+pt.toFixed(3),F_drag_lbf:+Vt.toFixed(2),F_lift_up_lbf:+lr.toFixed(2),normal_lbf:+Rr.toFixed(2),F_roll_lbf:+Qe.toFixed(2),AMin_ftps2:+Fe.toFixed(3),AMax_ftps2:+Ke.toFixed(3),AGS_ftps2:+z.toFixed(3)}),x<=10&&typeof console<"u"&&console.debug){const Dt=z/w,ke=qt*(fe??3.73);console.debug("[STEP]",{step:x,phase:nr?"PINNED":"HP",v_fps:i.v_fps.toFixed(6),EngRPM:Ct.toFixed(0),LockRPM:rt.toFixed(2),slipRPM:b.toFixed(0),lockThreshold:to.toFixed(0),rpmIsPinned:nr,clutchSlip:me.toFixed(6),gear:i.gearIdx+1,GRxFD:ke.toFixed(3),tireDia_eff_in:De.toFixed(2),tireGrowth:A.growth.toFixed(4),tireSlip:ge(i.s_ft).toFixed(4),RWTdyn_lbf:yt.toFixed(1),RWTfront_lbf:Bt.front_weight_lbf.toFixed(1),wheelieBar_lbf:Bt.wheelie_bar_weight_lbf.toFixed(1),rho_slug_ft3:le.toFixed(6),dragHP:ee.toFixed(2),...g?{converterWork:or.toFixed(4),converterSlipRatio:zr.toFixed(4),converterZStall:eo.toFixed(0)}:{},HP_engine:O.toFixed(1),HPEngPMI:Ht.toFixed(1),HPChasPMI:Lt.toFixed(1),HP_afterLine1:Nt.toFixed(1),HP_afterLine2:fo.toFixed(1),AGS_g:Dt.toFixed(4),AGS_ftps2:z.toFixed(4),AMin_ftps2:Fe.toFixed(4),AMax_ftps2:Ke.toFixed(4),SLIP:Fs})}}W=z;const oo=fr(U,d);At+=oo*550*F;const no=i.v_fps*F;ht+=Mt*no,dt+=Qe*no;const ms=1-Ge,ps=1-ce(),Ms=ms+ps;gt+=oo*550*F*Ms;const Ps=Ae(i.v_fps,0),Ts=Ae(i.s_ft,0),Ss=Ae(z,Fe),so=Ae(be,0),ot=sn(Ps,Ts,F,so);if(x<=12&&typeof console<"u"&&console.log&&console.log("[INTEGRATED]",{step:x,Vel_next:+ot.Vel_ftps.toFixed(3),Dist_next:+ot.Dist_ft.toFixed(6)}),!Number.isFinite(ot.Vel_ftps)||!Number.isFinite(ot.Dist_ft))throw new Error(`NaN in state @ step=${x} v=${ot.Vel_ftps} dist=${ot.Dist_ft} AGS=${Ss} PQWT=${so}`);if(i.v_fps=ot.Vel_ftps,i.s_ft=ot.Dist_ft,i.t_s=i.t_s+F,!Number.isFinite(i.v_fps)||!Number.isFinite(i.s_ft)||!Number.isFinite(z))throw new Error(`NaN in state @ step=${x} v=${i.v_fps} dist=${i.s_ft} AGS=${z}`);if(q=z/w,i.s_ft>=te){re="DISTANCE";break}if(i.t_s>=_e){re="TIME_CAP";break}const io=(X==null?void 0:X.length)??1,Rs=(ue??[])[i.gearIdx]??0,lo=r?tn(U,Rs,i.gearIdx,io-1):Zo(i.gearIdx,io,U,ue??[]);let br=!1;if(r)br=lo;else{const G=zo(kt,lo);kt=G.newState,br=G.executeShift}if(br){const G=i.gearIdx,O=U;i.gearIdx++;const ee=en(m);N=ee,$+=ee,typeof console<"u"&&console.debug&&console.debug("[SHIFT]",{step:x,t_s:i.t_s.toFixed(4),v_fps:i.v_fps.toFixed(2),from_gear:G+1,to_gear:i.gearIdx+1,EngRPM_before:O.toFixed(0),LockRPM:rt.toFixed(0),dwell_s:ee.toFixed(3)})}for(!ve&&i.s_ft>=Te&&(ve=!0,ne=i.t_s),ye===0&&i.s_ft>=594&&(ye=i.t_s),He===0&&i.s_ft>=1254&&(He=i.t_s);et<ft.length&&i.s_ft>=ft[et];){const G=ft[et],O=ve?i.t_s-ne:0,ee=i.v_fps*ae;Re.push({d_ft:G,t_s:O,v_mph:ee}),et++}if(i.t_s>=oe){const O=(i.v_fps-Be)/F/Do;bt.push({t_s:i.t_s,v_mph:i.v_fps*ae,a_g:O,s_ft:i.s_ft,rpm:i.rpm,gear:i.gearIdx+1}),oe+=ze,Be=i.v_fps}}i.t_s>=_e&&J.push("max_time_exceeded");const xt=ve?i.t_s-ne:i.t_s,zt=i.v_fps*ae;let pr,Mr;if(ye>0&&i.t_s>ye){const D=i.t_s-ye;D>0&&(pr=ae*66/D)}if(He>0&&i.t_s>He){const D=i.t_s-He;D>0&&(Mr=ae*66/D)}de=.5*Ft*i.v_fps*i.v_fps,re||(re="SAFETY"),typeof console<"u"&&console.debug&&console.debug("[RSACLASSIC END]",{reason:re,t_s:i.t_s,steps:x,d_ft:i.s_ft,target_ft:te,totalShiftDwell_s:$.toFixed(3)}),typeof console<"u"&&console.warn&&re!=="DISTANCE"&&console.warn("Terminated without crossing finish:",{reason:re,t_s:i.t_s,d_ft:i.s_ft,target_ft:te}),(Re.length===0||Re[Re.length-1].d_ft!==te)&&Re.push({d_ft:te,t_s:xt,v_mph:zt});const er={};pr!==void 0&&(er.e660_mph=pr),Mr!==void 0&&(er.q1320_mph=Mr);{const A=At,D=ht+dt+gt+mt+v,Ne=de+Q,De=A-D-Ne;console.log(`
=== ENERGY SUMMARY: ${M.name??"Unknown"} ===`),console.log(`ET: ${xt.toFixed(3)}s, Trap MPH: ${zt.toFixed(1)}`),console.log(`
Energy In:`),console.log(`  Engine:           ${(At/1e3).toFixed(1)} k-ft-lb`),console.log(`
Energy Out:`),console.log(`  Aero Drag:        ${(ht/1e3).toFixed(1)} k-ft-lb (${(100*ht/A).toFixed(1)}%)`),console.log(`  Rolling Resist:   ${(dt/1e3).toFixed(1)} k-ft-lb (${(100*dt/A).toFixed(1)}%)`),console.log(`  Driveline Loss:   ${(gt/1e3).toFixed(1)} k-ft-lb (${(100*gt/A).toFixed(1)}%)`),console.log(`  Engine PMI:       ${(mt/1e3).toFixed(1)} k-ft-lb (${(100*mt/A).toFixed(1)}%)`),console.log(`  Chassis PMI:      ${(v/1e3).toFixed(1)} k-ft-lb (${(100*v/A).toFixed(1)}%)`),console.log(`  Total Losses:     ${(D/1e3).toFixed(1)} k-ft-lb (${(100*D/A).toFixed(1)}%)`),console.log(`
Final Kinetic Energy:`),console.log(`  Translational:    ${(de/1e3).toFixed(1)} k-ft-lb (${(100*de/A).toFixed(1)}%)`),console.log(`  Rotational:       ${(Q/1e3).toFixed(1)} k-ft-lb (${(100*Q/A).toFixed(1)}%)`),console.log(`  Total Kinetic:    ${(Ne/1e3).toFixed(1)} k-ft-lb (${(100*Ne/A).toFixed(1)}%)`),console.log(`
Energy Balance:     ${(De/1e3).toFixed(1)} k-ft-lb (${(100*De/A).toFixed(1)}% error)`),console.log(`===
`)}const Y={et_s:r?wr(xt,3):xt,mph:r?wr(zt,2):zt,timeslip:Re,traces:bt.length>0?bt:void 0,meta:{model:"RSACLASSIC",steps:Math.floor(i.t_s/F),warnings:J,windowMPH:Object.keys(er).length>0?er:void 0,converter:g&&!P?{used:!0,avgTR:Je>0?$e/Je:1,avgETA:Je>0?Ue/Je:1,avgSR:Je>0?Yt/Je:1,deRateMax:.3,parasiticConst:.05,parasiticQuad:1e-6}:void 0,clutch:P?{used:!0,minC:ut,lockupAt_ft:Zt}:void 0,rollout:{rolloutIn:Pe??12,t_roll_s:ne},fuel:_t?{type:_t,minScale:Et,maxScale:wt}:void 0,vb6:{dt_s:F,trapMode:"time",windowsFt:{eighth:{start:594,end:660,distance:66},quarter:{start:1254,end:1320,distance:66}},timeslipPoints:[60,330,660,1e3,1320],rolloutBehavior:"ET clock starts after rollout distance (TIMESLIP.FRM:1380)"},termination:{reason:re,steps:x,t_s:i.t_s,target_ft:te}}};return console.log("[RSACLASSIC] done",{et_s:+(((Xr=(tr=Y==null?void 0:Y.et_s)==null?void 0:tr.toFixed)==null?void 0:Xr.call(tr,4))??(Y==null?void 0:Y.et_s)),mph:+(((jr=(rr=Y==null?void 0:Y.mph)==null?void 0:rr.toFixed)==null?void 0:jr.call(rr,1))??(Y==null?void 0:Y.mph)),steps:((Zr=(Yr=Y==null?void 0:Y.meta)==null?void 0:Yr.termination)==null?void 0:Zr.steps)??x,wallMs:Date.now()-o}),Y}}const qr=new mn;function gr(e,t,r,o,s){let n=0;for(n=0;n<r-1&&!(s<=e[n+1]);n++);n>=r-1&&(n=r-2),n<0&&(n=0);const l=e[n],a=e[n+1],f=t[n],c=t[n+1];if(a===l)return f;const u=(s-l)/(a-l);return f+u*(c-f)}function Or(e,t,r,o,s){let n,l;if(s)n=1+4e-5*r,l=n*e*Ye/12;else{const a=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));n=1+a*135e-7*Math.pow(r,1.6);const f=1+a*35e-5*r;f<n&&(n=f),l=(n-.035*Math.abs(o))*e*Ye/12}return{TireGrowth:n,TireCirFt:l}}function Vr(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function Br(e){return e?Io:Lo}function pn(e,t){if(!(t!=null&&t.enabled))return 1;const{activateTime_s:r,duration_s:o,throttlePct:s,rampTime_s:n=0}=t,l=r+o;if(e<r||e>=l)return 1;const a=s/100;if(n>0&&e<r+n){const f=(e-r)/n;return 1-(1-a)*f}if(n>0&&e>l-n){const f=(l-e)/n;return 1-(1-a)*f}return a}function Mn(e,t,r,o,s){const n=e.Gear;let l;const a=e.Gear!==e.PrevGear;if(a)l=t.DTShift,e.PrevGear=e.Gear;else{if(l=o,e.Ags0_g>0&&e.L>1){const F=Math.min(e.AgsMax_g/e.Ags0_g,10);l=o*Math.pow(F,4)}l>.1&&(l=.1)}let f=0;const c=e.time_s-e.Time0_s;c>0&&(f=(e.AGS_g-e.Ags0_g)/c),f<Tt&&(f=Tt),f>St&&(f=St),e.Vel0_ftps=e.Vel_ftps,e.Ags0_g=e.AGS_g,e.Time0_s=e.time_s,e.Dist0_ft=e.Dist_ft,e.RPM0=e.EngRPM,e.DSRPM0=e.DSRPM,e.RPM0===t.LaunchRPM&&e.Time0_s===0&&(e.RPM0=t.Stall,t.LaunchRPM<t.Stall&&(e.Time0_s=t.EnginePMI*(t.Stall-t.LaunchRPM)/25e4));const u=Or(t.TireDia_in,t.TireWidth_in,e.Vel_ftps,e.Ags0_g,r.isLandSpeed);e.TireGrowth=u.TireGrowth,e.TireCirFt=u.TireCirFt;let _;r.isLandSpeed?_=1.01+(r.TractionIndex-1)*.01:_=1.02+(.005*(r.TractionIndex-1)+3*(r.TrackTempEffect-1))*(1-Math.pow(e.Dist0_ft/1320,2));const d=t.TGR[n-1]??1,p=t.TiresPMI+t.TransPMI*Math.pow(t.GearRatio,2)*Math.pow(d,2);let h=e.Vel0_ftps+e.Ags0_g*w*l+f*w*l*l/2;h<e.Vel0_ftps*.9&&e.Vel0_ftps>100&&(h=e.Vel0_ftps),h<0&&(h=0);const P=t.ShiftRPM[n-1]??9e3;if(!a&&(l<.005&&(l=.005),l>.05&&(l=.05),h=e.Vel0_ftps+e.Ags0_g*w*l+f*w*l*l/2,e.Vel0_ftps>0&&e.RPM0>t.Stall&&n<t.NGR)){const F=e.Vel0_ftps*(P+5)/e.RPM0;h>F&&(h=F,e.Ags0_g*w>0&&(l=(h-e.Vel0_ftps)/(e.Ags0_g*w)))}const g=h*h-e.Vel0_ftps*e.Vel0_ftps,m=_*h*60/e.TireCirFt,R=m*t.GearRatio*d;let b=t.Slippage*R,C,y=t.Stall,I=0;t.isClutch?(b<t.Stall&&(n===1||!t.LockUp)&&(b=t.Stall),C=R/b):n===1||!t.LockUp?(y=t.Stall,I=t.Slippage*R/y,e.L>2&&(I>.6&&(y=y*(1+(t.Slippage-1)*(I-.6)/(1/t.Slippage-.6))),I=t.Slippage*R/y),C=1/t.Slippage,b<y&&(b=y,C=(t.TorqueMult-(t.TorqueMult-1)*I)*R/y)):(b=1.005*R,C=R/b),C>1&&(C=1);let S=gr(t.xrpm,t.yhp,t.NHP,1,b);S=t.HPTQMult*S/r.hpc,t.RevLimiterRPM>0&&b>=t.RevLimiterRPM&&(S=S*.05);const K=pn(e.time_s,s);S=S*K;const xe=S;S=S*C;const We=Math.sqrt(h*h+2*h*(r.WindSpeed_mph/Kt)*Math.cos(Ye*r.WindAngle_deg/180)+Math.pow(r.WindSpeed_mph/Kt,2)),it=Math.sign(We)*r.rho*Math.pow(Math.abs(We),2)/(2*w);let M;t.BodyStyle===8?M=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*t.TireWidth_in/144:M=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*(2*t.TireWidth_in)/144;const V=t.Weight_lbf+t.LiftCoef*M*it,lt=r.isLandSpeed?Cr:dr,J=r.isLandSpeed?xo:Ao,te=r.isLandSpeed?Co:Ho,Ie=(lt-e.Dist0_ft/1320*J)*V+1e-4*V*(Kt*h)+t.DragCoef*M*it,Z=Ie*h/550,fe=12*e.TireCirFt/(2*Ye),X=(e.Ags0_g*t.Weight_lbf*(t.YCG_in-fe+te/t.Efficiency*fe)+Ie*t.YCG_in)/t.Wheelbase_in;let j=t.StaticFWt_lbf-X,ue=0;j<0&&(ue=-j*t.Wheelbase_in/64,j=0);let Me=V-j-ue;Me<0&&(Me=t.Weight_lbf);const Ze=Vr(r.TractionIndex,r.TrackTempEffect),ct=Br(r.isLandSpeed);let Oe=Ze*ct*t.TireDia_in*(t.TireWidth_in+1)*(.92+.08*Math.pow(Me/1900,2.15));t.BodyStyle===8&&(Oe=.5*Oe);const E=(Oe/e.TireGrowth-Ie)/t.Weight_lbf,Pe=t.TGEff[n-1]??.99;S=S*Pe*t.Efficiency/_;const ie=S;S=S-Z;let k=550*w*S/t.Weight_lbf,L=k/(h*w),le=!1;L>E&&(le=!0,k=k*(E-(L-E))/L,L=E-(L-E)),L<pe&&(L=pe,k=pe*w*h);let Te=Math.max(0,g)/(2*k)+e.Time0_s;const re=r.isLandSpeed?vo:Hr,x=r.isLandSpeed?yo:Lr;let _e=t.EnginePMI*b*(b-e.RPM0);_e<0&&(t.isClutch?_e=re*_e:_e=x*_e);let ze=p*m*(m-e.DSRPM0);ze<0&&(ze=0);let at=0,he=0,Ce=0;for(Ce=1;Ce<=12;Ce++){const F=Te-e.Time0_s;if(F<=0)break;const i=Math.pow(2*Ye/60,2)/(12*550*F);at=_e*i,he=ze*i,S=(xe-at)*C,S=(S*Pe*t.Efficiency-he)/_-Z,k=550*w*S/t.Weight_lbf,L=k/(h*w);let oe=0;F!==0&&(oe=(L-e.Ags0_g)/F),oe<Tt&&(oe=Tt,L=e.Ags0_g+oe*F,k=L*w*h),oe>St&&(oe=St,L=e.Ags0_g+oe*F,k=L*w*h),le=!1,L>E&&(le=!0,k=k*(E-(L-E))/L,L=E-(L-E)),L<pe&&(L=pe,k=pe*w*h);const Re=Math.max(0,g)/(2*k)+e.Time0_s,ve=Re-e.Time0_s;if(Ce===12||Math.abs(100*(ve-F)/ve)<=.01){Te=Re;break}let ne=S/xe;ne<vr&&(ne=vr),ne>yr&&(ne=yr),Te=e.Time0_s+F+ne*(ve-F)}const Ve=Te-e.Time0_s;let Se;if(k<.1||Ve<=0){const F=(e.Vel0_ftps+h)/2;Se=e.Dist0_ft+Math.max(0,F*Math.abs(Ve))}else{const F=Math.pow(e.Vel0_ftps,3),i=2*k*Ve+e.Vel0_ftps*e.Vel0_ftps;if(i<0){const oe=(e.Vel0_ftps+h)/2;Se=e.Dist0_ft+oe*Ve}else Se=(Math.pow(i,1.5)-F)/(3*k)+e.Dist0_ft}return e.L+=1,e.time_s=Te,e.Vel_ftps=h,e.Dist_ft=Se,e.AGS_g=L,e.EngRPM=b,e.DSRPM=m,e.SLIP=le,{TimeStep_s:l,VelSqrd:g,LockRPM:R,ClutchSlip:C,zStall:y,SlipRatio:I,TireSlip:_,WindFPS:We,q:it,RefArea2_ft2:M,DownForce_lbf:V,DragForce_lbf:Ie,DragHP:Z,DynamicFWT_lbf:j,DynamicRWT_lbf:Me,WheelBarWT_lbf:ue,CRTF:Oe,AMax_g:E,ChassisPMI:p,EngAccHP:_e,ChasAccHP:ze,HPSave:xe,HPAtWheels:ie,HP:S,PQWT:k,iterations:Ce}}function Pn(e,t,r){const o=Or(e.TireDia_in,e.TireWidth_in,0,0,t.isLandSpeed),s=gr(e.xrpm,e.yhp,e.NHP,1,r);let a=5252*(e.HPTQMult*s/t.hpc)/r;const f=e.TGR[0]??1,c=e.TGEff[0]??.99;a=a*e.TorqueMult*f*c;const u=t.isLandSpeed?Cr:dr,_=t.WindSpeed_mph/Kt,d=Math.sign(_)*t.rho*Math.pow(Math.abs(_),2)/(2*w),p=u*e.Weight_lbf+e.DragCoef*e.RefArea_ft2*d;let h;t.isLandSpeed?h=1.01+(t.TractionIndex-1)*.01:h=1.02+(t.TractionIndex-1)*.005+(t.TrackTempEffect-1)*3;const P=a*e.GearRatio*e.Efficiency/(h*e.TireDia_in/24)-p;let m=(e.isClutch?.88:.96)*P/e.Weight_lbf;const b=e.Weight_lbf-e.StaticFWt_lbf,C=Vr(t.TractionIndex,t.TrackTempEffect),y=Br(t.isLandSpeed);let I=C*y*e.TireDia_in*(e.TireWidth_in+1)*(.92+.08*Math.pow(b/1900,2.15));e.BodyStyle===8&&(I=.5*I);const S=(I-p)/e.Weight_lbf;return m>S&&(m=S),m<pe&&(m=pe),{L:1,time_s:0,Vel_ftps:.001,Dist_ft:0,AGS_g:m,EngRPM:r,DSRPM:0,Gear:1,SLIP:!1,Vel0_ftps:0,Ags0_g:m,Time0_s:0,Dist0_ft:0,RPM0:r,DSRPM0:0,AgsMax_g:m,TireGrowth:o.TireGrowth,TireCirFt:o.TireCirFt,ShiftFlag:0,PrevGear:1}}function Tn(e,t,r,o){let s=e*.11*Math.pow(t*r/o,-.3333333333333333);return s=s/15,s<.005&&(s=.005),s}function $r(e,t,r){let o=0,s=0,n=r-1;const l=e[0],a=e[r-1];if(t<=l)return o=1,n=1,{KBOTM:s,KTOP:n,JJ:o};if(t>=a)return o=1,s=r-2,n=r-1,{KBOTM:s,KTOP:n,JJ:o};for(;n-s>1;){const f=Math.floor((s+n)/2);t<e[f]?n=f:s=f}return{KBOTM:s,KTOP:n,JJ:o}}function mr(e,t,r,o,s){if(r<=0)return 0;if(r===1)return t[0];let n=0,l=1;if(r===2)n=0,l=1;else{const f=$r(e,s,r);n=f.KBOTM,l=f.KTOP;const c=f.JJ;if(n===l)return t[n];c!==1&&o>1&&(l=l+1,(o>=3||l>r-1)&&(l>r-1&&(l=r-1),n=n-1,n<0&&(n=0)))}let a=0;for(let f=n;f<=l;f++){let c=1;const u=e[f];for(let _=n;_<=l;_++)if(_===f)c=c*t[f];else{const d=e[_];c=c*(s-d)/(u-d)}a=a+c}return a}function Sn(e,t,r,o,s,n,l,a,f){const c=$r(t,f,s);let u=c.KBOTM,_=c.KTOP;c.JJ;const d=[],p=[];for(let g=u;g<=_;g++){const m=[];for(let b=0;b<o;b++)m.push(r[g*o+b]);const R=mr(e,m,o,n,a);d.push(R),p.push(t[g])}const h=_-u+1,P=Math.min(l,h);return mr(p,d,h,P,f)}function Rn(e){switch(e){case 1:case 2:return 1;case 3:case 4:return 1.08;case 5:return 5;case 6:return 2*1;case 7:case 9:return 2.5*1.08;case 8:return 1.5*5.5;default:return 1}}function Fn(e){return e<=5}const bn=[.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],En=[.7,1.2,1.7,2.5,3.4],wn=[.53,.975,1.098,1.13,1.152,1.16,1.153,1.122,1.086,1.045,1,.938,.865,.795,.72,.63,.365,.87,1.018,1.066,1.11,1.129,1.132,1.11,1.079,1.042,1,.935,.855,.762,.66,.54,.24,.79,.96,1.023,1.08,1.106,1.117,1.102,1.074,1.04,1,.932,.845,.736,.612,.474,.1,.7,.894,.972,1.04,1.08,1.096,1.09,1.069,1.037,1,.928,.83,.698,.55,.39,0,.63,.84,.924,1,1.055,1.079,1.082,1.064,1.035,1,.923,.815,.662,.49,.31],Ur=[0,.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],Rt=[0,.7,1.2,1.7,2.5,3.4],An=[0,0,.61,.8,.9,.98,1.035,1.055,1.06,1.05,1.03,1,.93,.85,.765,.67,.58];function xn(e,t){return Sn(bn,En,wn,16,5,1,1,e,t)}function In(e){const{peakHP:t,peakRPM:r,displacement_cid:o,fuelSystem:s}=e,n=ur*t/r,l=Rn(s);let a=t/o/l;s<=5?a<Rt[1]&&(a=Rt[1]):a<Rt[2]&&(a=Rt[2]),a>Rt[5]&&(a=Rt[5]);const f=[0],c=[0],u=[0],_=16;for(let d=1;d<=_;d++){f[d]=Ur[d]*r;let p;s===8?p=An[d]*n:p=xn(Ur[d],a)*n,c[d]=f[d]*p/ur,u[d]=p}return{xrpm:f,yhp:c,ztq:u,NHP:_}}function Cn(e){const t=[],r=[];for(let o=1;o<=e.NHP;o++)t.push(e.xrpm[o]),r.push(e.yhp[o]);return{rpm:t,hp:r}}function vn(e){return e>800?1:8}function yn(e){switch(e){case 1:return{dragCoef:.66,liftCoef:.8,overhang_in:30};case 2:return{dragCoef:.5,liftCoef:.2,overhang_in:30};case 3:return{dragCoef:.52,liftCoef:.8,overhang_in:40};case 4:return{dragCoef:.52,liftCoef:.1,overhang_in:30};case 5:return{dragCoef:.28,liftCoef:.1,overhang_in:30};case 6:return{dragCoef:.4,liftCoef:.1,overhang_in:24};case 7:return{dragCoef:.46,liftCoef:.1,overhang_in:18};case 8:return{dragCoef:.54,liftCoef:.1,overhang_in:12};default:return{dragCoef:.5,liftCoef:.2,overhang_in:30}}}function Hn(e,t){const r=[];if(t){const o=e>=3?.985:.99;for(let s=1;s<=e;s++)r.push(o-(e-s)*2*.005)}else for(let s=1;s<=e;s++)r.push(.99-(e-s)*.005);return r}function Ln(e,t,r,o,s,n,l){let a,f,c;return Fn(t)?a=e/120:a=e/90,r?f=(o-1)*a/10:f=o*a/50,c=2*(1.15*.8*(.08*s*n)*Math.pow(s/2,2)/386),l===8&&(a=e/240,f=f/(240/120),c=c/2),{enginePMI:a,transPMI:f,tiresPMI:c}}function Nn(e){return e===8?.985:.97}function Dn(e){return 1.0025+e/1e6}function Gn(e){const t=we[e];return t?t.lengthFt:e==="EIGHTH"?660:1320}function kn(e){const t=Ee[e];return t||(e==="EIGHTH"?Ee.EIGHTH:Ee.QUARTER)}function Wn(e){if(!e)return 1;const t=e.toUpperCase();return t==="GAS+CARB"||t==="GASOLINE+CARBURETOR"?1:t==="GAS+INJECT"||t==="GASOLINE+FUEL INJECTION"?2:t==="METHANOL+CARB"||t==="METHANOL+CARBURETOR"?3:t==="METHANOL+INJECT"||t==="METHANOL+FUEL INJECTION"?4:t==="NITRO+INJECT"||t==="NITROMETHANE+FUEL INJECTION"?5:t==="GAS+SUPERCHARGED"||t==="GASOLINE+SUPERCHARGED"?6:t==="METHANOL+SUPERCHARGED"?7:t==="NITRO+SUPERCHARGED"||t==="NITROMETHANE+SUPERCHARGED"?8:t==="ELECTRIC"?9:t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function qn(e){const t=e.vehicle,r=e.engine??t.engine,o=(r==null?void 0:r.hpCurve)??(r==null?void 0:r.torqueCurve)??t.torqueCurve??t.hpCurve??[],s=[],n=[];for(const u of o)Array.isArray(u)?(s.push(u[0]),n.push(u[1])):u&&typeof u=="object"&&(s.push(u.rpm),u.hp!==void 0?n.push(u.hp):u.torque!==void 0?n.push(u.torque*u.rpm/5252):u.tq_lbft!==void 0&&n.push(u.tq_lbft*u.rpm/5252));if(s.length>=2)return{xrpm:s,yhp:n,NHP:s.length,isQuarterJr:!1};const l=Number(t.powerHP??t.peakHP),a=Number(t.rpmAtPeakHP??t.peakRPM??6500),f=Number(t.displacement_cid??t.displacementCID??350),c=e.fuelSystem??t.fuelSystem??1;if(Number.isFinite(l)&&l>0){const u=In({peakHP:l,peakRPM:a,displacement_cid:f,fuelSystem:c}),{rpm:_,hp:d}=Cn(u);return{xrpm:_,yhp:d,NHP:u.NHP,isQuarterJr:!0,quarterJrParams:{peakHP:l,rpmAtPeakHP:a,displacement_cid:f,fuelSystem:c}}}return{xrpm:[4e3,6500],yhp:[100,150],NHP:2,isQuarterJr:!1}}function On(e){const t=Math.abs(100-e);let r;return e>100?r=1+25e-7*Math.pow(t,2.5):r=1+2e-6*Math.pow(t,2.5),r>1.04&&(r=1.04),r}function Vn(e){var Zt,_t,Et,wt,At,ht,dt,gt,mt;const t=[],r=[],o=e.vehicle,s=e.env,n=e.raceLength??"QUARTER",l=e.raceLengthFt??Gn(n),a=((Zt=we[n])==null?void 0:Zt.category)==="landspeed",f=o.rolloutIn??9,c=o.overhangIn??0;let u=2*f;u<24&&(u=24);let _=(c+.25*u)/12;const d=.5*u/12;_<d&&(_=d);const p=f/12,h=e.drivetrain??o.drivetrain,P=(h==null?void 0:h.clutch)??e.clutch??o.clutch,g=(h==null?void 0:h.converter)??e.converter??o.converter,m=e.engine??o.engine,R=e.pmi??o.pmi,b=e.throttleStop,C=b!=null&&b.enabled?{enabled:!0,activateTime_s:b.activateTime_s,duration_s:b.duration_s,throttlePct:b.throttlePct,rampTime_s:b.rampTime_s}:void 0,y=o.transmissionType??e.transmissionType,I=y==="clutch"?!0:y==="converter"?!1:!g||P&&!g,S=e.fuel,K=typeof S=="string"?S:(S==null?void 0:S.fuelType)??(S==null?void 0:S.fuelSystem)??(S==null?void 0:S.type)??e.fuelType??e.fuelSystem??o.fuelSystem,xe=Wn(K),We=Nr({barometer_inHg:s.barometerInHg??29.92,temperature_F:s.temperatureF??59,relHumidity_pct:s.humidityPct??50,elevation_ft:s.elevation??0,fuelSystem:xe}),it=We.rho_slug_per_ft3*w,M=We.hpc,V=qn(e),{xrpm:lt,yhp:J,NHP:te,isQuarterJr:qe,quarterJrParams:Ie}=V;te<2&&t.push("HP curve has fewer than 2 points"),qe&&t.push("Using QuarterJr mode (synthetic HP curve from peak HP)");const Z=(h==null?void 0:h.gearRatios)??o.gearRatios??[2.5,1.8,1.4,1.1,1],fe=(h==null?void 0:h.finalDriveRatio)??o.finalDrive??o.rearGear??3.73,X=Z.length,j=o.tire,ue=(j==null?void 0:j.diameter_in)??o.tireDiaIn??32,Me=(j==null?void 0:j.width_in)??o.tireWidthIn??17,Ze=o.bodyStyle??vn(o.weightLb);let ct,Oe,E,Pe,ie,k,L,le,Ft,Te,re,x;if(qe&&Ie){const{displacement_cid:v,fuelSystem:de}=Ie;ct=Hn(X,!I);const Q=o.shiftRPM??(h==null?void 0:h.shiftRPM)??7e3;Oe=Z.map(()=>Q);const q=(P==null?void 0:P.slipRPM)??(g==null?void 0:g.stallRPM)??o.slipStallRPM??5e3;if(I)Pe=Dn(q),ie=1,E=q;else{const Gt=(g==null?void 0:g.diameter_in)??(g==null?void 0:g.diameter)??o.converterDiameterIn??o.converterDia_in??10;let se;if(q>220){E=q;const N=mr(lt,J,te,1,E)*(ur/E)/M;se=E/1e3*(E/N)}else se=q,E=q;const Le=se/(200*Math.pow(7/Gt,4));Pe=1.01+Le/20+se/8e3,ie=2.633-Math.pow(Le,.3)-se/1500,ie<1&&(ie=1),ie>2&&(ie=2)}Ft=Nn(Ze);const W=yn(Ze);Te=W.dragCoef,re=W.liftCoef,x=W.overhang_in;const B=Ln(v,de,!I,X,ue,Me,Ze);k=B.enginePMI,L=B.transPMI,le=B.tiresPMI}else{ct=(h==null?void 0:h.perGearEff)??o.gearEfficiencies??null??Z.map(()=>.99),Oe=(h==null?void 0:h.shiftRPMs)??(h==null?void 0:h.shiftsRPM)??o.shiftRPMs??Z.map(()=>7e3);const de=(P==null?void 0:P.slipRPM)??o.clutchSlipRPM??7200,Q=(g==null?void 0:g.stallRPM)??o.converterStallRPM??5500;E=I?de:Q;const q=(P==null?void 0:P.slippageFactor)??(P==null?void 0:P.slippage)??(P==null?void 0:P.slipRatio)??o.clutchSlippage??1.0025,W=(g==null?void 0:g.slippageFactor)??(g==null?void 0:g.slippage)??(g==null?void 0:g.slipRatio)??o.converterSlippage??1.06;Pe=I?q:W,ie=I?1:(g==null?void 0:g.torqueMult)??(g==null?void 0:g.torqueMultiplier)??o.converterTorqueMult??2.2,k=(R==null?void 0:R.engine_flywheel_clutch)??o.enginePMI??(m==null?void 0:m.enginePMI)??4,le=(R==null?void 0:R.tires_wheels_ringgear)??o.tiresPMI??(m==null?void 0:m.tiresPMI)??.5,L=(R==null?void 0:R.transmission_driveshaft)??o.transPMI??(m==null?void 0:m.transPMI)??.2,Ft=(h==null?void 0:h.overallEfficiency)??o.transEfficiency??.97;const B=e.aero??o.aero;Te=(B==null?void 0:B.Cd)??(B==null?void 0:B.cd)??o.cd??.35,re=(B==null?void 0:B.Cl)??(B==null?void 0:B.cl)??o.liftCoeff??0,x=c}const _e=o.cgHeight_in??o.cgHeightIn??ue/2+3.75,ze=o.staticFrontWeight_lb??o.staticFrontWeightLb??o.weightLb*.38,at=qe?x:c,he={Weight_lbf:o.weightLb,Wheelbase_in:o.wheelbaseIn??100,YCG_in:_e,StaticFWt_lbf:ze,TireDia_in:ue,TireWidth_in:Me,Rollout_in:o.rolloutIn??12,GearRatio:fe,TGR:Z,TGEff:ct,Efficiency:Ft,DTShift:I?.2:.25,Slippage:Pe,TorqueMult:ie,Stall:E,LockUp:(g==null?void 0:g.lockup)??!1,isClutch:I,RefArea_ft2:((_t=e.aero)==null?void 0:_t.frontalArea_ft2)??o.frontalArea_ft2??o.frontalAreaFt2??20,DragCoef:Te,LiftCoef:re,BodyStyle:Ze,EnginePMI:k,TiresPMI:le,TransPMI:L,xrpm:lt,yhp:J,NHP:te,HPTQMult:o.hpTorqueMultiplier??(m==null?void 0:m.hpTqMult)??1,ShiftRPM:Oe,NGR:X,LaunchRPM:I?(P==null?void 0:P.launchRPM)??o.clutchLaunchRPM??E:E,ShiftMode:o.shiftMode??"rpm",ShiftTimes:o.shiftTimes??[],RevLimiterRPM:o.revLimiterRPM??0};if(qe&&at!==c){let v=2*f;v<24&&(v=24),_=(at+.25*v)/12;const de=.5*v/12;_<de&&(_=de)}const Ce=s.trackTempF??100,Ve=a?1:On(Ce),Se={rho:it,hpc:M,TractionIndex:s.tractionIndex??5,TrackTempEffect:Ve,WindSpeed_mph:s.windMph??0,WindAngle_deg:s.windAngleDeg??0,isLandSpeed:a},F=I?(P==null?void 0:P.launchRPM)??E:E,i=Pn(he,Se,F),oe=gr(lt,J,te,1,F),bt=Tn(60,oe,ie,o.weightLb),Re=a?5e4:5e3,ve=a?300:30,ne={iterations:[],convergenceHistory:[]},ft=[],et=kn(n);let ye=0,He=null,Be=null,$e=null;for(let v=0;v<Re&&!(i.Dist_ft-p+_>=l+50||i.time_s>=ve);v++){if(!Number.isFinite(i.Vel_ftps)||!Number.isFinite(i.Dist_ft)||!Number.isFinite(i.AGS_g)){t.push(`NaN detected at step ${v}: Vel=${i.Vel_ftps}, Dist=${i.Dist_ft}, AGS=${i.AGS_g}`);break}const Q=Mn(i,he,Se,bt,C);if(ne.iterations.push(Q.iterations),v<20&&ne.convergenceHistory.push({step:v,iterations:Q.iterations,HPSave:Q.HPSave,HP:Q.HP,PQWT:Q.PQWT,AGS_g:i.AGS_g}),He===null&&i.Dist_ft>=p){const $=(i.Dist_ft-p)/i.Vel_ftps;He=i.time_s-$}const q=Math.max(0,i.Dist_ft-p+_),W=He!==null?i.time_s-He:0,B=he.TGR[i.Gear-1]??1,Gt=(Q.LockRPM??i.EngRPM)/B,se=Q.TireSlip,Le=i.Vel_ftps*se*ae,kt=(C==null?void 0:C.enabled)&&W>=C.activateTime_s&&W<C.activateTime_s+C.duration_s;if(r.push({t_s:W,s_ft:q,v_fps:i.Vel_ftps,v_mph:i.Vel_ftps*ae,a_g:i.AGS_g,rpm:i.EngRPM,dsrpm:Gt,lockRpm:Q.LockRPM,gear:i.Gear,slip:i.SLIP,tireSlip:se,hp:Q.HPAtWheels,dragHp:Q.DragHP,netHp:Q.HP,wheelSpeed_mph:Le,throttleStopActive:kt}),Be===null&&q>=594){const N=r.length>1?((Et=r[r.length-2])==null?void 0:Et.s_ft)??0:0,$=r.length>1?((wt=r[r.length-2])==null?void 0:wt.t_s)??0:0;if(N<594&&q>N){const tt=(594-N)/(q-N);Be=$+tt*(W-$)}else Be=W}if($e===null&&q>=1254){const N=r.length>1?((At=r[r.length-2])==null?void 0:At.s_ft)??0:0,$=r.length>1?((ht=r[r.length-2])==null?void 0:ht.t_s)??0:0;if(N<1254&&q>N){const tt=(1254-N)/(q-N);$e=$+tt*(W-$)}else $e=W}for(;ye<et.length&&q>=et[ye];){const N=et[ye],$=r.length>1?((dt=r[r.length-2])==null?void 0:dt.s_ft)??0:0,tt=r.length>1?((gt=r[r.length-2])==null?void 0:gt.t_s)??0:0;let ce=W;if($<N&&q>$){const xt=(N-$)/(q-$);ce=tt+xt*(W-tt)}let ge;N===660&&Be!==null&&ce>Be?ge=ae*66/(ce-Be):N===1320&&$e!==null&&ce>$e?ge=ae*66/(ce-$e):ge=i.Vel_ftps*ae,ft.push({d_ft:N,t_s:ce,v_mph:ge}),ye++}if(i.ShiftFlag===1)i.ShiftFlag=2,i.Gear++;else if(i.ShiftFlag===2)i.ShiftFlag=0;else if(i.Gear<he.NGR)if((he.ShiftMode??"rpm")==="time"){const $=(mt=he.ShiftTimes)==null?void 0:mt[i.Gear-1];$!==void 0&&i.time_s>=$&&(i.ShiftFlag=1)}else{const $=he.ShiftRPM[i.Gear-1]??7e3;i.EngRPM>=$&&(i.ShiftFlag=1)}}const Ue=ft.find(v=>v.d_ft===l),Yt=(Ue==null?void 0:Ue.t_s)??i.time_s,Je=(Ue==null?void 0:Ue.v_mph)??i.Vel_ftps*ae,ut=r.map(v=>({t_s:v.t_s,s_ft:v.s_ft,v_mph:v.v_mph,v_fps:v.v_fps,a_g:v.a_g,rpm:v.rpm,dsrpm:v.dsrpm,lockRpm:v.lockRpm,gear:v.gear,slip:v.slip,tireSlip:v.tireSlip,hp:v.hp,dragHp:v.dragHp,wheelSpeed_mph:v.wheelSpeed_mph}));return{et_s:Yt,mph:Je,timeslip:ft,traces:ut,meta:{model:"VB6Exact",steps:r.length,warnings:t},vb6Diagnostics:ne}}const Bn="rsa.model.";function $n(e){try{const t=Bn+e,r=localStorage.getItem(t);if(!r)return;const o=JSON.parse(r);if(!o.w||!o.P||typeof o.n!="number"){console.warn(`Invalid model structure for vehicle ${e}`);return}return o}catch(t){console.error(`Failed to load model for vehicle ${e}:`,t);return}}function Un(e,t){if(t.length!==e.w.length)throw new Error(`Feature dimension mismatch: expected ${e.w.length}, got ${t.length}`);let r=0;for(let o=0;o<e.w.length;o++)r+=e.w[o]*t[o];return r}class Jn{constructor(){Jt(this,"id","Blend")}simulate(t){const r=qr.simulate(t),o=t.vehicle.id,s=$n(o);let n=0;const l=[...r.meta.warnings];if(s){const d=[Pt(t.env)/1e3,t.vehicle.weightLb/3e3,t.vehicle.tireDiaIn/30,t.vehicle.rearGear/4,(r.et_s-10)/5];n=Un(s,d)}else l.push("no_learned_model");const a=r.et_s*.8,f=r.et_s*1.2;return{et_s:Math.max(a,Math.min(f,r.et_s+n)),mph:r.mph,timeslip:r.timeslip,traces:r.traces,meta:{model:"Blend",steps:r.meta.steps,warnings:l}}}}const Qn=new Jn;class Kn{constructor(){Jt(this,"id","SimpleV1")}simulate(t){const r=mo({vehicle:t.vehicle,env:t.env,raceLength:t.raceLength});return{et_s:r.baseET_s,mph:r.baseMPH,timeslip:r.timeslip,meta:{model:"SimpleV1",steps:r.timeslip.length,warnings:[]}}}}class Xn{constructor(){Jt(this,"id","VB6Exact")}simulate(t){const r=Vn(t);return{...r,meta:{...r.meta,model:"VB6Exact"}}}}const jn={SimpleV1:new Kn,RSACLASSIC:qr,VB6Exact:new Xn,Blend:Qn};function Jr(e){const t=jn[e];if(!t)throw new Error(`Unknown physics model: ${e}`);return t}function Yn(e){if(e!=null&&e.drivetrain){const t=e.drivetrain;t.shiftsRPM&&!t.shiftRPM&&(t.shiftRPM=t.shiftsRPM),t.overallEfficiency!==void 0&&t.overallEff===void 0&&(t.overallEff=t.overallEfficiency),t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}if(e!=null&&e.vehicle){const t=e.vehicle;t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}return e}function jt(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const o=Number(e.torque)*r/5252*t;return{rpm:r,hp:o}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const o=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:o}}return null}function Zn(e){var o,s,n,l,a,f;if(Array.isArray((o=e==null?void 0:e.engineParams)==null?void 0:o.powerHP)&&e.engineParams.powerHP.length>=2)return e;const t=((s=e==null?void 0:e.fuel)==null?void 0:s.hpTorqueMultiplier)??1;let r=[];if(Array.isArray((n=e==null?void 0:e.vehicle)==null?void 0:n.hpCurve)&&e.vehicle.hpCurve.length>=2&&(r=e.vehicle.hpCurve.map(c=>jt(c,t)).filter(c=>c!==null&&Number.isFinite(c.rpm)&&Number.isFinite(c.hp)).sort((c,u)=>c.rpm-u.rpm)),r.length<2&&Array.isArray(e==null?void 0:e.engineHP)&&e.engineHP.length>=2&&(r=e.engineHP.map(c=>Array.isArray(c)?{rpm:Number(c[0]),hp:Number(c[1])*t}:jt(c,t)).filter(c=>c!==null&&Number.isFinite(c.rpm)&&Number.isFinite(c.hp)).sort((c,u)=>c.rpm-u.rpm)),r.length<2&&Array.isArray((l=e==null?void 0:e.engineParams)==null?void 0:l.torqueCurve)&&e.engineParams.torqueCurve.length>=2&&(r=e.engineParams.torqueCurve.map(c=>jt(c,t)).filter(c=>c!==null&&Number.isFinite(c.rpm)&&Number.isFinite(c.hp)).sort((c,u)=>c.rpm-u.rpm)),r.length<2&&Array.isArray((a=e==null?void 0:e.vehicle)==null?void 0:a.torqueCurve)&&e.vehicle.torqueCurve.length>=2&&(r=e.vehicle.torqueCurve.map(c=>jt(c,t)).filter(c=>c!==null&&Number.isFinite(c.rpm)&&Number.isFinite(c.hp)).sort((c,u)=>c.rpm-u.rpm)),r.length<2){const c=Number((f=e==null?void 0:e.vehicle)==null?void 0:f.powerHP);Number.isFinite(c)&&c>0&&(r=[{rpm:4e3,hp:c*.85*t},{rpm:5e3,hp:c*.92*t},{rpm:6e3,hp:c*.97*t},{rpm:6500,hp:c*1*t},{rpm:7e3,hp:c*.98*t},{rpm:7500,hp:c*.94*t},{rpm:8e3,hp:c*.88*t}])}return r.length>=2&&(e.engineParams={...e.engineParams??{},powerHP:r}),e}function zn(e){Yn(e),Zn(e)}function es(e){var s,n;if(!Array.isArray(e))return"none";const t=(s=e[0])==null?void 0:s.rpm,r=(n=e[e.length-1])==null?void 0:n.rpm;return`n=${e.length},first=${t},last=${r}`}self.onmessage=async e=>{var t,r,o,s,n,l,a,f,c;try{const u=e.data;if(!(u!=null&&u.model)||!(u!=null&&u.payload))throw new Error("Bad worker message");const _=JSON.parse(JSON.stringify(u.payload));if(u.model==="VB6Exact"){console.log("[WORKER:VB6Exact] Running with SimInputs format",{hasVehicle:!!_.vehicle,vehicleName:(t=_.vehicle)==null?void 0:t.name,powerHP:(r=_.vehicle)==null?void 0:r.powerHP,hasHpCurve:!!((o=_.vehicle)!=null&&o.hpCurve),raceLength:_.raceLength});const m=Jr(u.model).simulate(_);self.postMessage({ok:!0,result:m});return}zn(_);const d=(s=_==null?void 0:_.engineParams)==null?void 0:s.powerHP;if(!Array.isArray(d)||d.length<2)throw console.error("[WORKER] bad powerHP",{hpLen:d==null?void 0:d.length,sample:(n=d==null?void 0:d.slice)==null?void 0:n.call(d,0,2)}),new Error("EngineParams must provide either torqueCurve or powerHP");Number.isFinite(_==null?void 0:_.raceLengthFt)||(_.raceLengthFt=(u==null?void 0:u.raceLengthFt)??1320);const p=(_==null?void 0:_.drivetrain)??{};console.log("[WORKER:normalized.input]",{hasEngineParams:!!_.engineParams,hasPowerHP:!!d,raceLengthFt:_.raceLengthFt,hpSummary:es(d),hasClutch:!!p.clutch,hasConverter:!!p.converter,slipRPM:(l=p==null?void 0:p.clutch)==null?void 0:l.slipRPM,stallRPM:(a=p==null?void 0:p.converter)==null?void 0:a.stallRPM});try{_!=null&&_.tuning&&console.debug("[WORKER:TUNING]",!0,_.tuning)}catch{}_.flags===void 0&&(_.flags={}),_.flags.vb6Strict===void 0&&(_.flags.vb6Strict=((c=(f=u.payload)==null?void 0:f.flags)==null?void 0:c.vb6Strict)??!0);const P=Jr(u.model).simulate(_);self.postMessage({ok:!0,result:P})}catch(u){console.error("[WORKER ERROR]",u),self.postMessage({ok:!1,error:String((u==null?void 0:u.message)||u)})}}})();
//# sourceMappingURL=index-D4xADerR.js.map
