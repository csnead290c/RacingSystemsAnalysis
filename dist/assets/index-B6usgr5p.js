var ws=Object.defineProperty;var Is=(we,Ie,Rt)=>Ie in we?ws(we,Ie,{enumerable:!0,configurable:!0,writable:!0,value:Rt}):we[Ie]=Rt;var cr=(we,Ie,Rt)=>Is(we,typeof Ie!="symbol"?Ie+"":Ie,Rt);(function(){"use strict";const we={EIGHTH:[60,330,660],THOUSAND:[60,330,660,1e3],QUARTER:[60,330,660,1e3,1320],ONE_MILE:[660,1320,2640,3960,5280],EL_MIRAGE:[660,1320,2640,3960,5280,6864],MUROC:[660,1320,2640,3960,5280,6600,7920],TWO_MILE:[660,1320,2640,5280,7920,10560],BONNEVILLE_SHORT:[660,1320,2640,5280,10560,15840],BONNEVILLE_LONG:[660,1320,2640,5280,10560,15840,21120,26400],TEN_MILE:[660,1320,2640,5280,10560,26400,52800]},Ie={EIGHTH:{label:"1/8 Mile",shortLabel:"1/8",category:"drag",lengthFt:660,lengthMiles:.125},THOUSAND:{label:"1000 Foot",shortLabel:"1000'",category:"drag",lengthFt:1e3,lengthMiles:.189},QUARTER:{label:"1/4 Mile",shortLabel:"1/4",category:"drag",lengthFt:1320,lengthMiles:.25},ONE_MILE:{label:"One Mile Asphalt",shortLabel:"1 Mi",category:"landspeed",lengthFt:5280,lengthMiles:1},EL_MIRAGE:{label:"El Mirage Dry Lake",shortLabel:"El Mirage",category:"landspeed",lengthFt:6864,lengthMiles:1.3},MUROC:{label:"Muroc Dry Lake (EAFB)",shortLabel:"Muroc",category:"landspeed",lengthFt:7920,lengthMiles:1.5},TWO_MILE:{label:"Two Mile Asphalt",shortLabel:"2 Mi",category:"landspeed",lengthFt:10560,lengthMiles:2},BONNEVILLE_SHORT:{label:"Bonneville - 3 Miles",shortLabel:"BV 3Mi",category:"landspeed",lengthFt:15840,lengthMiles:3},BONNEVILLE_LONG:{label:"Bonneville - 5 Miles",shortLabel:"BV 5Mi",category:"landspeed",lengthFt:26400,lengthMiles:5},TEN_MILE:{label:"Ten Mile Test Track",shortLabel:"10 Mi",category:"landspeed",lengthFt:52800,lengthMiles:10}};function Rt(e){const r=e.elevation+(29.92-e.barometerInHg)*1e3,n=59-r/1e3*3.5,o=(e.temperatureF-n)*120,s=e.humidityPct/10*50*(e.temperatureF/80);return r+o+s}function Mn(e){const r=.0061*Math.exp(17.27*(e.temperatureF-32)/1.8/(237.3+(e.temperatureF-32)/1.8))*(e.humidityPct/100),n=7e3*.622*(r/(e.barometerInHg-r));return Math.max(0,Math.min(n,500))}function Pn(e){const n=518.6700000000001,o=e.temperatureF+459.67,s=e.barometerInHg/29.92,i=n/o;let c=s*i;const l=1-Mn(e)/5e3;return c*=l,Math.max(.7,Math.min(c,1.15))}function Tn(e){const{vehicle:t,env:r,raceLength:n}=e;if(t.weightLb<=0||t.powerHP<=0)throw new Error("Invalid vehicle params");const o=we[n];if(!o)throw new Error(`Invalid race length: ${n}`);const s=Pn(r),i=t.powerHP*s,c=Math.max(1,i),a=Math.max(1,t.weightLb),l=5.825*Math.cbrt(a/c),u=234*Math.cbrt(c/a),h=l*.64,_=u*.8;let g,d;if(n==="EIGHTH"?(g=h,d=_):(g=l,d=u),!Number.isFinite(g)||!Number.isFinite(d))throw new Error("Invalid ET or MPH calculation");const M=5.825*Math.cbrt(a/Math.max(1,t.powerHP)),p=g-M,m={60:.16,330:.44,660:.79,1e3:.93,1320:1},R=o.map(C=>{const L=m[C]??1,I=g*L,S=C/o[o.length-1],K=d*S;return{d_ft:C,t_s:Math.max(0,I),v_mph:Math.max(0,K)}}),w=[{name:"Weather (HP)",delta_s:p}];return{baseET_s:Math.max(0,g),baseMPH:Math.max(0,d),timeslip:R,factors:w}}function Sn(e){return e/32.174}function Rn(e,t,r){return e+(t-e)*r}function Fn(e){var r;const t=(Array.isArray(e)?e:e==null?void 0:e.powerHP)??((r=e==null?void 0:e.engineParams)==null?void 0:r.powerHP);if(!Array.isArray(t)||t.length<2){const n=e&&typeof e=="object"?Object.keys(e):[];throw new Error(`EngineParams must provide either torqueCurve or powerHP (got keys=${JSON.stringify(n)}, len=${(t==null?void 0:t.length)??0})`)}return t}function Sr(e,t){const r=Fn(t);if(e<=r[0].rpm)return r[0].hp;if(e>=r[r.length-1].rpm)return r[r.length-1].hp;let n=0,o=r.length-1;for(;o-n>1;){const a=n+o>>1;r[a].rpm<=e?n=a:o=a}const s=r[n],i=r[o],c=(e-s.rpm)/(i.rpm-s.rpm);return s.hp+c*(i.hp-s.hp)}function ar(e,t,r){if("corr"in t&&typeof t.corr=="number"){const s=t;let i;if(s.torqueCurve&&s.torqueCurve.length>0)i=bn(e,s.torqueCurve);else if(s.powerHP!==void 0){const a=Math.max(e,1e3);i=s.powerHP*5252/a}else throw new Error("EngineParams must provide either torqueCurve or powerHP");return i*s.corr}const n=Sr(e,t);return(e>0?5252*n/e:0)*(Number.isFinite(r)?r:1)}function bn(e,t){const n=[...t.map(o=>{if(o.tq_lbft!==void 0)return{rpm:o.rpm,tq_lbft:o.tq_lbft};if(o.hp!==void 0&&o.rpm>0)return{rpm:o.rpm,tq_lbft:o.hp*5252/o.rpm};throw new Error(`Invalid torque curve point: ${JSON.stringify(o)}`)})].sort((o,s)=>o.rpm-s.rpm);if(e<=n[0].rpm)return n[0].tq_lbft;if(e>=n[n.length-1].rpm)return n[n.length-1].tq_lbft;for(let o=0;o<n.length-1;o++){const s=n[o],i=n[o+1];if(e>=s.rpm&&e<=i.rpm){const c=(e-s.rpm)/(i.rpm-s.rpm);return Rn(s.tq_lbft,i.tq_lbft,c)}}return n[n.length-1].tq_lbft}const T=e=>Math.fround(e),N={add:(e,t)=>Math.fround(Math.fround(e)+Math.fround(t)),sub:(e,t)=>Math.fround(Math.fround(e)-Math.fround(t)),mul:(e,t)=>Math.fround(Math.fround(e)*Math.fround(t)),div:(e,t)=>Math.fround(Math.fround(e)/Math.fround(t)),sqrt:e=>Math.fround(Math.sqrt(Math.fround(e))),pow:(e,t)=>Math.fround(Math.pow(Math.fround(e),Math.fround(t))),exp:e=>Math.fround(Math.exp(Math.fround(e))),log:e=>Math.fround(Math.log(Math.fround(e))),clamp:(e,t,r)=>Math.fround(Math.min(Math.max(Math.fround(e),Math.fround(t)),Math.fround(r))),abs:e=>Math.fround(Math.abs(Math.fround(e))),neg:e=>Math.fround(-Math.fround(e))};function kr(e,t=0){const r=Math.pow(10,t),n=Math.fround(e*r),o=Math.floor(n),s=n-o;return s>.5?(o+1)/r:s<.5?o/r:(o%2===0?o:o+1)/r}function En(e,t,r,n,o){const s=T(e),i=T(t),c=T(r),a=T(n),l=T(o);if(c===i)return a;const u=N.div(N.sub(s,i),N.sub(c,i));return N.add(a,N.mul(u,N.sub(l,a)))}function An(e,t){if(t.length===0)return T(0);if(t.length===1)return T(t[0][1]);const r=T(e);if(r<=T(t[0][0]))return T(t[0][1]);if(r>=T(t[t.length-1][0]))return T(t[t.length-1][1]);for(let n=0;n<t.length-1;n++){const o=T(t[n][0]),s=T(t[n+1][0]);if(r>=o&&r<=s)return En(r,o,s,t[n][1],t[n+1][1])}return T(t[t.length-1][1])}function wn(e){return Array.isArray(e==null?void 0:e.ratios)&&e.ratios.length>0?e.ratios:Array.isArray(e==null?void 0:e.gearRatios)&&e.gearRatios.length>0?e.gearRatios:[]}function In(e,t,r,n=0){const o=(r.tireDiaIn??28)/12,s=Math.PI*o,c=e/s*60,a=wn(r),l=a.length>0?a[Math.min(t,a.length-1)]??1:1;return c*l*(r.finalDrive??3.73)*(1+n)}function xn(){return{t_s:0,v_fps:0,s_ft:0,rpm:0,gearIdx:0,warnings:[]}}const je=3.141593,x=32.174,Rr=60/(2*je)*550,Fr=519.67,Wr=14.696,vn=29.92,br=28.9669,Or=18.016,qr=1545.32,fr=3600/5280,Er=.025,Cn=.01,Vr=.03,yn=0,Hn=9.7,Ln=1.01,Nn=0,Dn=0,Te=.004,Ft=-4,bt=2,Br=.92,$r=1.08,Ur=.15,Qr=.25,Gn=1.03,kn=10.8,de=3600/5280,Wn=459.67,On=x;function qn(e){const{engineTorque_lbft_atSlip:t,gearRatio:r,transEff:n,drivelineEff:o,finalDrive:s,tireDia_in:i,tireSlip:c,dragForce_lbf:a,vehicleWeight_lbf:l,isAutoTrans:u,torqueMult:h=1}=e,_=t*h*r*n,g=i/24,M=_*s*o/(c*g)-a;return{Ags0_ftps2:(u?.96:.88)*(M/l)*x,netThrust_lbf:M,wheelTorque_lbft:_}}function Jr(e){const t=e.elevation_ft??0,r=e.fuelSystem??1,n=[.0205558,.00118163,154988e-10,40245e-11,434856e-15,2096e-14],o=n[0]+n[1]*e.temperature_F+n[2]*e.temperature_F**2+n[3]*e.temperature_F**3+n[4]*e.temperature_F**4+n[5]*e.temperature_F**5,s=e.relHumidity_pct/100*o,i=Math.pow((Fr-.00356616*t)/Fr,5.25588),c=Wr*e.barometer_inHg/vn*i,a=c-s,l=a/Wr,u=s*Or/(a*br),h=qr*(1/br+u/Or)/(1+u),_=h/(qr/br),g=e.temperature_F+Wn,d=g/Fr,p=144*c/(h*g)/32.174;let m,R;switch(r){case 1:m=1,R=1;break;case 2:m=1,R=2;break;case 3:m=2,R=1;break;case 4:m=2,R=2;break;case 5:m=3,R=2;break;case 6:m=1,R=3;break;case 7:case 9:m=2,R=3;break;case 8:m=3,R=3;break;default:m=1,R=1;break}const w=1+2.48*Math.pow(u,1.5);let C,L,I;switch(m){case 1:C=1,L=.6,I=.15;break;case 2:C=1,L=.3,I=.13;break;case 3:C=.85,L=.5,I=.055;break;default:C=1,L=.6,I=.15;break}if(R===2&&(I=I-.005),R===3){const K=.3050108932461874;C=.95-K*L,L=L+K,I=.6*I}let S=Math.pow(l,C)/(Math.sqrt(_)*Math.pow(d,L));return S=(1+I)*w/S-I,r===9&&(S=1),{rho_slug_per_ft3:p,pamb_psi:c,PWV_psi:s,pair_psi:a,WAR:u,RGAS:h,temp_R:g,hpc:S,delta:l,theta:d,rgrs:_}}function Vn(e,t,r,n=.025,o=.01){const s=n-r/1320*o,i=3600/5280,c=s*e,a=1e-4*e*(i*t);return c+a}function Bn(e,t,r,n,o=.025,s=.01){return Vn(e,t,r,o,s)*n}function $n(e,t,r,n,o=1){let s=t,i=n*e/s;o>2&&i>.6&&(s=s*(1+(n-1)*(i-.6)/(1/n-.6)),i=n*e/s);let c=1/n,a=n*e,l=1;return a<s&&(a=s,l=r-(r-1)*i,c=l*e/s),c>1&&(c=1),{work:l,coupling:c,slipRatio:i,zStall:s,engRPM:a}}const Un=10.8;function Kr(e){const{tireDia_in:t,tireWidth_in:r,dynamicRWT_lbf:n,tractionIndexAdj:o,bodyStyle:s}=e,i=.92+.08*Math.pow(n/1900,2.15);let c=o*Un*t*(r+1)*i;return s===8&&(c=.5*c),c}function Qn(e){const{weight_lbf:t,tireGrowth:r,dragForce_lbf:n}=e;return(Kr(e)/r-n)/t*x}function Jn(){return Te*x}function Kn(e,t,r,n){let o=e,s=t,i=0;return o>n&&(i=1,s=s*(n-(o-n))/o,o=n-(o-n)),o<r&&(s=s*r/o,o=r),{AGS:o,PQWT:s,SLIP:i}}function Xn(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function jn(e,t,r,n){return e+t*Math.pow(r*n,2)}function Yn(e,t,r){return e*t*60/r}function Zn(e,t,r,n,o=!0){let s=n*t*(t-e);s<0&&(s=o?Ur*s:Qr*s);const i=Math.pow(2*je/60,2)/(12*550*r);return s*i}function zn(e,t,r,n){let o=n*t*(t-e);o<0&&(o=0);const s=Math.pow(2*je/60,2)/(12*550*r);return o*s}function eo(e,t,r,n){const o=Math.PI,s=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));let i=1+s*135e-7*Math.pow(r,1.6);const c=1+s*35e-5*r;c<i&&(i=c);const a=n/32.174,l=i-.035*Math.abs(a),u=l*e*o/12,h=12*u/(2*o),_=2*h,g=h/12;return{growth:i,squat:l,dia_eff_in:_,radius_eff_ft:g,circumference_eff_ft:u}}function to(e,t,r,n,o){const a=(t-1)*r/2*n*(o?1:2)/144;return e+a}function ro(e,t,r,n){if(e>=t-1)return!1;const o=n[e];if(!o||o<=0)return!1;const i=(n[0]??0)>8e3?20:10;return Math.abs(o-r)<i}var Xr=(e=>(e[e.NORMAL=0]="NORMAL",e[e.TRIGGERED=1]="TRIGGERED",e[e.EXECUTING=2]="EXECUTING",e))(Xr||{});function no(e,t){switch(e){case 0:return t?{newState:1,executeShift:!1}:{newState:0,executeShift:!1};case 1:return{newState:2,executeShift:!0};case 2:return{newState:0,executeShift:!1};default:return{newState:0,executeShift:!1}}}function oo(e){return e?.2:.25}function so(e,t,r,n){return r>=n||!t||t<=0?!1:N.sub(T(e),T(t))>=0}function io(e,t=3,r=1){const n=.005*(t-1)+3*(r-1),o=e/1320;return 1.02+n*(1-Math.pow(o,2))}function lo(e,t,r,n,o,s,i=.04,c=.9){const a=e*t*(r-n+i/c*n),l=s*r;return(a+l)/o}function co(e,t,r,n,o,s,i,c,a=.04,l=.9){const u=lo(r,e,n,o,s,i,a,l);let h=t-u,_=0;h<0&&(_=-h*s/64,h=0);let g=c-h-_;return g<0&&(g=e),{rear_weight_lbf:g,front_weight_lbf:h,wheelie_bar_weight_lbf:_}}function ao(e,t,r,n){const o=2*n*r,s=Math.sqrt(e*e+o),i=2*n*r+e*e,c=Math.pow(i,1.5),a=Math.pow(e,3),l=(c-a)/(3*n)+t;return{Vel_ftps:s,Dist_ft:l}}function fo(e,t,r){let n=e,o=1,s=0;if(n>r){s=1;const i=n-r,c=r-i;o=c/n,n=c}return n<t&&(o=t/n,n=t),{AGS_ftps2:n,PQWT_scale:o,slip:s}}function uo(e,t){return e/(t*x)}function ho(e,t,r){if(r<=0)return Math.max(.005,Math.min(.05,e));let n=e*Math.pow(t/r,4);return n>.05&&(n=.05),n<.005&&(n=.005),n}function _o(e,t,r,n){const o=t*r/n;let s=e*.11*Math.pow(o,-1/3);return s=s/15,s<.005&&(s=.005),s}function go(e){if(!e)return 1;const t=e.toUpperCase();return t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")||t.includes("FUEL INJECT")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function po(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const n=Number(e.torque)*r/5252*t;return{rpm:r,hp:n}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const n=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:n}}return null}function Jt(e,t=1){return e.map(r=>Array.isArray(r)?{rpm:Number(r[0]),hp:Number(r[1])*t}:po(r,t)).filter(r=>r!==null&&Number.isFinite(r.rpm)&&Number.isFinite(r.hp)).sort((r,n)=>r.rpm-n.rpm)}function mo(e){var a,l,u,h,_;const t=((a=e==null?void 0:e.fuel)==null?void 0:a.hpTorqueMultiplier)??1,r=[],n=(l=e==null?void 0:e.engineParams)==null?void 0:l.powerHP;if(Array.isArray(n)&&(r.push(`engineParams.powerHP(${n.length})`),n.length>=2)){const g=Jt(n,t);if(g.length>=2)return{powerHP:g}}const o=e==null?void 0:e.engineHP;if(Array.isArray(o)&&(r.push(`engineHP(${o.length})`),o.length>=2)){const g=Jt(o,t);if(g.length>=2)return{powerHP:g}}const s=(u=e==null?void 0:e.engineParams)==null?void 0:u.torqueCurve;if(Array.isArray(s)&&(r.push(`engineParams.torqueCurve(${s.length})`),s.length>=2)){const g=Jt(s,t);if(g.length>=2)return{powerHP:g}}const i=(h=e==null?void 0:e.vehicle)==null?void 0:h.torqueCurve;if(Array.isArray(i)&&(r.push(`vehicle.torqueCurve(${i.length})`),i.length>=2)){const g=Jt(i,t);if(g.length>=2)return{powerHP:g}}const c=(_=e==null?void 0:e.vehicle)==null?void 0:_.hpCurve;if(Array.isArray(c)&&(r.push(`vehicle.hpCurve(${c.length})`),c.length>=2)){const g=Jt(c,t);if(g.length>=2)return{powerHP:g}}throw new Error(`RSACLASSIC: missing power curve. Sources found: [${r.join(", ")||"none"}]. Keys(engineParams)=${JSON.stringify(Object.keys((e==null?void 0:e.engineParams)||{}))} Keys(vehicle)=${JSON.stringify(Object.keys((e==null?void 0:e.vehicle)||{}))}`)}function xe(e,t=0){return Number.isFinite(e)?Number(e):t}function jr(e,t){const r=t.map(n=>[n.rpm,n.hp]);return An(e,r)}function Yr(e,t,r){const n=jr(e,t);if(e<=0)return T(0);const o=N.div(N.mul(T(5252),n),T(e));return N.mul(o,T(r))}function Mo(e,t,r,n=t){const o=Number(e);return Number.isFinite(o)?Math.min(r,Math.max(t,o)):n}function Po(e){return Math.max(.85,Math.min(1,e))}class To{constructor(){cr(this,"id","RSACLASSIC")}simulate(t){var zt,er,y,De,Q,V,Y,$;const r=!!((zt=t==null?void 0:t.flags)!=null&&zt.vb6Strict);r&&console.log("[RSACLASSIC] VB6-STRICT mode enabled - using Float32 math");const n=Date.now(),o=9e4,s=2e6,i=5e4;let c=0;function a(A,H){if(Date.now()-n>o)throw new Error("simulation wall-time exceeded");if(A>=s)throw new Error("simulation step cap hit");if(A%i===0){const _e=H-c;if(console.log("[RSACLASSIC] heartbeat",{step:A,dist_ft:H,gained_ft:_e}),A>0&&_e<.001)throw new Error("simulation stalled");c=H}}const l=Number((t==null?void 0:t.raceLengthFt)??1320);if(!Number.isFinite(l)||l<=0)throw new Error(`invalid raceLengthFt: ${t==null?void 0:t.raceLengthFt}`);const u=Number((t==null?void 0:t.timeStep)??.002);if(!Number.isFinite(u)||u<=0)throw new Error(`invalid timeStep ${u}`);const _=mo(t).powerHP;if(console.log("[RSACLASSIC] start",{raceLenFt:l,hpPts:_.length}),!Array.isArray(_)||_.length<2)throw new Error(`RSACLASSIC: powerHP invalid (len=${(_==null?void 0:_.length)??0})`);const g=(t==null?void 0:t.drivetrain)??{},d=(t==null?void 0:t.vehicle)??{},M=g.clutch??(t==null?void 0:t.clutch)??d.clutch,p=g.converter??(t==null?void 0:t.converter)??d.converter,m=!!M,R=!!p,w=m?Number(M.slipRPM??M.slipRpm):NaN,C=m?Number(M.launchRPM??M.launchRpm):NaN,L=R?Number(p.stallRPM??p.stallRpm):NaN,I=m?Number(M.slippageFactor??M.slipRatio??1.0025):1,S=R?Number(p.slippageFactor??p.slipRatio??1.05):1;if(!m&&!R)throw new Error("RSACLASSIC: drivetrain must specify clutch or converter");if(m&&!Number.isFinite(w))throw new Error("RSACLASSIC: clutch.slipRPM missing/invalid");if(R&&!Number.isFinite(L))throw new Error("RSACLASSIC: converter.stallRPM missing/invalid");const K=m?Number.isFinite(C)?C:w:L;console.log("[RPM-RESOLVED]",{isClutch:m,isConverter:R,slipRPM:w,launchRPM:C,stallRPM:L,rpmPin:K});const Se=(t==null?void 0:t.tuning)??{},We=Number.isFinite(Se.aeroCdScale)?Se.aeroCdScale:1,Oe=Number.isFinite(Se.drivelineEffOffset)?Se.drivelineEffOffset:0,{vehicle:P,env:U,raceLength:ve}=t,q=[],z=ve==="EIGHTH"?660:1320,qe=P.cd,Ce=P.frontalArea_ft2,ee=P.transEff,ce=P.finalDrive??P.rearGear,Z=P.gearRatios,te=P.gearEff,ne=P.shiftRPM;qe||q.push("Missing vehicle.cd (drag coefficient) - required for VB6 parity"),Ce||q.push("Missing vehicle.frontalArea_ft2 - required for VB6 parity"),(!Z||Z.length===0)&&q.push("Missing vehicle.gearRatios[] - required for VB6 parity"),(!ne||ne.length===0)&&q.push("Missing vehicle.shiftRPM[] - required for VB6 parity"),ce||q.push("Missing vehicle.finalDrive or vehicle.rearGear - required for VB6 parity"),U.barometerInHg===void 0&&q.push("Missing env.barometerInHg - required for VB6 air density"),U.temperatureF===void 0&&q.push("Missing env.temperatureF - required for VB6 air density"),U.humidityPct===void 0&&q.push("Missing env.humidityPct - required for VB6 air density"),U.elevation===void 0&&q.push("Missing env.elevation - required for VB6 air density");const Re=P.tireRolloutIn??null,Ye=P.tireDiaIn??null,Ze=Math.PI;let E=(typeof Re=="number"&&Re>0?Re/Ze:null)??Ye??0;(!E||E<=0)&&(q.push("Tire diameter is undefined/invalid. Provide tireRolloutIn or tireDiaIn."),E=28);const ge=P.rolloutIn;ge||q.push("Missing vehicle.rolloutIn - required for VB6 parity");const ae=t.fuel,k=go(ae),fe=Jr({barometer_inHg:U.barometerInHg??29.92,temperature_F:U.temperatureF??59,relHumidity_pct:U.humidityPct??50,elevation_ft:U.elevation??0,fuelSystem:k}).rho_slug_per_ft3,ze=Sn(P.weightLb),pe=(ge??12)/12;let ue=null,v=0;const oe=30,et=.01,At=_.reduce((A,H)=>Math.max(A,H.hp),0),Kt=p?p.torqueMult??1.7:1,Fe=(P.rolloutIn??12)/12,Be=_o(Fe>0?Fe:1,At,Kt,P.weightLb);let ye=0,b=Be,f=xn(),se=0;const Xt=[];let ft=0,$e=0,He=0;const ut=[];let tt=!1,wt=0;const jt=[60,330,660,1e3,z];let ht=0,_t=0,It=0,xt=0,wr=0,Yt=0,Ir=0,Le=0,rt=1,he;f.rpm=K;const vt=t.fuel;let Ct=1,dt=1,yt=0,F=0,Ht=0,Lt=0,Nt=0,Dt=0,nt=0,gt=0,Gt=0,me=0;if(M||p){const A=ar(K,_,ee??.9),H=K>0?A*K/5252:0,ie=H>0&&K>0?5252*H/K:0,_e=(Z??[1])[0]??1,j=ie*_e*(ee??.9)*(ce??3.73)*(ee??.9)/(1.02*E/24);me=(p?.96:.88)*j/P.weightLb,me<Te&&(me=Te)}const kt=6,ot=5;let Me=K,Pe=0,Zt=Xr.NORMAL,st=0,_r=0;const xr=A=>te&&te[A]!==void 0?Math.max(.9,Math.min(1,te[A])):ee??.9,Ue=()=>{const A=g.overallEff??g.overallEfficiency??ee??.97;return Po(A+Oe)},Ne=A=>{const H=U.tractionIndex??3;return io(A,H,1)};for(;;){v++,a(v,f.s_ft);const A=eo(E,P.tireWidthIn??17,f.v_fps,me),H=A.radius_eff_ft,ie=A.circumference_eff_ft,_e=A.dia_eff_in;let G=In(f.v_fps,f.gearIdx,g),W=G,j=1,be=0,Pt=0,dr=0;const Ge=xr(f.gearIdx);r?Yr(G,_,Ge):ar(G,_,Ge);let tr=1;if(vt==="METHANOL"){const O=U.trackTempF;O!==void 0&&O<80&&f.t_s<.8&&(tr=1.025-.025*f.t_s/.8)}else if(vt==="NITRO"){if(f.t_s<.4)tr=.9;else if(f.t_s<1){const O=(f.t_s-.4)/.6;tr=.9+(1-.9)*O}}Ct=Math.min(Ct,tr),dt=Math.max(dt,tr);const rr=(Z??[1])[f.gearIdx]??1,vr=Ne(f.s_ft)*f.v_fps*60/ie;v===1&&typeof console<"u"&&console.debug&&console.debug("[RPM-DEBUG]",{isClutch:m,isConverter:R,slipRPM:w,launchRPM:C,stallRPM:L,calculated_slipRPM:w,rpm_from_speed:G});const it=vr*rr*(ce??3.73);let J=(m?I:S)*it;const os=f.gearIdx===0,ss=!0,nr=m?w:L;(m||R)&&(os||ss)&&J<nr&&(J=nr);const gr=J===nr&&it<nr,ln=nr;if(W=J,r?Yr(J,_,Ge):ar(J,_,Ge),M)j=J>1?Math.max(0,Math.min(1,it/J)):0,rt=Math.min(rt,j);else if(p){const O=p.torqueMult??2,B=$n(it,L,O,S,v);j=B.coupling,be=B.work,Pt=B.slipRatio,dr=B.zStall,wr+=B.work,Yt+=B.coupling,Ir+=B.slipRatio,Le++,rt=Math.min(rt,j)}else W=G;f.rpm=W;const qt=xe(f.v_fps,0),cn=U.windMph??0,is=U.windAngleDeg??0,Cr=cn/de,ls=is*Math.PI/180,cs=Math.sqrt(qt*qt+2*qt*Cr*Math.cos(ls)+Cr*Cr),as=P.bodyStyle===8,pr=to(Ce??0,A.growth,E,P.tireWidthIn??17,as);let mr,Tt,or,Mr;const yr=cn!==0?cs:qt;if(r){const O=T(yr);mr=N.mul(O,O),Tt=N.mul(N.mul(T(.5),T(fe)),mr),or=N.mul(N.mul(N.mul(Tt,T(qe??0)),T(We)),T(pr)),Mr=N.mul(N.mul(Tt,T(P.liftCoeff??0)),T(pr))}else mr=yr*yr,Tt=xe(.5*fe*mr,0),or=xe(Tt*(qe??0)*We*pr,0),Mr=xe(Tt*(P.liftCoeff??0)*pr,0);const Hr=xe(P.weightLb-Mr,P.weightLb),St=or,fs=Hr,us=P.rrCoeff??Er,hs=Bn(fs,qt,f.s_ft,H,us,.01),Qe=xe(hs/H,0),_s=1,ds=U.tractionIndex??3,Lr=Xn(ds,_s),gs=v===1?0:Gt,ps=P.wheelbaseIn??108,ms=E/2+3.75,Ms=P.staticFrontWeightLb??P.weightLb*.38,sr=co(P.weightLb,Ms,gs,ms,H*12,ps,St+Qe,Hr,1.03,Ue()),Vt=sr.rear_weight_lbf,Je=Qn({weight_lbf:P.weightLb,tireDia_in:E,tireWidth_in:P.tireWidthIn??17,dynamicRWT_lbf:Vt,tractionIndexAdj:Lr,tireGrowth:A.growth,dragForce_lbf:St+Qe,bodyStyle:void 0}),Ee=Jn();if(v<=12&&typeof console<"u"&&console.log){const O=Kr({weight_lbf:P.weightLb,tireDia_in:E,tireWidth_in:P.tireWidthIn??17,dynamicRWT_lbf:Vt,tractionIndexAdj:Lr,bodyStyle:void 0});console.log("[TRACTION]",{step:v,CAXI:+Lr.toFixed(4),AX:10.8,tireDia_in:+E.toFixed(2),tireWidth_in:+(P.tireWidthIn??17).toFixed(1),dynamicRWT_lbf:+Vt.toFixed(1),weightFactor:+(.92+.08*Math.pow(Vt/1900,2.15)).toFixed(4),CRTF:+O.toFixed(1),tireGrowth:+A.growth.toFixed(4),dragForce_lbf:+(St+Qe).toFixed(2),AMin_ftps2:+Ee.toFixed(3),AMax_ftps2:+Je.toFixed(3),AMin_g:+(Ee/x).toFixed(4),AMax_g:+(Je/x).toFixed(4)})}let le,Ae;if(v<=kt&&it<ot){const O=ar(K,_,Ge),B=R?p.torqueMult??2:1,re=qn({engineTorque_lbft_atSlip:O,gearRatio:rr,transEff:Ge,drivelineEff:Ue(),finalDrive:ce??3.73,tireDia_in:E,tireSlip:Ne(f.s_ft),dragForce_lbf:St+Qe,vehicleWeight_lbf:P.weightLb,isAutoTrans:!!p,torqueMult:B});Ae=re.netThrust_lbf/P.weightLb*x;const ct=Kn(re.Ags0_ftps2,Ae,Ee,Je);if(le=ct.AGS,Ae=ct.PQWT,v<=10&&typeof console<"u"&&console.debug){const at=re.Ags0_ftps2/x,ir=rr*(ce??3.73);console.debug("[STEP]",{step:v,phase:gr?"PINNED":"BOOTSTRAP",v_fps:f.v_fps.toFixed(6),EngRPM:W.toFixed(0),LockRPM:it.toFixed(2),slipRPM:w.toFixed(0),lockThreshold:ln.toFixed(0),rpmIsPinned:gr,clutchSlip:j.toFixed(6),gear:f.gearIdx+1,GRxFD:ir.toFixed(3),tireDia_eff_in:_e.toFixed(2),tireGrowth:A.growth.toFixed(4),tireSlip:Ne(f.s_ft).toFixed(4),RWTdyn_lbf:Vt.toFixed(1),RWTfront_lbf:sr.front_weight_lbf.toFixed(1),wheelieBar_lbf:sr.wheelie_bar_weight_lbf.toFixed(1),AGS_g:at.toFixed(4),AGS_ftps2:le.toFixed(4),AMin_ftps2:Ee.toFixed(4),AMax_ftps2:Je.toFixed(4),SLIP:ct.SLIP})}}else{let O=r?jr(J,_):Sr(J,_);st>0&&(O=0,st=Math.max(0,st-b),st===0&&typeof console<"u"&&console.debug&&console.debug("[SHIFT_DWELL_END]",{step:v,t_s:f.t_s.toFixed(4),v_fps:f.v_fps.toFixed(2)}));const B=O,re=r?N.div(N.mul(N.add(T(St),T(Qe)),T(f.v_fps)),T(550)):(St+Qe)*f.v_fps/550;v<=12&&typeof console<"u"&&console.log&&console.log("[PRE_HP_CHAIN]",{step:v,EngRPM_out:+J.toFixed(0),wheelRPM:+vr.toFixed(2),ClutchSlip:+j.toFixed(4),...p?{converterWork:+be.toFixed(4)}:{},HPSave:+B.toFixed(1),DragHP:+re.toFixed(2),F_drag_lbf:+or.toFixed(2),F_roll_lbf:+Qe.toFixed(2),v_fps:+f.v_fps.toFixed(2),tireSlip:+Ne(f.s_ft).toFixed(4),currentGearEff:+Ge.toFixed(4),drivelineEff:+Ue().toFixed(4),dt_s:+b.toFixed(4),RPM0:+Me.toFixed(0),DSRPM0:+Pe.toFixed(2)});const ct=Yn(Ne(f.s_ft),f.v_fps,ie);let at,ir,Pr;if(((er=P.pmi)==null?void 0:er.engine_flywheel_clutch)!==void 0)at=P.pmi.engine_flywheel_clutch,ir=P.pmi.transmission_driveshaft??0,Pr=P.pmi.tires_wheels_ringgear??0;else{at=500/120;const ke=(Z==null?void 0:Z.length)??5;ir=m?ke*at/50:(ke-1)*at/10,Pr=2*(1.15*.8*(.08*E*(P.tireWidthIn??17))*Math.pow(E/2,2)/386)}const dn=jn(Pr,ir,ce??3.73,rr),Bt=Zn(Me,J,b,at,m),$t=zn(Pe,ct,b,dn);v<=12&&typeof console<"u"&&console.log&&console.log("[PMI_CALC]",{step:v,EngRPM:+J.toFixed(0),RPM0:+Me.toFixed(0),RPM_delta:+(J-Me).toFixed(0),DSRPM:+ct.toFixed(2),DSRPM0:+Pe.toFixed(2),DSRPM_delta:+(ct-Pe).toFixed(2),enginePMI:+at.toFixed(3),chassisPMI:+dn.toFixed(3),HPEngPMI:+Bt.toFixed(1),HPChasPMI:+$t.toFixed(1)}),Me=J,Pe=ct,Nt+=Bt*550*b,Dt+=$t*550*b;let Ut,Ke;const gn=Ne(f.s_ft);if(r){Ut=N.mul(N.sub(T(B),T(Bt)),T(j)),Ke=Ut;const Qt=N.mul(N.mul(T(Ke),T(Ge)),T(Ue())),ke=N.sub(Qt,T($t)),Xe=N.div(ke,T(gn));Ke=N.sub(Xe,T(re))}else Ut=(B-Bt)*j,Ke=Ut,Ke=(Ke*Ge*Ue()-$t)/gn-re;const Dr=Ke;ft=B,$e=Dr,He=re,Ae=r?N.div(N.mul(N.mul(T(550),T(x)),T(Ke)),T(P.weightLb)):550*x*Ke/P.weightLb;let Tr=uo(Ae,f.v_fps);if(b>0&&b<=.01&&v>1){const Qt=Tr/x,ke=me/x;let Xe=(Qt-ke)/b;if(Xe<Ft){Xe=Ft;const lr=ke+Xe*b;Tr=lr*x,Ae=lr*x*f.v_fps}if(Xe>bt){Xe=bt;const lr=ke+Xe*b;Tr=lr*x,Ae=lr*x*f.v_fps}}const Gr=fo(Tr,Ee,Je);le=Gr.AGS_ftps2,Ae=Ae*Gr.PQWT_scale;const As=Gr.slip;le=Mo(le,Ee,Je,Ee);const pn=le/x;pn>ye&&(ye=pn);const mn=me/x;if(mn>0&&v>1&&(b=ho(Be,ye,mn)),v<=12&&typeof console<"u"&&console.log&&console.log("[CONSOLIDATED_ROW]",{step:v,v_ftps:+f.v_fps.toFixed(3),EngRPM:+J.toFixed(0),wheelRPM:+vr.toFixed(2),ClutchSlip:+j.toFixed(4),HPSave:+B.toFixed(1),HPEngPMI:+Bt.toFixed(1),HPChasPMI:+$t.toFixed(1),DragHP:+re.toFixed(2),HP_afterL1:+Ut.toFixed(1),HP_afterL2:+Dr.toFixed(1),PQWT:+Ae.toFixed(1),AMin:+Ee.toFixed(3),AMax:+Je.toFixed(3),AGS_applied:+le.toFixed(3)}),v<=20&&typeof console<"u"&&console.log&&console.log("[AERO_TRACE]",{step:v,v_fps:+qt.toFixed(6),rho_slug_per_ft3:+fe.toFixed(6),q_psf:+Tt.toFixed(3),F_drag_lbf:+or.toFixed(2),F_lift_up_lbf:+Mr.toFixed(2),normal_lbf:+Hr.toFixed(2),F_roll_lbf:+Qe.toFixed(2),AMin_ftps2:+Ee.toFixed(3),AMax_ftps2:+Je.toFixed(3),AGS_ftps2:+le.toFixed(3)}),v<=10&&typeof console<"u"&&console.debug){const Qt=le/x,ke=rr*(ce??3.73);console.debug("[STEP]",{step:v,phase:gr?"PINNED":"HP",v_fps:f.v_fps.toFixed(6),EngRPM:W.toFixed(0),LockRPM:it.toFixed(2),slipRPM:w.toFixed(0),lockThreshold:ln.toFixed(0),rpmIsPinned:gr,clutchSlip:j.toFixed(6),gear:f.gearIdx+1,GRxFD:ke.toFixed(3),tireDia_eff_in:_e.toFixed(2),tireGrowth:A.growth.toFixed(4),tireSlip:Ne(f.s_ft).toFixed(4),RWTdyn_lbf:Vt.toFixed(1),RWTfront_lbf:sr.front_weight_lbf.toFixed(1),wheelieBar_lbf:sr.wheelie_bar_weight_lbf.toFixed(1),rho_slug_ft3:fe.toFixed(6),dragHP:re.toFixed(2),...p?{converterWork:be.toFixed(4),converterSlipRatio:Pt.toFixed(4),converterZStall:dr.toFixed(0)}:{},HP_engine:B.toFixed(1),HPEngPMI:Bt.toFixed(1),HPChasPMI:$t.toFixed(1),HP_afterLine1:Ut.toFixed(1),HP_afterLine2:Dr.toFixed(1),AGS_g:Qt.toFixed(4),AGS_ftps2:le.toFixed(4),AMin_ftps2:Ee.toFixed(4),AMax_ftps2:Je.toFixed(4),SLIP:As})}}me=le;const an=Sr(J,_);yt+=an*550*b;const fn=f.v_fps*b;F+=St*fn,Ht+=Qe*fn;const Ps=1-Ge,Ts=1-Ue(),Ss=Ps+Ts;Lt+=an*550*b*Ss;const Rs=xe(f.v_fps,0),Fs=xe(f.s_ft,0),bs=xe(le,Ee),un=xe(Ae,0),lt=ao(Rs,Fs,b,un);if(v<=12&&typeof console<"u"&&console.log&&console.log("[INTEGRATED]",{step:v,Vel_next:+lt.Vel_ftps.toFixed(3),Dist_next:+lt.Dist_ft.toFixed(6)}),!Number.isFinite(lt.Vel_ftps)||!Number.isFinite(lt.Dist_ft))throw new Error(`NaN in state @ step=${v} v=${lt.Vel_ftps} dist=${lt.Dist_ft} AGS=${bs} PQWT=${un}`);if(f.v_fps=lt.Vel_ftps,f.s_ft=lt.Dist_ft,f.t_s=f.t_s+b,!Number.isFinite(f.v_fps)||!Number.isFinite(f.s_ft)||!Number.isFinite(le))throw new Error(`NaN in state @ step=${v} v=${f.v_fps} dist=${f.s_ft} AGS=${le}`);if(Gt=le/x,f.s_ft>=z){ue="DISTANCE";break}if(f.t_s>=oe){ue="TIME_CAP";break}const hn=(Z==null?void 0:Z.length)??1,Es=(ne??[])[f.gearIdx]??0,_n=r?so(J,Es,f.gearIdx,hn-1):ro(f.gearIdx,hn,J,ne??[]);let Nr=!1;if(r)Nr=_n;else{const O=no(Zt,_n);Zt=O.newState,Nr=O.executeShift}if(Nr){const O=f.gearIdx,B=J;f.gearIdx++;const re=oo(m);st=re,_r+=re,typeof console<"u"&&console.debug&&console.debug("[SHIFT]",{step:v,t_s:f.t_s.toFixed(4),v_fps:f.v_fps.toFixed(2),from_gear:O+1,to_gear:f.gearIdx+1,EngRPM_before:B.toFixed(0),LockRPM:it.toFixed(0),dwell_s:re.toFixed(3)})}for(!tt&&f.s_ft>=pe&&(tt=!0,wt=f.t_s),_t===0&&f.s_ft>=594&&(_t=f.t_s),It===0&&f.s_ft>=1254&&(It=f.t_s);ht<jt.length&&f.s_ft>=jt[ht];){const O=jt[ht],B=tt?f.t_s-wt:0,re=f.v_fps*de;ut.push({d_ft:O,t_s:B,v_mph:re}),ht++}if(f.t_s>=se){const B=(f.v_fps-xt)/b/On;Xt.push({t_s:f.t_s,v_mph:f.v_fps*de,a_g:B,s_ft:f.s_ft,rpm:f.rpm,gear:f.gearIdx+1,hp:$e>0?$e:void 0,engineHp:ft>0?ft:void 0,dragHp:He>0?He:void 0}),se+=et,xt=f.v_fps}}f.t_s>=oe&&q.push("max_time_exceeded");const pt=tt?f.t_s-wt:f.t_s,mt=f.v_fps*de;let Wt,Ot;if(_t>0&&f.t_s>_t){const H=f.t_s-_t;H>0&&(Wt=de*66/H)}if(It>0&&f.t_s>It){const H=f.t_s-It;H>0&&(Ot=de*66/H)}nt=.5*ze*f.v_fps*f.v_fps,ue||(ue="SAFETY"),typeof console<"u"&&console.debug&&console.debug("[RSACLASSIC END]",{reason:ue,t_s:f.t_s,steps:v,d_ft:f.s_ft,target_ft:z,totalShiftDwell_s:_r.toFixed(3)}),typeof console<"u"&&console.warn&&ue!=="DISTANCE"&&console.warn("Terminated without crossing finish:",{reason:ue,t_s:f.t_s,d_ft:f.s_ft,target_ft:z}),(ut.length===0||ut[ut.length-1].d_ft!==z)&&ut.push({d_ft:z,t_s:pt,v_mph:mt});const Mt={};Wt!==void 0&&(Mt.e660_mph=Wt),Ot!==void 0&&(Mt.q1320_mph=Ot);{const A=yt,H=F+Ht+Lt+Nt+Dt,ie=nt+gt,_e=A-H-ie;console.log(`
=== ENERGY SUMMARY: ${P.name??"Unknown"} ===`),console.log(`ET: ${pt.toFixed(3)}s, Trap MPH: ${mt.toFixed(1)}`),console.log(`
Energy In:`),console.log(`  Engine:           ${(yt/1e3).toFixed(1)} k-ft-lb`),console.log(`
Energy Out:`),console.log(`  Aero Drag:        ${(F/1e3).toFixed(1)} k-ft-lb (${(100*F/A).toFixed(1)}%)`),console.log(`  Rolling Resist:   ${(Ht/1e3).toFixed(1)} k-ft-lb (${(100*Ht/A).toFixed(1)}%)`),console.log(`  Driveline Loss:   ${(Lt/1e3).toFixed(1)} k-ft-lb (${(100*Lt/A).toFixed(1)}%)`),console.log(`  Engine PMI:       ${(Nt/1e3).toFixed(1)} k-ft-lb (${(100*Nt/A).toFixed(1)}%)`),console.log(`  Chassis PMI:      ${(Dt/1e3).toFixed(1)} k-ft-lb (${(100*Dt/A).toFixed(1)}%)`),console.log(`  Total Losses:     ${(H/1e3).toFixed(1)} k-ft-lb (${(100*H/A).toFixed(1)}%)`),console.log(`
Final Kinetic Energy:`),console.log(`  Translational:    ${(nt/1e3).toFixed(1)} k-ft-lb (${(100*nt/A).toFixed(1)}%)`),console.log(`  Rotational:       ${(gt/1e3).toFixed(1)} k-ft-lb (${(100*gt/A).toFixed(1)}%)`),console.log(`  Total Kinetic:    ${(ie/1e3).toFixed(1)} k-ft-lb (${(100*ie/A).toFixed(1)}%)`),console.log(`
Energy Balance:     ${(_e/1e3).toFixed(1)} k-ft-lb (${(100*_e/A).toFixed(1)}% error)`),console.log(`===
`)}const X={et_s:r?kr(pt,3):pt,mph:r?kr(mt,2):mt,timeslip:ut,traces:Xt.length>0?Xt:void 0,meta:{model:"RSACLASSIC",steps:Math.floor(f.t_s/b),warnings:q,windowMPH:Object.keys(Mt).length>0?Mt:void 0,converter:p&&!M?{used:!0,avgTR:Le>0?wr/Le:1,avgETA:Le>0?Yt/Le:1,avgSR:Le>0?Ir/Le:1,deRateMax:.3,parasiticConst:.05,parasiticQuad:1e-6}:void 0,clutch:M?{used:!0,minC:rt,lockupAt_ft:he}:void 0,rollout:{rolloutIn:ge??12,t_roll_s:wt},fuel:vt?{type:vt,minScale:Ct,maxScale:dt}:void 0,vb6:{dt_s:b,trapMode:"time",windowsFt:{eighth:{start:594,end:660,distance:66},quarter:{start:1254,end:1320,distance:66}},timeslipPoints:[60,330,660,1e3,1320],rolloutBehavior:"ET clock starts after rollout distance (TIMESLIP.FRM:1380)"},termination:{reason:ue,steps:v,t_s:f.t_s,target_ft:z}}};return console.log("[RSACLASSIC] done",{et_s:+(((De=(y=X==null?void 0:X.et_s)==null?void 0:y.toFixed)==null?void 0:De.call(y,4))??(X==null?void 0:X.et_s)),mph:+(((V=(Q=X==null?void 0:X.mph)==null?void 0:Q.toFixed)==null?void 0:V.call(Q,1))??(X==null?void 0:X.mph)),steps:(($=(Y=X==null?void 0:X.meta)==null?void 0:Y.termination)==null?void 0:$.steps)??v,wallMs:Date.now()-n}),X}}const Zr=new To;function ur(e,t,r,n,o){let s=0;for(s=0;s<r-1&&!(o<=e[s+1]);s++);s>=r-1&&(s=r-2),s<0&&(s=0);const i=e[s],c=e[s+1],a=t[s],l=t[s+1];if(c===i)return a;const u=(o-i)/(c-i);return a+u*(l-a)}function zr(e,t,r,n,o){let s,i;if(o)s=1+4e-5*r,i=s*e*je/12;else{const c=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));s=1+c*135e-7*Math.pow(r,1.6);const a=1+c*35e-5*r;a<s&&(s=a),i=(s-.035*Math.abs(n))*e*je/12}return{TireGrowth:s,TireCirFt:i}}function en(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function tn(e){return e?Hn:kn}function So(e,t){if(!(t!=null&&t.enabled))return 1;const{activateTime_s:r,duration_s:n,throttlePct:o,rampTime_s:s=0}=t,i=r+n;if(e<r||e>=i)return 1;const c=o/100;if(s>0&&e<r+s){const a=(e-r)/s;return 1-(1-c)*a}if(s>0&&e>i-s){const a=(i-e)/s;return 1-(1-c)*a}return c}function Ro(e,t,r,n,o){const s=e.Gear;let i;const c=e.Gear!==e.PrevGear;if(c)i=t.DTShift,e.PrevGear=e.Gear;else{if(i=n,e.Ags0_g>0&&e.L>1){const b=Math.min(e.AgsMax_g/e.Ags0_g,10);i=n*Math.pow(b,4)}i>.1&&(i=.1)}let a=0;const l=e.time_s-e.Time0_s;l>0&&(a=(e.AGS_g-e.Ags0_g)/l),a<Ft&&(a=Ft),a>bt&&(a=bt),e.Vel0_ftps=e.Vel_ftps,e.Ags0_g=e.AGS_g,e.Time0_s=e.time_s,e.Dist0_ft=e.Dist_ft,e.RPM0=e.EngRPM,e.DSRPM0=e.DSRPM,e.RPM0===t.LaunchRPM&&e.Time0_s===0&&(e.RPM0=t.Stall,t.LaunchRPM<t.Stall&&(e.Time0_s=t.EnginePMI*(t.Stall-t.LaunchRPM)/25e4));const u=zr(t.TireDia_in,t.TireWidth_in,e.Vel_ftps,e.Ags0_g,r.isLandSpeed);e.TireGrowth=u.TireGrowth,e.TireCirFt=u.TireCirFt;let h;r.isLandSpeed?h=1.01+(r.TractionIndex-1)*.01:h=1.02+(.005*(r.TractionIndex-1)+3*(r.TrackTempEffect-1))*(1-Math.pow(e.Dist0_ft/1320,2));const _=t.TGR[s-1]??1,g=t.TiresPMI+t.TransPMI*Math.pow(t.GearRatio,2)*Math.pow(_,2);let d=e.Vel0_ftps+e.Ags0_g*x*i+a*x*i*i/2;d<e.Vel0_ftps*.9&&e.Vel0_ftps>100&&(d=e.Vel0_ftps),d<0&&(d=0);const M=t.ShiftRPM[s-1]??9e3;if(!c&&(i<.005&&(i=.005),i>.05&&(i=.05),d=e.Vel0_ftps+e.Ags0_g*x*i+a*x*i*i/2,e.Vel0_ftps>0&&e.RPM0>t.Stall&&s<t.NGR)){const b=e.Vel0_ftps*(M+5)/e.RPM0;d>b&&(d=b,e.Ags0_g*x>0&&(i=(d-e.Vel0_ftps)/(e.Ags0_g*x)))}const p=d*d-e.Vel0_ftps*e.Vel0_ftps,m=h*d*60/e.TireCirFt,R=m*t.GearRatio*_;let w=t.Slippage*R,C,L=t.Stall,I=0;t.isClutch?(w<t.Stall&&(s===1||!t.LockUp)&&(w=t.Stall),C=R/w):s===1||!t.LockUp?(L=t.Stall,I=t.Slippage*R/L,e.L>2&&(I>.6&&(L=L*(1+(t.Slippage-1)*(I-.6)/(1/t.Slippage-.6))),I=t.Slippage*R/L),C=1/t.Slippage,w<L&&(w=L,C=(t.TorqueMult-(t.TorqueMult-1)*I)*R/L)):(w=1.005*R,C=R/w),C>1&&(C=1);let S=ur(t.xrpm,t.yhp,t.NHP,1,w);S=t.HPTQMult*S/r.hpc,t.RevLimiterRPM>0&&w>=t.RevLimiterRPM&&(S=S*.05);const K=So(e.time_s,o);S=S*K;const Se=S;S=S*C;const We=Math.sqrt(d*d+2*d*(r.WindSpeed_mph/fr)*Math.cos(je*r.WindAngle_deg/180)+Math.pow(r.WindSpeed_mph/fr,2)),Oe=Math.sign(We)*r.rho*Math.pow(Math.abs(We),2)/(2*x);let P;t.BodyStyle===8?P=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*t.TireWidth_in/144:P=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*(2*t.TireWidth_in)/144;const U=t.Weight_lbf+t.LiftCoef*P*Oe,ve=r.isLandSpeed?Vr:Er,q=r.isLandSpeed?yn:Cn,z=r.isLandSpeed?Ln:Gn,Ce=(ve-e.Dist0_ft/1320*q)*U+1e-4*U*(fr*d)+t.DragCoef*P*Oe,ee=Ce*d/550,ce=12*e.TireCirFt/(2*je),Z=(e.Ags0_g*t.Weight_lbf*(t.YCG_in-ce+z/t.Efficiency*ce)+Ce*t.YCG_in)/t.Wheelbase_in;let te=t.StaticFWt_lbf-Z,ne=0;te<0&&(ne=-te*t.Wheelbase_in/64,te=0);let Re=U-te-ne;Re<0&&(Re=t.Weight_lbf);const Ye=en(r.TractionIndex,r.TrackTempEffect),Ze=tn(r.isLandSpeed);let Ve=Ye*Ze*t.TireDia_in*(t.TireWidth_in+1)*(.92+.08*Math.pow(Re/1900,2.15));t.BodyStyle===8&&(Ve=.5*Ve);const E=(Ve/e.TireGrowth-Ce)/t.Weight_lbf,ge=t.TGEff[s-1]??.99;S=S*ge*t.Efficiency/h;const ae=S;S=S-ee;let k=550*x*S/t.Weight_lbf,D=k/(d*x),fe=!1;D>E&&(fe=!0,k=k*(E-(D-E))/D,D=E-(D-E)),D<Te&&(D=Te,k=Te*x*d);let pe=Math.max(0,p)/(2*k)+e.Time0_s;const ue=r.isLandSpeed?Nn:Ur,v=r.isLandSpeed?Dn:Qr;let oe=t.EnginePMI*w*(w-e.RPM0);oe<0&&(t.isClutch?oe=ue*oe:oe=v*oe);let et=g*m*(m-e.DSRPM0);et<0&&(et=0);let At=0,Kt=0,Fe=0;for(Fe=1;Fe<=12;Fe++){const b=pe-e.Time0_s;if(b<=0)break;const f=Math.pow(2*je/60,2)/(12*550*b);At=oe*f,Kt=et*f,S=(Se-At)*C,S=(S*ge*t.Efficiency-Kt)/h-ee,k=550*x*S/t.Weight_lbf,D=k/(d*x);let se=0;b!==0&&(se=(D-e.Ags0_g)/b),se<Ft&&(se=Ft,D=e.Ags0_g+se*b,k=D*x*d),se>bt&&(se=bt,D=e.Ags0_g+se*b,k=D*x*d),fe=!1,D>E&&(fe=!0,k=k*(E-(D-E))/D,D=E-(D-E)),D<Te&&(k=k*Te/D,D=Te);const ft=Math.max(0,p)/(2*k)+e.Time0_s,$e=ft-e.Time0_s;if(Fe===12||Math.abs(100*($e-b)/$e)<=.01){pe=ft;break}let He=S/Se;He<Br&&(He=Br),He>$r&&(He=$r),pe=e.Time0_s+b+He*($e-b)}const Be=pe-e.Time0_s;let ye;if(k<.1||Be<=0){const b=(e.Vel0_ftps+d)/2;ye=e.Dist0_ft+Math.max(0,b*Math.abs(Be))}else{const b=Math.pow(e.Vel0_ftps,3),f=2*k*Be+e.Vel0_ftps*e.Vel0_ftps;if(f<0){const se=(e.Vel0_ftps+d)/2;ye=e.Dist0_ft+se*Be}else ye=(Math.pow(f,1.5)-b)/(3*k)+e.Dist0_ft}return e.L+=1,e.time_s=pe,e.Vel_ftps=d,e.Dist_ft=ye,e.AGS_g=D,e.EngRPM=w,e.DSRPM=m,e.SLIP=fe,{TimeStep_s:i,VelSqrd:p,LockRPM:R,ClutchSlip:C,zStall:L,SlipRatio:I,TireSlip:h,WindFPS:We,q:Oe,RefArea2_ft2:P,DownForce_lbf:U,DragForce_lbf:Ce,DragHP:ee,DynamicFWT_lbf:te,DynamicRWT_lbf:Re,WheelBarWT_lbf:ne,CRTF:Ve,AMax_g:E,ChassisPMI:g,EngAccHP:oe,ChasAccHP:et,HPSave:Se,HPAtWheels:ae,HP:S,PQWT:k,iterations:Fe}}function Fo(e,t,r){const n=zr(e.TireDia_in,e.TireWidth_in,0,0,t.isLandSpeed),o=ur(e.xrpm,e.yhp,e.NHP,1,r);let c=5252*(e.HPTQMult*o/t.hpc)/r;const a=e.TGR[0]??1,l=e.TGEff[0]??.99;c=c*e.TorqueMult*a*l;const u=t.isLandSpeed?Vr:Er,h=t.WindSpeed_mph/fr,_=Math.sign(h)*t.rho*Math.pow(Math.abs(h),2)/(2*x),g=u*e.Weight_lbf+e.DragCoef*e.RefArea_ft2*_;let d;t.isLandSpeed?d=1.01+(t.TractionIndex-1)*.01:d=1.02+(t.TractionIndex-1)*.005+(t.TrackTempEffect-1)*3;const M=c*e.GearRatio*e.Efficiency/(d*e.TireDia_in/24)-g;let m=(e.isClutch?.88:.96)*M/e.Weight_lbf,w=e.Weight_lbf-e.StaticFWt_lbf;w<0&&(w=e.Weight_lbf);const C=en(t.TractionIndex,t.TrackTempEffect),L=tn(t.isLandSpeed);let I=C*L*e.TireDia_in*(e.TireWidth_in+1)*(.92+.08*Math.pow(w/1900,2.15));e.BodyStyle===8&&(I=.5*I);const S=(I-g)/e.Weight_lbf;return m>S&&(m=S),m<Te&&(m=Te),{L:1,time_s:0,Vel_ftps:.001,Dist_ft:0,AGS_g:m,EngRPM:r,DSRPM:0,Gear:1,SLIP:!1,Vel0_ftps:0,Ags0_g:m,Time0_s:0,Dist0_ft:0,RPM0:r,DSRPM0:0,AgsMax_g:m,TireGrowth:n.TireGrowth,TireCirFt:n.TireCirFt,ShiftFlag:0,PrevGear:1}}function bo(e,t,r,n){let o=e*.11*Math.pow(t*r/n,-.3333333333333333);return o=o/15,o<.005&&(o=.005),o}function rn(e,t,r){let n=0,o=0,s=r-1;const i=e[0],c=e[r-1];if(t<=i)return n=1,s=1,{KBOTM:o,KTOP:s,JJ:n};if(t>=c)return n=1,o=r-2,s=r-1,{KBOTM:o,KTOP:s,JJ:n};for(;s-o>1;){const a=Math.floor((o+s)/2);t<e[a]?s=a:o=a}return{KBOTM:o,KTOP:s,JJ:n}}function Ar(e,t,r,n,o){if(r<=0)return 0;if(r===1)return t[0];let s=0,i=1;if(r===2)s=0,i=1;else{const a=rn(e,o,r);s=a.KBOTM,i=a.KTOP;const l=a.JJ;if(s===i)return t[s];l!==1&&n>1&&(i=i+1,(n>=3||i>r-1)&&(i>r-1&&(i=r-1),s=s-1,s<0&&(s=0)))}let c=0;for(let a=s;a<=i;a++){let l=1;const u=e[a];for(let h=s;h<=i;h++)if(h===a)l=l*t[a];else{const _=e[h];l=l*(o-_)/(u-_)}c=c+l}return c}function Eo(e,t,r,n,o,s,i,c,a){const l=rn(t,a,o);let u=l.KBOTM,h=l.KTOP;l.JJ;const _=[],g=[];for(let p=u;p<=h;p++){const m=[];for(let w=0;w<n;w++)m.push(r[p*n+w]);const R=Ar(e,m,n,s,c);_.push(R),g.push(t[p])}const d=h-u+1,M=Math.min(i,d);return Ar(g,_,d,M,a)}function Ao(e){switch(e){case 1:case 2:return 1;case 3:case 4:return 1.08;case 5:return 5;case 6:return 2*1;case 7:case 9:return 2.5*1.08;case 8:return 1.5*5.5;default:return 1}}function wo(e){return e<=5}const Io=[.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],xo=[.7,1.2,1.7,2.5,3.4],vo=[.53,.975,1.098,1.13,1.152,1.16,1.153,1.122,1.086,1.045,1,.938,.865,.795,.72,.63,.365,.87,1.018,1.066,1.11,1.129,1.132,1.11,1.079,1.042,1,.935,.855,.762,.66,.54,.24,.79,.96,1.023,1.08,1.106,1.117,1.102,1.074,1.04,1,.932,.845,.736,.612,.474,.1,.7,.894,.972,1.04,1.08,1.096,1.09,1.069,1.037,1,.928,.83,.698,.55,.39,0,.63,.84,.924,1,1.055,1.079,1.082,1.064,1.035,1,.923,.815,.662,.49,.31],nn=[0,.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],Et=[0,.7,1.2,1.7,2.5,3.4],Co=[0,0,.61,.8,.9,.98,1.035,1.055,1.06,1.05,1.03,1,.93,.85,.765,.67,.58];function yo(e,t){return Eo(Io,xo,vo,16,5,1,1,e,t)}function Ho(e){const{peakHP:t,peakRPM:r,displacement_cid:n,fuelSystem:o}=e,s=Rr*t/r,i=Ao(o);let c=t/n/i;o<=5?c<Et[1]&&(c=Et[1]):c<Et[2]&&(c=Et[2]),c>Et[5]&&(c=Et[5]);const a=[0],l=[0],u=[0],h=16;for(let _=1;_<=h;_++){a[_]=nn[_]*r;let g;o===8?g=Co[_]*s:g=yo(nn[_],c)*s,l[_]=a[_]*g/Rr,u[_]=g}return{xrpm:a,yhp:l,ztq:u,NHP:h}}function Lo(e){const t=[],r=[];for(let n=1;n<=e.NHP;n++)t.push(e.xrpm[n]),r.push(e.yhp[n]);return{rpm:t,hp:r}}function No(e){return e>800?1:8}function Do(e){switch(e){case 1:return{dragCoef:.66,liftCoef:.8,overhang_in:30};case 2:return{dragCoef:.5,liftCoef:.2,overhang_in:30};case 3:return{dragCoef:.52,liftCoef:.8,overhang_in:40};case 4:return{dragCoef:.52,liftCoef:.1,overhang_in:30};case 5:return{dragCoef:.28,liftCoef:.1,overhang_in:30};case 6:return{dragCoef:.4,liftCoef:.1,overhang_in:24};case 7:return{dragCoef:.46,liftCoef:.1,overhang_in:18};case 8:return{dragCoef:.54,liftCoef:.1,overhang_in:12};default:return{dragCoef:.5,liftCoef:.2,overhang_in:30}}}function Go(e,t){const r=[];if(t){const n=e>=3?.985:.99;for(let o=1;o<=e;o++)r.push(n-(e-o)*2*.005)}else for(let o=1;o<=e;o++)r.push(.99-(e-o)*.005);return r}function ko(e,t,r,n,o,s,i){let c,a,l;return wo(t)?c=e/120:c=e/90,r?a=(n-1)*c/10:a=n*c/50,l=2*(1.15*.8*(.08*o*s)*Math.pow(o/2,2)/386),i===8&&(c=e/240,a=a/(240/120),l=l/2),{enginePMI:c,transPMI:a,tiresPMI:l}}function Wo(e){return e===8?.985:.97}function Oo(e){return 1.0025+e/1e6}function qo(e){const t=Ie[e];return t?t.lengthFt:e==="EIGHTH"?660:1320}function Vo(e){const t=we[e];return t||(e==="EIGHTH"?we.EIGHTH:we.QUARTER)}function Bo(e){if(!e)return 1;const t=e.toUpperCase();return t==="GASOLINE"?1:t==="GASOLINE EFI"?2:t==="METHANOL"?3:t==="METHANOL EFI"?4:t==="NITROMETHANE"?5:t==="SUPERCHARGED GASOLINE"?6:t==="SUPERCHARGED METHANOL"?7:t==="SUPERCHARGED NITRO"?8:t==="E85"||t==="DIESEL"||t==="GAS+CARB"||t==="GASOLINE+CARBURETOR"?1:t==="GAS+INJECT"||t==="GASOLINE+FUEL INJECTION"?2:t==="METHANOL+CARB"||t==="METHANOL+CARBURETOR"?3:t==="METHANOL+INJECT"||t==="METHANOL+FUEL INJECTION"?4:t==="NITRO+INJECT"||t==="NITROMETHANE+FUEL INJECTION"?5:t==="GAS+SUPERCHARGED"||t==="GASOLINE+SUPERCHARGED"?6:t==="METHANOL+SUPERCHARGED"?7:t==="NITRO+SUPERCHARGED"||t==="NITROMETHANE+SUPERCHARGED"?8:t==="ELECTRIC"?9:t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function $o(e){const t=e.vehicle,r=e.engine??t.engine,n=(r==null?void 0:r.hpCurve)??(r==null?void 0:r.torqueCurve)??t.torqueCurve??t.hpCurve??[],o=[],s=[];for(const u of n)Array.isArray(u)?(o.push(u[0]),s.push(u[1])):u&&typeof u=="object"&&(o.push(u.rpm),u.hp!==void 0?s.push(u.hp):u.torque!==void 0?s.push(u.torque*u.rpm/5252):u.tq_lbft!==void 0&&s.push(u.tq_lbft*u.rpm/5252));if(o.length>=2)return{xrpm:o,yhp:s,NHP:o.length,isQuarterJr:!1};const i=Number(t.powerHP??t.peakHP),c=Number(t.rpmAtPeakHP??t.peakRPM??6500),a=Number(t.displacement_cid??t.displacementCID??350),l=e.fuelSystem??t.fuelSystem??1;if(Number.isFinite(i)&&i>0){const u=Ho({peakHP:i,peakRPM:c,displacement_cid:a,fuelSystem:l}),{rpm:h,hp:_}=Lo(u);return{xrpm:h,yhp:_,NHP:u.NHP,isQuarterJr:!0,quarterJrParams:{peakHP:i,rpmAtPeakHP:c,displacement_cid:a,fuelSystem:l}}}return{xrpm:[4e3,6500],yhp:[100,150],NHP:2,isQuarterJr:!1}}function on(e){const t=Math.abs(100-e);let r;return e>100?r=1+25e-7*Math.pow(t,2.5):r=1+2e-6*Math.pow(t,2.5),r>1.04&&(r=1.04),r}function Uo(e){var Ue,Ne,pt,mt,Wt,Ot,Mt,X,zt,er;const t=[],r=[],n=e.vehicle,o=e.env,s=e.raceLength??"QUARTER",i=e.raceLengthFt??qo(s),c=((Ue=Ie[s])==null?void 0:Ue.category)==="landspeed",a=n.rolloutIn??9,l=n.overhangIn??0;let u=2*a;u<24&&(u=24);let h=(l+.25*u)/12;const _=.5*u/12;h<_&&(h=_);const g=a/12,d=e.drivetrain??n.drivetrain,M=(d==null?void 0:d.clutch)??e.clutch??n.clutch,p=(d==null?void 0:d.converter)??e.converter??n.converter,m=e.engine??n.engine,R=e.pmi??n.pmi,w=e.throttleStop,C=w!=null&&w.enabled?{enabled:!0,activateTime_s:w.activateTime_s,duration_s:w.duration_s,throttlePct:w.throttlePct,rampTime_s:w.rampTime_s}:void 0,L=n.transmissionType??e.transmissionType,I=L==="clutch"?!0:L==="converter"?!1:!p||M&&!p,S=e.fuel,K=typeof S=="string"?S:(S==null?void 0:S.fuelType)??(S==null?void 0:S.fuelSystem)??(S==null?void 0:S.type)??e.fuelType??n.fuelType??e.fuelSystem??n.fuelSystem,Se=Bo(K),We=Jr({barometer_inHg:o.barometerInHg??29.92,temperature_F:o.temperatureF??59,relHumidity_pct:o.humidityPct??50,elevation_ft:o.elevation??0,fuelSystem:Se}),Oe=We.rho_slug_per_ft3*x,P=We.hpc,U=$o(e),{xrpm:ve,yhp:q,NHP:z,isQuarterJr:qe,quarterJrParams:Ce}=U;z<2&&t.push("HP curve has fewer than 2 points"),qe&&t.push("Using QuarterJr mode (synthetic HP curve from peak HP)");const ee=(d==null?void 0:d.gearRatios)??n.gearRatios??[2.5,1.8,1.4,1.1,1],ce=(d==null?void 0:d.finalDriveRatio)??n.finalDrive??n.rearGear??3.73,Z=ee.length,te=n.tire,ne=(te==null?void 0:te.diameter_in)??n.tireDiaIn??32,Re=(te==null?void 0:te.width_in)??n.tireWidthIn??17,Ye=n.bodyStyle??No(n.weightLb);let Ze,Ve,E,ge,ae,k,D,fe,ze,pe,ue,v;if(qe&&Ce){const{displacement_cid:y,fuelSystem:De}=Ce;Ze=Go(Z,!I);const Q=n.shiftRPM??(d==null?void 0:d.shiftRPM)??7e3;Ve=ee.map(()=>Q);const V=(M==null?void 0:M.slipRPM)??(p==null?void 0:p.stallRPM)??n.slipStallRPM??5e3;if(I)ge=Oo(V),ae=1,E=V;else{const A=(p==null?void 0:p.diameter_in)??(p==null?void 0:p.diameter)??n.converterDiameterIn??n.converterDia_in??10;let H;if(V>220){E=V;const G=Ar(ve,q,z,1,E)*(Rr/E)/P;H=E/1e3*(E/G)}else H=V,E=V;const ie=H/(200*Math.pow(7/A,4));ge=1.01+ie/20+H/8e3,ae=2.633-Math.pow(ie,.3)-H/1500,ae<1&&(ae=1),ae>2&&(ae=2)}ze=Wo(Ye);const Y=Do(Ye);pe=Y.dragCoef,ue=Y.liftCoef,v=Y.overhang_in;const $=ko(y,De,!I,Z,ne,Re,Ye);k=$.enginePMI,D=$.transPMI,fe=$.tiresPMI}else{Ze=(d==null?void 0:d.perGearEff)??n.gearEfficiencies??null??ee.map(()=>.99),Ve=(d==null?void 0:d.shiftRPMs)??(d==null?void 0:d.shiftsRPM)??n.shiftRPMs??ee.map(()=>7e3);const De=(M==null?void 0:M.slipRPM)??n.clutchSlipRPM??7200,Q=(p==null?void 0:p.stallRPM)??n.converterStallRPM??5500;E=I?De:Q;const V=(M==null?void 0:M.slippageFactor)??(M==null?void 0:M.slippage)??n.clutchSlippage??1.0025,Y=(p==null?void 0:p.slippageFactor)??(p==null?void 0:p.slippage)??n.converterSlippage??1.06;ge=I?V:Y,ae=I?1:(p==null?void 0:p.torqueMult)??(p==null?void 0:p.torqueMultiplier)??n.converterTorqueMult??2.2,k=(R==null?void 0:R.engine_flywheel_clutch)??n.enginePMI??(m==null?void 0:m.enginePMI)??4,fe=(R==null?void 0:R.tires_wheels_ringgear)??n.tiresPMI??(m==null?void 0:m.tiresPMI)??.5,D=(R==null?void 0:R.transmission_driveshaft)??n.transPMI??(m==null?void 0:m.transPMI)??.2,ze=(d==null?void 0:d.overallEfficiency)??n.transEfficiency??.97;const $=e.aero??n.aero;pe=($==null?void 0:$.Cd)??($==null?void 0:$.cd)??n.cd??.35,ue=($==null?void 0:$.Cl)??($==null?void 0:$.cl)??n.liftCoeff??0,v=l}const oe=ne/2+3.75,et=o.trackTempF??100,At=c?1:on(et),Fe=1.02+((o.tractionIndex??5)-1)*.005+(At-1)*3,Be=1.03,ye=.025,b=n.wheelbaseIn??100,f=n.weightLb,se=I?(M==null?void 0:M.launchRPM)??n.clutchLaunchRPM??E:E,$e=5252*(ur(ve,q,z,1,se)/P)/se*ae*ee[0]*Ze[0],tt=(o.windMph??0)/.681818,wt=tt>0?Oe*tt*tt/(2*x):0,jt=((Ne=e.aero)==null?void 0:Ne.frontalArea_ft2)??n.frontalArea_ft2??n.frontalAreaFt2??20,ht=ye*f+pe*jt*wt,_t=$e*ce*ze/(Fe*ne/24)-ht,xt=(I?.88:.96)*_t/f,Yt=(1-.035*Math.abs(xt))*ne/2,Le=(xt*f*(oe-Yt+Be/ze*Yt)+ht*oe)/b,rt=qe?v:l,he={Weight_lbf:n.weightLb,Wheelbase_in:n.wheelbaseIn??100,YCG_in:oe,StaticFWt_lbf:Le,TireDia_in:ne,TireWidth_in:Re,Rollout_in:n.rolloutIn??12,GearRatio:ce,TGR:ee,TGEff:Ze,Efficiency:ze,DTShift:I?.2:.25,Slippage:ge,TorqueMult:ae,Stall:E,LockUp:(p==null?void 0:p.lockup)??!1,isClutch:I,RefArea_ft2:((pt=e.aero)==null?void 0:pt.frontalArea_ft2)??n.frontalArea_ft2??n.frontalAreaFt2??20,DragCoef:pe,LiftCoef:ue,BodyStyle:Ye,EnginePMI:k,TiresPMI:fe,TransPMI:D,xrpm:ve,yhp:q,NHP:z,HPTQMult:n.hpTorqueMultiplier??(m==null?void 0:m.hpTqMult)??1,ShiftRPM:Ve,NGR:Z,LaunchRPM:I?(M==null?void 0:M.launchRPM)??n.clutchLaunchRPM??E:E,ShiftMode:n.shiftMode??"rpm",ShiftTimes:n.shiftTimes??[],RevLimiterRPM:n.revLimiterRPM??0};if(qe&&rt!==l){let y=2*a;y<24&&(y=24),h=(rt+.25*y)/12;const De=.5*y/12;h<De&&(h=De)}const vt=o.trackTempF??100,Ct=c?1:on(vt),dt={rho:Oe,hpc:P,TractionIndex:o.tractionIndex??5,TrackTempEffect:Ct,WindSpeed_mph:o.windMph??0,WindAngle_deg:o.windAngleDeg??0,isLandSpeed:c},yt=I?(M==null?void 0:M.launchRPM)??E:E,F=Fo(he,dt,yt),Ht=ur(ve,q,z,1,yt),Lt=bo(60,Ht,ae,n.weightLb),Nt=c?5e4:5e3,Dt=c?300:30,nt={iterations:[],convergenceHistory:[]},gt=[],Gt=Vo(s);let me=0,kt=null,ot=null,Me=null;for(let y=0;y<Nt&&!(F.Dist_ft-g+h>=i+50||F.time_s>=Dt);y++){if(!Number.isFinite(F.Vel_ftps)||!Number.isFinite(F.Dist_ft)||!Number.isFinite(F.AGS_g)){t.push(`NaN detected at step ${y}: Vel=${F.Vel_ftps}, Dist=${F.Dist_ft}, AGS=${F.AGS_g}`);break}const Q=Ro(F,he,dt,Lt,C);if(nt.iterations.push(Q.iterations),y<20&&nt.convergenceHistory.push({step:y,iterations:Q.iterations,HPSave:Q.HPSave,HP:Q.HP,PQWT:Q.PQWT,AGS_g:F.AGS_g}),kt===null&&F.Dist_ft>=g){const W=(F.Dist_ft-g)/F.Vel_ftps;kt=F.time_s-W}const V=Math.max(0,F.Dist_ft-g+h),Y=kt!==null?F.time_s-kt:0,$=he.TGR[F.Gear-1]??1,A=(Q.LockRPM??F.EngRPM)/$,H=Q.TireSlip,ie=F.Vel_ftps*H*de,_e=(C==null?void 0:C.enabled)&&Y>=C.activateTime_s&&Y<C.activateTime_s+C.duration_s;if(r.push({t_s:Y,s_ft:V,v_fps:F.Vel_ftps,v_mph:F.Vel_ftps*de,a_g:F.AGS_g,rpm:F.EngRPM,dsrpm:A,lockRpm:Q.LockRPM,gear:F.Gear,slip:F.SLIP,tireSlip:H,hp:Q.HPAtWheels,dragHp:Q.DragHP,netHp:Q.HP,wheelSpeed_mph:ie,throttleStopActive:_e}),ot===null&&V>=594){const G=r.length>1?((mt=r[r.length-2])==null?void 0:mt.s_ft)??0:0,W=r.length>1?((Wt=r[r.length-2])==null?void 0:Wt.t_s)??0:0;if(G<594&&V>G){const j=(594-G)/(V-G);ot=W+j*(Y-W)}else ot=Y}if(Me===null&&V>=1254){const G=r.length>1?((Ot=r[r.length-2])==null?void 0:Ot.s_ft)??0:0,W=r.length>1?((Mt=r[r.length-2])==null?void 0:Mt.t_s)??0:0;if(G<1254&&V>G){const j=(1254-G)/(V-G);Me=W+j*(Y-W)}else Me=Y}for(;me<Gt.length&&V>=Gt[me];){const G=Gt[me],W=r.length>1?((X=r[r.length-2])==null?void 0:X.s_ft)??0:0,j=r.length>1?((zt=r[r.length-2])==null?void 0:zt.t_s)??0:0;let be=Y;if(W<G&&V>W){const dr=(G-W)/(V-W);be=j+dr*(Y-j)}let Pt;G===660&&ot!==null&&be>ot?Pt=de*66/(be-ot):G===1320&&Me!==null&&be>Me?Pt=de*66/(be-Me):Pt=F.Vel_ftps*de,gt.push({d_ft:G,t_s:be,v_mph:Pt}),me++}if(F.ShiftFlag===1)F.ShiftFlag=2,F.Gear++;else if(F.ShiftFlag===2)F.ShiftFlag=0;else if(F.Gear<he.NGR)if((he.ShiftMode??"rpm")==="time"){const W=(er=he.ShiftTimes)==null?void 0:er[F.Gear-1];W!==void 0&&F.time_s>=W&&(F.ShiftFlag=1)}else{const W=he.ShiftRPM[F.Gear-1]??7e3;F.EngRPM>=W&&(F.ShiftFlag=1)}}const Pe=gt.find(y=>y.d_ft===i),Zt=(Pe==null?void 0:Pe.t_s)??F.time_s,st=(Pe==null?void 0:Pe.v_mph)??F.Vel_ftps*de,_r=r.map(y=>({t_s:y.t_s,s_ft:y.s_ft,v_mph:y.v_mph,v_fps:y.v_fps,a_g:y.a_g,rpm:y.rpm,dsrpm:y.dsrpm,lockRpm:y.lockRpm,gear:y.gear,slip:y.slip,tireSlip:y.tireSlip,hp:y.hp,dragHp:y.dragHp,wheelSpeed_mph:y.wheelSpeed_mph})),xr={fuelType:{resolved:K??"unknown",fuelSystemType:Se,vehicleFuelType:n.fuelType,vehicleFuelSystem:n.fuelSystem},hpCurve:{length:z,peakHP:Math.max(...q),rpmRange:`${Math.min(...ve)} - ${Math.max(...ve)}`},airCalc:{rho_lbm_ft3:Oe,hpc:P},simParams:{weight:n.weightLb,tireDia:ne,wheelbase:n.wheelbaseIn??100,finalDrive:ce,NGR:Z,peakHP:Math.max(...q),stallRPM:E,slippage:ge,slippageSource:(M==null?void 0:M.slippageFactor)!==void 0?"clutch.slippageFactor":(M==null?void 0:M.slippage)!==void 0?"clutch.slippage":n.clutchSlippage!==void 0?"vehicle.clutchSlippage":"default",vehicleClutchSlippage:n.clutchSlippage,isClutch:I,tractionIndex:dt.TractionIndex,trackTempEffect:Ct,pmi:{engine:k,trans:D,tires:fe},aero:{frontalArea:he.RefArea_ft2,cd:he.DragCoef,cl:he.LiftCoef},launchRPM:he.LaunchRPM,ycg:oe,staticFWt:Le,ags0:xt,tireSlipAtLaunch:Fe},result:{et:Zt,mph:st}};return{et_s:Zt,mph:st,timeslip:gt,traces:_r,meta:{model:"VB6Exact",steps:r.length,warnings:t},vb6Diagnostics:nt,debugData:xr}}const Qo="rsa.model.";function Jo(e){try{const t=Qo+e,r=localStorage.getItem(t);if(!r)return;const n=JSON.parse(r);if(!n.w||!n.P||typeof n.n!="number"){console.warn(`Invalid model structure for vehicle ${e}`);return}return n}catch(t){console.error(`Failed to load model for vehicle ${e}:`,t);return}}function Ko(e,t){if(t.length!==e.w.length)throw new Error(`Feature dimension mismatch: expected ${e.w.length}, got ${t.length}`);let r=0;for(let n=0;n<e.w.length;n++)r+=e.w[n]*t[n];return r}class Xo{constructor(){cr(this,"id","Blend")}simulate(t){const r=Zr.simulate(t),n=t.vehicle.id,o=Jo(n);let s=0;const i=[...r.meta.warnings];if(o){const _=[Rt(t.env)/1e3,t.vehicle.weightLb/3e3,t.vehicle.tireDiaIn/30,t.vehicle.rearGear/4,(r.et_s-10)/5];s=Ko(o,_)}else i.push("no_learned_model");const c=r.et_s*.8,a=r.et_s*1.2;return{et_s:Math.max(c,Math.min(a,r.et_s+s)),mph:r.mph,timeslip:r.timeslip,traces:r.traces,meta:{model:"Blend",steps:r.meta.steps,warnings:i}}}}const jo=new Xo;class Yo{constructor(){cr(this,"id","SimpleV1")}simulate(t){const r=Tn({vehicle:t.vehicle,env:t.env,raceLength:t.raceLength});return{et_s:r.baseET_s,mph:r.baseMPH,timeslip:r.timeslip,meta:{model:"SimpleV1",steps:r.timeslip.length,warnings:[]}}}}class Zo{constructor(){cr(this,"id","VB6Exact")}simulate(t){const r=Uo(t);return{...r,meta:{...r.meta,model:"VB6Exact"}}}}const zo={SimpleV1:new Yo,RSACLASSIC:Zr,VB6Exact:new Zo,Blend:jo};function sn(e){const t=zo[e];if(!t)throw new Error(`Unknown physics model: ${e}`);return t}function es(e){if(e!=null&&e.drivetrain){const t=e.drivetrain;t.shiftsRPM&&!t.shiftRPM&&(t.shiftRPM=t.shiftsRPM),t.overallEfficiency!==void 0&&t.overallEff===void 0&&(t.overallEff=t.overallEfficiency),t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}if(e!=null&&e.vehicle){const t=e.vehicle;t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}return e}function hr(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const n=Number(e.torque)*r/5252*t;return{rpm:r,hp:n}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const n=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:n}}return null}function ts(e){var n,o,s,i,c,a;if(Array.isArray((n=e==null?void 0:e.engineParams)==null?void 0:n.powerHP)&&e.engineParams.powerHP.length>=2)return e;const t=((o=e==null?void 0:e.fuel)==null?void 0:o.hpTorqueMultiplier)??1;let r=[];if(Array.isArray((s=e==null?void 0:e.vehicle)==null?void 0:s.hpCurve)&&e.vehicle.hpCurve.length>=2&&(r=e.vehicle.hpCurve.map(l=>hr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2&&Array.isArray(e==null?void 0:e.engineHP)&&e.engineHP.length>=2&&(r=e.engineHP.map(l=>Array.isArray(l)?{rpm:Number(l[0]),hp:Number(l[1])*t}:hr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2&&Array.isArray((i=e==null?void 0:e.engineParams)==null?void 0:i.torqueCurve)&&e.engineParams.torqueCurve.length>=2&&(r=e.engineParams.torqueCurve.map(l=>hr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2&&Array.isArray((c=e==null?void 0:e.vehicle)==null?void 0:c.torqueCurve)&&e.vehicle.torqueCurve.length>=2&&(r=e.vehicle.torqueCurve.map(l=>hr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2){const l=Number((a=e==null?void 0:e.vehicle)==null?void 0:a.powerHP);Number.isFinite(l)&&l>0&&(r=[{rpm:4e3,hp:l*.85*t},{rpm:5e3,hp:l*.92*t},{rpm:6e3,hp:l*.97*t},{rpm:6500,hp:l*1*t},{rpm:7e3,hp:l*.98*t},{rpm:7500,hp:l*.94*t},{rpm:8e3,hp:l*.88*t}])}return r.length>=2&&(e.engineParams={...e.engineParams??{},powerHP:r}),e}function rs(e){es(e),ts(e)}function ns(e){var o,s;if(!Array.isArray(e))return"none";const t=(o=e[0])==null?void 0:o.rpm,r=(s=e[e.length-1])==null?void 0:s.rpm;return`n=${e.length},first=${t},last=${r}`}self.onmessage=async e=>{var t,r,n,o,s,i,c,a,l;try{const u=e.data;if(!(u!=null&&u.model)||!(u!=null&&u.payload))throw new Error("Bad worker message");const h=JSON.parse(JSON.stringify(u.payload));if(u.model==="VB6Exact"){console.log("[WORKER:VB6Exact] Running with SimInputs format",{hasVehicle:!!h.vehicle,vehicleName:(t=h.vehicle)==null?void 0:t.name,powerHP:(r=h.vehicle)==null?void 0:r.powerHP,hasHpCurve:!!((n=h.vehicle)!=null&&n.hpCurve),raceLength:h.raceLength});const m=sn(u.model).simulate(h);self.postMessage({ok:!0,result:m});return}rs(h);const _=(o=h==null?void 0:h.engineParams)==null?void 0:o.powerHP;if(!Array.isArray(_)||_.length<2)throw console.error("[WORKER] bad powerHP",{hpLen:_==null?void 0:_.length,sample:(s=_==null?void 0:_.slice)==null?void 0:s.call(_,0,2)}),new Error("EngineParams must provide either torqueCurve or powerHP");Number.isFinite(h==null?void 0:h.raceLengthFt)||(h.raceLengthFt=(u==null?void 0:u.raceLengthFt)??1320);const g=(h==null?void 0:h.drivetrain)??{};console.log("[WORKER:normalized.input]",{hasEngineParams:!!h.engineParams,hasPowerHP:!!_,raceLengthFt:h.raceLengthFt,hpSummary:ns(_),hasClutch:!!g.clutch,hasConverter:!!g.converter,slipRPM:(i=g==null?void 0:g.clutch)==null?void 0:i.slipRPM,stallRPM:(c=g==null?void 0:g.converter)==null?void 0:c.stallRPM});try{h!=null&&h.tuning&&console.debug("[WORKER:TUNING]",!0,h.tuning)}catch{}h.flags===void 0&&(h.flags={}),h.flags.vb6Strict===void 0&&(h.flags.vb6Strict=((l=(a=u.payload)==null?void 0:a.flags)==null?void 0:l.vb6Strict)??!0);const M=sn(u.model).simulate(h);self.postMessage({ok:!0,result:M})}catch(u){console.error("[WORKER ERROR]",u),self.postMessage({ok:!1,error:String((u==null?void 0:u.message)||u)})}}})();
//# sourceMappingURL=index-B6usgr5p.js.map
