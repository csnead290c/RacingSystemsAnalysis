var ws=Object.defineProperty;var Is=(Ie,xe,wt)=>xe in Ie?ws(Ie,xe,{enumerable:!0,configurable:!0,writable:!0,value:wt}):Ie[xe]=wt;var nr=(Ie,xe,wt)=>Is(Ie,typeof xe!="symbol"?xe+"":xe,wt);(function(){"use strict";const Ie={EIGHTH:[60,330,660],THOUSAND:[60,330,660,1e3],QUARTER:[60,330,660,1e3,1320],ONE_MILE:[660,1320,2640,3960,5280],EL_MIRAGE:[660,1320,2640,3960,5280,6864],MUROC:[660,1320,2640,3960,5280,6600,7920],TWO_MILE:[660,1320,2640,5280,7920,10560],BONNEVILLE_SHORT:[660,1320,2640,5280,10560,15840],BONNEVILLE_LONG:[660,1320,2640,5280,10560,15840,21120,26400],TEN_MILE:[660,1320,2640,5280,10560,26400,52800]},xe={EIGHTH:{label:"1/8 Mile",shortLabel:"1/8",category:"drag",lengthFt:660,lengthMiles:.125},THOUSAND:{label:"1000 Foot",shortLabel:"1000'",category:"drag",lengthFt:1e3,lengthMiles:.189},QUARTER:{label:"1/4 Mile",shortLabel:"1/4",category:"drag",lengthFt:1320,lengthMiles:.25},ONE_MILE:{label:"One Mile Asphalt",shortLabel:"1 Mi",category:"landspeed",lengthFt:5280,lengthMiles:1},EL_MIRAGE:{label:"El Mirage Dry Lake",shortLabel:"El Mirage",category:"landspeed",lengthFt:6864,lengthMiles:1.3},MUROC:{label:"Muroc Dry Lake (EAFB)",shortLabel:"Muroc",category:"landspeed",lengthFt:7920,lengthMiles:1.5},TWO_MILE:{label:"Two Mile Asphalt",shortLabel:"2 Mi",category:"landspeed",lengthFt:10560,lengthMiles:2},BONNEVILLE_SHORT:{label:"Bonneville - 3 Miles",shortLabel:"BV 3Mi",category:"landspeed",lengthFt:15840,lengthMiles:3},BONNEVILLE_LONG:{label:"Bonneville - 5 Miles",shortLabel:"BV 5Mi",category:"landspeed",lengthFt:26400,lengthMiles:5},TEN_MILE:{label:"Ten Mile Test Track",shortLabel:"10 Mi",category:"landspeed",lengthFt:52800,lengthMiles:10}};function wt(e){const r=e.elevation+(29.92-e.barometerInHg)*1e3,o=59-r/1e3*3.5,s=(e.temperatureF-o)*120,n=e.humidityPct/10*50*(e.temperatureF/80);return r+s+n}function mo(e){const r=.0061*Math.exp(17.27*(e.temperatureF-32)/1.8/(237.3+(e.temperatureF-32)/1.8))*(e.humidityPct/100),o=7e3*.622*(r/(e.barometerInHg-r));return Math.max(0,Math.min(o,500))}function Mo(e){const o=518.6700000000001,s=e.temperatureF+459.67,n=e.barometerInHg/29.92,i=o/s;let c=n*i;const l=1-mo(e)/5e3;return c*=l,Math.max(.7,Math.min(c,1.15))}function Po(e){const{vehicle:t,env:r,raceLength:o}=e;if(t.weightLb<=0||t.powerHP<=0)throw new Error("Invalid vehicle params");const s=Ie[o];if(!s)throw new Error(`Invalid race length: ${o}`);const n=Mo(r),i=t.powerHP*n,c=Math.max(1,i),a=Math.max(1,t.weightLb),l=5.825*Math.cbrt(a/c),u=234*Math.cbrt(c/a),h=l*.64,d=u*.8;let g,_;if(o==="EIGHTH"?(g=h,_=d):(g=l,_=u),!Number.isFinite(g)||!Number.isFinite(_))throw new Error("Invalid ET or MPH calculation");const M=5.825*Math.cbrt(a/Math.max(1,t.powerHP)),p=g-M,m={60:.16,330:.44,660:.79,1e3:.93,1320:1},R=s.map(C=>{const y=m[C]??1,w=g*y,S=C/s[s.length-1],j=_*S;return{d_ft:C,t_s:Math.max(0,w),v_mph:Math.max(0,j)}}),A=[{name:"Weather (HP)",delta_s:p}];return{baseET_s:Math.max(0,g),baseMPH:Math.max(0,_),timeslip:R,factors:A}}function To(e){return e/32.174}function So(e,t,r){return e+(t-e)*r}function Ro(e){var r;const t=(Array.isArray(e)?e:e==null?void 0:e.powerHP)??((r=e==null?void 0:e.engineParams)==null?void 0:r.powerHP);if(!Array.isArray(t)||t.length<2){const o=e&&typeof e=="object"?Object.keys(e):[];throw new Error(`EngineParams must provide either torqueCurve or powerHP (got keys=${JSON.stringify(o)}, len=${(t==null?void 0:t.length)??0})`)}return t}function Sr(e,t){const r=Ro(t);if(e<=r[0].rpm)return r[0].hp;if(e>=r[r.length-1].rpm)return r[r.length-1].hp;let o=0,s=r.length-1;for(;s-o>1;){const a=o+s>>1;r[a].rpm<=e?o=a:s=a}const n=r[o],i=r[s],c=(e-n.rpm)/(i.rpm-n.rpm);return n.hp+c*(i.hp-n.hp)}function sr(e,t,r){if("corr"in t&&typeof t.corr=="number"){const n=t;let i;if(n.torqueCurve&&n.torqueCurve.length>0)i=Fo(e,n.torqueCurve);else if(n.powerHP!==void 0){const a=Math.max(e,1e3);i=n.powerHP*5252/a}else throw new Error("EngineParams must provide either torqueCurve or powerHP");return i*n.corr}const o=Sr(e,t);return(e>0?5252*o/e:0)*(Number.isFinite(r)?r:1)}function Fo(e,t){const o=[...t.map(s=>{if(s.tq_lbft!==void 0)return{rpm:s.rpm,tq_lbft:s.tq_lbft};if(s.hp!==void 0&&s.rpm>0)return{rpm:s.rpm,tq_lbft:s.hp*5252/s.rpm};throw new Error(`Invalid torque curve point: ${JSON.stringify(s)}`)})].sort((s,n)=>s.rpm-n.rpm);if(e<=o[0].rpm)return o[0].tq_lbft;if(e>=o[o.length-1].rpm)return o[o.length-1].tq_lbft;for(let s=0;s<o.length-1;s++){const n=o[s],i=o[s+1];if(e>=n.rpm&&e<=i.rpm){const c=(e-n.rpm)/(i.rpm-n.rpm);return So(n.tq_lbft,i.tq_lbft,c)}}return o[o.length-1].tq_lbft}const T=e=>Math.fround(e),L={add:(e,t)=>Math.fround(Math.fround(e)+Math.fround(t)),sub:(e,t)=>Math.fround(Math.fround(e)-Math.fround(t)),mul:(e,t)=>Math.fround(Math.fround(e)*Math.fround(t)),div:(e,t)=>Math.fround(Math.fround(e)/Math.fround(t)),sqrt:e=>Math.fround(Math.sqrt(Math.fround(e))),pow:(e,t)=>Math.fround(Math.pow(Math.fround(e),Math.fround(t))),exp:e=>Math.fround(Math.exp(Math.fround(e))),log:e=>Math.fround(Math.log(Math.fround(e))),clamp:(e,t,r)=>Math.fround(Math.min(Math.max(Math.fround(e),Math.fround(t)),Math.fround(r))),abs:e=>Math.fround(Math.abs(Math.fround(e))),neg:e=>Math.fround(-Math.fround(e))};function Nr(e,t=0){const r=Math.pow(10,t),o=Math.fround(e*r),s=Math.floor(o),n=o-s;return n>.5?(s+1)/r:n<.5?s/r:(s%2===0?s:s+1)/r}function bo(e,t,r,o,s){const n=T(e),i=T(t),c=T(r),a=T(o),l=T(s);if(c===i)return a;const u=L.div(L.sub(n,i),L.sub(c,i));return L.add(a,L.mul(u,L.sub(l,a)))}function Eo(e,t){if(t.length===0)return T(0);if(t.length===1)return T(t[0][1]);const r=T(e);if(r<=T(t[0][0]))return T(t[0][1]);if(r>=T(t[t.length-1][0]))return T(t[t.length-1][1]);for(let o=0;o<t.length-1;o++){const s=T(t[o][0]),n=T(t[o+1][0]);if(r>=s&&r<=n)return bo(r,s,n,t[o][1],t[o+1][1])}return T(t[t.length-1][1])}function Ao(e){return Array.isArray(e==null?void 0:e.ratios)&&e.ratios.length>0?e.ratios:Array.isArray(e==null?void 0:e.gearRatios)&&e.gearRatios.length>0?e.gearRatios:[]}function wo(e,t,r,o=0){const s=(r.tireDiaIn??28)/12,n=Math.PI*s,c=e/n*60,a=Ao(r),l=a.length>0?a[Math.min(t,a.length-1)]??1:1;return c*l*(r.finalDrive??3.73)*(1+o)}function Io(){return{t_s:0,v_fps:0,s_ft:0,rpm:0,gearIdx:0,warnings:[]}}const je=3.141593,I=32.174,Rr=60/(2*je)*550,Fr=519.67,Dr=14.696,xo=29.92,br=28.9669,Gr=18.016,kr=1545.32,ir=3600/5280,Er=.025,vo=.01,Wr=.03,Co=0,yo=9.7,Ho=1.01,Lo=0,No=0,pe=.004,It=-4,xt=2,Or=.92,qr=1.08,Vr=.15,Br=.25,Do=1.03,Go=10.8,de=3600/5280,ko=459.67,Wo=I;function Oo(e){const{engineTorque_lbft_atSlip:t,gearRatio:r,transEff:o,drivelineEff:s,finalDrive:n,tireDia_in:i,tireSlip:c,dragForce_lbf:a,vehicleWeight_lbf:l,isAutoTrans:u,torqueMult:h=1}=e,d=t*h*r*o,g=i/24,M=d*n*s/(c*g)-a;return{Ags0_ftps2:(u?.96:.88)*(M/l)*I,netThrust_lbf:M,wheelTorque_lbft:d}}function $r(e){const t=e.elevation_ft??0,r=e.fuelSystem??1,o=[.0205558,.00118163,154988e-10,40245e-11,434856e-15,2096e-14],s=o[0]+o[1]*e.temperature_F+o[2]*e.temperature_F**2+o[3]*e.temperature_F**3+o[4]*e.temperature_F**4+o[5]*e.temperature_F**5,n=e.relHumidity_pct/100*s,i=Math.pow((Fr-.00356616*t)/Fr,5.25588),c=Dr*e.barometer_inHg/xo*i,a=c-n,l=a/Dr,u=n*Gr/(a*br),h=kr*(1/br+u/Gr)/(1+u),d=h/(kr/br),g=e.temperature_F+ko,_=g/Fr,p=144*c/(h*g)/32.174;let m,R;switch(r){case 1:m=1,R=1;break;case 2:m=1,R=2;break;case 3:m=2,R=1;break;case 4:m=2,R=2;break;case 5:m=3,R=2;break;case 6:m=1,R=3;break;case 7:case 9:m=2,R=3;break;case 8:m=3,R=3;break;default:m=1,R=1;break}const A=1+2.48*Math.pow(u,1.5);let C,y,w;switch(m){case 1:C=1,y=.6,w=.15;break;case 2:C=1,y=.3,w=.13;break;case 3:C=.85,y=.5,w=.055;break;default:C=1,y=.6,w=.15;break}if(R===2&&(w=w-.005),R===3){const j=.3050108932461874;C=.95-j*y,y=y+j,w=.6*w}let S=Math.pow(l,C)/(Math.sqrt(d)*Math.pow(_,y));return S=(1+w)*A/S-w,r===9&&(S=1),{rho_slug_per_ft3:p,pamb_psi:c,PWV_psi:n,pair_psi:a,WAR:u,RGAS:h,temp_R:g,hpc:S,delta:l,theta:_,rgrs:d}}function qo(e,t,r,o=.025,s=.01){const n=o-r/1320*s,i=3600/5280,c=n*e,a=1e-4*e*(i*t);return c+a}function Vo(e,t,r,o,s=.025,n=.01){return qo(e,t,r,s,n)*o}function Bo(e,t,r,o,s=1){let n=t,i=o*e/n;s>2&&i>.6&&(n=n*(1+(o-1)*(i-.6)/(1/o-.6)),i=o*e/n);let c=1/o,a=o*e,l=1;return a<n&&(a=n,l=r-(r-1)*i,c=l*e/n),c>1&&(c=1),{work:l,coupling:c,slipRatio:i,zStall:n,engRPM:a}}const $o=10.8;function Ur(e){const{tireDia_in:t,tireWidth_in:r,dynamicRWT_lbf:o,tractionIndexAdj:s,bodyStyle:n}=e,i=.92+.08*Math.pow(o/1900,2.15);let c=s*$o*t*(r+1)*i;return n===8&&(c=.5*c),c}function Uo(e){const{weight_lbf:t,tireGrowth:r,dragForce_lbf:o}=e;return(Ur(e)/r-o)/t*I}function Jo(){return pe*I}function Qo(e,t,r,o){let s=e,n=t,i=0;return s>o&&(i=1,n=n*(o-(s-o))/s,s=o-(s-o)),s<r&&(n=n*r/s,s=r),{AGS:s,PQWT:n,SLIP:i}}function Ko(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function Xo(e,t,r,o){return e+t*Math.pow(r*o,2)}function jo(e,t,r){return e*t*60/r}function Yo(e,t,r,o,s=!0){let n=o*t*(t-e);n<0&&(n=s?Vr*n:Br*n);const i=Math.pow(2*je/60,2)/(12*550*r);return n*i}function Zo(e,t,r,o){let s=o*t*(t-e);s<0&&(s=0);const n=Math.pow(2*je/60,2)/(12*550*r);return s*n}function zo(e,t,r,o){const s=Math.PI,n=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));let i=1+n*135e-7*Math.pow(r,1.6);const c=1+n*35e-5*r;c<i&&(i=c);const a=o/32.174,l=i-.035*Math.abs(a),u=l*e*s/12,h=12*u/(2*s),d=2*h,g=h/12;return{growth:i,squat:l,dia_eff_in:d,radius_eff_ft:g,circumference_eff_ft:u}}function en(e,t,r,o,s){const a=(t-1)*r/2*o*(s?1:2)/144;return e+a}function tn(e,t,r,o){if(e>=t-1)return!1;const s=o[e];if(!s||s<=0)return!1;const i=(o[0]??0)>8e3?20:10;return Math.abs(s-r)<i}var Jr=(e=>(e[e.NORMAL=0]="NORMAL",e[e.TRIGGERED=1]="TRIGGERED",e[e.EXECUTING=2]="EXECUTING",e))(Jr||{});function rn(e,t){switch(e){case 0:return t?{newState:1,executeShift:!1}:{newState:0,executeShift:!1};case 1:return{newState:2,executeShift:!0};case 2:return{newState:0,executeShift:!1};default:return{newState:0,executeShift:!1}}}function on(e){return e?.2:.25}function nn(e,t,r,o){return r>=o||!t||t<=0?!1:L.sub(T(e),T(t))>=0}function sn(e,t=3,r=1){const o=.005*(t-1)+3*(r-1),s=e/1320;return 1.02+o*(1-Math.pow(s,2))}function ln(e,t,r,o,s,n,i=.04,c=.9){const a=e*t*(r-o+i/c*o),l=n*r;return(a+l)/s}function cn(e,t,r,o,s,n,i,c,a=.04,l=.9){const u=ln(r,e,o,s,n,i,a,l);let h=t-u,d=0;h<0&&(d=-h*n/64,h=0);let g=c-h-d;return g<0&&(g=e),{rear_weight_lbf:g,front_weight_lbf:h,wheelie_bar_weight_lbf:d}}function an(e,t,r,o){const s=2*o*r,n=Math.sqrt(e*e+s),i=2*o*r+e*e,c=Math.pow(i,1.5),a=Math.pow(e,3),l=(c-a)/(3*o)+t;return{Vel_ftps:n,Dist_ft:l}}function fn(e,t,r){let o=e,s=1,n=0;if(o>r){n=1;const i=o-r,c=r-i;s=c/o,o=c}return o<t&&(s=t/o,o=t),{AGS_ftps2:o,PQWT_scale:s,slip:n}}function un(e,t){return e/(t*I)}function hn(e,t,r){if(r<=0)return Math.max(.005,Math.min(.05,e));let o=e*Math.pow(t/r,4);return o>.05&&(o=.05),o<.005&&(o=.005),o}function _n(e,t,r,o){const s=t*r/o;let n=e*.11*Math.pow(s,-1/3);return n=n/15,n<.005&&(n=.005),n}function dn(e){if(!e)return 1;const t=e.toUpperCase();return t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")||t.includes("FUEL INJECT")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function gn(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const o=Number(e.torque)*r/5252*t;return{rpm:r,hp:o}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const o=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:o}}return null}function Bt(e,t=1){return e.map(r=>Array.isArray(r)?{rpm:Number(r[0]),hp:Number(r[1])*t}:gn(r,t)).filter(r=>r!==null&&Number.isFinite(r.rpm)&&Number.isFinite(r.hp)).sort((r,o)=>r.rpm-o.rpm)}function pn(e){var a,l,u,h,d;const t=((a=e==null?void 0:e.fuel)==null?void 0:a.hpTorqueMultiplier)??1,r=[],o=(l=e==null?void 0:e.engineParams)==null?void 0:l.powerHP;if(Array.isArray(o)&&(r.push(`engineParams.powerHP(${o.length})`),o.length>=2)){const g=Bt(o,t);if(g.length>=2)return{powerHP:g}}const s=e==null?void 0:e.engineHP;if(Array.isArray(s)&&(r.push(`engineHP(${s.length})`),s.length>=2)){const g=Bt(s,t);if(g.length>=2)return{powerHP:g}}const n=(u=e==null?void 0:e.engineParams)==null?void 0:u.torqueCurve;if(Array.isArray(n)&&(r.push(`engineParams.torqueCurve(${n.length})`),n.length>=2)){const g=Bt(n,t);if(g.length>=2)return{powerHP:g}}const i=(h=e==null?void 0:e.vehicle)==null?void 0:h.torqueCurve;if(Array.isArray(i)&&(r.push(`vehicle.torqueCurve(${i.length})`),i.length>=2)){const g=Bt(i,t);if(g.length>=2)return{powerHP:g}}const c=(d=e==null?void 0:e.vehicle)==null?void 0:d.hpCurve;if(Array.isArray(c)&&(r.push(`vehicle.hpCurve(${c.length})`),c.length>=2)){const g=Bt(c,t);if(g.length>=2)return{powerHP:g}}throw new Error(`RSACLASSIC: missing power curve. Sources found: [${r.join(", ")||"none"}]. Keys(engineParams)=${JSON.stringify(Object.keys((e==null?void 0:e.engineParams)||{}))} Keys(vehicle)=${JSON.stringify(Object.keys((e==null?void 0:e.vehicle)||{}))}`)}function ve(e,t=0){return Number.isFinite(e)?Number(e):t}function Qr(e,t){const r=t.map(o=>[o.rpm,o.hp]);return Eo(e,r)}function Kr(e,t,r){const o=Qr(e,t);if(e<=0)return T(0);const s=L.div(L.mul(T(5252),o),T(e));return L.mul(s,T(r))}function mn(e,t,r,o=t){const s=Number(e);return Number.isFinite(s)?Math.min(r,Math.max(t,s)):o}function Mn(e){return Math.max(.85,Math.min(1,e))}class Pn{constructor(){nr(this,"id","RSACLASSIC")}simulate(t){var jt,B,$,Ue,Ee,bt,_r,ro;const r=!!((jt=t==null?void 0:t.flags)!=null&&jt.vb6Strict);r&&console.log("[RSACLASSIC] VB6-STRICT mode enabled - using Float32 math");const o=Date.now(),s=9e4,n=2e6,i=5e4;let c=0;function a(x,k){if(Date.now()-o>s)throw new Error("simulation wall-time exceeded");if(x>=n)throw new Error("simulation step cap hit");if(x%i===0){const Ge=k-c;if(console.log("[RSACLASSIC] heartbeat",{step:x,dist_ft:k,gained_ft:Ge}),x>0&&Ge<.001)throw new Error("simulation stalled");c=k}}const l=Number((t==null?void 0:t.raceLengthFt)??1320);if(!Number.isFinite(l)||l<=0)throw new Error(`invalid raceLengthFt: ${t==null?void 0:t.raceLengthFt}`);const u=Number((t==null?void 0:t.timeStep)??.002);if(!Number.isFinite(u)||u<=0)throw new Error(`invalid timeStep ${u}`);const d=pn(t).powerHP;if(console.log("[RSACLASSIC] start",{raceLenFt:l,hpPts:d.length}),!Array.isArray(d)||d.length<2)throw new Error(`RSACLASSIC: powerHP invalid (len=${(d==null?void 0:d.length)??0})`);const g=(t==null?void 0:t.drivetrain)??{},_=(t==null?void 0:t.vehicle)??{},M=g.clutch??(t==null?void 0:t.clutch)??_.clutch,p=g.converter??(t==null?void 0:t.converter)??_.converter,m=!!M,R=!!p,A=m?Number(M.slipRPM??M.slipRpm):NaN,C=m?Number(M.launchRPM??M.launchRpm):NaN,y=R?Number(p.stallRPM??p.stallRpm):NaN,w=m?Number(M.slippageFactor??M.slipRatio??1.0025):1,S=R?Number(p.slippageFactor??p.slipRatio??1.05):1;if(!m&&!R)throw new Error("RSACLASSIC: drivetrain must specify clutch or converter");if(m&&!Number.isFinite(A))throw new Error("RSACLASSIC: clutch.slipRPM missing/invalid");if(R&&!Number.isFinite(y))throw new Error("RSACLASSIC: converter.stallRPM missing/invalid");const j=m?Number.isFinite(C)?C:A:y;console.log("[RPM-RESOLVED]",{isClutch:m,isConverter:R,slipRPM:A,launchRPM:C,stallRPM:y,rpmPin:j});const me=(t==null?void 0:t.tuning)??{},Oe=Number.isFinite(me.aeroCdScale)?me.aeroCdScale:1,Ye=Number.isFinite(me.drivelineEffOffset)?me.drivelineEffOffset:0,{vehicle:P,env:Q,raceLength:Ce}=t,q=[],Z=Ce==="EIGHTH"?660:1320,qe=P.cd,ye=P.frontalArea_ft2,z=P.transEff,se=P.finalDrive??P.rearGear,Y=P.gearRatios,ee=P.gearEff,re=P.shiftRPM;qe||q.push("Missing vehicle.cd (drag coefficient) - required for VB6 parity"),ye||q.push("Missing vehicle.frontalArea_ft2 - required for VB6 parity"),(!Y||Y.length===0)&&q.push("Missing vehicle.gearRatios[] - required for VB6 parity"),(!re||re.length===0)&&q.push("Missing vehicle.shiftRPM[] - required for VB6 parity"),se||q.push("Missing vehicle.finalDrive or vehicle.rearGear - required for VB6 parity"),Q.barometerInHg===void 0&&q.push("Missing env.barometerInHg - required for VB6 air density"),Q.temperatureF===void 0&&q.push("Missing env.temperatureF - required for VB6 air density"),Q.humidityPct===void 0&&q.push("Missing env.humidityPct - required for VB6 air density"),Q.elevation===void 0&&q.push("Missing env.elevation - required for VB6 air density");const Me=P.tireRolloutIn??null,Ze=P.tireDiaIn??null,ze=Math.PI;let b=(typeof Me=="number"&&Me>0?Me/ze:null)??Ze??0;(!b||b<=0)&&(q.push("Tire diameter is undefined/invalid. Provide tireRolloutIn or tireDiaIn."),b=28);const he=P.rolloutIn;he||q.push("Missing vehicle.rolloutIn - required for VB6 parity");const ie=t.fuel,D=dn(ie),le=$r({barometer_inHg:Q.barometerInHg??29.92,temperature_F:Q.temperatureF??59,relHumidity_pct:Q.humidityPct??50,elevation_ft:Q.elevation??0,fuelSystem:D}).rho_slug_per_ft3,et=To(P.weightLb),Pe=(he??12)/12;let ce=null,v=0;const ae=30,tt=.01,Ct=d.reduce((x,k)=>Math.max(x,k.hp),0),gt=p?p.torqueMult??1.7:1,He=(P.rolloutIn??12)/12,Te=_n(He>0?He:1,Ct,gt,P.weightLb);let Se=0,E=Te,f=Io(),fe=0;const pt=[];let rt=0,ot=0,Le=0;const mt=[];let yt=!1,Mt=0;const oe=[60,330,660,1e3,Z];let Ht=0,nt=0,Be=0,$t=0,F=0,ar=0,fr=0,$e=0,Pt=1,Ut;f.rpm=j;const st=t.fuel;let Tt=1,it=1,lt=0,Re=0,Fe=0,be=0,St=0,Rt=0,Lt=0,Jt=0,Qt=0,Ne=0;if(M||p){const x=sr(j,d,z??.9),k=j>0?x*j/5252:0,De=k>0&&j>0?5252*k/j:0,Ge=(Y??[1])[0]??1,ge=De*Ge*(z??.9)*(se??3.73)*(z??.9)/(1.02*b/24);Ne=(p?.96:.88)*ge/P.weightLb,Ne<pe&&(Ne=pe)}const ur=6,hr=5;let ct=j,at=0,Kt=Jr.NORMAL,ft=0,Xt=0;const H=x=>ee&&ee[x]!==void 0?Math.max(.9,Math.min(1,ee[x])):z??.9,ue=()=>{const x=g.overallEff??g.overallEfficiency??z??.97;return Mn(x+Ye)},O=x=>{const k=Q.tractionIndex??3;return sn(x,k,1)};for(;;){v++,a(v,f.s_ft);const x=zo(b,P.tireWidthIn??17,f.v_fps,Ne),k=x.radius_eff_ft,De=x.circumference_eff_ft,Ge=x.dia_eff_in;let Nt=wo(f.v_fps,f.gearIdx,g),Dt=Nt,ge=1,dr=0,oo=0,no=0;const ke=H(f.gearIdx);r?Kr(Nt,d,ke):sr(Nt,d,ke);let Yt=1;if(st==="METHANOL"){const W=Q.trackTempF;W!==void 0&&W<80&&f.t_s<.8&&(Yt=1.025-.025*f.t_s/.8)}else if(st==="NITRO"){if(f.t_s<.4)Yt=.9;else if(f.t_s<1){const W=(f.t_s-.4)/.6;Yt=.9+(1-.9)*W}}Tt=Math.min(Tt,Yt),it=Math.max(it,Yt);const Zt=(Y??[1])[f.gearIdx]??1,wr=O(f.s_ft)*f.v_fps*60/De;v===1&&typeof console<"u"&&console.debug&&console.debug("[RPM-DEBUG]",{isClutch:m,isConverter:R,slipRPM:A,launchRPM:C,stallRPM:y,calculated_slipRPM:A,rpm_from_speed:Nt});const ut=wr*Zt*(se??3.73);let X=(m?w:S)*ut;const ns=f.gearIdx===0,ss=!0,zt=m?A:y;(m||R)&&(ns||ss)&&X<zt&&(X=zt);const gr=X===zt&&ut<zt,so=zt;if(Dt=X,r?Kr(X,d,ke):sr(X,d,ke),M)ge=X>1?Math.max(0,Math.min(1,ut/X)):0,Pt=Math.min(Pt,ge);else if(p){const W=p.torqueMult??2,U=Bo(ut,y,W,S,v);ge=U.coupling,dr=U.work,oo=U.slipRatio,no=U.zStall,F+=U.work,ar+=U.coupling,fr+=U.slipRatio,$e++,Pt=Math.min(Pt,ge)}else Dt=Nt;f.rpm=Dt;const Gt=ve(f.v_fps,0),io=Q.windMph??0,is=Q.windAngleDeg??0,Ir=io/de,ls=is*Math.PI/180,cs=Math.sqrt(Gt*Gt+2*Gt*Ir*Math.cos(ls)+Ir*Ir),as=P.bodyStyle===8,pr=en(ye??0,x.growth,b,P.tireWidthIn??17,as);let mr,Et,er,Mr;const xr=io!==0?cs:Gt;if(r){const W=T(xr);mr=L.mul(W,W),Et=L.mul(L.mul(T(.5),T(le)),mr),er=L.mul(L.mul(L.mul(Et,T(qe??0)),T(Oe)),T(pr)),Mr=L.mul(L.mul(Et,T(P.liftCoeff??0)),T(pr))}else mr=xr*xr,Et=ve(.5*le*mr,0),er=ve(Et*(qe??0)*Oe*pr,0),Mr=ve(Et*(P.liftCoeff??0)*pr,0);const vr=ve(P.weightLb-Mr,P.weightLb),At=er,fs=vr,us=P.rrCoeff??Er,hs=Vo(fs,Gt,f.s_ft,k,us,.01),Je=ve(hs/k,0),_s=1,ds=Q.tractionIndex??3,Cr=Ko(ds,_s),gs=v===1?0:Qt,ps=P.wheelbaseIn??108,ms=b/2+3.75,Ms=P.staticFrontWeightLb??P.weightLb*.38,tr=cn(P.weightLb,Ms,gs,ms,k*12,ps,At+Je,vr,1.03,ue()),kt=tr.rear_weight_lbf,Qe=Uo({weight_lbf:P.weightLb,tireDia_in:b,tireWidth_in:P.tireWidthIn??17,dynamicRWT_lbf:kt,tractionIndexAdj:Cr,tireGrowth:x.growth,dragForce_lbf:At+Je,bodyStyle:void 0}),Ae=Jo();if(v<=12&&typeof console<"u"&&console.log){const W=Ur({weight_lbf:P.weightLb,tireDia_in:b,tireWidth_in:P.tireWidthIn??17,dynamicRWT_lbf:kt,tractionIndexAdj:Cr,bodyStyle:void 0});console.log("[TRACTION]",{step:v,CAXI:+Cr.toFixed(4),AX:10.8,tireDia_in:+b.toFixed(2),tireWidth_in:+(P.tireWidthIn??17).toFixed(1),dynamicRWT_lbf:+kt.toFixed(1),weightFactor:+(.92+.08*Math.pow(kt/1900,2.15)).toFixed(4),CRTF:+W.toFixed(1),tireGrowth:+x.growth.toFixed(4),dragForce_lbf:+(At+Je).toFixed(2),AMin_ftps2:+Ae.toFixed(3),AMax_ftps2:+Qe.toFixed(3),AMin_g:+(Ae/I).toFixed(4),AMax_g:+(Qe/I).toFixed(4)})}let ne,we;if(v<=ur&&ut<hr){const W=sr(j,d,ke),U=R?p.torqueMult??2:1,te=Oo({engineTorque_lbft_atSlip:W,gearRatio:Zt,transEff:ke,drivelineEff:ue(),finalDrive:se??3.73,tireDia_in:b,tireSlip:O(f.s_ft),dragForce_lbf:At+Je,vehicleWeight_lbf:P.weightLb,isAutoTrans:!!p,torqueMult:U});we=te.netThrust_lbf/P.weightLb*I;const _t=Qo(te.Ags0_ftps2,we,Ae,Qe);if(ne=_t.AGS,we=_t.PQWT,v<=10&&typeof console<"u"&&console.debug){const dt=te.Ags0_ftps2/I,rr=Zt*(se??3.73);console.debug("[STEP]",{step:v,phase:gr?"PINNED":"BOOTSTRAP",v_fps:f.v_fps.toFixed(6),EngRPM:Dt.toFixed(0),LockRPM:ut.toFixed(2),slipRPM:A.toFixed(0),lockThreshold:so.toFixed(0),rpmIsPinned:gr,clutchSlip:ge.toFixed(6),gear:f.gearIdx+1,GRxFD:rr.toFixed(3),tireDia_eff_in:Ge.toFixed(2),tireGrowth:x.growth.toFixed(4),tireSlip:O(f.s_ft).toFixed(4),RWTdyn_lbf:kt.toFixed(1),RWTfront_lbf:tr.front_weight_lbf.toFixed(1),wheelieBar_lbf:tr.wheelie_bar_weight_lbf.toFixed(1),AGS_g:dt.toFixed(4),AGS_ftps2:ne.toFixed(4),AMin_ftps2:Ae.toFixed(4),AMax_ftps2:Qe.toFixed(4),SLIP:_t.SLIP})}}else{let W=r?Qr(X,d):Sr(X,d);ft>0&&(W=0,ft=Math.max(0,ft-E),ft===0&&typeof console<"u"&&console.debug&&console.debug("[SHIFT_DWELL_END]",{step:v,t_s:f.t_s.toFixed(4),v_fps:f.v_fps.toFixed(2)}));const U=W,te=r?L.div(L.mul(L.add(T(At),T(Je)),T(f.v_fps)),T(550)):(At+Je)*f.v_fps/550;v<=12&&typeof console<"u"&&console.log&&console.log("[PRE_HP_CHAIN]",{step:v,EngRPM_out:+X.toFixed(0),wheelRPM:+wr.toFixed(2),ClutchSlip:+ge.toFixed(4),...p?{converterWork:+dr.toFixed(4)}:{},HPSave:+U.toFixed(1),DragHP:+te.toFixed(2),F_drag_lbf:+er.toFixed(2),F_roll_lbf:+Je.toFixed(2),v_fps:+f.v_fps.toFixed(2),tireSlip:+O(f.s_ft).toFixed(4),currentGearEff:+ke.toFixed(4),drivelineEff:+ue().toFixed(4),dt_s:+E.toFixed(4),RPM0:+ct.toFixed(0),DSRPM0:+at.toFixed(2)});const _t=jo(O(f.s_ft),f.v_fps,De);let dt,rr,Pr;if(((B=P.pmi)==null?void 0:B.engine_flywheel_clutch)!==void 0)dt=P.pmi.engine_flywheel_clutch,rr=P.pmi.transmission_driveshaft??0,Pr=P.pmi.tires_wheels_ringgear??0;else{dt=500/120;const We=(Y==null?void 0:Y.length)??5;rr=m?We*dt/50:(We-1)*dt/10,Pr=2*(1.15*.8*(.08*b*(P.tireWidthIn??17))*Math.pow(b/2,2)/386)}const ho=Xo(Pr,rr,se??3.73,Zt),Wt=Yo(ct,X,E,dt,m),Ot=Zo(at,_t,E,ho);v<=12&&typeof console<"u"&&console.log&&console.log("[PMI_CALC]",{step:v,EngRPM:+X.toFixed(0),RPM0:+ct.toFixed(0),RPM_delta:+(X-ct).toFixed(0),DSRPM:+_t.toFixed(2),DSRPM0:+at.toFixed(2),DSRPM_delta:+(_t-at).toFixed(2),enginePMI:+dt.toFixed(3),chassisPMI:+ho.toFixed(3),HPEngPMI:+Wt.toFixed(1),HPChasPMI:+Ot.toFixed(1)}),ct=X,at=_t,St+=Wt*550*E,Rt+=Ot*550*E;let qt,Ke;const _o=O(f.s_ft);if(r){qt=L.mul(L.sub(T(U),T(Wt)),T(ge)),Ke=qt;const Vt=L.mul(L.mul(T(Ke),T(ke)),T(ue())),We=L.sub(Vt,T(Ot)),Xe=L.div(We,T(_o));Ke=L.sub(Xe,T(te))}else qt=(U-Wt)*ge,Ke=qt,Ke=(Ke*ke*ue()-Ot)/_o-te;const Hr=Ke;rt=U,ot=Hr,Le=te,we=r?L.div(L.mul(L.mul(T(550),T(I)),T(Ke)),T(P.weightLb)):550*I*Ke/P.weightLb;let Tr=un(we,f.v_fps);if(E>0&&E<=.01&&v>1){const Vt=Tr/I,We=Ne/I;let Xe=(Vt-We)/E;if(Xe<It){Xe=It;const or=We+Xe*E;Tr=or*I,we=or*I*f.v_fps}if(Xe>xt){Xe=xt;const or=We+Xe*E;Tr=or*I,we=or*I*f.v_fps}}const Lr=fn(Tr,Ae,Qe);ne=Lr.AGS_ftps2,we=we*Lr.PQWT_scale;const As=Lr.slip;ne=mn(ne,Ae,Qe,Ae);const go=ne/I;go>Se&&(Se=go);const po=Ne/I;if(po>0&&v>1&&(E=hn(Te,Se,po)),v<=12&&typeof console<"u"&&console.log&&console.log("[CONSOLIDATED_ROW]",{step:v,v_ftps:+f.v_fps.toFixed(3),EngRPM:+X.toFixed(0),wheelRPM:+wr.toFixed(2),ClutchSlip:+ge.toFixed(4),HPSave:+U.toFixed(1),HPEngPMI:+Wt.toFixed(1),HPChasPMI:+Ot.toFixed(1),DragHP:+te.toFixed(2),HP_afterL1:+qt.toFixed(1),HP_afterL2:+Hr.toFixed(1),PQWT:+we.toFixed(1),AMin:+Ae.toFixed(3),AMax:+Qe.toFixed(3),AGS_applied:+ne.toFixed(3)}),v<=20&&typeof console<"u"&&console.log&&console.log("[AERO_TRACE]",{step:v,v_fps:+Gt.toFixed(6),rho_slug_per_ft3:+le.toFixed(6),q_psf:+Et.toFixed(3),F_drag_lbf:+er.toFixed(2),F_lift_up_lbf:+Mr.toFixed(2),normal_lbf:+vr.toFixed(2),F_roll_lbf:+Je.toFixed(2),AMin_ftps2:+Ae.toFixed(3),AMax_ftps2:+Qe.toFixed(3),AGS_ftps2:+ne.toFixed(3)}),v<=10&&typeof console<"u"&&console.debug){const Vt=ne/I,We=Zt*(se??3.73);console.debug("[STEP]",{step:v,phase:gr?"PINNED":"HP",v_fps:f.v_fps.toFixed(6),EngRPM:Dt.toFixed(0),LockRPM:ut.toFixed(2),slipRPM:A.toFixed(0),lockThreshold:so.toFixed(0),rpmIsPinned:gr,clutchSlip:ge.toFixed(6),gear:f.gearIdx+1,GRxFD:We.toFixed(3),tireDia_eff_in:Ge.toFixed(2),tireGrowth:x.growth.toFixed(4),tireSlip:O(f.s_ft).toFixed(4),RWTdyn_lbf:kt.toFixed(1),RWTfront_lbf:tr.front_weight_lbf.toFixed(1),wheelieBar_lbf:tr.wheelie_bar_weight_lbf.toFixed(1),rho_slug_ft3:le.toFixed(6),dragHP:te.toFixed(2),...p?{converterWork:dr.toFixed(4),converterSlipRatio:oo.toFixed(4),converterZStall:no.toFixed(0)}:{},HP_engine:U.toFixed(1),HPEngPMI:Wt.toFixed(1),HPChasPMI:Ot.toFixed(1),HP_afterLine1:qt.toFixed(1),HP_afterLine2:Hr.toFixed(1),AGS_g:Vt.toFixed(4),AGS_ftps2:ne.toFixed(4),AMin_ftps2:Ae.toFixed(4),AMax_ftps2:Qe.toFixed(4),SLIP:As})}}Ne=ne;const lo=Sr(X,d);lt+=lo*550*E;const co=f.v_fps*E;Re+=At*co,Fe+=Je*co;const Ps=1-ke,Ts=1-ue(),Ss=Ps+Ts;be+=lo*550*E*Ss;const Rs=ve(f.v_fps,0),Fs=ve(f.s_ft,0),bs=ve(ne,Ae),ao=ve(we,0),ht=an(Rs,Fs,E,ao);if(v<=12&&typeof console<"u"&&console.log&&console.log("[INTEGRATED]",{step:v,Vel_next:+ht.Vel_ftps.toFixed(3),Dist_next:+ht.Dist_ft.toFixed(6)}),!Number.isFinite(ht.Vel_ftps)||!Number.isFinite(ht.Dist_ft))throw new Error(`NaN in state @ step=${v} v=${ht.Vel_ftps} dist=${ht.Dist_ft} AGS=${bs} PQWT=${ao}`);if(f.v_fps=ht.Vel_ftps,f.s_ft=ht.Dist_ft,f.t_s=f.t_s+E,!Number.isFinite(f.v_fps)||!Number.isFinite(f.s_ft)||!Number.isFinite(ne))throw new Error(`NaN in state @ step=${v} v=${f.v_fps} dist=${f.s_ft} AGS=${ne}`);if(Qt=ne/I,f.s_ft>=Z){ce="DISTANCE";break}if(f.t_s>=ae){ce="TIME_CAP";break}const fo=(Y==null?void 0:Y.length)??1,Es=(re??[])[f.gearIdx]??0,uo=r?nn(X,Es,f.gearIdx,fo-1):tn(f.gearIdx,fo,X,re??[]);let yr=!1;if(r)yr=uo;else{const W=rn(Kt,uo);Kt=W.newState,yr=W.executeShift}if(yr){const W=f.gearIdx,U=X;f.gearIdx++;const te=on(m);ft=te,Xt+=te,typeof console<"u"&&console.debug&&console.debug("[SHIFT]",{step:v,t_s:f.t_s.toFixed(4),v_fps:f.v_fps.toFixed(2),from_gear:W+1,to_gear:f.gearIdx+1,EngRPM_before:U.toFixed(0),LockRPM:ut.toFixed(0),dwell_s:te.toFixed(3)})}for(!yt&&f.s_ft>=Pe&&(yt=!0,Mt=f.t_s),nt===0&&f.s_ft>=594&&(nt=f.t_s),Be===0&&f.s_ft>=1254&&(Be=f.t_s);Ht<oe.length&&f.s_ft>=oe[Ht];){const W=oe[Ht],U=yt?f.t_s-Mt:0,te=f.v_fps*de;mt.push({d_ft:W,t_s:U,v_mph:te}),Ht++}if(f.t_s>=fe){const U=(f.v_fps-$t)/E/Wo;pt.push({t_s:f.t_s,v_mph:f.v_fps*de,a_g:U,s_ft:f.s_ft,rpm:f.rpm,gear:f.gearIdx+1,hp:ot>0?ot:void 0,engineHp:rt>0?rt:void 0,dragHp:Le>0?Le:void 0}),fe+=tt,$t=f.v_fps}}f.t_s>=ae&&q.push("max_time_exceeded");const G=yt?f.t_s-Mt:f.t_s,K=f.v_fps*de;let V,Ft;if(nt>0&&f.t_s>nt){const k=f.t_s-nt;k>0&&(V=de*66/k)}if(Be>0&&f.t_s>Be){const k=f.t_s-Be;k>0&&(Ft=de*66/k)}Lt=.5*et*f.v_fps*f.v_fps,ce||(ce="SAFETY"),typeof console<"u"&&console.debug&&console.debug("[RSACLASSIC END]",{reason:ce,t_s:f.t_s,steps:v,d_ft:f.s_ft,target_ft:Z,totalShiftDwell_s:Xt.toFixed(3)}),typeof console<"u"&&console.warn&&ce!=="DISTANCE"&&console.warn("Terminated without crossing finish:",{reason:ce,t_s:f.t_s,d_ft:f.s_ft,target_ft:Z}),(mt.length===0||mt[mt.length-1].d_ft!==Z)&&mt.push({d_ft:Z,t_s:G,v_mph:K});const _e={};V!==void 0&&(_e.e660_mph=V),Ft!==void 0&&(_e.q1320_mph=Ft);{const x=lt,k=Re+Fe+be+St+Rt,De=Lt+Jt,Ge=x-k-De;console.log(`
=== ENERGY SUMMARY: ${P.name??"Unknown"} ===`),console.log(`ET: ${G.toFixed(3)}s, Trap MPH: ${K.toFixed(1)}`),console.log(`
Energy In:`),console.log(`  Engine:           ${(lt/1e3).toFixed(1)} k-ft-lb`),console.log(`
Energy Out:`),console.log(`  Aero Drag:        ${(Re/1e3).toFixed(1)} k-ft-lb (${(100*Re/x).toFixed(1)}%)`),console.log(`  Rolling Resist:   ${(Fe/1e3).toFixed(1)} k-ft-lb (${(100*Fe/x).toFixed(1)}%)`),console.log(`  Driveline Loss:   ${(be/1e3).toFixed(1)} k-ft-lb (${(100*be/x).toFixed(1)}%)`),console.log(`  Engine PMI:       ${(St/1e3).toFixed(1)} k-ft-lb (${(100*St/x).toFixed(1)}%)`),console.log(`  Chassis PMI:      ${(Rt/1e3).toFixed(1)} k-ft-lb (${(100*Rt/x).toFixed(1)}%)`),console.log(`  Total Losses:     ${(k/1e3).toFixed(1)} k-ft-lb (${(100*k/x).toFixed(1)}%)`),console.log(`
Final Kinetic Energy:`),console.log(`  Translational:    ${(Lt/1e3).toFixed(1)} k-ft-lb (${(100*Lt/x).toFixed(1)}%)`),console.log(`  Rotational:       ${(Jt/1e3).toFixed(1)} k-ft-lb (${(100*Jt/x).toFixed(1)}%)`),console.log(`  Total Kinetic:    ${(De/1e3).toFixed(1)} k-ft-lb (${(100*De/x).toFixed(1)}%)`),console.log(`
Energy Balance:     ${(Ge/1e3).toFixed(1)} k-ft-lb (${(100*Ge/x).toFixed(1)}% error)`),console.log(`===
`)}const J={et_s:r?Nr(G,3):G,mph:r?Nr(K,2):K,timeslip:mt,traces:pt.length>0?pt:void 0,meta:{model:"RSACLASSIC",steps:Math.floor(f.t_s/E),warnings:q,windowMPH:Object.keys(_e).length>0?_e:void 0,converter:p&&!M?{used:!0,avgTR:$e>0?F/$e:1,avgETA:$e>0?ar/$e:1,avgSR:$e>0?fr/$e:1,deRateMax:.3,parasiticConst:.05,parasiticQuad:1e-6}:void 0,clutch:M?{used:!0,minC:Pt,lockupAt_ft:Ut}:void 0,rollout:{rolloutIn:he??12,t_roll_s:Mt},fuel:st?{type:st,minScale:Tt,maxScale:it}:void 0,vb6:{dt_s:E,trapMode:"time",windowsFt:{eighth:{start:594,end:660,distance:66},quarter:{start:1254,end:1320,distance:66}},timeslipPoints:[60,330,660,1e3,1320],rolloutBehavior:"ET clock starts after rollout distance (TIMESLIP.FRM:1380)"},termination:{reason:ce,steps:v,t_s:f.t_s,target_ft:Z}}};return console.log("[RSACLASSIC] done",{et_s:+(((Ue=($=J==null?void 0:J.et_s)==null?void 0:$.toFixed)==null?void 0:Ue.call($,4))??(J==null?void 0:J.et_s)),mph:+(((bt=(Ee=J==null?void 0:J.mph)==null?void 0:Ee.toFixed)==null?void 0:bt.call(Ee,1))??(J==null?void 0:J.mph)),steps:((ro=(_r=J==null?void 0:J.meta)==null?void 0:_r.termination)==null?void 0:ro.steps)??v,wallMs:Date.now()-o}),J}}const Xr=new Pn;function lr(e,t,r,o,s){let n=0;for(n=0;n<r-1&&!(s<=e[n+1]);n++);n>=r-1&&(n=r-2),n<0&&(n=0);const i=e[n],c=e[n+1],a=t[n],l=t[n+1];if(c===i)return a;const u=(s-i)/(c-i);return a+u*(l-a)}function jr(e,t,r,o,s){let n,i;if(s)n=1+4e-5*r,i=n*e*je/12;else{const c=(Math.pow(t,1.4)+e-16)/(.171*Math.pow(e,1.7));n=1+c*135e-7*Math.pow(r,1.6);const a=1+c*35e-5*r;a<n&&(n=a),i=(n-.035*Math.abs(o))*e*je/12}return{TireGrowth:n,TireCirFt:i}}function Yr(e,t){return(1-(e-1)*.01)/Math.pow(t,.25)}function Zr(e){return e?yo:Go}function Tn(e,t){if(!(t!=null&&t.enabled))return 1;const{activateTime_s:r,duration_s:o,throttlePct:s,rampTime_s:n=0}=t,i=r+o;if(e<r||e>=i)return 1;const c=s/100;if(n>0&&e<r+n){const a=(e-r)/n;return 1-(1-c)*a}if(n>0&&e>i-n){const a=(i-e)/n;return 1-(1-c)*a}return c}function Sn(e,t,r,o,s){const n=e.Gear;let i;const c=e.Gear!==e.PrevGear;if(c)i=t.DTShift,e.PrevGear=e.Gear;else{if(i=o,e.Ags0_g>0&&e.L>1){const E=Math.min(e.AgsMax_g/e.Ags0_g,10);i=o*Math.pow(E,4)}i>.1&&(i=.1)}let a=0;const l=e.time_s-e.Time0_s;l>0&&(a=(e.AGS_g-e.Ags0_g)/l),a<It&&(a=It),a>xt&&(a=xt),e.Vel0_ftps=e.Vel_ftps,e.Ags0_g=e.AGS_g,e.Time0_s=e.time_s,e.Dist0_ft=e.Dist_ft,e.RPM0=e.EngRPM,e.DSRPM0=e.DSRPM,e.RPM0===t.LaunchRPM&&e.Time0_s===0&&(e.RPM0=t.Stall,t.LaunchRPM<t.Stall&&(e.Time0_s=t.EnginePMI*(t.Stall-t.LaunchRPM)/25e4));const u=jr(t.TireDia_in,t.TireWidth_in,e.Vel_ftps,e.Ags0_g,r.isLandSpeed);e.TireGrowth=u.TireGrowth,e.TireCirFt=u.TireCirFt;let h;r.isLandSpeed?h=1.01+(r.TractionIndex-1)*.01:h=1.02+(.005*(r.TractionIndex-1)+3*(r.TrackTempEffect-1))*(1-Math.pow(e.Dist0_ft/1320,2));const d=t.TGR[n-1]??1,g=t.TiresPMI+t.TransPMI*Math.pow(t.GearRatio,2)*Math.pow(d,2);let _=e.Vel0_ftps+e.Ags0_g*I*i+a*I*i*i/2;_<e.Vel0_ftps*.9&&e.Vel0_ftps>100&&(_=e.Vel0_ftps),_<0&&(_=0);const M=t.ShiftRPM[n-1]??9e3;if(!c&&(i<.005&&(i=.005),i>.05&&(i=.05),_=e.Vel0_ftps+e.Ags0_g*I*i+a*I*i*i/2,e.Vel0_ftps>0&&e.RPM0>t.Stall&&n<t.NGR)){const E=e.Vel0_ftps*(M+5)/e.RPM0;_>E&&(_=E,e.Ags0_g*I>0&&(i=(_-e.Vel0_ftps)/(e.Ags0_g*I)))}const p=_*_-e.Vel0_ftps*e.Vel0_ftps,m=h*_*60/e.TireCirFt,R=m*t.GearRatio*d;let A=t.Slippage*R,C,y=t.Stall,w=0;t.isClutch?(A<t.Stall&&(n===1||!t.LockUp)&&(A=t.Stall),C=R/A):n===1||!t.LockUp?(y=t.Stall,w=t.Slippage*R/y,e.L>2&&(w>.6&&(y=y*(1+(t.Slippage-1)*(w-.6)/(1/t.Slippage-.6))),w=t.Slippage*R/y),C=1/t.Slippage,A<y&&(A=y,C=(t.TorqueMult-(t.TorqueMult-1)*w)*R/y)):(A=1.005*R,C=R/A),C>1&&(C=1);let S=lr(t.xrpm,t.yhp,t.NHP,1,A);S=t.HPTQMult*S/r.hpc,t.RevLimiterRPM>0&&A>=t.RevLimiterRPM&&(S=S*.05);const j=Tn(e.time_s,s);S=S*j;const me=S;S=S*C;const Oe=Math.sqrt(_*_+2*_*(r.WindSpeed_mph/ir)*Math.cos(je*r.WindAngle_deg/180)+Math.pow(r.WindSpeed_mph/ir,2)),Ye=Math.sign(Oe)*r.rho*Math.pow(Math.abs(Oe),2)/(2*I);let P;t.BodyStyle===8?P=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*t.TireWidth_in/144:P=t.RefArea_ft2+(e.TireGrowth-1)*t.TireDia_in/2*(2*t.TireWidth_in)/144;const Q=t.Weight_lbf+t.LiftCoef*P*Ye,Ce=r.isLandSpeed?Wr:Er,q=r.isLandSpeed?Co:vo,Z=r.isLandSpeed?Ho:Do,ye=(Ce-e.Dist0_ft/1320*q)*Q+1e-4*Q*(ir*_)+t.DragCoef*P*Ye,z=ye*_/550,se=12*e.TireCirFt/(2*je),Y=(e.Ags0_g*t.Weight_lbf*(t.YCG_in-se+Z/t.Efficiency*se)+ye*t.YCG_in)/t.Wheelbase_in;let ee=t.StaticFWt_lbf-Y,re=0;ee<0&&(re=-ee*t.Wheelbase_in/64,ee=0);let Me=Q-ee-re;Me<0&&(Me=t.Weight_lbf);const Ze=Yr(r.TractionIndex,r.TrackTempEffect),ze=Zr(r.isLandSpeed);let Ve=Ze*ze*t.TireDia_in*(t.TireWidth_in+1)*(.92+.08*Math.pow(Me/1900,2.15));t.BodyStyle===8&&(Ve=.5*Ve);const b=(Ve/e.TireGrowth-ye)/t.Weight_lbf,he=t.TGEff[n-1]??.99;S=S*he*t.Efficiency/h;const ie=S;S=S-z;let D=550*I*S/t.Weight_lbf,N=D/(_*I),le=!1;N>b&&(le=!0,D=D*(b-(N-b))/N,N=b-(N-b)),N<pe&&(N=pe,D=pe*I*_);let Pe=Math.max(0,p)/(2*D)+e.Time0_s;const ce=r.isLandSpeed?Lo:Vr,v=r.isLandSpeed?No:Br;let ae=t.EnginePMI*A*(A-e.RPM0);ae<0&&(t.isClutch?ae=ce*ae:ae=v*ae);let tt=g*m*(m-e.DSRPM0);tt<0&&(tt=0);let Ct=0,gt=0,He=0;for(He=1;He<=12;He++){const E=Pe-e.Time0_s;if(E<=0)break;const f=Math.pow(2*je/60,2)/(12*550*E);Ct=ae*f,gt=tt*f,S=(me-Ct)*C,S=(S*he*t.Efficiency-gt)/h-z,D=550*I*S/t.Weight_lbf,N=D/(_*I);let fe=0;E!==0&&(fe=(N-e.Ags0_g)/E),fe<It&&(fe=It,N=e.Ags0_g+fe*E,D=N*I*_),fe>xt&&(fe=xt,N=e.Ags0_g+fe*E,D=N*I*_),le=!1,N>b&&(le=!0,D=D*(b-(N-b))/N,N=b-(N-b)),N<pe&&(N=pe,D=pe*I*_);const rt=Math.max(0,p)/(2*D)+e.Time0_s,ot=rt-e.Time0_s;if(He===12||Math.abs(100*(ot-E)/ot)<=.01){Pe=rt;break}let Le=S/me;Le<Or&&(Le=Or),Le>qr&&(Le=qr),Pe=e.Time0_s+E+Le*(ot-E)}const Te=Pe-e.Time0_s;let Se;if(D<.1||Te<=0){const E=(e.Vel0_ftps+_)/2;Se=e.Dist0_ft+Math.max(0,E*Math.abs(Te))}else{const E=Math.pow(e.Vel0_ftps,3),f=2*D*Te+e.Vel0_ftps*e.Vel0_ftps;if(f<0){const fe=(e.Vel0_ftps+_)/2;Se=e.Dist0_ft+fe*Te}else Se=(Math.pow(f,1.5)-E)/(3*D)+e.Dist0_ft}return e.L+=1,e.time_s=Pe,e.Vel_ftps=_,e.Dist_ft=Se,e.AGS_g=N,e.EngRPM=A,e.DSRPM=m,e.SLIP=le,{TimeStep_s:i,VelSqrd:p,LockRPM:R,ClutchSlip:C,zStall:y,SlipRatio:w,TireSlip:h,WindFPS:Oe,q:Ye,RefArea2_ft2:P,DownForce_lbf:Q,DragForce_lbf:ye,DragHP:z,DynamicFWT_lbf:ee,DynamicRWT_lbf:Me,WheelBarWT_lbf:re,CRTF:Ve,AMax_g:b,ChassisPMI:g,EngAccHP:ae,ChasAccHP:tt,HPSave:me,HPAtWheels:ie,HP:S,PQWT:D,iterations:He}}function Rn(e,t,r){const o=jr(e.TireDia_in,e.TireWidth_in,0,0,t.isLandSpeed),s=lr(e.xrpm,e.yhp,e.NHP,1,r);let c=5252*(e.HPTQMult*s/t.hpc)/r;const a=e.TGR[0]??1,l=e.TGEff[0]??.99;c=c*e.TorqueMult*a*l;const u=t.isLandSpeed?Wr:Er,h=t.WindSpeed_mph/ir,d=Math.sign(h)*t.rho*Math.pow(Math.abs(h),2)/(2*I),g=u*e.Weight_lbf+e.DragCoef*e.RefArea_ft2*d;let _;t.isLandSpeed?_=1.01+(t.TractionIndex-1)*.01:_=1.02+(t.TractionIndex-1)*.005+(t.TrackTempEffect-1)*3;const M=c*e.GearRatio*e.Efficiency/(_*e.TireDia_in/24)-g;let m=(e.isClutch?.88:.96)*M/e.Weight_lbf;const A=e.Weight_lbf-e.StaticFWt_lbf,C=Yr(t.TractionIndex,t.TrackTempEffect),y=Zr(t.isLandSpeed);let w=C*y*e.TireDia_in*(e.TireWidth_in+1)*(.92+.08*Math.pow(A/1900,2.15));e.BodyStyle===8&&(w=.5*w);const S=(w-g)/e.Weight_lbf;return m>S&&(m=S),m<pe&&(m=pe),{L:1,time_s:0,Vel_ftps:.001,Dist_ft:0,AGS_g:m,EngRPM:r,DSRPM:0,Gear:1,SLIP:!1,Vel0_ftps:0,Ags0_g:m,Time0_s:0,Dist0_ft:0,RPM0:r,DSRPM0:0,AgsMax_g:m,TireGrowth:o.TireGrowth,TireCirFt:o.TireCirFt,ShiftFlag:0,PrevGear:1}}function Fn(e,t,r,o){let s=e*.11*Math.pow(t*r/o,-.3333333333333333);return s=s/15,s<.005&&(s=.005),s}function zr(e,t,r){let o=0,s=0,n=r-1;const i=e[0],c=e[r-1];if(t<=i)return o=1,n=1,{KBOTM:s,KTOP:n,JJ:o};if(t>=c)return o=1,s=r-2,n=r-1,{KBOTM:s,KTOP:n,JJ:o};for(;n-s>1;){const a=Math.floor((s+n)/2);t<e[a]?n=a:s=a}return{KBOTM:s,KTOP:n,JJ:o}}function Ar(e,t,r,o,s){if(r<=0)return 0;if(r===1)return t[0];let n=0,i=1;if(r===2)n=0,i=1;else{const a=zr(e,s,r);n=a.KBOTM,i=a.KTOP;const l=a.JJ;if(n===i)return t[n];l!==1&&o>1&&(i=i+1,(o>=3||i>r-1)&&(i>r-1&&(i=r-1),n=n-1,n<0&&(n=0)))}let c=0;for(let a=n;a<=i;a++){let l=1;const u=e[a];for(let h=n;h<=i;h++)if(h===a)l=l*t[a];else{const d=e[h];l=l*(s-d)/(u-d)}c=c+l}return c}function bn(e,t,r,o,s,n,i,c,a){const l=zr(t,a,s);let u=l.KBOTM,h=l.KTOP;l.JJ;const d=[],g=[];for(let p=u;p<=h;p++){const m=[];for(let A=0;A<o;A++)m.push(r[p*o+A]);const R=Ar(e,m,o,n,c);d.push(R),g.push(t[p])}const _=h-u+1,M=Math.min(i,_);return Ar(g,d,_,M,a)}function En(e){switch(e){case 1:case 2:return 1;case 3:case 4:return 1.08;case 5:return 5;case 6:return 2*1;case 7:case 9:return 2.5*1.08;case 8:return 1.5*5.5;default:return 1}}function An(e){return e<=5}const wn=[.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],In=[.7,1.2,1.7,2.5,3.4],xn=[.53,.975,1.098,1.13,1.152,1.16,1.153,1.122,1.086,1.045,1,.938,.865,.795,.72,.63,.365,.87,1.018,1.066,1.11,1.129,1.132,1.11,1.079,1.042,1,.935,.855,.762,.66,.54,.24,.79,.96,1.023,1.08,1.106,1.117,1.102,1.074,1.04,1,.932,.845,.736,.612,.474,.1,.7,.894,.972,1.04,1.08,1.096,1.09,1.069,1.037,1,.928,.83,.698,.55,.39,0,.63,.84,.924,1,1.055,1.079,1.082,1.064,1.035,1,.923,.815,.662,.49,.31],eo=[0,.25,.5,.6,.65,.7,.75,.8,.85,.9,.95,1,1.05,1.1,1.15,1.2,1.25],vt=[0,.7,1.2,1.7,2.5,3.4],vn=[0,0,.61,.8,.9,.98,1.035,1.055,1.06,1.05,1.03,1,.93,.85,.765,.67,.58];function Cn(e,t){return bn(wn,In,xn,16,5,1,1,e,t)}function yn(e){const{peakHP:t,peakRPM:r,displacement_cid:o,fuelSystem:s}=e,n=Rr*t/r,i=En(s);let c=t/o/i;s<=5?c<vt[1]&&(c=vt[1]):c<vt[2]&&(c=vt[2]),c>vt[5]&&(c=vt[5]);const a=[0],l=[0],u=[0],h=16;for(let d=1;d<=h;d++){a[d]=eo[d]*r;let g;s===8?g=vn[d]*n:g=Cn(eo[d],c)*n,l[d]=a[d]*g/Rr,u[d]=g}return{xrpm:a,yhp:l,ztq:u,NHP:h}}function Hn(e){const t=[],r=[];for(let o=1;o<=e.NHP;o++)t.push(e.xrpm[o]),r.push(e.yhp[o]);return{rpm:t,hp:r}}function Ln(e){return e>800?1:8}function Nn(e){switch(e){case 1:return{dragCoef:.66,liftCoef:.8,overhang_in:30};case 2:return{dragCoef:.5,liftCoef:.2,overhang_in:30};case 3:return{dragCoef:.52,liftCoef:.8,overhang_in:40};case 4:return{dragCoef:.52,liftCoef:.1,overhang_in:30};case 5:return{dragCoef:.28,liftCoef:.1,overhang_in:30};case 6:return{dragCoef:.4,liftCoef:.1,overhang_in:24};case 7:return{dragCoef:.46,liftCoef:.1,overhang_in:18};case 8:return{dragCoef:.54,liftCoef:.1,overhang_in:12};default:return{dragCoef:.5,liftCoef:.2,overhang_in:30}}}function Dn(e,t){const r=[];if(t){const o=e>=3?.985:.99;for(let s=1;s<=e;s++)r.push(o-(e-s)*2*.005)}else for(let s=1;s<=e;s++)r.push(.99-(e-s)*.005);return r}function Gn(e,t,r,o,s,n,i){let c,a,l;return An(t)?c=e/120:c=e/90,r?a=(o-1)*c/10:a=o*c/50,l=2*(1.15*.8*(.08*s*n)*Math.pow(s/2,2)/386),i===8&&(c=e/240,a=a/(240/120),l=l/2),{enginePMI:c,transPMI:a,tiresPMI:l}}function kn(e){return e===8?.985:.97}function Wn(e){return 1.0025+e/1e6}function On(e){const t=xe[e];return t?t.lengthFt:e==="EIGHTH"?660:1320}function qn(e){const t=Ie[e];return t||(e==="EIGHTH"?Ie.EIGHTH:Ie.QUARTER)}function Vn(e){if(!e)return 1;const t=e.toUpperCase();return t==="GASOLINE"?1:t==="GASOLINE EFI"?2:t==="METHANOL"?3:t==="METHANOL EFI"?4:t==="NITROMETHANE"?5:t==="SUPERCHARGED GASOLINE"?6:t==="SUPERCHARGED METHANOL"?7:t==="SUPERCHARGED NITRO"?8:t==="E85"||t==="DIESEL"||t==="GAS+CARB"||t==="GASOLINE+CARBURETOR"?1:t==="GAS+INJECT"||t==="GASOLINE+FUEL INJECTION"?2:t==="METHANOL+CARB"||t==="METHANOL+CARBURETOR"?3:t==="METHANOL+INJECT"||t==="METHANOL+FUEL INJECTION"?4:t==="NITRO+INJECT"||t==="NITROMETHANE+FUEL INJECTION"?5:t==="GAS+SUPERCHARGED"||t==="GASOLINE+SUPERCHARGED"?6:t==="METHANOL+SUPERCHARGED"?7:t==="NITRO+SUPERCHARGED"||t==="NITROMETHANE+SUPERCHARGED"?8:t==="ELECTRIC"?9:t.includes("SUPERCHARG")||t.includes("BLOWN")?t.includes("NITRO")?8:t.includes("METHANOL")||t.includes("ALCOHOL")?7:6:t.includes("INJECT")||t.includes("EFI")?t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?4:2:t.includes("NITRO")?5:t.includes("METHANOL")||t.includes("ALCOHOL")?3:t.includes("ELECTRIC")?9:1}function Bn(e){const t=e.vehicle,r=e.engine??t.engine,o=(r==null?void 0:r.hpCurve)??(r==null?void 0:r.torqueCurve)??t.torqueCurve??t.hpCurve??[],s=[],n=[];for(const u of o)Array.isArray(u)?(s.push(u[0]),n.push(u[1])):u&&typeof u=="object"&&(s.push(u.rpm),u.hp!==void 0?n.push(u.hp):u.torque!==void 0?n.push(u.torque*u.rpm/5252):u.tq_lbft!==void 0&&n.push(u.tq_lbft*u.rpm/5252));if(s.length>=2)return{xrpm:s,yhp:n,NHP:s.length,isQuarterJr:!1};const i=Number(t.powerHP??t.peakHP),c=Number(t.rpmAtPeakHP??t.peakRPM??6500),a=Number(t.displacement_cid??t.displacementCID??350),l=e.fuelSystem??t.fuelSystem??1;if(Number.isFinite(i)&&i>0){const u=yn({peakHP:i,peakRPM:c,displacement_cid:a,fuelSystem:l}),{rpm:h,hp:d}=Hn(u);return{xrpm:h,yhp:d,NHP:u.NHP,isQuarterJr:!0,quarterJrParams:{peakHP:i,rpmAtPeakHP:c,displacement_cid:a,fuelSystem:l}}}return{xrpm:[4e3,6500],yhp:[100,150],NHP:2,isQuarterJr:!1}}function $n(e){const t=Math.abs(100-e);let r;return e>100?r=1+25e-7*Math.pow(t,2.5):r=1+2e-6*Math.pow(t,2.5),r>1.04&&(r=1.04),r}function Un(e){var Qt,Ne,ur,hr,ct,at,Kt,ft,Xt;const t=[],r=[],o=e.vehicle,s=e.env,n=e.raceLength??"QUARTER",i=e.raceLengthFt??On(n),c=((Qt=xe[n])==null?void 0:Qt.category)==="landspeed",a=o.rolloutIn??9,l=o.overhangIn??0;let u=2*a;u<24&&(u=24);let h=(l+.25*u)/12;const d=.5*u/12;h<d&&(h=d);const g=a/12,_=e.drivetrain??o.drivetrain,M=(_==null?void 0:_.clutch)??e.clutch??o.clutch,p=(_==null?void 0:_.converter)??e.converter??o.converter,m=e.engine??o.engine,R=e.pmi??o.pmi,A=e.throttleStop,C=A!=null&&A.enabled?{enabled:!0,activateTime_s:A.activateTime_s,duration_s:A.duration_s,throttlePct:A.throttlePct,rampTime_s:A.rampTime_s}:void 0,y=o.transmissionType??e.transmissionType,w=y==="clutch"?!0:y==="converter"?!1:!p||M&&!p,S=e.fuel,j=typeof S=="string"?S:(S==null?void 0:S.fuelType)??(S==null?void 0:S.fuelSystem)??(S==null?void 0:S.type)??e.fuelType??o.fuelType??e.fuelSystem??o.fuelSystem,me=Vn(j),Oe=$r({barometer_inHg:s.barometerInHg??29.92,temperature_F:s.temperatureF??59,relHumidity_pct:s.humidityPct??50,elevation_ft:s.elevation??0,fuelSystem:me}),Ye=Oe.rho_slug_per_ft3*I,P=Oe.hpc,Q=Bn(e),{xrpm:Ce,yhp:q,NHP:Z,isQuarterJr:qe,quarterJrParams:ye}=Q;Z<2&&t.push("HP curve has fewer than 2 points"),qe&&t.push("Using QuarterJr mode (synthetic HP curve from peak HP)");const z=(_==null?void 0:_.gearRatios)??o.gearRatios??[2.5,1.8,1.4,1.1,1],se=(_==null?void 0:_.finalDriveRatio)??o.finalDrive??o.rearGear??3.73,Y=z.length,ee=o.tire,re=(ee==null?void 0:ee.diameter_in)??o.tireDiaIn??32,Me=(ee==null?void 0:ee.width_in)??o.tireWidthIn??17,Ze=o.bodyStyle??Ln(o.weightLb);let ze,Ve,b,he,ie,D,N,le,et,Pe,ce,v;if(qe&&ye){const{displacement_cid:H,fuelSystem:ue}=ye;ze=Dn(Y,!w);const O=o.shiftRPM??(_==null?void 0:_.shiftRPM)??7e3;Ve=z.map(()=>O);const G=(M==null?void 0:M.slipRPM)??(p==null?void 0:p.stallRPM)??o.slipStallRPM??5e3;if(w)he=Wn(G),ie=1,b=G;else{const Ft=(p==null?void 0:p.diameter_in)??(p==null?void 0:p.diameter)??o.converterDiameterIn??o.converterDia_in??10;let _e;if(G>220){b=G;const B=Ar(Ce,q,Z,1,b)*(Rr/b)/P;_e=b/1e3*(b/B)}else _e=G,b=G;const J=_e/(200*Math.pow(7/Ft,4));he=1.01+J/20+_e/8e3,ie=2.633-Math.pow(J,.3)-_e/1500,ie<1&&(ie=1),ie>2&&(ie=2)}et=kn(Ze);const K=Nn(Ze);Pe=K.dragCoef,ce=K.liftCoef,v=K.overhang_in;const V=Gn(H,ue,!w,Y,re,Me,Ze);D=V.enginePMI,N=V.transPMI,le=V.tiresPMI}else{ze=(_==null?void 0:_.perGearEff)??o.gearEfficiencies??null??z.map(()=>.99),Ve=(_==null?void 0:_.shiftRPMs)??(_==null?void 0:_.shiftsRPM)??o.shiftRPMs??z.map(()=>7e3);const ue=(M==null?void 0:M.slipRPM)??o.clutchSlipRPM??7200,O=(p==null?void 0:p.stallRPM)??o.converterStallRPM??5500;b=w?ue:O;const G=(M==null?void 0:M.slippageFactor)??(M==null?void 0:M.slippage)??o.clutchSlippage??1.0025,K=(p==null?void 0:p.slippageFactor)??(p==null?void 0:p.slippage)??o.converterSlippage??1.06;he=w?G:K,ie=w?1:(p==null?void 0:p.torqueMult)??(p==null?void 0:p.torqueMultiplier)??o.converterTorqueMult??2.2,D=(R==null?void 0:R.engine_flywheel_clutch)??o.enginePMI??(m==null?void 0:m.enginePMI)??4,le=(R==null?void 0:R.tires_wheels_ringgear)??o.tiresPMI??(m==null?void 0:m.tiresPMI)??.5,N=(R==null?void 0:R.transmission_driveshaft)??o.transPMI??(m==null?void 0:m.transPMI)??.2,et=(_==null?void 0:_.overallEfficiency)??o.transEfficiency??.97;const V=e.aero??o.aero;Pe=(V==null?void 0:V.Cd)??(V==null?void 0:V.cd)??o.cd??.35,ce=(V==null?void 0:V.Cl)??(V==null?void 0:V.cl)??o.liftCoeff??0,v=l}const ae=re/2+3.75,tt=1.03,Ct=.015,gt=re/2,He=o.wheelbaseIn??100,Te=o.weightLb,Se=w?(M==null?void 0:M.launchRPM)??o.clutchLaunchRPM??b:b,fe=5252*(lr(Ce,q,Z,1,Se)/P)/Se*ie*z[0]*ze[0],pt=Ct*Te,rt=fe*se*et/(he*re/24)-pt,yt=((w?.88:.96)*rt/Te*Te*(ae-gt+tt/et*gt)+pt*ae)/He,Mt=qe?v:l,oe={Weight_lbf:o.weightLb,Wheelbase_in:o.wheelbaseIn??100,YCG_in:ae,StaticFWt_lbf:yt,TireDia_in:re,TireWidth_in:Me,Rollout_in:o.rolloutIn??12,GearRatio:se,TGR:z,TGEff:ze,Efficiency:et,DTShift:w?.2:.25,Slippage:he,TorqueMult:ie,Stall:b,LockUp:(p==null?void 0:p.lockup)??!1,isClutch:w,RefArea_ft2:((Ne=e.aero)==null?void 0:Ne.frontalArea_ft2)??o.frontalArea_ft2??o.frontalAreaFt2??20,DragCoef:Pe,LiftCoef:ce,BodyStyle:Ze,EnginePMI:D,TiresPMI:le,TransPMI:N,xrpm:Ce,yhp:q,NHP:Z,HPTQMult:o.hpTorqueMultiplier??(m==null?void 0:m.hpTqMult)??1,ShiftRPM:Ve,NGR:Y,LaunchRPM:w?(M==null?void 0:M.launchRPM)??o.clutchLaunchRPM??b:b,ShiftMode:o.shiftMode??"rpm",ShiftTimes:o.shiftTimes??[],RevLimiterRPM:o.revLimiterRPM??0};if(qe&&Mt!==l){let H=2*a;H<24&&(H=24),h=(Mt+.25*H)/12;const ue=.5*H/12;h<ue&&(h=ue)}const Ht=s.trackTempF??100,nt=c?1:$n(Ht),Be={rho:Ye,hpc:P,TractionIndex:s.tractionIndex??5,TrackTempEffect:nt,WindSpeed_mph:s.windMph??0,WindAngle_deg:s.windAngleDeg??0,isLandSpeed:c},$t=w?(M==null?void 0:M.launchRPM)??b:b,F=Rn(oe,Be,$t),ar=lr(Ce,q,Z,1,$t),fr=Fn(60,ar,ie,o.weightLb),$e=c?5e4:5e3,Pt=c?300:30,Ut={iterations:[],convergenceHistory:[]},st=[],Tt=qn(n);let it=0,lt=null,Re=null,Fe=null;for(let H=0;H<$e&&!(F.Dist_ft-g+h>=i+50||F.time_s>=Pt);H++){if(!Number.isFinite(F.Vel_ftps)||!Number.isFinite(F.Dist_ft)||!Number.isFinite(F.AGS_g)){t.push(`NaN detected at step ${H}: Vel=${F.Vel_ftps}, Dist=${F.Dist_ft}, AGS=${F.AGS_g}`);break}const O=Sn(F,oe,Be,fr,C);if(Ut.iterations.push(O.iterations),H<20&&Ut.convergenceHistory.push({step:H,iterations:O.iterations,HPSave:O.HPSave,HP:O.HP,PQWT:O.PQWT,AGS_g:F.AGS_g}),lt===null&&F.Dist_ft>=g){const $=(F.Dist_ft-g)/F.Vel_ftps;lt=F.time_s-$}const G=Math.max(0,F.Dist_ft-g+h),K=lt!==null?F.time_s-lt:0,V=oe.TGR[F.Gear-1]??1,Ft=(O.LockRPM??F.EngRPM)/V,_e=O.TireSlip,J=F.Vel_ftps*_e*de,jt=(C==null?void 0:C.enabled)&&K>=C.activateTime_s&&K<C.activateTime_s+C.duration_s;if(r.push({t_s:K,s_ft:G,v_fps:F.Vel_ftps,v_mph:F.Vel_ftps*de,a_g:F.AGS_g,rpm:F.EngRPM,dsrpm:Ft,lockRpm:O.LockRPM,gear:F.Gear,slip:F.SLIP,tireSlip:_e,hp:O.HPAtWheels,dragHp:O.DragHP,netHp:O.HP,wheelSpeed_mph:J,throttleStopActive:jt}),Re===null&&G>=594){const B=r.length>1?((ur=r[r.length-2])==null?void 0:ur.s_ft)??0:0,$=r.length>1?((hr=r[r.length-2])==null?void 0:hr.t_s)??0:0;if(B<594&&G>B){const Ue=(594-B)/(G-B);Re=$+Ue*(K-$)}else Re=K}if(Fe===null&&G>=1254){const B=r.length>1?((ct=r[r.length-2])==null?void 0:ct.s_ft)??0:0,$=r.length>1?((at=r[r.length-2])==null?void 0:at.t_s)??0:0;if(B<1254&&G>B){const Ue=(1254-B)/(G-B);Fe=$+Ue*(K-$)}else Fe=K}for(;it<Tt.length&&G>=Tt[it];){const B=Tt[it],$=r.length>1?((Kt=r[r.length-2])==null?void 0:Kt.s_ft)??0:0,Ue=r.length>1?((ft=r[r.length-2])==null?void 0:ft.t_s)??0:0;let Ee=K;if($<B&&G>$){const _r=(B-$)/(G-$);Ee=Ue+_r*(K-Ue)}let bt;B===660&&Re!==null&&Ee>Re?bt=de*66/(Ee-Re):B===1320&&Fe!==null&&Ee>Fe?bt=de*66/(Ee-Fe):bt=F.Vel_ftps*de,st.push({d_ft:B,t_s:Ee,v_mph:bt}),it++}if(F.ShiftFlag===1)F.ShiftFlag=2,F.Gear++;else if(F.ShiftFlag===2)F.ShiftFlag=0;else if(F.Gear<oe.NGR)if((oe.ShiftMode??"rpm")==="time"){const $=(Xt=oe.ShiftTimes)==null?void 0:Xt[F.Gear-1];$!==void 0&&F.time_s>=$&&(F.ShiftFlag=1)}else{const $=oe.ShiftRPM[F.Gear-1]??7e3;F.EngRPM>=$&&(F.ShiftFlag=1)}}const be=st.find(H=>H.d_ft===i),St=(be==null?void 0:be.t_s)??F.time_s,Rt=(be==null?void 0:be.v_mph)??F.Vel_ftps*de,Lt=r.map(H=>({t_s:H.t_s,s_ft:H.s_ft,v_mph:H.v_mph,v_fps:H.v_fps,a_g:H.a_g,rpm:H.rpm,dsrpm:H.dsrpm,lockRpm:H.lockRpm,gear:H.gear,slip:H.slip,tireSlip:H.tireSlip,hp:H.hp,dragHp:H.dragHp,wheelSpeed_mph:H.wheelSpeed_mph})),Jt={fuelType:{resolved:j??"unknown",fuelSystemType:me,vehicleFuelType:o.fuelType,vehicleFuelSystem:o.fuelSystem},hpCurve:{length:Z,peakHP:Math.max(...q),rpmRange:`${Math.min(...Ce)} - ${Math.max(...Ce)}`},airCalc:{rho_lbm_ft3:Ye,hpc:P},simParams:{weight:o.weightLb,tireDia:re,wheelbase:o.wheelbaseIn??100,finalDrive:se,NGR:Y,peakHP:Math.max(...q),stallRPM:b,slippage:he,slippageSource:(M==null?void 0:M.slippageFactor)!==void 0?"clutch.slippageFactor":(M==null?void 0:M.slippage)!==void 0?"clutch.slippage":o.clutchSlippage!==void 0?"vehicle.clutchSlippage":"default",vehicleClutchSlippage:o.clutchSlippage,isClutch:w,tractionIndex:Be.TractionIndex,trackTempEffect:nt,pmi:{engine:D,trans:N,tires:le},aero:{frontalArea:oe.RefArea_ft2,cd:oe.DragCoef,cl:oe.LiftCoef},launchRPM:oe.LaunchRPM},result:{et:St,mph:Rt}};return{et_s:St,mph:Rt,timeslip:st,traces:Lt,meta:{model:"VB6Exact",steps:r.length,warnings:t},vb6Diagnostics:Ut,debugData:Jt}}const Jn="rsa.model.";function Qn(e){try{const t=Jn+e,r=localStorage.getItem(t);if(!r)return;const o=JSON.parse(r);if(!o.w||!o.P||typeof o.n!="number"){console.warn(`Invalid model structure for vehicle ${e}`);return}return o}catch(t){console.error(`Failed to load model for vehicle ${e}:`,t);return}}function Kn(e,t){if(t.length!==e.w.length)throw new Error(`Feature dimension mismatch: expected ${e.w.length}, got ${t.length}`);let r=0;for(let o=0;o<e.w.length;o++)r+=e.w[o]*t[o];return r}class Xn{constructor(){nr(this,"id","Blend")}simulate(t){const r=Xr.simulate(t),o=t.vehicle.id,s=Qn(o);let n=0;const i=[...r.meta.warnings];if(s){const d=[wt(t.env)/1e3,t.vehicle.weightLb/3e3,t.vehicle.tireDiaIn/30,t.vehicle.rearGear/4,(r.et_s-10)/5];n=Kn(s,d)}else i.push("no_learned_model");const c=r.et_s*.8,a=r.et_s*1.2;return{et_s:Math.max(c,Math.min(a,r.et_s+n)),mph:r.mph,timeslip:r.timeslip,traces:r.traces,meta:{model:"Blend",steps:r.meta.steps,warnings:i}}}}const jn=new Xn;class Yn{constructor(){nr(this,"id","SimpleV1")}simulate(t){const r=Po({vehicle:t.vehicle,env:t.env,raceLength:t.raceLength});return{et_s:r.baseET_s,mph:r.baseMPH,timeslip:r.timeslip,meta:{model:"SimpleV1",steps:r.timeslip.length,warnings:[]}}}}class Zn{constructor(){nr(this,"id","VB6Exact")}simulate(t){const r=Un(t);return{...r,meta:{...r.meta,model:"VB6Exact"}}}}const zn={SimpleV1:new Yn,RSACLASSIC:Xr,VB6Exact:new Zn,Blend:jn};function to(e){const t=zn[e];if(!t)throw new Error(`Unknown physics model: ${e}`);return t}function es(e){if(e!=null&&e.drivetrain){const t=e.drivetrain;t.shiftsRPM&&!t.shiftRPM&&(t.shiftRPM=t.shiftsRPM),t.overallEfficiency!==void 0&&t.overallEff===void 0&&(t.overallEff=t.overallEfficiency),t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}if(e!=null&&e.vehicle){const t=e.vehicle;t.ratios&&!t.gearRatios&&(t.gearRatios=t.ratios),t.gearRatios&&!t.ratios&&(t.ratios=t.gearRatios)}return e}function cr(e,t){const r=Number(e==null?void 0:e.rpm);if(!Number.isFinite(r))return null;if(Number.isFinite(e==null?void 0:e.hp))return{rpm:r,hp:Number(e.hp)*t};if(Number.isFinite(e==null?void 0:e.torque)){const o=Number(e.torque)*r/5252*t;return{rpm:r,hp:o}}if(Number.isFinite(e==null?void 0:e.tq_lbft)){const o=Number(e.tq_lbft)*r/5252*t;return{rpm:r,hp:o}}return null}function ts(e){var o,s,n,i,c,a;if(Array.isArray((o=e==null?void 0:e.engineParams)==null?void 0:o.powerHP)&&e.engineParams.powerHP.length>=2)return e;const t=((s=e==null?void 0:e.fuel)==null?void 0:s.hpTorqueMultiplier)??1;let r=[];if(Array.isArray((n=e==null?void 0:e.vehicle)==null?void 0:n.hpCurve)&&e.vehicle.hpCurve.length>=2&&(r=e.vehicle.hpCurve.map(l=>cr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2&&Array.isArray(e==null?void 0:e.engineHP)&&e.engineHP.length>=2&&(r=e.engineHP.map(l=>Array.isArray(l)?{rpm:Number(l[0]),hp:Number(l[1])*t}:cr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2&&Array.isArray((i=e==null?void 0:e.engineParams)==null?void 0:i.torqueCurve)&&e.engineParams.torqueCurve.length>=2&&(r=e.engineParams.torqueCurve.map(l=>cr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2&&Array.isArray((c=e==null?void 0:e.vehicle)==null?void 0:c.torqueCurve)&&e.vehicle.torqueCurve.length>=2&&(r=e.vehicle.torqueCurve.map(l=>cr(l,t)).filter(l=>l!==null&&Number.isFinite(l.rpm)&&Number.isFinite(l.hp)).sort((l,u)=>l.rpm-u.rpm)),r.length<2){const l=Number((a=e==null?void 0:e.vehicle)==null?void 0:a.powerHP);Number.isFinite(l)&&l>0&&(r=[{rpm:4e3,hp:l*.85*t},{rpm:5e3,hp:l*.92*t},{rpm:6e3,hp:l*.97*t},{rpm:6500,hp:l*1*t},{rpm:7e3,hp:l*.98*t},{rpm:7500,hp:l*.94*t},{rpm:8e3,hp:l*.88*t}])}return r.length>=2&&(e.engineParams={...e.engineParams??{},powerHP:r}),e}function rs(e){es(e),ts(e)}function os(e){var s,n;if(!Array.isArray(e))return"none";const t=(s=e[0])==null?void 0:s.rpm,r=(n=e[e.length-1])==null?void 0:n.rpm;return`n=${e.length},first=${t},last=${r}`}self.onmessage=async e=>{var t,r,o,s,n,i,c,a,l;try{const u=e.data;if(!(u!=null&&u.model)||!(u!=null&&u.payload))throw new Error("Bad worker message");const h=JSON.parse(JSON.stringify(u.payload));if(u.model==="VB6Exact"){console.log("[WORKER:VB6Exact] Running with SimInputs format",{hasVehicle:!!h.vehicle,vehicleName:(t=h.vehicle)==null?void 0:t.name,powerHP:(r=h.vehicle)==null?void 0:r.powerHP,hasHpCurve:!!((o=h.vehicle)!=null&&o.hpCurve),raceLength:h.raceLength});const m=to(u.model).simulate(h);self.postMessage({ok:!0,result:m});return}rs(h);const d=(s=h==null?void 0:h.engineParams)==null?void 0:s.powerHP;if(!Array.isArray(d)||d.length<2)throw console.error("[WORKER] bad powerHP",{hpLen:d==null?void 0:d.length,sample:(n=d==null?void 0:d.slice)==null?void 0:n.call(d,0,2)}),new Error("EngineParams must provide either torqueCurve or powerHP");Number.isFinite(h==null?void 0:h.raceLengthFt)||(h.raceLengthFt=(u==null?void 0:u.raceLengthFt)??1320);const g=(h==null?void 0:h.drivetrain)??{};console.log("[WORKER:normalized.input]",{hasEngineParams:!!h.engineParams,hasPowerHP:!!d,raceLengthFt:h.raceLengthFt,hpSummary:os(d),hasClutch:!!g.clutch,hasConverter:!!g.converter,slipRPM:(i=g==null?void 0:g.clutch)==null?void 0:i.slipRPM,stallRPM:(c=g==null?void 0:g.converter)==null?void 0:c.stallRPM});try{h!=null&&h.tuning&&console.debug("[WORKER:TUNING]",!0,h.tuning)}catch{}h.flags===void 0&&(h.flags={}),h.flags.vb6Strict===void 0&&(h.flags.vb6Strict=((l=(a=u.payload)==null?void 0:a.flags)==null?void 0:l.vb6Strict)??!0);const M=to(u.model).simulate(h);self.postMessage({ok:!0,result:M})}catch(u){console.error("[WORKER ERROR]",u),self.postMessage({ok:!1,error:String((u==null?void 0:u.message)||u)})}}})();
//# sourceMappingURL=index-aOJIFDIz.js.map
